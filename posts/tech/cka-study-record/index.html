<!DOCTYPE html>
<html lang="zh" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>CKA备考笔记 | Niuhe&#39;s Blog</title>
<meta name="keywords" content="Kubernetes">
<meta name="description" content="记录一下CKA考试的备考过程">
<meta name="author" content="Niuhe">
<link rel="canonical" href="https://blog.niuhemoon.win/posts/tech/cka-study-record/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.3613efbd0b1772781e8f49935e973cae632a7f61471c05b17be155505ccf87b5.css" integrity="sha256-NhPvvQsXcngej0mTXpc8rmMqf2FHHAWxe&#43;FVUFzPh7U=" rel="preload stylesheet" as="style">
<script defer crossorigin="anonymous" src="/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js" integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG&#43;9vmJ0cTS&#43;ovo0FeA="
    onload="hljs.initHighlightingOnLoad();"></script>
<link rel="icon" href="https://blog.niuhemoon.win/base/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="https://blog.niuhemoon.win/base/favicon.ico">
<link rel="icon" type="image/png" sizes="32x32" href="https://blog.niuhemoon.win/base/favicon.ico">
<link rel="apple-touch-icon" href="https://blog.niuhemoon.win/base/avatar.jpeg">
<link rel="mask-icon" href="https://blog.niuhemoon.win/base/avatar.jpeg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --hljs-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript>
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
	ga('create', 'UA-116933089-1', 'auto');
	
	ga('send', 'pageview');
}
</script><meta property="og:title" content="CKA备考笔记" />
<meta property="og:description" content="记录一下CKA考试的备考过程" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://blog.niuhemoon.win/posts/tech/cka-study-record/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2024-01-15T00:00:00+00:00" />
<meta property="article:modified_time" content="2024-01-15T00:00:00+00:00" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="CKA备考笔记"/>
<meta name="twitter:description" content="记录一下CKA考试的备考过程"/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "📚文章",
      "item": "https://blog.niuhemoon.win/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  3 ,
      "name": "👨🏻‍💻 技术",
      "item": "https://blog.niuhemoon.win/posts/tech/"
    }, 
    {
      "@type": "ListItem",
      "position":  4 ,
      "name": "CKA备考笔记",
      "item": "https://blog.niuhemoon.win/posts/tech/cka-study-record/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "CKA备考笔记",
  "name": "CKA备考笔记",
  "description": "记录一下CKA考试的备考过程\n",
  "keywords": [
    "Kubernetes"
  ],
  "articleBody": "记录一下CKA考试的备考过程\nCKA考试备考笔记\n记录备考CKA的过程\n学习K8S的资源主要有三个：\nCertified Kubernetes Administrator (CKA) Practice Exam Tests | Udemy kubectl Cheat Sheet | Kubernetes Udemy Labs - Certified Kubernetes Administrator with Practice Tests - KodeKloud 其中kodekloud提供了在线的实验环境，无需自己搭建k8s集群测试环境 最终考了94分，高分飘过\n考试技巧 考试环境是类似远程桌面，是一个远程的ubuntu桌面，只能在远程桌面内操作，不能使用你自己电脑上的浏览器，但是可以使用远程桌面里的firefox浏览器\n提前30分钟就可以进入考场，出示证件并检查环境\n考试命令行各种快捷键和命令补全都已经配置好了，不用操心\n如果要求是写shell命令行到文件中，不能用k缩写，必须是完整的kubelet命令\n考试时可以复制粘贴k8s官网的内容\n一定要看看网上历年真题，并实际联系，题目几乎一样（很关键）\n最好看英文试题，不会因为翻译产生误解\n最好参加下Killer Shell - Exam Simulators的模拟考试，模拟难度很大，分析学习完会有明显提高\n必学命令\nvim grep命令 yaml语法 netstat命令 ip命令 systemctl命令 journalctl命令 ipcalc命令(可选) apt-cache madison apt-get json-path 笔记 核心概念 核心概念 一切皆是资源\n通过如下命令可以列出api支持的资源\nkubectl api-resources Short name Full name csr certificatesigningrequests cs componentstatuses cm configmaps ds daemonsets deploy deployments ep endpoints ev events hpa horizontalpodautoscalers ing ingresses limits limitranges ns namespaces no nodes pvc persistentvolumeclaims pv persistentvolumes po pods pdb poddisruptionbudgets psp podsecuritypolicies rs replicasets rc replicationcontrollers quota resourcequotas sa serviceaccounts svc services 通用命令 # 列出api接口支持的资源(也包含了资源的apiVersiono和kind信息) kubectl api-resources # 解释具体的资源 kubectl explain kubectl explain replicaset kubectl explain rs | head -n3 # 列出当前namespace所有资源 kubectl get all Pod # 查看所有pods kubectl get pods kubectl get pods -o wide # 创建一个nginx容器 kubectl run nginx --image=nginx # 查看pod的详情 kubectl describe pod | less # 删除pod kubectl delete pod # 查找特定lable的pods k get pods --selector env=dev,bu=finance 利用声明式接口创建pod\ndry run机制生成yaml kubectl create -f 从yaml文件生成pod controlplane ~ ➜ kubectl run redis --image=redis123 --dry-run=client -o yaml \u003e redis-definition.yaml controlplane ~ ➜ cat redis-definition.yaml apiVersion: v1 kind: Pod metadata: creationTimestamp: null labels: run: redis name: redis spec: containers: - image: redis123 name: redis resources: {} dnsPolicy: ClusterFirst restartPolicy: Always status: {} controlplane ~ ➜ kubectl create -f redis-definition.yaml pod/redis created 刚才创建的pod中image名字redis123无法pull镜像，现在进行修复\n方式1:\nkubectl edit pod redis将spec段中的redis123修改为redis，保存即可生效\n方式2:\n直接编辑redis-definition.yaml文件，修改image名后\nkubectl apply -f redis-definition.yaml 方式3:\n先获取pod的yaml\nkubectl get pod redis -o yaml \u003e redis-definition.yaml\n编辑修改后再进行替换\nkubectl replace -f redis-definition.yaml --force\n一些例子\n# 创建带lable的pod kubectl run redis --image=redis:alpine --labels tier=db # 为pod创建一个service k expose pod redis --port 6379 --name redis-service # 创建pod并制定端口 k run custom-nginx --image=nginx --port=8080 # 创建pod同时创建同名的service k run httpd --image httpd:alpine --port=80 --expose 查看/创建static pod\nstatic pod由kubelet直接管理，只能从api接口查看，无法从api管理\n# 查看哪些是static pod，以-controlplane结尾的是的 k get pods --all-namespaces | grep -controlplane # 查找static pod的yaml配置路径 # step1: 查看kubelet的配置文件（启动时通过命令行传递） ps -aux | grep /usr/bin/kubelet # kubelet的配置路径为/var/lib/kubelet/config.yaml grep -i staticpod /var/lib/kubelet/config.yaml # 创建static pod # 首先创建定义pod的yaml文件，然后放到/etc/kubernetes/manifests路径下 kubectl run --restart=Never --image=busybox static-busybox --dry-run=client -o yaml --command -- sleep 1000 \u003e /etc/kubernetes/manifests/static-busybox.yaml Replicaset # 列出replicasets资源 kubectl get replicasets kubectl get rs # 查看replicasets更多信息 kubectl get rs -o wide kubectl describe replicaset # 从yaml文件创建replicasets # 命令式：资源已存在会报错 kubectl create -f replicaset-definition.yaml # 声明式：资源已存在不会报错，更适用于版本更新 kubectl apply -f replicaset-definition.yaml # 删除replicasets kubectl delete rs # 修复错误的replicasets # step1: 修复配置 kubectl edit rs # step2: 删除之前未成功的pods k get po | grep | awk '{print $1}' | xargs -n 1 k delete po # scale扩容或缩容 k scale rs --replicas=5 # 或者直接k edit编辑replicas k edit rs 一些例子\nk create deployment webapp --image kodekloud/webapp-color --replicas DaemonSet # 获取所有namespace中的daemonsets k get daemonsets --all-namespaces # 查看daemonset详情 kubectl describe ds --namespace= # 创建一个daemonset的yaml # step1: 先通过dry run方式创建一个deployment的yaml # step2: 编辑yaml，移除replicas, strategy and status 段 # step3: 将kind从Deployment 改为 DaemonSet 创建daemonset的例子\nk create deployment elasticsearch -n kube-system --image registry.k8s.io/fluentd-elasticsearch:1.20 --dry-run=client -o yaml \u003e daemonset.yaml apiVersion: apps/v1 kind: DaemonSet metadata: creationTimestamp: null labels: app: elasticsearch name: elasticsearch namespace: kube-system spec: selector: matchLabels: app: elasticsearch template: metadata: creationTimestamp: null labels: app: elasticsearch spec: containers: - image: registry.k8s.io/fluentd-elasticsearch:1.20 name: fluentd-elasticsearch resources: {} k apply -f daemonset.yaml Deployment # 列出deployments资源 kubectl get deployments kubectl get deploy # 创建deployment # 方式1:直接命令创建 kubectl create deployment --image httpd:2.4-alpine --replicas 3 httpd-frontent # 方式2:先dry-run生成yaml，然后修改后再apply kubectl create deployment --image httpd:2.4-alpine --replicas 3 --dry-run=client httpd-frontent -o yaml \u003e httpd-deployment.yaml kubectl apply -f httpd-deployment.yaml # 删除deployment k delete deploy 一些例子\n# 指定namespace创建deployment kubectl create deployment redis-deploy -n dev-ns --image redis --replicas 2 Namespace # 列出所有namespace k get namespaces k get ns # 获取环境中namespace个数 k get ns --no-headers | wc -l # 列出特定namespace中的pods k get pods -n # 获取所有namespace中的pods k get pods --all-namespaces # 在特定namespace中创建pod k run redis --image=redis -n finance k run redis --image=redis --dry-run=client -n finance -o yaml # 列出特定namespace中的service k get service -n # 创建一个新的namespace k create namespace 备注：\nservice的DNS解析策略 同namespace，可以直接用service的名字 不同namesapce，需要加上namespace的后缀，例如 db-service.dev db-service.dev.svc.cluster.local Service # 列出所有services k get services k get svc # 查看特定service详情 k describe svc # 创建service，使用类似下民的yaml创建 k apply -f service-definition.yaml --- apiVersion: v1 kind: Service metadata: name: webapp-service namespace: default spec: ports: - nodePort: 30080 port: 8080 targetPort: 8080 selector: name: simple-webapp type: NodePort Node # 获取集群中所有node的信息 kubectl get nodes # 查看节点详情 k describe node 调度部分 通过指定nodeName指定节点部署\n--- apiVersion: v1 kind: Pod metadata: name: nginx spec: nodeName: node01 containers: - image: nginx name: nginx Taint和Tolerance\n# 为节点node01添加taint，效果是NoSchedule k taint node node01 spary=mortein:NoSchedule # 为节点node01移除key是spary的taint k taint node node01 spary- 创建可以容忍特定taint的pod\n--- apiVersion: v1 kind: Pod metadata: name: bee spec: containers: - image: nginx name: bee tolerations: - key: spray value: mortein effect: NoSchedule operator: Equal Label\n# 为节点添加lable color=blue kubectl label node node01 color=blue 使用label实现一个deployment中的pod调度亲和\n--- apiVersion: apps/v1 kind: Deployment metadata: name: blue spec: replicas: 3 selector: matchLabels: run: nginx template: metadata: labels: run: nginx spec: containers: - image: nginx imagePullPolicy: Always name: nginx affinity: nodeAffinity: requiredDuringSchedulingIgnoredDuringExecution: nodeSelectorTerms: - matchExpressions: - key: color operator: In values: - blue 遇到pod定义的资源不足以运行\nkubectl get pod elephant -o yaml \u003e ele.yaml # 编辑资源request后 kubectl replace -f ele.yaml --force pod通过schedulerName指定调度器\n--- apiVersion: v1 kind: Pod metadata: name: nginx spec: schedulerName: my-scheduler containers: - image: nginx name: nginx 度量和日志Metric \u0026 Log Metrics # Metrics度量 git clone https://github.com/kodekloudhub/kubernetes-metrics-server.git cd kubernetes-metrics-server/ kubectl create -f . # wait a minute kubectl top node # cpu占用最高的节点 kubectl top node --sort-by='cpu' --no-headers | head -1 # 内存占用最高的节点 kubectl top node --sort-by='memory' --no-headers | head -1 # 内存占用最多的pod kubectl top pod --sort-by='memory' --no-headers | head -1 # 内存占用最少的pod kubectl top pod --sort-by='memory' --no-headers | tail -1 Log # 查看pod日志 kubectl logs # 指定pod中容器查看日志（一个pod可以有多个container） kubectl logs -c # 登入pod中指定的容器 kubectl exec -it -c -- /bin/bash 应用生命周期管理 更新deployment版本 # 查看deployment的策略 k describe deploy | grep StrategyType # RollingUpdate意味着一次只更新部分pod # Recreate意味着同时终止pod并重新创建 k describe deploy | grep RollingUpdateStrategy # 25% max unavailable, 25% max surge意味着最多可以同时终止25%的pod # 更新deployment的镜像 k edit deploy 命令行 指定容器命令行\napiVersion: v1 kind: Pod metadata: name: ubuntu-sleeper-2 spec: containers: - name: ubuntu image: ubuntu command: - \"sleep\" - \"5000\" apiVersion: v1 kind: Pod metadata: name: webapp-green labels: name: webapp-green spec: containers: - name: simple-webapp image: kodekloud/webapp-color command: [\"python\", \"app.py\"] args: [\"--color\", \"pink\"] Secret # 列出secrets k get secrets # 查看secret详情 k describe secrets # 创建secret，名为db-secret kubectl create secret generic db-secret --from-literal=DB_Host=sql01 --from-literal=DB_User=root pod使用secret\n--- apiVersion: v1 kind: Pod metadata: labels: name: webapp-pod name: webapp-pod namespace: default spec: containers: - image: kodekloud/simple-webapp-mysql imagePullPolicy: Always name: webapp envFrom: - secretRef: name: db-secret Multi Container apiVersion: v1 kind: Pod metadata: creationTimestamp: null labels: run: yellow name: yellow spec: containers: - image: busybox name: lemon resources: {} command: [\"sleep\", \"1000\"] - image: redis name: gold resources: {} dnsPolicy: ClusterFirst restartPolicy: Always status: {} 多容器共享文件系统\n--- apiVersion: v1 kind: Pod metadata: name: app namespace: elastic-stack labels: name: app spec: containers: - name: app image: kodekloud/event-simulator volumeMounts: - mountPath: /log name: log-volume - name: sidecar image: kodekloud/filebeat-configured volumeMounts: - mountPath: /var/log/event-simulator/ name: log-volume volumes: - name: log-volume hostPath: # directory location on host path: /var/log/webapp # this field is optional type: DirectoryOrCreate Init Container --- apiVersion: v1 kind: Pod metadata: name: red namespace: default spec: containers: - command: - sh - -c - echo The app is running! \u0026\u0026 sleep 3600 image: busybox:1.28 name: red-container initContainers: - image: busybox name: red-initcontainer command: - \"sleep\" - \"20\" Cluster 维护 升级OS # 升级node01，首先清空node01上的pod # 效果 pod evicted, node drained # drain会默认将node cordon，即不可调度 kubectl drain node01 --ignore-daemonsets # node01维护完毕后，将node01设置为可调度 kubectl uncordon node01 # NOTE: drain只能处理replicaset，单独的pod需要强制执行 k drain node01 --ignore-daemonsets --force # 对不属于replicaset的pod，将会永久丢失 # 将node01设置不可调度 kubectl cordon node01 升级K8S # 查看控制节点版本 k version --short # 查看node版本，当前1.26 k get nodes # 查看远端可升级版本 kubeadm upgrade plan # 有两个node分别是controlplane和node01 # 先清空controlplane的pod kubectl drain controlplane --ignore-daemonsets # 开始升级controlplane apt update # 首先升级kubeadm apt-get install kubeadm=1.27.0-00 kubeadm upgrade apply v1.27.0 # 升级命令行 apt-get install kubelet=1.27.0-00 # 重启服务 systemctl daemon-reload systemctl restart kubelet # controlplane升级完毕，标记为可调度 kubectl uncordon controlplane # 需要解除controlplane的taint k drain node01 # 接着ssh登录到node01上，升级node01 apt-get update apt-get install kubeadm=1.27.0-00 kubeadm upgrade node apt-get install kubelet=1.27.0-00 systemctl daemon-reload systemctl restart kubelet # 最后让node01可调度 kubectl uncordon node01 备份恢复 # 查看etcd版本（查看日志或者镜像） kubectl -n kube-system logs etcd-controlplane | grep -i 'etcd-version' kubectl -n kube-system describe pod etcd-controlplane | grep Image: # 查看etcd的endpoint kubectl -n kube-system describe pod etcd-controlplane | grep '\\--listen-client-urls' # 查看etcd的cert文件 kubectl -n kube-system describe pod etcd-controlplane | grep '\\--cert-file' # 查看etcd的ca cert文件 kubectl -n kube-system describe pod etcd-controlplane | grep '\\--trusted-ca-file' # 在维护或者对环境做操作前先备份etcd ETCDCTL_API=3 etcdctl --endpoints=https://[127.0.0.1]:2379 \\ --cacert=/etc/kubernetes/pki/etcd/ca.crt \\ --cert=/etc/kubernetes/pki/etcd/server.crt \\ --key=/etc/kubernetes/pki/etcd/server.key \\ snapshot save /opt/snapshot-pre-boot.db # 在维护窗口期间丢失了一些pod或deployment，需要恢复 # 首先将etcd快照恢复到一个新的目录 ETCDCTL_API=3 etcdctl --data-dir /var/lib/etcd-from-backup \\ snapshot restore /opt/snapshot-pre-boot.db # 修改etcd这个staticpod的yaml，指向恢复的data-dir vim /etc/kubernetes/manifests/etcd.yaml # 修改成如下，将etcd-data这个volume指向hostPath: /var/lib/etcd-from-backup # volumes: # - hostPath: # path: /var/lib/etcd-from-backup # type: DirectoryOrCreate # name: etcd-data # 更新yaml后，etcd会自动重建，若etcd一直PENDING，手动删除触发重启 kubectl delete pod -n kube-system etcd-controlplane 多cluster\n# 查看cluster信息 kubectl config view # 或者 kubectl config get-clusters # 查看当前的cluster kubectl config view | grep current-context # 切换cluster kubectl config use-context cluster2 # Type1: Stacked ETCD Topology # 如下命令可以在cluster中查找到etcd的pod kubectl get pods -n kube-system | grep etcd kubectl -n kube-system describe pod etcd-cluster1-controlplane # Type2: External ETCD # cluster内没有etcd的pod，kube-apiserver直接指向一个外部的etcd endpoint ps -aux | grep etcd # 查看ETCD集群的members ETCDCTL_API=3 etcdctl \\ --endpoints=https://127.0.0.1:2379 \\ --cacert=/etc/etcd/pki/ca.pem \\ --cert=/etc/etcd/pki/etcd.pem \\ --key=/etc/etcd/pki/etcd-key.pem \\ member list # 备份Stacked ETCD kubectl config use-context cluster1 kubectl describe pods -n kube-system etcd-cluster1-controlplane | grep advertise-client-urls # --advertise-client-urls=https://10.1.218.16:2379 kubectl describe pods -n kube-system etcd-cluster1-controlplane | grep pki # --cert-file=/etc/kubernetes/pki/etcd/server.crt # --key-file=/etc/kubernetes/pki/etcd/server.key # --peer-cert-file=/etc/kubernetes/pki/etcd/peer.crt # --peer-key-file=/etc/kubernetes/pki/etcd/peer.key # --peer-trusted-ca-file=/etc/kubernetes/pki/etcd/ca.crt # --trusted-ca-file=/etc/kubernetes/pki/etcd/ca.crt # /etc/kubernetes/pki/etcd from etcd-certs (rw) # Path: /etc/kubernetes/pki/etcd # 登录到etcd pod所在的节点 ETCDCTL_API=3 etcdctl --endpoints=https://10.1.220.8:2379 --cacert=/etc/kubernetes/pki/etcd/ca.crt --cert=/etc/kubernetes/pki/etcd/server.crt --key=/etc/kubernetes/pki/etcd/server.key snapshot save /opt/cluster1.db # 恢复External ETCD ETCDCTL_API=3 etcdctl --endpoints=https://127.0.0.1:2379 --cacert=/etc/etcd/pki/ca.pem --cert=/etc/etcd/pki/etcd.pem --key=/etc/etcd/pki/etcd-key.pem snapshot restore /root/cluster2.db --data-dir /var/lib/etcd-data-new systemctl status etcd.service vim /etc/systemd/system/etcd.service systemctl daemon-reload # service的User是etcd，修改文件权限 chown -R etcd:etcd /var/lib/etcd-data-new systemctl restart etcd # 推荐重启控制平面的pod(kube-scheduler, kube-controller-manager, kubelet) 安全Security TLS和证书介绍 Certificate: Data: Version: 3 (0x2) Serial Number: 3478545236123834268 (0x304646764e49d79c) Signature Algorithm: sha256WithRSAEncryption Issuer: CN = kubernetes Validity Not Before: Dec 1 12:24:30 2023 GMT Not After : Nov 30 12:24:30 2024 GMT Subject: CN = kube-apiserver Subject Public Key Info: Public Key Algorithm: rsaEncryption RSA Public-Key: (2048 bit) Modulus: 00:ce:fc:11:8c:a0:2c:83:2d:20:b2:47:83:dc:38: ec:3f:7f:b5:9a:09:c8:a5:7a:16:7a:c7:2d:1d:62: ae:a6:02:7e:d0:be:6a:c6:fd:71:d3:1a:a8:fd:9b: 4d:11:45:f1:21:aa:20:a1:9d:4e:d7:be:f1:22:25: a9:82:52:87:f8:e5:ce:d5:30:e6:1f:99:a5:13:56: e1:38:e3:68:f5:54:de:67:e1:d1:7e:7a:30:12:6c: 48:fd:d9:89:95:07:2a:51:8e:d8:fa:0c:02:79:54: c4:8f:16:42:b1:f4:a9:0e:ac:83:20:f7:d4:eb:c6: 8f:e2:74:2a:03:c7:2a:b6:d9:c4:ea:28:3c:b8:14: 3f:dd:f0:d9:d9:b2:1f:6c:89:93:0b:37:cd:1b:57: 1c:8e:53:fe:d1:40:f5:80:ee:2d:8d:c6:ce:c2:39: 03:d6:c7:aa:61:cb:b5:8d:5c:d6:73:99:ef:c8:6b: 87:ac:0e:3b:59:bb:ec:e2:c5:04:54:4b:ad:d5:da: 48:16:f5:15:0c:bb:29:fe:13:c7:ed:29:dc:bc:01: b5:ac:dd:84:c9:01:e1:fc:40:1e:8f:c5:4a:82:c5: 69:3a:4a:54:b3:22:c6:4b:61:78:54:59:e9:21:ef: a9:5d:cf:a1:b4:c8:f2:18:4e:6a:03:d3:44:3c:be: 9e:d9 Exponent: 65537 (0x10001) X509v3 extensions: X509v3 Key Usage: critical Digital Signature, Key Encipherment X509v3 Extended Key Usage: TLS Web Server Authentication X509v3 Basic Constraints: critical CA:FALSE X509v3 Authority Key Identifier: keyid:27:89:3A:1C:08:4F:74:4E:60:20:1A:44:E0:47:AC:D6:F9:05:93:E5 X509v3 Subject Alternative Name: DNS:controlplane, DNS:kubernetes, DNS:kubernetes.default, DNS:kubernetes.default.svc, DNS:kubernetes.default.svc.cluster.local, IP Address:10.96.0.1, IP Address:192.21.43.6 Signature Algorithm: sha256WithRSAEncryption 8e:75:b2:8e:47:5c:8f:a1:6c:c8:49:da:ef:e0:09:09:6d:cf: dd💿35:f0:e2:df:b2🇩🇪b0:f0:8a:0a:4b:4b:32:7e:46:45: 6b:0b:52:7b:8d:ad:17:67:59:fb:7d:68:86:2b:d1:91:7d:99: c8:ff:d2:17:46:a0:92:ae:3c:55:9a:e4:f5:ee:59:48:a5:2a: 93:4d:8d:02:ba:02:73:f6:07:36:2a:5a:99:4a:33:52:ce:36: ea:44:29:19:cb:d1:6f:4a:db:1f:d9:47:7e:8c:e7:2b:6a:7f: 11:43:57:f1:f6:7a:19:c1:b6:ff:81:37:71:3a:f6:14:d5:63: ab:9d:31:f7:bc:4c:0a:19:fb:36:d7:84:f2:1c:fd:c5:fc:8d: 83:b0:8f:ec:1b:9c:ae:57:4f:f1:96:f5:45:f5:c5:4e:8f:a0: ac:04:97:fa:87:2c:0d:5c:83:a9:d8:94:2f:d5:64:8d:ec:13: c6:b4:93:d2:29:f9:87:23:a0:90:7b:68:8c:d6:5c:fd:a3:97: 96:68:a7:e0:2a:22:8b:a9:d4:01:fc:f5:06:39:7f:63:6b:33: 8e:3f:6b:23:18:9c:c8:7c:0f:0c:c1:4c:73:3f:a3:c2:d7:ea: cb:2a:a8:5d:86:a1:0d:4a:5e:12:51:ba:6c:1e:1c:20:75:d6: 5f:62:5f:d3 证书查看 # 查看kube-api的cert文件 cat /etc/kubernetes/manifests/kube-apiserver.yaml | grep tls-cert-file # 查看certfile详情 openssl x509 -in ./apiserver.crt -text -noout # kube-api故障，排查问题 # 列出所有的容器 crictl ps -a crictl ps -a | grep kube-api crictl logs CertificateSigningRequest # 有签名文件akshay.csr，先base64编码 cat akshay.csr | base64 -w 0 # 按照如下yaml，执行k apply创建csr # 查看csr，刚创建的状态是Pending k get certificatesigningrequests k get csr # 授权，授权后状态是Approved,Issued k certificate approve # 拒绝 csr kubectl certificate deny # 删除csr k delete csr # 查看csr详情 k get csr -o yaml --- apiVersion: certificates.k8s.io/v1 kind: CertificateSigningRequest metadata: name: akshay spec: groups: - system:authenticated request: signerName: kubernetes.io/kube-apiserver-client usages: - client auth Kube Config Client-certificate（客户端证书）和client-key（客户端密钥）是在SSL/TLS通信中用于客户端身份验证的两个重要组件。\n客户端证书是一种数字证书，用于验证客户端的身份。它包含了客户端的公钥以及与之相关联的身份信息，通常由证书颁发机构（CA）签发。客户端证书可以被服务器用来验证客户端的身份，确保通信双方的合法性和安全性。\n客户端密钥是客户端证书中包含的私钥部分。私钥是一种加密密钥，用于对数据进行签名和解密。客户端使用私钥对数据进行签名，服务器使用客户端证书中的公钥对签名进行验证，从而确认客户端的身份。\n在SSL/TLS通信中，客户端证书和客户端密钥通常一起使用，以确保通信的安全性和完整性。客户端证书用于验证客户端的身份，客户端密钥用于生成数字签名以进行身份验证和数据加密。\n这三个文件名后缀分别代表以下含义：\n.crt：代表证书文件，包含了公钥和证书相关信息。 .csr：代表证书签名请求文件，包含了公钥和一些个人信息，用于向证书颁发机构申请签名。 .key：代表密钥文件，包含了与证书相关的私钥信息。 这三个文件之间的关联性在于：\n证书签名请求文件（.csr）是用来向证书颁发机构申请签名的，其中包含了公钥和一些个人信息。 证书文件（.crt）是由证书颁发机构签名后的证书，包含了公钥和证书相关信息。 密钥文件（.key）包含了与证书相关的私钥信息，用于与证书进行配对，以进行加密和解密操作。 这三个文件通常一起使用，以建立安全的通信连接和进行加密操作。\n# config默认文件路径 ls ~/.kube/config # 查看所有cluster k config view # 指定config文件 kubectl config view --kubeconfig # 查看config中的current-context kubectl config current-context --kubeconfig # 切换context kubectl config --kubeconfig= use-context # 将自定义的config文件替换~/.kube/config文件，即可设置为默认的config RBAC # 查看kube-api的authorization-mode kubectl describe pod kube-apiserver-controlplane -n kube-system | grep mode # 列出roles k get roles # 列出所有namespace的roles k get roles.rbac.authorization.k8s.io --all-namespaces --no-headers # 查看roles详情 k describe roles # 列出rolebinding k get rolebindings --all-namespaces # 查看rolebinding详情 k describe rolebindings -n kube-system # 查看config k config view # 指定config中的用户执行kubectl命令 k get pods --as # 上述命令执行报错，用户无权限，需要创建role和rolebinding # 创建一个role，名为developer k create role developer --namespace=default --verb=list,create,delete --resource=pod --dry-run=client -o yaml # 创建rolebinding，将deveploer绑定到用户dev-user上 kubectl create rolebinding dev-user-binding --namespace=default --role=developer --user=dev-user # 编辑role的权限，编辑后无需重新binding k edit role Cluster Role # 列出clusterrole k get clusterrole # 列出clusterrolebinding k get clusterrolebindings # 查看环境中cluster数量 k get clusterrole --no-headers | wc -l # 查看clusterrolebinding数量 k get clusterrolebindings.rbac.authorization.k8s.io --no-headers | wc -l # 查看所有与namspace无关的resource k api-resources --namespaced=false # 查看clusterrole详情 k describe clusterrole # 查看clusterrolebinding详情 k describe clusterrolebindings.rbac.authorization.k8s.io # 创建一个管理node的clusterrole k create clusterrole nodeadmin --resource=nodes --verb=get,watch,list,create,delete --dry-run=client -o yaml # 创建clusterrolebinding k create clusterrolebinding michella-binding --clusterrole nodeadmin --user=michelle --dry-run=client -o yaml # 测试是否有执行权限 kubectl auth can-i list nodes --as michelle # 需要给michelle用户增加权限，新建存储相关的clusterrole和binding k create clusterrole storage-admin --resource=persistentvolumes,storageclasses --verb=get,watch,list,create,delete --dry-run=client -o yaml k create clusterrolebinding michelle-storage-admin --clusterrole=storage-admin --user=michelle --dry-run=client -o yaml Service Account # 获取所有service account k get serviceaccounts k get sa # 查看service account详情 k describe sa # 查看pod的serviceaccount k get po web-dashboard-97c9c59f6-vmw8g -o yaml | grep -i account # 创建一个serviceaccount k create serviceaccount dashboard-sa # 用如下yaml为serviceaccount创建role和rolebinding赋予权限 # 为dashboard-sa这个service account创建token kubectl create token dashboard-sa # 编辑deployment的serviceaccount（默认是default） k edit deployments.apps web-dashboard # 或者 k set serviceaccount deploy/web-dashboard dashboard-sa --- kind: Role apiVersion: rbac.authorization.k8s.io/v1 metadata: namespace: default name: pod-reader rules: - apiGroups: - '' resources: - pods verbs: - get - watch - list --- kind: RoleBinding apiVersion: rbac.authorization.k8s.io/v1 metadata: name: read-pods namespace: default subjects: - kind: ServiceAccount name: dashboard-sa # Name is case sensitive namespace: default roleRef: kind: Role #this must be Role or ClusterRole name: pod-reader # this must match the name of the Role or ClusterRole you wish to bind to apiGroup: rbac.authorization.k8s.io Image Secret # 应用使用私有仓库的镜像 k create secret --help # 创建docker-registry类型的密钥 k create secret docker-registry private-reg-cred --docker-username=dock_user --docker-password=dock_passwd --docker-server=myprivateregistry.com:5000 --docker-email=dock_user@myprivateregistry.com apiVersion: apps/v1 kind: Deployment metadata: annotations: deployment.kubernetes.io/revision: \"3\" creationTimestamp: \"2023-12-02T13:18:12Z\" generation: 3 labels: app: web name: web namespace: default resourceVersion: \"2598\" uid: b375109f-b184-4cb1-9a80-425f1a940e3d spec: progressDeadlineSeconds: 600 replicas: 2 revisionHistoryLimit: 10 selector: matchLabels: app: web strategy: rollingUpdate: maxSurge: 25% maxUnavailable: 25% type: RollingUpdate template: metadata: creationTimestamp: null labels: app: web spec: containers: - image: myprivateregistry.com:5000/nginx:alpine imagePullPolicy: IfNotPresent name: nginx resources: {} terminationMessagePath: /dev/termination-log terminationMessagePolicy: File dnsPolicy: ClusterFirst imagePullSecrets: - name: private-reg-cred restartPolicy: Always schedulerName: default-scheduler securityContext: {} terminationGracePeriodSeconds: 30 Security Context # 执行whoami查看容器内部的执行用户 kubectl exec -- whoami # 强制删除pod kubectl delete pod --force # 更新security context必须先删除再新建pod，可以用k replace命令 # 编辑如下yaml，容器内用user ID 1010执行sleep命令 --- apiVersion: v1 kind: Pod metadata: name: ubuntu-sleeper namespace: default spec: securityContext: runAsUser: 1010 containers: - command: - sleep - \"4800\" image: ubuntu name: ubuntu-sleeper securityContext: capabilities: add: [\"SYS_TIME\"] 不同level的context\napiVersion: v1 kind: Pod metadata: name: multi-pod spec: securityContext: runAsUser: 1001 containers: - image: ubuntu name: web command: [\"sleep\", \"5000\"] securityContext: runAsUser: 1002 - image: ubuntu name: sidecar command: [\"sleep\", \"5000\"] 编辑如下yaml，为容器增加SYS_TIME的能力\n--- apiVersion: v1 kind: Pod metadata: name: ubuntu-sleeper namespace: default spec: containers: - command: - sleep - \"4800\" image: ubuntu name: ubuntu-sleeper securityContext: capabilities: add: [\"SYS_TIME\"] Network Policy # 列出networkpolicy k get networkpolicies.networking.k8s.io k get netpol # 查看netpol详情 k describe netpol # 使用netpol中对应的selector查询应用的pod k get pods --selector name=payroll # 或者 k get po --show-labels # 创建network policy使得Internal只能访问mysql和payroll # 注意同时放开了53端口，因为需要通过53端口访问DNS # 使用如下yaml实现 apiVersion: networking.k8s.io/v1 kind: NetworkPolicy metadata: name: internal-policy namespace: default spec: podSelector: matchLabels: name: internal policyTypes: - Egress - Ingress ingress: - {} egress: - to: - podSelector: matchLabels: name: mysql ports: - protocol: TCP port: 3306 - to: - podSelector: matchLabels: name: payroll ports: - protocol: TCP port: 8080 - ports: - port: 53 protocol: UDP - port: 53 protocol: TCP 存储Storage Persistent Volume Claim # 查看pod内的日志 kubectl exec -- cat /log/app.log # 为pod添加持久化的日志卷 kubectl get po webapp -o yaml \u003e webapp.yaml # 配置hostpath类型的volume apiVersion: v1 kind: Pod metadata: name: webapp spec: containers: - name: event-simulator image: kodekloud/event-simulator env: - name: LOG_HANDLERS value: file volumeMounts: - mountPath: /log name: log-volume volumes: - name: log-volume hostPath: # directory location on host path: /var/log/webapp # this field is optional type: Directory 用如下yaml创建Persistent Volume\napiVersion: v1 kind: PersistentVolume metadata: name: pv-log spec: persistentVolumeReclaimPolicy: Retain accessModes: - ReadWriteMany capacity: storage: 100Mi hostPath: path: /pv/log 创建Persistent Volume Claim\nkind: PersistentVolumeClaim apiVersion: v1 metadata: name: claim-log-1 spec: accessModes: - ReadWriteOnce resources: requests: storage: 50Mi # 列出persistent volume k get persistentvolume k get pv # 列出persistent volume claim k get pvc k get persistentvolumeclaims # 列出多种资源 k get pv,pvc # pod中使用pvc apiVersion: v1 kind: Pod metadata: name: webapp spec: containers: - name: event-simulator image: kodekloud/event-simulator env: - name: LOG_HANDLERS value: file volumeMounts: - mountPath: /log name: log-volume volumes: - name: log-volume persistentVolumeClaim: claimName: claim-log-1 被pod使用中的PVC无法直接删除，需要等到pod删除后才能删掉PVC\nStorage Class # 列出storage class k get storageclasses.storage.k8s.io k get sc # 查看sc详情 k describe sc # 创建storage class，使用如下yaml --- apiVersion: storage.k8s.io/v1 kind: StorageClass metadata: name: delayed-volume-sc provisioner: kubernetes.io/no-provisioner volumeBindingMode: WaitForFirstConsumer 注意WaitForFirstConsume模式的storage，pvc绑定pv时，不会立刻申请存储，而是处于PENDING状态，等到使用pvc的pod被调度时，才会实际上申请存储\n如下为一个使用pvc的yaml\n--- apiVersion: v1 kind: Pod metadata: name: nginx labels: name: nginx spec: containers: - name: nginx image: nginx:alpine volumeMounts: - name: local-persistent-storage mountPath: /var/www/html volumes: - name: local-persistent-storage persistentVolumeClaim: claimName: local-pvc 网络Networking 网络基本命令 # 查看node的internal ip地址 k get nodes -o wide # 查看ip地址对应的网口 ip a | grep # 查看网口的mac地址/状态 ip link show # 查看Containerd创建的网口(Container Network Interface) ip link | grep cni # 查看路由表 ip route list # 查看默认路由 # 默认路由：默认路由是指当目标网络不在路由表中时，数据包将被发送到的默认网关 ip route show default # 查看kube服务监听的port netstat -ntpl | grep kube # 查看etcd的tcp监听服务 netstat -ntpl | grep etcd # 查看etcd的所有链接（包含client） netstat -anp | grep etcd CNI # 查看kubelet的container runtime endpoint ps aux | grep kubelet | grep runtime # 查看cni的插件 ls /opt/cni/bin/ # 查看当前cluster配置的cni插件 ls /etc/cni/net.d/ 部署weave net # 部署weave-net k apply -f weave-daemonset-k8s.yaml # serviceaccount/weave-net created # clusterrole.rbac.authorization.k8s.io/weave-net created # clusterrolebinding.rbac.authorization.k8s.io/weave-net created # role.rbac.authorization.k8s.io/weave-net created # rolebinding.rbac.authorization.k8s.io/weave-net created # daemonset.apps/weave-net created apiVersion: v1 kind: List items: - apiVersion: v1 kind: ServiceAccount metadata: name: weave-net labels: name: weave-net namespace: kube-system - apiVersion: rbac.authorization.k8s.io/v1 kind: ClusterRole metadata: name: weave-net labels: name: weave-net rules: - apiGroups: - '' resources: - pods - namespaces - nodes verbs: - get - list - watch - apiGroups: - extensions resources: - networkpolicies verbs: - get - list - watch - apiGroups: - 'networking.k8s.io' resources: - networkpolicies verbs: - get - list - watch - apiGroups: - '' resources: - nodes/status verbs: - patch - update - apiVersion: rbac.authorization.k8s.io/v1 kind: ClusterRoleBinding metadata: name: weave-net labels: name: weave-net roleRef: kind: ClusterRole name: weave-net apiGroup: rbac.authorization.k8s.io subjects: - kind: ServiceAccount name: weave-net namespace: kube-system - apiVersion: rbac.authorization.k8s.io/v1 kind: Role metadata: name: weave-net namespace: kube-system labels: name: weave-net rules: - apiGroups: - '' resources: - configmaps resourceNames: - weave-net verbs: - get - update - apiGroups: - '' resources: - configmaps verbs: - create - apiVersion: rbac.authorization.k8s.io/v1 kind: RoleBinding metadata: name: weave-net namespace: kube-system labels: name: weave-net roleRef: kind: Role name: weave-net apiGroup: rbac.authorization.k8s.io subjects: - kind: ServiceAccount name: weave-net namespace: kube-system - apiVersion: apps/v1 kind: DaemonSet metadata: name: weave-net labels: name: weave-net namespace: kube-system spec: # Wait 5 seconds to let pod connect before rolling next pod selector: matchLabels: name: weave-net minReadySeconds: 5 template: metadata: labels: name: weave-net spec: initContainers: - name: weave-init image: 'weaveworks/weave-kube:2.8.1' command: - /home/weave/init.sh env: securityContext: privileged: true volumeMounts: - name: cni-bin mountPath: /host/opt - name: cni-bin2 mountPath: /host/home - name: cni-conf mountPath: /host/etc - name: lib-modules mountPath: /lib/modules - name: xtables-lock mountPath: /run/xtables.lock readOnly: false containers: - name: weave command: - /home/weave/launch.sh env: - name: IPALLOC_RANGE value: 10.32.1.0/24 - name: INIT_CONTAINER value: \"true\" - name: HOSTNAME valueFrom: fieldRef: apiVersion: v1 fieldPath: spec.nodeName image: 'weaveworks/weave-kube:2.8.1' readinessProbe: httpGet: host: 127.0.0.1 path: /status port: 6784 resources: requests: cpu: 50m securityContext: privileged: true volumeMounts: - name: weavedb mountPath: /weavedb - name: dbus mountPath: /host/var/lib/dbus readOnly: true - mountPath: /host/etc/machine-id name: cni-machine-id readOnly: true - name: xtables-lock mountPath: /run/xtables.lock readOnly: false - name: weave-npc env: - name: HOSTNAME valueFrom: fieldRef: apiVersion: v1 fieldPath: spec.nodeName image: 'weaveworks/weave-npc:2.8.1' #npc-args resources: requests: cpu: 50m securityContext: privileged: true volumeMounts: - name: xtables-lock mountPath: /run/xtables.lock readOnly: false hostNetwork: true dnsPolicy: ClusterFirstWithHostNet hostPID: false restartPolicy: Always securityContext: seLinuxOptions: {} serviceAccountName: weave-net tolerations: - effect: NoSchedule operator: Exists - effect: NoExecute operator: Exists volumes: - name: weavedb hostPath: path: /var/lib/weave - name: cni-bin hostPath: path: /opt - name: cni-bin2 hostPath: path: /home - name: cni-conf hostPath: path: /etc - name: cni-machine-id hostPath: path: /etc/machine-id - name: dbus hostPath: path: /var/lib/dbus - name: lib-modules hostPath: path: /lib/modules - name: xtables-lock hostPath: path: /run/xtables.lock type: FileOrCreate priorityClassName: system-node-critical updateStrategy: type: RollingUpdate # 查看weave的agent/peer k get pods --all-namespaces | grep weave # weave pod在每个节点上存在一个（包括master和work node） # 查看weave创建的网口 ip link | grep weave # 查看weave网口的ip地址段 ip addr show weave ip route list # 查看work node上weave net的默认网关，首先登录到work node ip route | gre weave Service Networking # 查看整个cluster的网络范围 ip addr | grep eth0 # 215: eth0@if216: mtu 1450 qdisc noqueue state UP group default # inet 192.4.210.9/24 brd 192.4.210.255 scope global eth0 ipcalc -b 192.4.210.9 # 计算的cluster的地址范围192.4.210.0/24 # 查看cluster中pod的网络地址范围 # 若pod使用weave网络，使用如下查询方式 k logs -n kube-system weave-net-8v8hr | grep ipalloc-range # pod地址范围是10.244.0.0/16 # 查看service的网络地址范围 cat /etc/kubernetes/manifests/kube-apiserver.yaml | grep cluster-ip-range # --service-cluster-ip-range=10.96.0.0/12 # 查看kube-proxy的类型 k logs -n kube-system CoreDNS # 查看cluster的DNS解决方案 k get pods -n kube-system | grep dns # 查看dns service k get service --all-namespaces | grep dns # 查看coredns的配置文件 k -n kube-system describe deployments.apps coredns | grep -A2 Args # 查看Corefile的注入方式 k get po -n kube-system coredns-5d78c9869d-5sxxz -o yaml k describe cm -n kube-system coredns # service的DNS规则如下：service.namespace.svc.cluster.local # web-service.payroll.svc.cluster.local # 查看DNS结果 kubectl exec -it hr -- nslookup mysql.payroll \u003e /root/CKA/nslookup.out Ingress # 查看ingress kubectl get all -A | grep -i ingress k get ingress -A # 查看ingress详情 kubectl describe ingress # 编辑ingress修改rules kubectl edit ingress # 创建ingress，注意如下命令缺少annotation，创建的yaml添加annotation才能正常工作 # pathType: Exact k create ingress -n critical-space test-ingress --rule=/pay=pay-service:8282 --dry-run=client -o yaml # pathType: Prefix k create ingress -n critical-space test-ingress --rule=/pay*=pay-service:8282 --dry-run=client -o yaml apiVersion: networking.k8s.io/v1 kind: Ingress metadata: annotations: nginx.ingress.kubernetes.io/rewrite-target: / nginx.ingress.kubernetes.io/ssl-redirect: \"false\" name: ingress-wear-watch namespace: app-space spec: rules: - http: paths: - backend: service: name: wear-service port: number: 8080 path: /wear pathType: Prefix - backend: service: name: video-service port: number: 8080 path: /stream pathType: Prefix 如下为cluster创建ingress controller\n# 创建ingress独立的namespace(便于隔离) k create namespace ingress-nginx # 创建configmap kubectl create configmap ingress-nginx-controller --namespace ingress-nginx # 创建service account k create sa ingress-nginx -n ingress-nginx k create sa ingress-nginx-admission -n ingress-nginx # 创建role，rolebinding，clusterrole，clusterrolebinding # 略 # ingress controller 的yaml如下 apiVersion: apps/v1 kind: Deployment metadata: labels: app.kubernetes.io/component: controller app.kubernetes.io/instance: ingress-nginx app.kubernetes.io/managed-by: Helm app.kubernetes.io/name: ingress-nginx app.kubernetes.io/part-of: ingress-nginx app.kubernetes.io/version: 1.1.2 helm.sh/chart: ingress-nginx-4.0.18 name: ingress-nginx-controller namespace: ingress-nginx spec: replicas: 1 minReadySeconds: 0 revisionHistoryLimit: 10 selector: matchLabels: app.kubernetes.io/component: controller app.kubernetes.io/instance: ingress-nginx app.kubernetes.io/name: ingress-nginx template: metadata: labels: app.kubernetes.io/component: controller app.kubernetes.io/instance: ingress-nginx app.kubernetes.io/name: ingress-nginx spec: containers: - args: - /nginx-ingress-controller - --publish-service=$(POD_NAMESPACE)/ingress-nginx-controller - --election-id=ingress-controller-leader - --watch-ingress-without-class=true - --default-backend-service=app-space/default-http-backend - --controller-class=k8s.io/ingress-nginx - --ingress-class=nginx - --configmap=$(POD_NAMESPACE)/ingress-nginx-controller - --validating-webhook=:8443 - --validating-webhook-certificate=/usr/local/certificates/cert - --validating-webhook-key=/usr/local/certificates/key env: - name: POD_NAME valueFrom: fieldRef: fieldPath: metadata.name - name: POD_NAMESPACE valueFrom: fieldRef: fieldPath: metadata.namespace - name: LD_PRELOAD value: /usr/local/lib/libmimalloc.so image: registry.k8s.io/ingress-nginx/controller:v1.1.2@sha256:28b11ce69e57843de44e3db6413e98d09de0f6688e33d4bd384002a44f78405c imagePullPolicy: IfNotPresent lifecycle: preStop: exec: command: - /wait-shutdown livenessProbe: failureThreshold: 5 httpGet: path: /healthz port: 10254 scheme: HTTP initialDelaySeconds: 10 periodSeconds: 10 successThreshold: 1 timeoutSeconds: 1 name: controller ports: - name: http containerPort: 80 protocol: TCP - containerPort: 443 name: https protocol: TCP - containerPort: 8443 name: webhook protocol: TCP readinessProbe: failureThreshold: 3 httpGet: path: /healthz port: 10254 scheme: HTTP initialDelaySeconds: 10 periodSeconds: 10 successThreshold: 1 timeoutSeconds: 1 resources: requests: cpu: 100m memory: 90Mi securityContext: allowPrivilegeEscalation: true capabilities: add: - NET_BIND_SERVICE drop: - ALL runAsUser: 101 volumeMounts: - mountPath: /usr/local/certificates/ name: webhook-cert readOnly: true dnsPolicy: ClusterFirst nodeSelector: kubernetes.io/os: linux serviceAccountName: ingress-nginx terminationGracePeriodSeconds: 300 volumes: - name: webhook-cert secret: secretName: ingress-nginx-admission --- apiVersion: v1 kind: Service metadata: creationTimestamp: null labels: app.kubernetes.io/component: controller app.kubernetes.io/instance: ingress-nginx app.kubernetes.io/managed-by: Helm app.kubernetes.io/name: ingress-nginx app.kubernetes.io/part-of: ingress-nginx app.kubernetes.io/version: 1.1.2 helm.sh/chart: ingress-nginx-4.0.18 name: ingress-nginx-controller namespace: ingress-nginx spec: ports: - port: 80 protocol: TCP targetPort: 80 nodePort: 30080 selector: app.kubernetes.io/component: controller app.kubernetes.io/instance: ingress-nginx app.kubernetes.io/name: ingress-nginx type: NodePort # 接着创建ingress，ingress资源是在namespace范围下的，所以ingress要和service同一个namespace k create ingress -n app-space --rule /wear*=wear-service:8080 --rule /watch*=video-service:8080 --annotation nginx.ingress.kubernetes.io/rewrite-target=/ --annotation nginx.ingress.kubernetes.io/ssl-redirect=false test-ingress --dry-run=client -o yaml apiVersion: networking.k8s.io/v1 kind: Ingress metadata: annotations: nginx.ingress.kubernetes.io/rewrite-target: / nginx.ingress.kubernetes.io/ssl-redirect: \"false\" creationTimestamp: null name: test-ingress namespace: app-space spec: rules: - http: paths: - backend: service: name: wear-service port: number: 8080 path: /wear pathType: Prefix - backend: service: name: video-service port: number: 8080 path: /watch pathType: Prefix status: loadBalancer: {} 部署K8S # 在每个节点上执行如下安装操作 # step1: 修改网络策略 cat \u003c",
  "wordCount" : "10926",
  "inLanguage": "zh",
  "datePublished": "2024-01-15T00:00:00Z",
  "dateModified": "2024-01-15T00:00:00Z",
  "author":{
    "@type": "Person",
    "name": "Niuhe"
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://blog.niuhemoon.win/posts/tech/cka-study-record/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Niuhe's Blog",
    "logo": {
      "@type": "ImageObject",
      "url": "https://blog.niuhemoon.win/base/favicon.ico"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://blog.niuhemoon.win" accesskey="h" title="Niuhe&#39;s Blog (Alt + H)">
                <img src="https://blog.niuhemoon.win/base/avatar.jpeg" alt="" aria-label="logo"
                    height="35">Niuhe&#39;s Blog</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="https://blog.niuhemoon.win/search" title="🔍搜索 (Alt &#43; /)" accesskey=/>
                    <span>🔍搜索</span>
                </a>
            </li>
            <li>
                <a href="https://blog.niuhemoon.win/" title="🏠主页">
                    <span>🏠主页</span>
                </a>
            </li>
            <li>
                <a href="https://blog.niuhemoon.win/posts" title="📚文章">
                    <span>📚文章</span>
                </a>
            </li>
            <li>
                <a href="https://blog.niuhemoon.win/tags" title="🔖标签">
                    <span>🔖标签</span>
                </a>
            </li>
            <li>
                <a href="https://blog.niuhemoon.win/archives/" title="⏱时间轴">
                    <span>⏱时间轴</span>
                </a>
            </li>
            <li>
                <a href="https://blog.niuhemoon.win/about" title="🙋🏻‍♂️关于">
                    <span>🙋🏻‍♂️关于</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="https://blog.niuhemoon.win">🏠主页</a>&nbsp;»&nbsp;<a href="https://blog.niuhemoon.win/posts/">📚文章</a>&nbsp;»&nbsp;<a href="https://blog.niuhemoon.win/posts/tech/">👨🏻‍💻 技术</a></div>
    <h1 class="post-title">
      CKA备考笔记
    </h1>
    <div class="post-meta"><span title='2024-01-15 00:00:00 +0000 UTC'>2024-01-15</span>&nbsp;·&nbsp;22 min&nbsp;·&nbsp;10926 字&nbsp;·&nbsp;Niuhe

</div>
  </header> <div class="toc">
    <details  open>
        <summary accesskey="c" title="(Alt + C)">
            <span class="details">文章目录</span>
        </summary>

        <div class="inner"><ul>
                <li>
                    <a href="#%e8%80%83%e8%af%95%e6%8a%80%e5%b7%a7" aria-label="考试技巧">考试技巧</a></li>
                <li>
                    <a href="#%e7%ac%94%e8%ae%b0" aria-label="笔记">笔记</a><ul>
                        
                <li>
                    <a href="#%e6%a0%b8%e5%bf%83%e6%a6%82%e5%bf%b5" aria-label="核心概念">核心概念</a><ul>
                        
                <li>
                    <a href="#%e6%a0%b8%e5%bf%83%e6%a6%82%e5%bf%b5-1" aria-label="核心概念">核心概念</a></li>
                <li>
                    <a href="#%e9%80%9a%e7%94%a8%e5%91%bd%e4%bb%a4" aria-label="通用命令">通用命令</a></li>
                <li>
                    <a href="#pod" aria-label="Pod">Pod</a></li>
                <li>
                    <a href="#replicaset" aria-label="Replicaset">Replicaset</a></li>
                <li>
                    <a href="#daemonset" aria-label="DaemonSet">DaemonSet</a></li>
                <li>
                    <a href="#deployment" aria-label="Deployment">Deployment</a></li>
                <li>
                    <a href="#namespace" aria-label="Namespace">Namespace</a></li>
                <li>
                    <a href="#service" aria-label="Service">Service</a></li>
                <li>
                    <a href="#node" aria-label="Node">Node</a></li></ul>
                </li>
                <li>
                    <a href="#%e8%b0%83%e5%ba%a6%e9%83%a8%e5%88%86" aria-label="调度部分">调度部分</a></li>
                <li>
                    <a href="#%e5%ba%a6%e9%87%8f%e5%92%8c%e6%97%a5%e5%bf%97metric--log" aria-label="度量和日志Metric &amp;amp; Log">度量和日志Metric &amp; Log</a><ul>
                        
                <li>
                    <a href="#metrics" aria-label="Metrics">Metrics</a></li>
                <li>
                    <a href="#log" aria-label="Log">Log</a></li></ul>
                </li>
                <li>
                    <a href="#%e5%ba%94%e7%94%a8%e7%94%9f%e5%91%bd%e5%91%a8%e6%9c%9f%e7%ae%a1%e7%90%86" aria-label="应用生命周期管理">应用生命周期管理</a><ul>
                        
                <li>
                    <a href="#%e6%9b%b4%e6%96%b0deployment%e7%89%88%e6%9c%ac" aria-label="更新deployment版本">更新deployment版本</a></li>
                <li>
                    <a href="#%e5%91%bd%e4%bb%a4%e8%a1%8c" aria-label="命令行">命令行</a></li>
                <li>
                    <a href="#secret" aria-label="Secret">Secret</a></li>
                <li>
                    <a href="#multi-container" aria-label="Multi Container">Multi Container</a></li>
                <li>
                    <a href="#init-container" aria-label="Init Container">Init Container</a></li></ul>
                </li>
                <li>
                    <a href="#cluster-%e7%bb%b4%e6%8a%a4" aria-label="Cluster 维护">Cluster 维护</a><ul>
                        
                <li>
                    <a href="#%e5%8d%87%e7%ba%a7os" aria-label="升级OS">升级OS</a></li>
                <li>
                    <a href="#%e5%8d%87%e7%ba%a7k8s" aria-label="升级K8S">升级K8S</a></li>
                <li>
                    <a href="#%e5%a4%87%e4%bb%bd%e6%81%a2%e5%a4%8d" aria-label="备份恢复">备份恢复</a></li></ul>
                </li>
                <li>
                    <a href="#%e5%ae%89%e5%85%a8security" aria-label="安全Security">安全Security</a><ul>
                        
                <li>
                    <a href="#tls%e5%92%8c%e8%af%81%e4%b9%a6%e4%bb%8b%e7%bb%8d" aria-label="TLS和证书介绍">TLS和证书介绍</a></li>
                <li>
                    <a href="#%e8%af%81%e4%b9%a6%e6%9f%a5%e7%9c%8b" aria-label="证书查看">证书查看</a></li>
                <li>
                    <a href="#certificatesigningrequest" aria-label="CertificateSigningRequest">CertificateSigningRequest</a></li>
                <li>
                    <a href="#kube-config" aria-label="Kube Config">Kube Config</a></li>
                <li>
                    <a href="#rbac" aria-label="RBAC">RBAC</a></li>
                <li>
                    <a href="#cluster-role" aria-label="Cluster Role">Cluster Role</a></li>
                <li>
                    <a href="#service-account" aria-label="Service Account">Service Account</a></li>
                <li>
                    <a href="#image-secret" aria-label="Image Secret">Image Secret</a></li>
                <li>
                    <a href="#security-context" aria-label="Security Context">Security Context</a></li>
                <li>
                    <a href="#network-policy" aria-label="Network Policy">Network Policy</a></li></ul>
                </li>
                <li>
                    <a href="#%e5%ad%98%e5%82%a8storage" aria-label="存储Storage">存储Storage</a><ul>
                        
                <li>
                    <a href="#persistent-volume-claim" aria-label="Persistent Volume Claim">Persistent Volume Claim</a></li>
                <li>
                    <a href="#storage-class" aria-label="Storage Class">Storage Class</a></li></ul>
                </li>
                <li>
                    <a href="#%e7%bd%91%e7%bb%9cnetworking" aria-label="网络Networking">网络Networking</a><ul>
                        
                <li>
                    <a href="#%e7%bd%91%e7%bb%9c%e5%9f%ba%e6%9c%ac%e5%91%bd%e4%bb%a4" aria-label="网络基本命令">网络基本命令</a></li>
                <li>
                    <a href="#cni" aria-label="CNI">CNI</a></li>
                <li>
                    <a href="#%e9%83%a8%e7%bd%b2weave-net" aria-label="部署weave net">部署weave net</a></li>
                <li>
                    <a href="#service-networking" aria-label="Service Networking">Service Networking</a></li>
                <li>
                    <a href="#coredns" aria-label="CoreDNS">CoreDNS</a></li>
                <li>
                    <a href="#ingress" aria-label="Ingress">Ingress</a></li></ul>
                </li>
                <li>
                    <a href="#%e9%83%a8%e7%bd%b2k8s" aria-label="部署K8S">部署K8S</a></li>
                <li>
                    <a href="#trouble-shooting" aria-label="Trouble Shooting">Trouble Shooting</a></li>
                <li>
                    <a href="#lighting-lab" aria-label="Lighting Lab">Lighting Lab</a><ul>
                        
                <li>
                    <a href="#%e5%8f%82%e8%80%83" aria-label="参考">参考</a>
                </li>
            </ul>
            </li>
            </ul>
            </li>
            </ul>
        </div>
    </details>
</div>

  <div class="post-content"><p>记录一下CKA考试的备考过程</p>
<p>CKA考试备考笔记</p>
<blockquote>
<p>记录备考CKA的过程</p>
<p>学习K8S的资源主要有三个：</p>
<ul>
<li><a href="https://www.udemy.com/course/certified-kubernetes-administrator-with-practice-tests/">Certified Kubernetes Administrator (CKA) Practice Exam Tests | Udemy</a></li>
<li><a href="https://kubernetes.io/docs/reference/kubectl/cheatsheet/">kubectl Cheat Sheet | Kubernetes</a></li>
<li><a href="https://kodekloud.com/courses/labs-certified-kubernetes-administrator-with-practice-tests/">Udemy Labs - Certified Kubernetes Administrator with Practice Tests - KodeKloud</a></li>
</ul>
<p>其中kodekloud提供了在线的实验环境，无需自己搭建k8s集群测试环境
最终考了94分，高分飘过</p>
</blockquote>
<h1 id="考试技巧">考试技巧<a hidden class="anchor" aria-hidden="true" href="#考试技巧">#</a></h1>
<ul>
<li>
<p>考试环境是类似远程桌面，是一个远程的ubuntu桌面，只能在远程桌面内操作，不能使用你自己电脑上的浏览器，但是可以使用远程桌面里的firefox浏览器</p>
</li>
<li>
<p>提前30分钟就可以进入考场，出示证件并检查环境</p>
</li>
<li>
<p>考试命令行各种快捷键和命令补全都已经配置好了，不用操心</p>
</li>
<li>
<p>如果要求是写shell命令行到文件中，不能用k缩写，必须是完整的kubelet命令</p>
</li>
<li>
<p>考试时可以复制粘贴k8s官网的内容</p>
</li>
<li>
<p>一定要看看网上历年真题，并实际联系，题目几乎一样（很关键）</p>
</li>
<li>
<p>最好看英文试题，不会因为翻译产生误解</p>
</li>
<li>
<p>最好参加下<a href="https://killer.sh/dashboard">Killer Shell - Exam Simulators</a>的模拟考试，模拟难度很大，分析学习完会有明显提高</p>
</li>
<li>
<p>必学命令</p>
<ul>
<li>vim</li>
<li>grep命令</li>
<li>yaml语法</li>
<li>netstat命令</li>
<li>ip命令</li>
<li>systemctl命令</li>
<li>journalctl命令</li>
<li>ipcalc命令(可选)</li>
<li>apt-cache madison</li>
<li>apt-get</li>
<li>json-path</li>
</ul>
</li>
</ul>
<h1 id="笔记">笔记<a hidden class="anchor" aria-hidden="true" href="#笔记">#</a></h1>
<h2 id="核心概念">核心概念<a hidden class="anchor" aria-hidden="true" href="#核心概念">#</a></h2>
<h3 id="核心概念-1">核心概念<a hidden class="anchor" aria-hidden="true" href="#核心概念-1">#</a></h3>
<blockquote>
<p>一切皆是资源</p>
</blockquote>
<p>通过如下命令可以列出api支持的资源</p>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>kubectl api-resources
</span></span></code></pre></div><table>
<thead>
<tr>
<th>Short name</th>
<th>Full name</th>
</tr>
</thead>
<tbody>
<tr>
<td>csr</td>
<td>certificatesigningrequests</td>
</tr>
<tr>
<td>cs</td>
<td>componentstatuses</td>
</tr>
<tr>
<td>cm</td>
<td>configmaps</td>
</tr>
<tr>
<td>ds</td>
<td>daemonsets</td>
</tr>
<tr>
<td>deploy</td>
<td>deployments</td>
</tr>
<tr>
<td>ep</td>
<td>endpoints</td>
</tr>
<tr>
<td>ev</td>
<td>events</td>
</tr>
<tr>
<td>hpa</td>
<td>horizontalpodautoscalers</td>
</tr>
<tr>
<td>ing</td>
<td>ingresses</td>
</tr>
<tr>
<td>limits</td>
<td>limitranges</td>
</tr>
<tr>
<td>ns</td>
<td>namespaces</td>
</tr>
<tr>
<td>no</td>
<td>nodes</td>
</tr>
<tr>
<td>pvc</td>
<td>persistentvolumeclaims</td>
</tr>
<tr>
<td>pv</td>
<td>persistentvolumes</td>
</tr>
<tr>
<td>po</td>
<td>pods</td>
</tr>
<tr>
<td>pdb</td>
<td>poddisruptionbudgets</td>
</tr>
<tr>
<td>psp</td>
<td>podsecuritypolicies</td>
</tr>
<tr>
<td>rs</td>
<td>replicasets</td>
</tr>
<tr>
<td>rc</td>
<td>replicationcontrollers</td>
</tr>
<tr>
<td>quota</td>
<td>resourcequotas</td>
</tr>
<tr>
<td>sa</td>
<td>serviceaccounts</td>
</tr>
<tr>
<td>svc</td>
<td>services</td>
</tr>
</tbody>
</table>
<h3 id="通用命令">通用命令<a hidden class="anchor" aria-hidden="true" href="#通用命令">#</a></h3>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#007f7f"># 列出api接口支持的资源(也包含了资源的apiVersiono和kind信息)</span>
</span></span><span style="display:flex;"><span>kubectl api-resources
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># 解释具体的资源</span>
</span></span><span style="display:flex;"><span>kubectl explain &lt;resource-name&gt;
</span></span><span style="display:flex;"><span>kubectl explain replicaset
</span></span><span style="display:flex;"><span>kubectl explain rs | head -n3
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># 列出当前namespace所有资源</span>
</span></span><span style="display:flex;"><span>kubectl get all
</span></span></code></pre></div><h3 id="pod">Pod<a hidden class="anchor" aria-hidden="true" href="#pod">#</a></h3>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#007f7f"># 查看所有pods</span>
</span></span><span style="display:flex;"><span>kubectl get pods
</span></span><span style="display:flex;"><span>kubectl get pods -o wide
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># 创建一个nginx容器</span>
</span></span><span style="display:flex;"><span>kubectl run nginx --image=nginx
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># 查看pod的详情</span>
</span></span><span style="display:flex;"><span>kubectl describe pod &lt;podname&gt; | less
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># 删除pod</span>
</span></span><span style="display:flex;"><span>kubectl delete pod &lt;podname&gt;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># 查找特定lable的pods</span>
</span></span><span style="display:flex;"><span>k get pods --selector env=dev,bu=finance
</span></span></code></pre></div><blockquote>
<p>利用声明式接口创建pod</p>
<ul>
<li>dry run机制生成yaml</li>
<li><code>kubectl create -f</code> 从yaml文件生成pod</li>
</ul>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>controlplane ~ ➜  kubectl run redis --image=redis123 --dry-run=client -o yaml &gt; redis-definition.yaml
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>controlplane ~ ➜  cat redis-definition.yaml 
</span></span><span style="display:flex;"><span>apiVersion: v1
</span></span><span style="display:flex;"><span>kind: Pod
</span></span><span style="display:flex;"><span>metadata:
</span></span><span style="display:flex;"><span>  creationTimestamp: null
</span></span><span style="display:flex;"><span>  labels:
</span></span><span style="display:flex;"><span>    run: redis
</span></span><span style="display:flex;"><span>  name: redis
</span></span><span style="display:flex;"><span>spec:
</span></span><span style="display:flex;"><span>  containers:
</span></span><span style="display:flex;"><span>  - image: redis123
</span></span><span style="display:flex;"><span>    name: redis
</span></span><span style="display:flex;"><span>    resources: {}
</span></span><span style="display:flex;"><span>  dnsPolicy: ClusterFirst
</span></span><span style="display:flex;"><span>  restartPolicy: Always
</span></span><span style="display:flex;"><span>status: {}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>controlplane ~ ➜  kubectl create -f redis-definition.yaml 
</span></span><span style="display:flex;"><span>pod/redis created
</span></span></code></pre></div><blockquote>
<p>刚才创建的pod中image名字redis123无法pull镜像，现在进行修复</p>
<p>方式1:</p>
<p><code>kubectl edit pod redis</code>将spec段中的redis123修改为redis，保存即可生效</p>
<p>方式2:</p>
<p>直接编辑redis-definition.yaml文件，修改image名后</p>
<p><code>kubectl apply -f redis-definition.yaml </code></p>
<p>方式3:</p>
<p>先获取pod的yaml</p>
<p><code>kubectl get pod redis -o yaml &gt; redis-definition.yaml</code></p>
<p>编辑修改后再进行替换</p>
<p><code>kubectl replace -f redis-definition.yaml --force</code></p>
</blockquote>
<blockquote>
<p>一些例子</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># 创建带lable的pod</span>
</span></span><span style="display:flex;"><span>kubectl run redis --image=redis:alpine --labels tier=db
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># 为pod创建一个service</span>
</span></span><span style="display:flex;"><span>k expose pod redis --port <span style="color:#ff0;font-weight:bold">6379</span> --name redis-service
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># 创建pod并制定端口</span>
</span></span><span style="display:flex;"><span>k run custom-nginx --image=nginx --port=<span style="color:#ff0;font-weight:bold">8080</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># 创建pod同时创建同名的service</span>
</span></span><span style="display:flex;"><span>k run httpd --image httpd:alpine --port=<span style="color:#ff0;font-weight:bold">80</span> --expose
</span></span></code></pre></div><blockquote>
<p>查看/创建static pod</p>
<p>static pod由kubelet直接管理，只能从api接口查看，无法从api管理</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#007f7f"># 查看哪些是static pod，以-controlplane结尾的是的</span>
</span></span><span style="display:flex;"><span>k get pods --all-namespaces | grep -controlplane
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># 查找static pod的yaml配置路径</span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># step1: 查看kubelet的配置文件（启动时通过命令行传递）</span>
</span></span><span style="display:flex;"><span>ps -aux | grep /usr/bin/kubelet
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># kubelet的配置路径为/var/lib/kubelet/config.yaml</span>
</span></span><span style="display:flex;"><span>grep -i staticpod /var/lib/kubelet/config.yaml
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># 创建static pod</span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># 首先创建定义pod的yaml文件，然后放到/etc/kubernetes/manifests路径下</span>
</span></span><span style="display:flex;"><span>kubectl run --restart=Never --image=busybox static-busybox --dry-run=client -o yaml --command -- sleep <span style="color:#ff0;font-weight:bold">1000</span> &gt; /etc/kubernetes/manifests/static-busybox.yaml
</span></span></code></pre></div><h3 id="replicaset">Replicaset<a hidden class="anchor" aria-hidden="true" href="#replicaset">#</a></h3>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#007f7f"># 列出replicasets资源</span>
</span></span><span style="display:flex;"><span>kubectl get replicasets
</span></span><span style="display:flex;"><span>kubectl get rs
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># 查看replicasets更多信息</span>
</span></span><span style="display:flex;"><span>kubectl get rs -o wide
</span></span><span style="display:flex;"><span>kubectl describe replicaset &lt;replicaset-name&gt;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># 从yaml文件创建replicasets</span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># 命令式：资源已存在会报错</span>
</span></span><span style="display:flex;"><span>kubectl create -f replicaset-definition.yaml
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># 声明式：资源已存在不会报错，更适用于版本更新</span>
</span></span><span style="display:flex;"><span>kubectl apply -f replicaset-definition.yaml
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># 删除replicasets</span>
</span></span><span style="display:flex;"><span>kubectl delete rs &lt;replicaset-name&gt;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># 修复错误的replicasets</span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># step1: 修复配置</span>
</span></span><span style="display:flex;"><span>kubectl edit rs &lt;replicaset-name&gt;
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># step2: 删除之前未成功的pods</span>
</span></span><span style="display:flex;"><span>k get po | grep &lt;replicaset-name&gt; | awk  <span style="color:#0ff;font-weight:bold">&#39;{print $1}&#39;</span> | xargs -n <span style="color:#ff0;font-weight:bold">1</span> k delete po
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># scale扩容或缩容</span>
</span></span><span style="display:flex;"><span>k scale rs &lt;replicaset-name&gt; --replicas=<span style="color:#ff0;font-weight:bold">5</span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># 或者直接k edit编辑replicas</span>
</span></span><span style="display:flex;"><span>k edit rs &lt;replicaset-name&gt;
</span></span></code></pre></div><blockquote>
<p>一些例子</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>k create deployment webapp --image kodekloud/webapp-color --replicas 
</span></span></code></pre></div><h3 id="daemonset">DaemonSet<a hidden class="anchor" aria-hidden="true" href="#daemonset">#</a></h3>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#007f7f"># 获取所有namespace中的daemonsets</span>
</span></span><span style="display:flex;"><span>k get daemonsets --all-namespaces
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># 查看daemonset详情</span>
</span></span><span style="display:flex;"><span>kubectl describe ds &lt;daemonset-name&gt; --namespace=&lt;namespace-name&gt;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># 创建一个daemonset的yaml</span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># step1: 先通过dry run方式创建一个deployment的yaml</span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># step2: 编辑yaml，移除replicas, strategy and status 段</span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># step3: 将kind从Deployment 改为 DaemonSet</span>
</span></span></code></pre></div><blockquote>
<p>创建daemonset的例子</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>k create deployment elasticsearch -n kube-system --image registry.k8s.io/fluentd-elasticsearch:1.20 --dry-run=client  -o yaml &gt; daemonset.yaml
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="font-weight:bold">apiVersion</span>: apps/v1
</span></span><span style="display:flex;"><span><span style="font-weight:bold">kind</span>: DaemonSet
</span></span><span style="display:flex;"><span><span style="font-weight:bold">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="font-weight:bold">creationTimestamp</span>: <span style="color:#fff;font-weight:bold">null</span>
</span></span><span style="display:flex;"><span>  <span style="font-weight:bold">labels</span>:
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">app</span>: elasticsearch
</span></span><span style="display:flex;"><span>  <span style="font-weight:bold">name</span>: elasticsearch
</span></span><span style="display:flex;"><span>  <span style="font-weight:bold">namespace</span>: kube-system
</span></span><span style="display:flex;"><span><span style="font-weight:bold">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="font-weight:bold">selector</span>:
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">matchLabels</span>:
</span></span><span style="display:flex;"><span>      <span style="font-weight:bold">app</span>: elasticsearch
</span></span><span style="display:flex;"><span>  <span style="font-weight:bold">template</span>:
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">metadata</span>:
</span></span><span style="display:flex;"><span>      <span style="font-weight:bold">creationTimestamp</span>: <span style="color:#fff;font-weight:bold">null</span>
</span></span><span style="display:flex;"><span>      <span style="font-weight:bold">labels</span>:
</span></span><span style="display:flex;"><span>        <span style="font-weight:bold">app</span>: elasticsearch
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">spec</span>:
</span></span><span style="display:flex;"><span>      <span style="font-weight:bold">containers</span>:
</span></span><span style="display:flex;"><span>      - <span style="font-weight:bold">image</span>: registry.k8s.io/fluentd-elasticsearch:1.20
</span></span><span style="display:flex;"><span>        <span style="font-weight:bold">name</span>: fluentd-elasticsearch
</span></span><span style="display:flex;"><span>        <span style="font-weight:bold">resources</span>: {}
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>k apply -f daemonset.yaml
</span></span></code></pre></div><h3 id="deployment">Deployment<a hidden class="anchor" aria-hidden="true" href="#deployment">#</a></h3>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#007f7f"># 列出deployments资源</span>
</span></span><span style="display:flex;"><span>kubectl get deployments
</span></span><span style="display:flex;"><span>kubectl get deploy
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># 创建deployment</span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># 方式1:直接命令创建</span>
</span></span><span style="display:flex;"><span>kubectl create deployment --image httpd:2.4-alpine --replicas <span style="color:#ff0;font-weight:bold">3</span> httpd-frontent
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># 方式2:先dry-run生成yaml，然后修改后再apply</span>
</span></span><span style="display:flex;"><span>kubectl create deployment --image httpd:2.4-alpine --replicas <span style="color:#ff0;font-weight:bold">3</span> --dry-run=client httpd-frontent -o yaml &gt; httpd-deployment.yaml
</span></span><span style="display:flex;"><span>kubectl apply -f httpd-deployment.yaml
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># 删除deployment</span>
</span></span><span style="display:flex;"><span>k delete deploy &lt;deployment-name&gt;
</span></span></code></pre></div><blockquote>
<p>一些例子</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#007f7f"># 指定namespace创建deployment</span>
</span></span><span style="display:flex;"><span>kubectl create deployment redis-deploy -n dev-ns --image redis --replicas <span style="color:#ff0;font-weight:bold">2</span>
</span></span></code></pre></div><h3 id="namespace">Namespace<a hidden class="anchor" aria-hidden="true" href="#namespace">#</a></h3>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#007f7f"># 列出所有namespace</span>
</span></span><span style="display:flex;"><span>k get namespaces
</span></span><span style="display:flex;"><span>k get ns
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># 获取环境中namespace个数</span>
</span></span><span style="display:flex;"><span>k get ns --no-headers | wc -l
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># 列出特定namespace中的pods</span>
</span></span><span style="display:flex;"><span>k get pods -n &lt;namespace-name&gt;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># 获取所有namespace中的pods</span>
</span></span><span style="display:flex;"><span>k get pods --all-namespaces
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># 在特定namespace中创建pod</span>
</span></span><span style="display:flex;"><span>k run redis --image=redis  -n finance
</span></span><span style="display:flex;"><span>k run redis --image=redis --dry-run=client -n finance -o yaml
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># 列出特定namespace中的service</span>
</span></span><span style="display:flex;"><span>k get service -n &lt;namespace-name&gt;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># 创建一个新的namespace</span>
</span></span><span style="display:flex;"><span>k create namespace &lt;namespace-name&gt;
</span></span></code></pre></div><p>备注：</p>
<ul>
<li>service的DNS解析策略
<ul>
<li>同namespace，可以直接用service的名字</li>
<li>不同namesapce，需要加上namespace的后缀，例如
<ul>
<li>db-service.dev</li>
<li>db-service.dev.svc.cluster.local</li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id="service">Service<a hidden class="anchor" aria-hidden="true" href="#service">#</a></h3>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#007f7f"># 列出所有services</span>
</span></span><span style="display:flex;"><span>k get services
</span></span><span style="display:flex;"><span>k get svc
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># 查看特定service详情</span>
</span></span><span style="display:flex;"><span>k describe svc &lt;service-name&gt;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># 创建service，使用类似下民的yaml创建</span>
</span></span><span style="display:flex;"><span>k apply -f service-definition.yaml
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span><span style="font-weight:bold">apiVersion</span>: v1
</span></span><span style="display:flex;"><span><span style="font-weight:bold">kind</span>: Service
</span></span><span style="display:flex;"><span><span style="font-weight:bold">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="font-weight:bold">name</span>: webapp-service 
</span></span><span style="display:flex;"><span>  <span style="font-weight:bold">namespace</span>: default
</span></span><span style="display:flex;"><span><span style="font-weight:bold">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="font-weight:bold">ports</span>: 
</span></span><span style="display:flex;"><span>  - <span style="font-weight:bold">nodePort</span>: <span style="color:#ff0;font-weight:bold">30080</span> 
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">port</span>: <span style="color:#ff0;font-weight:bold">8080</span>
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">targetPort</span>: <span style="color:#ff0;font-weight:bold">8080</span> 
</span></span><span style="display:flex;"><span>  <span style="font-weight:bold">selector</span>:
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">name</span>:  simple-webapp
</span></span><span style="display:flex;"><span>  <span style="font-weight:bold">type</span>: NodePort
</span></span></code></pre></div><h3 id="node">Node<a hidden class="anchor" aria-hidden="true" href="#node">#</a></h3>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#007f7f"># 获取集群中所有node的信息</span>
</span></span><span style="display:flex;"><span>kubectl get nodes
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># 查看节点详情</span>
</span></span><span style="display:flex;"><span>k describe node &lt;node-name&gt;
</span></span></code></pre></div><hr>
<h2 id="调度部分">调度部分<a hidden class="anchor" aria-hidden="true" href="#调度部分">#</a></h2>
<blockquote>
<p>通过指定<code>nodeName</code>指定节点部署</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span><span style="font-weight:bold">apiVersion</span>: v1
</span></span><span style="display:flex;"><span><span style="font-weight:bold">kind</span>: Pod
</span></span><span style="display:flex;"><span><span style="font-weight:bold">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="font-weight:bold">name</span>: nginx
</span></span><span style="display:flex;"><span><span style="font-weight:bold">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="font-weight:bold">nodeName</span>: node01
</span></span><span style="display:flex;"><span>  <span style="font-weight:bold">containers</span>:
</span></span><span style="display:flex;"><span>  -  <span style="font-weight:bold">image</span>: nginx
</span></span><span style="display:flex;"><span>     <span style="font-weight:bold">name</span>: nginx
</span></span></code></pre></div><blockquote>
<p>Taint和Tolerance</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#007f7f"># 为节点node01添加taint，效果是NoSchedule</span>
</span></span><span style="display:flex;"><span>k taint node node01 spary=mortein:NoSchedule
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># 为节点node01移除key是spary的taint</span>
</span></span><span style="display:flex;"><span>k taint node node01 spary-
</span></span></code></pre></div><blockquote>
<p>创建可以容忍特定taint的pod</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span><span style="font-weight:bold">apiVersion</span>: v1
</span></span><span style="display:flex;"><span><span style="font-weight:bold">kind</span>: Pod
</span></span><span style="display:flex;"><span><span style="font-weight:bold">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="font-weight:bold">name</span>: bee
</span></span><span style="display:flex;"><span><span style="font-weight:bold">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="font-weight:bold">containers</span>:
</span></span><span style="display:flex;"><span>  - <span style="font-weight:bold">image</span>: nginx
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">name</span>: bee
</span></span><span style="display:flex;"><span>  <span style="font-weight:bold">tolerations</span>:
</span></span><span style="display:flex;"><span>  - <span style="font-weight:bold">key</span>: spray
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">value</span>: mortein
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">effect</span>: NoSchedule
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">operator</span>: Equal
</span></span></code></pre></div><blockquote>
<p>Label</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#007f7f"># 为节点添加lable color=blue</span>
</span></span><span style="display:flex;"><span>kubectl label node node01 color=blue
</span></span></code></pre></div><blockquote>
<p>使用label实现一个deployment中的pod调度亲和</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span><span style="font-weight:bold">apiVersion</span>: apps/v1
</span></span><span style="display:flex;"><span><span style="font-weight:bold">kind</span>: Deployment
</span></span><span style="display:flex;"><span><span style="font-weight:bold">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="font-weight:bold">name</span>: blue
</span></span><span style="display:flex;"><span><span style="font-weight:bold">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="font-weight:bold">replicas</span>: <span style="color:#ff0;font-weight:bold">3</span>
</span></span><span style="display:flex;"><span>  <span style="font-weight:bold">selector</span>:
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">matchLabels</span>:
</span></span><span style="display:flex;"><span>      <span style="font-weight:bold">run</span>: nginx
</span></span><span style="display:flex;"><span>  <span style="font-weight:bold">template</span>:
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">metadata</span>:
</span></span><span style="display:flex;"><span>      <span style="font-weight:bold">labels</span>:
</span></span><span style="display:flex;"><span>        <span style="font-weight:bold">run</span>: nginx
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">spec</span>:
</span></span><span style="display:flex;"><span>      <span style="font-weight:bold">containers</span>:
</span></span><span style="display:flex;"><span>      - <span style="font-weight:bold">image</span>: nginx
</span></span><span style="display:flex;"><span>        <span style="font-weight:bold">imagePullPolicy</span>: Always
</span></span><span style="display:flex;"><span>        <span style="font-weight:bold">name</span>: nginx
</span></span><span style="display:flex;"><span>      <span style="font-weight:bold">affinity</span>:
</span></span><span style="display:flex;"><span>        <span style="font-weight:bold">nodeAffinity</span>:
</span></span><span style="display:flex;"><span>          <span style="font-weight:bold">requiredDuringSchedulingIgnoredDuringExecution</span>:
</span></span><span style="display:flex;"><span>            <span style="font-weight:bold">nodeSelectorTerms</span>:
</span></span><span style="display:flex;"><span>            - <span style="font-weight:bold">matchExpressions</span>:
</span></span><span style="display:flex;"><span>              - <span style="font-weight:bold">key</span>: color
</span></span><span style="display:flex;"><span>                <span style="font-weight:bold">operator</span>: In
</span></span><span style="display:flex;"><span>                <span style="font-weight:bold">values</span>:
</span></span><span style="display:flex;"><span>                - blue
</span></span></code></pre></div><blockquote>
<p>遇到pod定义的资源不足以运行</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>kubectl get pod elephant -o yaml &gt; ele.yaml
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># 编辑资源request后</span>
</span></span><span style="display:flex;"><span>kubectl replace -f ele.yaml --force
</span></span></code></pre></div><blockquote>
<p>pod通过schedulerName指定调度器</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span><span style="font-weight:bold">apiVersion</span>: v1 
</span></span><span style="display:flex;"><span><span style="font-weight:bold">kind</span>: Pod 
</span></span><span style="display:flex;"><span><span style="font-weight:bold">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="font-weight:bold">name</span>: nginx 
</span></span><span style="display:flex;"><span><span style="font-weight:bold">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="font-weight:bold">schedulerName</span>: my-scheduler
</span></span><span style="display:flex;"><span>  <span style="font-weight:bold">containers</span>:
</span></span><span style="display:flex;"><span>  - <span style="font-weight:bold">image</span>: nginx
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">name</span>: nginx
</span></span></code></pre></div><h2 id="度量和日志metric--log">度量和日志Metric &amp; Log<a hidden class="anchor" aria-hidden="true" href="#度量和日志metric--log">#</a></h2>
<h3 id="metrics">Metrics<a hidden class="anchor" aria-hidden="true" href="#metrics">#</a></h3>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#007f7f"># Metrics度量</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>git clone https://github.com/kodekloudhub/kubernetes-metrics-server.git
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">cd</span> kubernetes-metrics-server/
</span></span><span style="display:flex;"><span>kubectl create -f .
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># wait a minute</span>
</span></span><span style="display:flex;"><span>kubectl top node
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># cpu占用最高的节点</span>
</span></span><span style="display:flex;"><span>kubectl top node --sort-by=<span style="color:#0ff;font-weight:bold">&#39;cpu&#39;</span> --no-headers | head -1 
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># 内存占用最高的节点</span>
</span></span><span style="display:flex;"><span>kubectl top node --sort-by=<span style="color:#0ff;font-weight:bold">&#39;memory&#39;</span> --no-headers | head -1
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># 内存占用最多的pod</span>
</span></span><span style="display:flex;"><span>kubectl top pod --sort-by=<span style="color:#0ff;font-weight:bold">&#39;memory&#39;</span> --no-headers | head -1
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># 内存占用最少的pod</span>
</span></span><span style="display:flex;"><span>kubectl top pod --sort-by=<span style="color:#0ff;font-weight:bold">&#39;memory&#39;</span> --no-headers | tail -1
</span></span></code></pre></div><h3 id="log">Log<a hidden class="anchor" aria-hidden="true" href="#log">#</a></h3>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#007f7f"># 查看pod日志</span>
</span></span><span style="display:flex;"><span>kubectl logs &lt;pod-name&gt;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># 指定pod中容器查看日志（一个pod可以有多个container）</span>
</span></span><span style="display:flex;"><span>kubectl logs &lt;pod-name&gt; -c &lt;container-name&gt;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># 登入pod中指定的容器</span>
</span></span><span style="display:flex;"><span>kubectl <span style="color:#fff;font-weight:bold">exec</span> -it &lt;pod-name&gt; -c &lt;container-name&gt; -- /bin/bash
</span></span></code></pre></div><h2 id="应用生命周期管理">应用生命周期管理<a hidden class="anchor" aria-hidden="true" href="#应用生命周期管理">#</a></h2>
<h3 id="更新deployment版本">更新deployment版本<a hidden class="anchor" aria-hidden="true" href="#更新deployment版本">#</a></h3>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#007f7f"># 查看deployment的策略</span>
</span></span><span style="display:flex;"><span>k describe deploy &lt;deployment-name&gt; | grep StrategyType
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># RollingUpdate意味着一次只更新部分pod</span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># Recreate意味着同时终止pod并重新创建</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>k describe deploy &lt;deployment-name&gt; | grep RollingUpdateStrategy
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># 25% max unavailable, 25% max surge意味着最多可以同时终止25%的pod</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># 更新deployment的镜像</span>
</span></span><span style="display:flex;"><span>k edit deploy &lt;deployment-name&gt;
</span></span></code></pre></div><h3 id="命令行">命令行<a hidden class="anchor" aria-hidden="true" href="#命令行">#</a></h3>
<blockquote>
<p>指定容器命令行</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="font-weight:bold">apiVersion</span>: v1 
</span></span><span style="display:flex;"><span><span style="font-weight:bold">kind</span>: Pod 
</span></span><span style="display:flex;"><span><span style="font-weight:bold">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="font-weight:bold">name</span>: ubuntu-sleeper-2 
</span></span><span style="display:flex;"><span><span style="font-weight:bold">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="font-weight:bold">containers</span>:
</span></span><span style="display:flex;"><span>  - <span style="font-weight:bold">name</span>: ubuntu
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">image</span>: ubuntu
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">command</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#0ff;font-weight:bold">&#34;sleep&#34;</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#0ff;font-weight:bold">&#34;5000&#34;</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="font-weight:bold">apiVersion</span>: v1 
</span></span><span style="display:flex;"><span><span style="font-weight:bold">kind</span>: Pod 
</span></span><span style="display:flex;"><span><span style="font-weight:bold">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="font-weight:bold">name</span>: webapp-green
</span></span><span style="display:flex;"><span>  <span style="font-weight:bold">labels</span>:
</span></span><span style="display:flex;"><span>      <span style="font-weight:bold">name</span>: webapp-green 
</span></span><span style="display:flex;"><span><span style="font-weight:bold">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="font-weight:bold">containers</span>:
</span></span><span style="display:flex;"><span>  - <span style="font-weight:bold">name</span>: simple-webapp
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">image</span>: kodekloud/webapp-color
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">command</span>: [<span style="color:#0ff;font-weight:bold">&#34;python&#34;</span>, <span style="color:#0ff;font-weight:bold">&#34;app.py&#34;</span>]
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">args</span>: [<span style="color:#0ff;font-weight:bold">&#34;--color&#34;</span>, <span style="color:#0ff;font-weight:bold">&#34;pink&#34;</span>]
</span></span></code></pre></div><h3 id="secret">Secret<a hidden class="anchor" aria-hidden="true" href="#secret">#</a></h3>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#007f7f"># 列出secrets</span>
</span></span><span style="display:flex;"><span>k get secrets
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># 查看secret详情</span>
</span></span><span style="display:flex;"><span>k describe secrets &lt;secret-name&gt;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># 创建secret，名为db-secret</span>
</span></span><span style="display:flex;"><span>kubectl create secret generic db-secret --from-literal=DB_Host=sql01 --from-literal=DB_User=root
</span></span></code></pre></div><blockquote>
<p>pod使用secret</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span><span style="font-weight:bold">apiVersion</span>: v1 
</span></span><span style="display:flex;"><span><span style="font-weight:bold">kind</span>: Pod 
</span></span><span style="display:flex;"><span><span style="font-weight:bold">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="font-weight:bold">labels</span>:
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">name</span>: webapp-pod
</span></span><span style="display:flex;"><span>  <span style="font-weight:bold">name</span>: webapp-pod
</span></span><span style="display:flex;"><span>  <span style="font-weight:bold">namespace</span>: default 
</span></span><span style="display:flex;"><span><span style="font-weight:bold">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="font-weight:bold">containers</span>:
</span></span><span style="display:flex;"><span>  - <span style="font-weight:bold">image</span>: kodekloud/simple-webapp-mysql
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">imagePullPolicy</span>: Always
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">name</span>: webapp
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">envFrom</span>:
</span></span><span style="display:flex;"><span>    - <span style="font-weight:bold">secretRef</span>:
</span></span><span style="display:flex;"><span>        <span style="font-weight:bold">name</span>: db-secret
</span></span></code></pre></div><h3 id="multi-container">Multi Container<a hidden class="anchor" aria-hidden="true" href="#multi-container">#</a></h3>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="font-weight:bold">apiVersion</span>: v1
</span></span><span style="display:flex;"><span><span style="font-weight:bold">kind</span>: Pod
</span></span><span style="display:flex;"><span><span style="font-weight:bold">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="font-weight:bold">creationTimestamp</span>: <span style="color:#fff;font-weight:bold">null</span>
</span></span><span style="display:flex;"><span>  <span style="font-weight:bold">labels</span>:
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">run</span>: yellow
</span></span><span style="display:flex;"><span>  <span style="font-weight:bold">name</span>: yellow
</span></span><span style="display:flex;"><span><span style="font-weight:bold">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="font-weight:bold">containers</span>:
</span></span><span style="display:flex;"><span>  - <span style="font-weight:bold">image</span>: busybox
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">name</span>: lemon
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">resources</span>: {}
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">command</span>: [<span style="color:#0ff;font-weight:bold">&#34;sleep&#34;</span>, <span style="color:#0ff;font-weight:bold">&#34;1000&#34;</span>]
</span></span><span style="display:flex;"><span>  - <span style="font-weight:bold">image</span>: redis
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">name</span>: gold
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">resources</span>: {}
</span></span><span style="display:flex;"><span>  <span style="font-weight:bold">dnsPolicy</span>: ClusterFirst
</span></span><span style="display:flex;"><span>  <span style="font-weight:bold">restartPolicy</span>: Always
</span></span><span style="display:flex;"><span><span style="font-weight:bold">status</span>: {}
</span></span></code></pre></div><blockquote>
<p>多容器共享文件系统</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span><span style="font-weight:bold">apiVersion</span>: v1
</span></span><span style="display:flex;"><span><span style="font-weight:bold">kind</span>: Pod
</span></span><span style="display:flex;"><span><span style="font-weight:bold">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="font-weight:bold">name</span>: app
</span></span><span style="display:flex;"><span>  <span style="font-weight:bold">namespace</span>: elastic-stack
</span></span><span style="display:flex;"><span>  <span style="font-weight:bold">labels</span>:
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">name</span>: app
</span></span><span style="display:flex;"><span><span style="font-weight:bold">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="font-weight:bold">containers</span>:
</span></span><span style="display:flex;"><span>  - <span style="font-weight:bold">name</span>: app
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">image</span>: kodekloud/event-simulator
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">volumeMounts</span>:
</span></span><span style="display:flex;"><span>    - <span style="font-weight:bold">mountPath</span>: /log
</span></span><span style="display:flex;"><span>      <span style="font-weight:bold">name</span>: log-volume
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  - <span style="font-weight:bold">name</span>: sidecar
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">image</span>: kodekloud/filebeat-configured
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">volumeMounts</span>:
</span></span><span style="display:flex;"><span>    - <span style="font-weight:bold">mountPath</span>: /var/log/event-simulator/
</span></span><span style="display:flex;"><span>      <span style="font-weight:bold">name</span>: log-volume
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="font-weight:bold">volumes</span>:
</span></span><span style="display:flex;"><span>  - <span style="font-weight:bold">name</span>: log-volume
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">hostPath</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#007f7f"># directory location on host</span>
</span></span><span style="display:flex;"><span>      <span style="font-weight:bold">path</span>: /var/log/webapp
</span></span><span style="display:flex;"><span>      <span style="color:#007f7f"># this field is optional</span>
</span></span><span style="display:flex;"><span>      <span style="font-weight:bold">type</span>: DirectoryOrCreate
</span></span></code></pre></div><h3 id="init-container">Init Container<a hidden class="anchor" aria-hidden="true" href="#init-container">#</a></h3>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span><span style="font-weight:bold">apiVersion</span>: v1
</span></span><span style="display:flex;"><span><span style="font-weight:bold">kind</span>: Pod
</span></span><span style="display:flex;"><span><span style="font-weight:bold">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="font-weight:bold">name</span>: red
</span></span><span style="display:flex;"><span>  <span style="font-weight:bold">namespace</span>: default
</span></span><span style="display:flex;"><span><span style="font-weight:bold">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="font-weight:bold">containers</span>:
</span></span><span style="display:flex;"><span>  - <span style="font-weight:bold">command</span>:
</span></span><span style="display:flex;"><span>    - sh
</span></span><span style="display:flex;"><span>    - -c
</span></span><span style="display:flex;"><span>    - echo The app is running! &amp;&amp; sleep 3600
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">image</span>: busybox:1.28
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">name</span>: red-container
</span></span><span style="display:flex;"><span>  <span style="font-weight:bold">initContainers</span>:
</span></span><span style="display:flex;"><span>  - <span style="font-weight:bold">image</span>: busybox
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">name</span>: red-initcontainer
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">command</span>: 
</span></span><span style="display:flex;"><span>      - <span style="color:#0ff;font-weight:bold">&#34;sleep&#34;</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#0ff;font-weight:bold">&#34;20&#34;</span>
</span></span></code></pre></div><h2 id="cluster-维护">Cluster 维护<a hidden class="anchor" aria-hidden="true" href="#cluster-维护">#</a></h2>
<h3 id="升级os">升级OS<a hidden class="anchor" aria-hidden="true" href="#升级os">#</a></h3>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#007f7f"># 升级node01，首先清空node01上的pod</span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># 效果 pod evicted, node drained</span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># drain会默认将node cordon，即不可调度</span>
</span></span><span style="display:flex;"><span>kubectl drain node01 --ignore-daemonsets
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># node01维护完毕后，将node01设置为可调度</span>
</span></span><span style="display:flex;"><span>kubectl uncordon node01
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># NOTE: drain只能处理replicaset，单独的pod需要强制执行</span>
</span></span><span style="display:flex;"><span>k drain node01 --ignore-daemonsets --force
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># 对不属于replicaset的pod，将会永久丢失</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># 将node01设置不可调度</span>
</span></span><span style="display:flex;"><span>kubectl cordon node01
</span></span></code></pre></div><h3 id="升级k8s">升级K8S<a hidden class="anchor" aria-hidden="true" href="#升级k8s">#</a></h3>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#007f7f"># 查看控制节点版本</span>
</span></span><span style="display:flex;"><span>k version --short
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># 查看node版本，当前1.26</span>
</span></span><span style="display:flex;"><span>k get nodes
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># 查看远端可升级版本</span>
</span></span><span style="display:flex;"><span>kubeadm upgrade plan
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># 有两个node分别是controlplane和node01</span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># 先清空controlplane的pod</span>
</span></span><span style="display:flex;"><span>kubectl drain controlplane --ignore-daemonsets
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># 开始升级controlplane</span>
</span></span><span style="display:flex;"><span>apt update
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># 首先升级kubeadm</span>
</span></span><span style="display:flex;"><span>apt-get install kubeadm=1.27.0-00
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>kubeadm upgrade apply v1.27.0
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># 升级命令行</span>
</span></span><span style="display:flex;"><span>apt-get install kubelet=1.27.0-00 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># 重启服务</span>
</span></span><span style="display:flex;"><span>systemctl daemon-reload
</span></span><span style="display:flex;"><span>systemctl restart kubelet
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># controlplane升级完毕，标记为可调度</span>
</span></span><span style="display:flex;"><span>kubectl uncordon controlplane
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># 需要解除controlplane的taint</span>
</span></span><span style="display:flex;"><span>k drain node01
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># 接着ssh登录到node01上，升级node01</span>
</span></span><span style="display:flex;"><span>apt-get update
</span></span><span style="display:flex;"><span>apt-get install kubeadm=1.27.0-00
</span></span><span style="display:flex;"><span>kubeadm upgrade node
</span></span><span style="display:flex;"><span>apt-get install kubelet=1.27.0-00 
</span></span><span style="display:flex;"><span>systemctl daemon-reload
</span></span><span style="display:flex;"><span>systemctl restart kubelet
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># 最后让node01可调度</span>
</span></span><span style="display:flex;"><span>kubectl uncordon node01
</span></span></code></pre></div><h3 id="备份恢复">备份恢复<a hidden class="anchor" aria-hidden="true" href="#备份恢复">#</a></h3>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#007f7f"># 查看etcd版本（查看日志或者镜像）</span>
</span></span><span style="display:flex;"><span>kubectl -n kube-system logs etcd-controlplane | grep -i <span style="color:#0ff;font-weight:bold">&#39;etcd-version&#39;</span>
</span></span><span style="display:flex;"><span>kubectl -n kube-system describe pod etcd-controlplane | grep Image:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># 查看etcd的endpoint</span>
</span></span><span style="display:flex;"><span>kubectl -n kube-system describe pod etcd-controlplane | grep <span style="color:#0ff;font-weight:bold">&#39;\--listen-client-urls&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># 查看etcd的cert文件</span>
</span></span><span style="display:flex;"><span>kubectl -n kube-system describe pod etcd-controlplane | grep <span style="color:#0ff;font-weight:bold">&#39;\--cert-file&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># 查看etcd的ca cert文件</span>
</span></span><span style="display:flex;"><span>kubectl -n kube-system describe pod etcd-controlplane | grep <span style="color:#0ff;font-weight:bold">&#39;\--trusted-ca-file&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># 在维护或者对环境做操作前先备份etcd</span>
</span></span><span style="display:flex;"><span>ETCDCTL_API=<span style="color:#ff0;font-weight:bold">3</span> etcdctl --endpoints=https://[127.0.0.1]:2379 <span style="color:#0ff;font-weight:bold">\
</span></span></span><span style="display:flex;"><span><span style="color:#0ff;font-weight:bold"></span>--cacert=/etc/kubernetes/pki/etcd/ca.crt <span style="color:#0ff;font-weight:bold">\
</span></span></span><span style="display:flex;"><span><span style="color:#0ff;font-weight:bold"></span>--cert=/etc/kubernetes/pki/etcd/server.crt <span style="color:#0ff;font-weight:bold">\
</span></span></span><span style="display:flex;"><span><span style="color:#0ff;font-weight:bold"></span>--key=/etc/kubernetes/pki/etcd/server.key <span style="color:#0ff;font-weight:bold">\
</span></span></span><span style="display:flex;"><span><span style="color:#0ff;font-weight:bold"></span>snapshot save /opt/snapshot-pre-boot.db
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># 在维护窗口期间丢失了一些pod或deployment，需要恢复</span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># 首先将etcd快照恢复到一个新的目录</span>
</span></span><span style="display:flex;"><span>ETCDCTL_API=<span style="color:#ff0;font-weight:bold">3</span> etcdctl  --data-dir /var/lib/etcd-from-backup <span style="color:#0ff;font-weight:bold">\
</span></span></span><span style="display:flex;"><span><span style="color:#0ff;font-weight:bold"></span>snapshot restore /opt/snapshot-pre-boot.db
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># 修改etcd这个staticpod的yaml，指向恢复的data-dir</span>
</span></span><span style="display:flex;"><span>vim /etc/kubernetes/manifests/etcd.yaml
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># 修改成如下，将etcd-data这个volume指向hostPath: /var/lib/etcd-from-backup</span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">#  volumes:</span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">#  - hostPath:</span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">#      path: /var/lib/etcd-from-backup</span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">#      type: DirectoryOrCreate</span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">#    name: etcd-data</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># 更新yaml后，etcd会自动重建，若etcd一直PENDING，手动删除触发重启</span>
</span></span><span style="display:flex;"><span>kubectl delete pod -n kube-system etcd-controlplane
</span></span></code></pre></div><blockquote>
<p>多cluster</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#007f7f"># 查看cluster信息</span>
</span></span><span style="display:flex;"><span>kubectl config view
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># 或者</span>
</span></span><span style="display:flex;"><span>kubectl config get-clusters
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># 查看当前的cluster</span>
</span></span><span style="display:flex;"><span>kubectl config view | grep current-context
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># 切换cluster</span>
</span></span><span style="display:flex;"><span>kubectl config use-context cluster2
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># Type1: Stacked ETCD Topology</span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># 如下命令可以在cluster中查找到etcd的pod</span>
</span></span><span style="display:flex;"><span>kubectl get pods -n kube-system | grep etcd
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>kubectl -n kube-system describe pod etcd-cluster1-controlplane
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># Type2: External ETCD</span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># cluster内没有etcd的pod，kube-apiserver直接指向一个外部的etcd endpoint</span>
</span></span><span style="display:flex;"><span>ps -aux | grep etcd
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># 查看ETCD集群的members</span>
</span></span><span style="display:flex;"><span>ETCDCTL_API=<span style="color:#ff0;font-weight:bold">3</span> etcdctl <span style="color:#0ff;font-weight:bold">\
</span></span></span><span style="display:flex;"><span><span style="color:#0ff;font-weight:bold"></span> --endpoints=https://127.0.0.1:2379 <span style="color:#0ff;font-weight:bold">\
</span></span></span><span style="display:flex;"><span><span style="color:#0ff;font-weight:bold"></span> --cacert=/etc/etcd/pki/ca.pem <span style="color:#0ff;font-weight:bold">\
</span></span></span><span style="display:flex;"><span><span style="color:#0ff;font-weight:bold"></span> --cert=/etc/etcd/pki/etcd.pem <span style="color:#0ff;font-weight:bold">\
</span></span></span><span style="display:flex;"><span><span style="color:#0ff;font-weight:bold"></span> --key=/etc/etcd/pki/etcd-key.pem <span style="color:#0ff;font-weight:bold">\
</span></span></span><span style="display:flex;"><span><span style="color:#0ff;font-weight:bold"></span>  member list
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># 备份Stacked ETCD</span>
</span></span><span style="display:flex;"><span>kubectl config use-context cluster1
</span></span><span style="display:flex;"><span>kubectl describe pods -n kube-system etcd-cluster1-controlplane  | grep advertise-client-urls
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># --advertise-client-urls=https://10.1.218.16:2379</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>kubectl describe  pods -n kube-system etcd-cluster1-controlplane  | grep pki
</span></span><span style="display:flex;"><span><span style="color:#007f7f">#      --cert-file=/etc/kubernetes/pki/etcd/server.crt</span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">#      --key-file=/etc/kubernetes/pki/etcd/server.key</span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">#      --peer-cert-file=/etc/kubernetes/pki/etcd/peer.crt</span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">#      --peer-key-file=/etc/kubernetes/pki/etcd/peer.key</span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">#      --peer-trusted-ca-file=/etc/kubernetes/pki/etcd/ca.crt</span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">#      --trusted-ca-file=/etc/kubernetes/pki/etcd/ca.crt</span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">#      /etc/kubernetes/pki/etcd from etcd-certs (rw)</span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">#    Path:          /etc/kubernetes/pki/etcd</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># 登录到etcd pod所在的节点</span>
</span></span><span style="display:flex;"><span>ETCDCTL_API=<span style="color:#ff0;font-weight:bold">3</span> etcdctl --endpoints=https://10.1.220.8:2379 --cacert=/etc/kubernetes/pki/etcd/ca.crt --cert=/etc/kubernetes/pki/etcd/server.crt --key=/etc/kubernetes/pki/etcd/server.key snapshot save /opt/cluster1.db
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># 恢复External ETCD</span>
</span></span><span style="display:flex;"><span>ETCDCTL_API=<span style="color:#ff0;font-weight:bold">3</span> etcdctl --endpoints=https://127.0.0.1:2379 --cacert=/etc/etcd/pki/ca.pem --cert=/etc/etcd/pki/etcd.pem --key=/etc/etcd/pki/etcd-key.pem snapshot restore /root/cluster2.db --data-dir /var/lib/etcd-data-new
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>systemctl status etcd.service
</span></span><span style="display:flex;"><span>vim /etc/systemd/system/etcd.service
</span></span><span style="display:flex;"><span>systemctl daemon-reload 
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># service的User是etcd，修改文件权限</span>
</span></span><span style="display:flex;"><span>chown -R etcd:etcd /var/lib/etcd-data-new
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>systemctl restart etcd
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># 推荐重启控制平面的pod(kube-scheduler, kube-controller-manager, kubelet)</span>
</span></span></code></pre></div><h2 id="安全security">安全Security<a hidden class="anchor" aria-hidden="true" href="#安全security">#</a></h2>
<h3 id="tls和证书介绍">TLS和证书介绍<a hidden class="anchor" aria-hidden="true" href="#tls和证书介绍">#</a></h3>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>Certificate:
</span></span><span style="display:flex;"><span>    Data:
</span></span><span style="display:flex;"><span>        Version: <span style="color:#ff0;font-weight:bold">3</span> (0x2)
</span></span><span style="display:flex;"><span>        Serial Number: <span style="color:#ff0;font-weight:bold">3478545236123834268</span> (0x304646764e49d79c)
</span></span><span style="display:flex;"><span>        Signature Algorithm: sha256WithRSAEncryption
</span></span><span style="display:flex;"><span>        Issuer: CN = kubernetes
</span></span><span style="display:flex;"><span>        Validity
</span></span><span style="display:flex;"><span>            Not Before: Dec  <span style="color:#ff0;font-weight:bold">1</span> 12:24:30 <span style="color:#ff0;font-weight:bold">2023</span> GMT
</span></span><span style="display:flex;"><span>            Not After : Nov <span style="color:#ff0;font-weight:bold">30</span> 12:24:30 <span style="color:#ff0;font-weight:bold">2024</span> GMT
</span></span><span style="display:flex;"><span>        Subject: CN = kube-apiserver
</span></span><span style="display:flex;"><span>        Subject Public Key Info:
</span></span><span style="display:flex;"><span>            Public Key Algorithm: rsaEncryption
</span></span><span style="display:flex;"><span>                RSA Public-Key: (<span style="color:#ff0;font-weight:bold">2048</span> bit)
</span></span><span style="display:flex;"><span>                Modulus:
</span></span><span style="display:flex;"><span>                    00:ce:fc:11:8c:a0:2c:83:2d:20:b2:47:83:dc:38:
</span></span><span style="display:flex;"><span>                    ec:3f:7f:b5:9a:09:c8:a5:7a:16:7a:c7:2d:1d:62:
</span></span><span style="display:flex;"><span>                    ae:a6:02:7e:d0:be:6a:c6:fd:71:d3:1a:a8:fd:9b:
</span></span><span style="display:flex;"><span>                    4d:11:45:f1:21:aa:20:a1:9d:4e:d7:be:f1:22:25:
</span></span><span style="display:flex;"><span>                    a9:82:52:87:f8:e5:ce:d5:30:e6:1f:99:a5:13:56:
</span></span><span style="display:flex;"><span>                    e1:38:e3:68:f5:54:de:67:e1:d1:7e:7a:30:12:6c:
</span></span><span style="display:flex;"><span>                    48:fd:d9:89:95:07:2a:51:8e:d8:fa:0c:02:79:54:
</span></span><span style="display:flex;"><span>                    c4:8f:16:42:b1:f4:a9:0e:ac:83:20:f7:d4:eb:c6:
</span></span><span style="display:flex;"><span>                    8f:e2:74:2a:03:c7:2a:b6:d9:c4:ea:28:3c:b8:14:
</span></span><span style="display:flex;"><span>                    3f:dd:f0:d9:d9:b2:1f:6c:89:93:0b:37:cd:1b:57:
</span></span><span style="display:flex;"><span>                    1c:8e:53:fe:d1:40:f5:80:ee:2d:8d:c6:ce:c2:39:
</span></span><span style="display:flex;"><span>                    03:d6:c7:aa:61:cb:b5:8d:5c:d6:73:99:ef:c8:6b:
</span></span><span style="display:flex;"><span>                    87:ac:0e:3b:59:bb:ec:e2:c5:04:54:4b:ad:d5:da:
</span></span><span style="display:flex;"><span>                    48:16:f5:15:0c:bb:29:fe:13:c7:ed:29:dc:bc:01:
</span></span><span style="display:flex;"><span>                    b5:ac:dd:84:c9:01:e1:fc:40:1e:8f:c5:4a:82:c5:
</span></span><span style="display:flex;"><span>                    69:3a:4a:54:b3:22:c6:4b:61:78:54:59:e9:21:ef:
</span></span><span style="display:flex;"><span>                    a9:5d:cf:a1:b4:c8:f2:18:4e:6a:03:d3:44:3c:be:
</span></span><span style="display:flex;"><span>                    9e:d9
</span></span><span style="display:flex;"><span>                Exponent: <span style="color:#ff0;font-weight:bold">65537</span> (0x10001)
</span></span><span style="display:flex;"><span>        X509v3 extensions:
</span></span><span style="display:flex;"><span>            X509v3 Key Usage: critical
</span></span><span style="display:flex;"><span>                Digital Signature, Key Encipherment
</span></span><span style="display:flex;"><span>            X509v3 Extended Key Usage: 
</span></span><span style="display:flex;"><span>                TLS Web Server Authentication
</span></span><span style="display:flex;"><span>            X509v3 Basic Constraints: critical
</span></span><span style="display:flex;"><span>                CA:FALSE
</span></span><span style="display:flex;"><span>            X509v3 Authority Key Identifier: 
</span></span><span style="display:flex;"><span>                keyid:27:89:3A:1C:08:4F:74:4E:60:20:1A:44:E0:47:AC:D6:F9:05:93:E5
</span></span><span style="display:flex;"><span>            X509v3 Subject Alternative Name: 
</span></span><span style="display:flex;"><span>                DNS:controlplane, DNS:kubernetes, DNS:kubernetes.default, DNS:kubernetes.default.svc, DNS:kubernetes.default.svc.cluster.local, IP Address:10.96.0.1, IP Address:192.21.43.6
</span></span><span style="display:flex;"><span>    Signature Algorithm: sha256WithRSAEncryption
</span></span><span style="display:flex;"><span>         8e:75:b2:8e:47:5c:8f:a1:6c:c8:49:da:ef:e0:09:09:6d:cf:
</span></span><span style="display:flex;"><span>         dd💿35:f0:e2:df:b2🇩🇪b0:f0:8a:0a:4b:4b:32:7e:46:45:
</span></span><span style="display:flex;"><span>         6b:0b:52:7b:8d:ad:17:67:59:fb:7d:68:86:2b:d1:91:7d:99:
</span></span><span style="display:flex;"><span>         c8:ff:d2:17:46:a0:92:ae:3c:55:9a:e4:f5:ee:59:48:a5:2a:
</span></span><span style="display:flex;"><span>         93:4d:8d:02:ba:02:73:f6:07:36:2a:5a:99:4a:33:52:ce:36:
</span></span><span style="display:flex;"><span>         ea:44:29:19:cb:d1:6f:4a:db:1f:d9:47:7e:8c:e7:2b:6a:7f:
</span></span><span style="display:flex;"><span>         11:43:57:f1:f6:7a:19:c1:b6:ff:81:37:71:3a:f6:14:d5:63:
</span></span><span style="display:flex;"><span>         ab:9d:31:f7:bc:4c:0a:19:fb:36:d7:84:f2:1c:fd:c5:fc:8d:
</span></span><span style="display:flex;"><span>         83:b0:8f:ec:1b:9c:ae:57:4f:f1:96:f5:45:f5:c5:4e:8f:a0:
</span></span><span style="display:flex;"><span>         ac:04:97:fa:87:2c:0d:5c:83:a9:d8:94:2f:d5:64:8d:ec:13:
</span></span><span style="display:flex;"><span>         c6:b4:93:d2:29:f9:87:23:a0:90:7b:68:8c:d6:5c:fd:a3:97:
</span></span><span style="display:flex;"><span>         96:68:a7:e0:2a:22:8b:a9:d4:01:fc:f5:06:39:7f:63:6b:33:
</span></span><span style="display:flex;"><span>         8e:3f:6b:23:18:9c:c8:7c:0f:0c:c1:4c:73:3f:a3:c2:d7:ea:
</span></span><span style="display:flex;"><span>         cb:2a:a8:5d:86:a1:0d:4a:5e:12:51:ba:6c:1e:1c:20:75:d6:
</span></span><span style="display:flex;"><span>         5f:62:5f:d3
</span></span></code></pre></div><h3 id="证书查看">证书查看<a hidden class="anchor" aria-hidden="true" href="#证书查看">#</a></h3>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#007f7f"># 查看kube-api的cert文件</span>
</span></span><span style="display:flex;"><span>cat /etc/kubernetes/manifests/kube-apiserver.yaml | grep tls-cert-file
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># 查看certfile详情</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>openssl x509 -in ./apiserver.crt -text -noout
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># kube-api故障，排查问题</span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># 列出所有的容器</span>
</span></span><span style="display:flex;"><span>crictl ps -a
</span></span><span style="display:flex;"><span>crictl ps -a | grep kube-api
</span></span><span style="display:flex;"><span>crictl logs &lt;container-id&gt;
</span></span></code></pre></div><h3 id="certificatesigningrequest">CertificateSigningRequest<a hidden class="anchor" aria-hidden="true" href="#certificatesigningrequest">#</a></h3>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#007f7f"># 有签名文件akshay.csr，先base64编码</span>
</span></span><span style="display:flex;"><span>cat akshay.csr | base64 -w <span style="color:#ff0;font-weight:bold">0</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># 按照如下yaml，执行k apply创建csr</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># 查看csr，刚创建的状态是Pending</span>
</span></span><span style="display:flex;"><span>k get certificatesigningrequests
</span></span><span style="display:flex;"><span>k get csr
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># 授权，授权后状态是Approved,Issued</span>
</span></span><span style="display:flex;"><span>k certificate approve &lt;csr-name&gt;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># 拒绝 csr</span>
</span></span><span style="display:flex;"><span>kubectl certificate deny &lt;csr-name&gt;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># 删除csr</span>
</span></span><span style="display:flex;"><span>k delete csr &lt;csr-name&gt;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># 查看csr详情</span>
</span></span><span style="display:flex;"><span>k get csr &lt;csr-name&gt; -o yaml
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span><span style="font-weight:bold">apiVersion</span>: certificates.k8s.io/v1
</span></span><span style="display:flex;"><span><span style="font-weight:bold">kind</span>: CertificateSigningRequest
</span></span><span style="display:flex;"><span><span style="font-weight:bold">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="font-weight:bold">name</span>: akshay
</span></span><span style="display:flex;"><span><span style="font-weight:bold">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="font-weight:bold">groups</span>:
</span></span><span style="display:flex;"><span>  - system:authenticated
</span></span><span style="display:flex;"><span>  <span style="font-weight:bold">request</span>: &lt;Paste the base64 encoded value of the CSR file&gt;
</span></span><span style="display:flex;"><span>  <span style="font-weight:bold">signerName</span>: kubernetes.io/kube-apiserver-client
</span></span><span style="display:flex;"><span>  <span style="font-weight:bold">usages</span>:
</span></span><span style="display:flex;"><span>  - client auth
</span></span></code></pre></div><h3 id="kube-config">Kube Config<a hidden class="anchor" aria-hidden="true" href="#kube-config">#</a></h3>
<blockquote>
<p>Client-certificate（客户端证书）和client-key（客户端密钥）是在SSL/TLS通信中用于客户端身份验证的两个重要组件。</p>
<p>客户端证书是一种数字证书，用于验证客户端的身份。它包含了客户端的公钥以及与之相关联的身份信息，通常由证书颁发机构（CA）签发。客户端证书可以被服务器用来验证客户端的身份，确保通信双方的合法性和安全性。</p>
<p>客户端密钥是客户端证书中包含的私钥部分。私钥是一种加密密钥，用于对数据进行签名和解密。客户端使用私钥对数据进行签名，服务器使用客户端证书中的公钥对签名进行验证，从而确认客户端的身份。</p>
<p>在SSL/TLS通信中，客户端证书和客户端密钥通常一起使用，以确保通信的安全性和完整性。客户端证书用于验证客户端的身份，客户端密钥用于生成数字签名以进行身份验证和数据加密。</p>
</blockquote>
<p>这三个文件名后缀分别代表以下含义：</p>
<ul>
<li><code>.crt</code>：代表证书文件，包含了公钥和证书相关信息。</li>
<li><code>.csr</code>：代表证书签名请求文件，包含了公钥和一些个人信息，用于向证书颁发机构申请签名。</li>
<li><code>.key</code>：代表密钥文件，包含了与证书相关的私钥信息。</li>
</ul>
<p>这三个文件之间的关联性在于：</p>
<ol>
<li>证书签名请求文件（.csr）是用来向证书颁发机构申请签名的，其中包含了公钥和一些个人信息。</li>
<li>证书文件（.crt）是由证书颁发机构签名后的证书，包含了公钥和证书相关信息。</li>
<li>密钥文件（.key）包含了与证书相关的私钥信息，用于与证书进行配对，以进行加密和解密操作。</li>
</ol>
<p>这三个文件通常一起使用，以建立安全的通信连接和进行加密操作。</p>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#007f7f"># config默认文件路径</span>
</span></span><span style="display:flex;"><span>ls ~/.kube/config
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># 查看所有cluster</span>
</span></span><span style="display:flex;"><span>k config view
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># 指定config文件</span>
</span></span><span style="display:flex;"><span>kubectl config view --kubeconfig &lt;config-file-path&gt;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># 查看config中的current-context</span>
</span></span><span style="display:flex;"><span>kubectl config current-context --kubeconfig &lt;config-file-path&gt;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># 切换context</span>
</span></span><span style="display:flex;"><span>kubectl config --kubeconfig=&lt;config-file-path&gt; use-context &lt;new-context-name&gt;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># 将自定义的config文件替换~/.kube/config文件，即可设置为默认的config</span>
</span></span></code></pre></div><h3 id="rbac">RBAC<a hidden class="anchor" aria-hidden="true" href="#rbac">#</a></h3>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#007f7f"># 查看kube-api的authorization-mode</span>
</span></span><span style="display:flex;"><span>kubectl describe pod kube-apiserver-controlplane -n kube-system | grep mode
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># 列出roles</span>
</span></span><span style="display:flex;"><span>k get roles
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># 列出所有namespace的roles</span>
</span></span><span style="display:flex;"><span>k get roles.rbac.authorization.k8s.io --all-namespaces --no-headers 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># 查看roles详情</span>
</span></span><span style="display:flex;"><span>k describe roles &lt;role-name&gt;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># 列出rolebinding</span>
</span></span><span style="display:flex;"><span>k get rolebindings  --all-namespaces
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># 查看rolebinding详情</span>
</span></span><span style="display:flex;"><span>k describe rolebindings &lt;rolebinding-name&gt; -n kube-system
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># 查看config</span>
</span></span><span style="display:flex;"><span>k config view
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># 指定config中的用户执行kubectl命令</span>
</span></span><span style="display:flex;"><span>k get pods --as &lt;user-name&gt;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># 上述命令执行报错，用户无权限，需要创建role和rolebinding</span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># 创建一个role，名为developer</span>
</span></span><span style="display:flex;"><span>k create role developer --namespace=default --verb=list,create,delete --resource=pod --dry-run=client -o yaml
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># 创建rolebinding，将deveploer绑定到用户dev-user上</span>
</span></span><span style="display:flex;"><span>kubectl create rolebinding dev-user-binding --namespace=default --role=developer --user=dev-user
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># 编辑role的权限，编辑后无需重新binding</span>
</span></span><span style="display:flex;"><span>k edit role &lt;role-name&gt;
</span></span></code></pre></div><h3 id="cluster-role">Cluster Role<a hidden class="anchor" aria-hidden="true" href="#cluster-role">#</a></h3>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#007f7f"># 列出clusterrole</span>
</span></span><span style="display:flex;"><span>k get clusterrole
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># 列出clusterrolebinding</span>
</span></span><span style="display:flex;"><span>k get clusterrolebindings
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># 查看环境中cluster数量</span>
</span></span><span style="display:flex;"><span>k get clusterrole --no-headers | wc -l
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># 查看clusterrolebinding数量</span>
</span></span><span style="display:flex;"><span>k get clusterrolebindings.rbac.authorization.k8s.io --no-headers | wc -l
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># 查看所有与namspace无关的resource</span>
</span></span><span style="display:flex;"><span>k api-resources --namespaced=<span style="color:#fff;font-weight:bold">false</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># 查看clusterrole详情</span>
</span></span><span style="display:flex;"><span>k describe clusterrole &lt;clusterrole-name&gt;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># 查看clusterrolebinding详情</span>
</span></span><span style="display:flex;"><span>k describe clusterrolebindings.rbac.authorization.k8s.io &lt;name&gt;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># 创建一个管理node的clusterrole</span>
</span></span><span style="display:flex;"><span>k create clusterrole nodeadmin --resource=nodes --verb=get,watch,list,create,delete --dry-run=client  -o yaml
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># 创建clusterrolebinding</span>
</span></span><span style="display:flex;"><span>k create clusterrolebinding michella-binding --clusterrole nodeadmin --user=michelle  --dry-run=client -o yaml
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># 测试是否有执行权限</span>
</span></span><span style="display:flex;"><span>kubectl auth can-i list nodes --as michelle
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># 需要给michelle用户增加权限，新建存储相关的clusterrole和binding</span>
</span></span><span style="display:flex;"><span>k create clusterrole storage-admin --resource=persistentvolumes,storageclasses --verb=get,watch,list,create,delete --dry-run=client -o yaml
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>k create clusterrolebinding michelle-storage-admin --clusterrole=storage-admin --user=michelle --dry-run=client -o yaml
</span></span></code></pre></div><h3 id="service-account">Service Account<a hidden class="anchor" aria-hidden="true" href="#service-account">#</a></h3>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#007f7f"># 获取所有service account</span>
</span></span><span style="display:flex;"><span>k get serviceaccounts
</span></span><span style="display:flex;"><span>k get sa
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># 查看service account详情</span>
</span></span><span style="display:flex;"><span>k describe sa &lt;sa-name&gt;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># 查看pod的serviceaccount</span>
</span></span><span style="display:flex;"><span>k get po web-dashboard-97c9c59f6-vmw8g -o yaml | grep -i account
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># 创建一个serviceaccount</span>
</span></span><span style="display:flex;"><span>k create serviceaccount dashboard-sa
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># 用如下yaml为serviceaccount创建role和rolebinding赋予权限</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># 为dashboard-sa这个service account创建token</span>
</span></span><span style="display:flex;"><span>kubectl create token dashboard-sa
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># 编辑deployment的serviceaccount（默认是default）</span>
</span></span><span style="display:flex;"><span>k edit deployments.apps web-dashboard
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># 或者</span>
</span></span><span style="display:flex;"><span>k <span style="color:#fff;font-weight:bold">set</span> serviceaccount deploy/web-dashboard dashboard-sa
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span><span style="font-weight:bold">kind</span>: Role
</span></span><span style="display:flex;"><span><span style="font-weight:bold">apiVersion</span>: rbac.authorization.k8s.io/v1
</span></span><span style="display:flex;"><span><span style="font-weight:bold">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="font-weight:bold">namespace</span>: default
</span></span><span style="display:flex;"><span>  <span style="font-weight:bold">name</span>: pod-reader
</span></span><span style="display:flex;"><span><span style="font-weight:bold">rules</span>:
</span></span><span style="display:flex;"><span>- <span style="font-weight:bold">apiGroups</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#0ff;font-weight:bold">&#39;&#39;</span>
</span></span><span style="display:flex;"><span>  <span style="font-weight:bold">resources</span>:
</span></span><span style="display:flex;"><span>  - pods
</span></span><span style="display:flex;"><span>  <span style="font-weight:bold">verbs</span>:
</span></span><span style="display:flex;"><span>  - get
</span></span><span style="display:flex;"><span>  - watch
</span></span><span style="display:flex;"><span>  - list
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span><span style="font-weight:bold">kind</span>: RoleBinding
</span></span><span style="display:flex;"><span><span style="font-weight:bold">apiVersion</span>: rbac.authorization.k8s.io/v1
</span></span><span style="display:flex;"><span><span style="font-weight:bold">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="font-weight:bold">name</span>: read-pods
</span></span><span style="display:flex;"><span>  <span style="font-weight:bold">namespace</span>: default
</span></span><span style="display:flex;"><span><span style="font-weight:bold">subjects</span>:
</span></span><span style="display:flex;"><span>- <span style="font-weight:bold">kind</span>: ServiceAccount
</span></span><span style="display:flex;"><span>  <span style="font-weight:bold">name</span>: dashboard-sa <span style="color:#007f7f"># Name is case sensitive</span>
</span></span><span style="display:flex;"><span>  <span style="font-weight:bold">namespace</span>: default
</span></span><span style="display:flex;"><span><span style="font-weight:bold">roleRef</span>:
</span></span><span style="display:flex;"><span>  <span style="font-weight:bold">kind</span>: Role <span style="color:#007f7f">#this must be Role or ClusterRole</span>
</span></span><span style="display:flex;"><span>  <span style="font-weight:bold">name</span>: pod-reader <span style="color:#007f7f"># this must match the name of the Role or ClusterRole you wish to bind to</span>
</span></span><span style="display:flex;"><span>  <span style="font-weight:bold">apiGroup</span>: rbac.authorization.k8s.io
</span></span></code></pre></div><h3 id="image-secret">Image Secret<a hidden class="anchor" aria-hidden="true" href="#image-secret">#</a></h3>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#007f7f"># 应用使用私有仓库的镜像</span>
</span></span><span style="display:flex;"><span>k create secret --help
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># 创建docker-registry类型的密钥</span>
</span></span><span style="display:flex;"><span>k create secret docker-registry private-reg-cred --docker-username=dock_user --docker-password=dock_passwd --docker-server=myprivateregistry.com:5000 --docker-email=dock_user@myprivateregistry.com
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="font-weight:bold">apiVersion</span>: apps/v1
</span></span><span style="display:flex;"><span><span style="font-weight:bold">kind</span>: Deployment
</span></span><span style="display:flex;"><span><span style="font-weight:bold">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="font-weight:bold">annotations</span>:
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">deployment.kubernetes.io/revision</span>: <span style="color:#0ff;font-weight:bold">&#34;3&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="font-weight:bold">creationTimestamp</span>: <span style="color:#0ff;font-weight:bold">&#34;2023-12-02T13:18:12Z&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="font-weight:bold">generation</span>: <span style="color:#ff0;font-weight:bold">3</span>
</span></span><span style="display:flex;"><span>  <span style="font-weight:bold">labels</span>:
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">app</span>: web
</span></span><span style="display:flex;"><span>  <span style="font-weight:bold">name</span>: web
</span></span><span style="display:flex;"><span>  <span style="font-weight:bold">namespace</span>: default
</span></span><span style="display:flex;"><span>  <span style="font-weight:bold">resourceVersion</span>: <span style="color:#0ff;font-weight:bold">&#34;2598&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="font-weight:bold">uid</span>: b375109f-b184-4cb1-9a80-425f1a940e3d
</span></span><span style="display:flex;"><span><span style="font-weight:bold">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="font-weight:bold">progressDeadlineSeconds</span>: <span style="color:#ff0;font-weight:bold">600</span>
</span></span><span style="display:flex;"><span>  <span style="font-weight:bold">replicas</span>: <span style="color:#ff0;font-weight:bold">2</span>
</span></span><span style="display:flex;"><span>  <span style="font-weight:bold">revisionHistoryLimit</span>: <span style="color:#ff0;font-weight:bold">10</span>
</span></span><span style="display:flex;"><span>  <span style="font-weight:bold">selector</span>:
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">matchLabels</span>:
</span></span><span style="display:flex;"><span>      <span style="font-weight:bold">app</span>: web
</span></span><span style="display:flex;"><span>  <span style="font-weight:bold">strategy</span>:
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">rollingUpdate</span>:
</span></span><span style="display:flex;"><span>      <span style="font-weight:bold">maxSurge</span>: <span style="color:#ff0;font-weight:bold">25</span>%
</span></span><span style="display:flex;"><span>      <span style="font-weight:bold">maxUnavailable</span>: <span style="color:#ff0;font-weight:bold">25</span>%
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">type</span>: RollingUpdate
</span></span><span style="display:flex;"><span>  <span style="font-weight:bold">template</span>:
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">metadata</span>:
</span></span><span style="display:flex;"><span>      <span style="font-weight:bold">creationTimestamp</span>: <span style="color:#fff;font-weight:bold">null</span>
</span></span><span style="display:flex;"><span>      <span style="font-weight:bold">labels</span>:
</span></span><span style="display:flex;"><span>        <span style="font-weight:bold">app</span>: web
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">spec</span>:
</span></span><span style="display:flex;"><span>      <span style="font-weight:bold">containers</span>:
</span></span><span style="display:flex;"><span>      - <span style="font-weight:bold">image</span>: myprivateregistry.com:5000/nginx:alpine
</span></span><span style="display:flex;"><span>        <span style="font-weight:bold">imagePullPolicy</span>: IfNotPresent
</span></span><span style="display:flex;"><span>        <span style="font-weight:bold">name</span>: nginx
</span></span><span style="display:flex;"><span>        <span style="font-weight:bold">resources</span>: {}
</span></span><span style="display:flex;"><span>        <span style="font-weight:bold">terminationMessagePath</span>: /dev/termination-log
</span></span><span style="display:flex;"><span>        <span style="font-weight:bold">terminationMessagePolicy</span>: File
</span></span><span style="display:flex;"><span>      <span style="font-weight:bold">dnsPolicy</span>: ClusterFirst
</span></span><span style="display:flex;"><span>      <span style="font-weight:bold">imagePullSecrets</span>:
</span></span><span style="display:flex;"><span>      - <span style="font-weight:bold">name</span>: private-reg-cred
</span></span><span style="display:flex;"><span>      <span style="font-weight:bold">restartPolicy</span>: Always
</span></span><span style="display:flex;"><span>      <span style="font-weight:bold">schedulerName</span>: default-scheduler
</span></span><span style="display:flex;"><span>      <span style="font-weight:bold">securityContext</span>: {}
</span></span><span style="display:flex;"><span>      <span style="font-weight:bold">terminationGracePeriodSeconds</span>: <span style="color:#ff0;font-weight:bold">30</span>
</span></span></code></pre></div><h3 id="security-context">Security Context<a hidden class="anchor" aria-hidden="true" href="#security-context">#</a></h3>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#007f7f"># 执行whoami查看容器内部的执行用户</span>
</span></span><span style="display:flex;"><span>kubectl <span style="color:#fff;font-weight:bold">exec</span> &lt;pod-name&gt; -- whoami
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># 强制删除pod</span>
</span></span><span style="display:flex;"><span>kubectl delete pod &lt;pod-name&gt; --force
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># 更新security context必须先删除再新建pod，可以用k replace命令</span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># 编辑如下yaml，容器内用user ID 1010执行sleep命令</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span><span style="font-weight:bold">apiVersion</span>: v1
</span></span><span style="display:flex;"><span><span style="font-weight:bold">kind</span>: Pod
</span></span><span style="display:flex;"><span><span style="font-weight:bold">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="font-weight:bold">name</span>: ubuntu-sleeper
</span></span><span style="display:flex;"><span>  <span style="font-weight:bold">namespace</span>: default
</span></span><span style="display:flex;"><span><span style="font-weight:bold">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="font-weight:bold">securityContext</span>:
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">runAsUser</span>: <span style="color:#ff0;font-weight:bold">1010</span>
</span></span><span style="display:flex;"><span>  <span style="font-weight:bold">containers</span>:
</span></span><span style="display:flex;"><span>  - <span style="font-weight:bold">command</span>:
</span></span><span style="display:flex;"><span>    - sleep
</span></span><span style="display:flex;"><span>    - <span style="color:#0ff;font-weight:bold">&#34;4800&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">image</span>: ubuntu
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">name</span>: ubuntu-sleeper
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">securityContext</span>:
</span></span><span style="display:flex;"><span>      <span style="font-weight:bold">capabilities</span>:
</span></span><span style="display:flex;"><span>        <span style="font-weight:bold">add</span>: [<span style="color:#0ff;font-weight:bold">&#34;SYS_TIME&#34;</span>]
</span></span></code></pre></div><blockquote>
<p>不同level的context</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="font-weight:bold">apiVersion</span>: v1
</span></span><span style="display:flex;"><span><span style="font-weight:bold">kind</span>: Pod
</span></span><span style="display:flex;"><span><span style="font-weight:bold">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="font-weight:bold">name</span>: multi-pod
</span></span><span style="display:flex;"><span><span style="font-weight:bold">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="font-weight:bold">securityContext</span>:
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">runAsUser</span>: <span style="color:#ff0;font-weight:bold">1001</span>
</span></span><span style="display:flex;"><span>  <span style="font-weight:bold">containers</span>:
</span></span><span style="display:flex;"><span>  -  <span style="font-weight:bold">image</span>: ubuntu
</span></span><span style="display:flex;"><span>     <span style="font-weight:bold">name</span>: web
</span></span><span style="display:flex;"><span>     <span style="font-weight:bold">command</span>: [<span style="color:#0ff;font-weight:bold">&#34;sleep&#34;</span>, <span style="color:#0ff;font-weight:bold">&#34;5000&#34;</span>]
</span></span><span style="display:flex;"><span>     <span style="font-weight:bold">securityContext</span>:
</span></span><span style="display:flex;"><span>      <span style="font-weight:bold">runAsUser</span>: <span style="color:#ff0;font-weight:bold">1002</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  -  <span style="font-weight:bold">image</span>: ubuntu
</span></span><span style="display:flex;"><span>     <span style="font-weight:bold">name</span>: sidecar
</span></span><span style="display:flex;"><span>     <span style="font-weight:bold">command</span>: [<span style="color:#0ff;font-weight:bold">&#34;sleep&#34;</span>, <span style="color:#0ff;font-weight:bold">&#34;5000&#34;</span>]
</span></span></code></pre></div><blockquote>
<p>编辑如下yaml，为容器增加SYS_TIME的能力</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span><span style="font-weight:bold">apiVersion</span>: v1
</span></span><span style="display:flex;"><span><span style="font-weight:bold">kind</span>: Pod
</span></span><span style="display:flex;"><span><span style="font-weight:bold">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="font-weight:bold">name</span>: ubuntu-sleeper
</span></span><span style="display:flex;"><span>  <span style="font-weight:bold">namespace</span>: default
</span></span><span style="display:flex;"><span><span style="font-weight:bold">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="font-weight:bold">containers</span>:
</span></span><span style="display:flex;"><span>  - <span style="font-weight:bold">command</span>:
</span></span><span style="display:flex;"><span>    - sleep
</span></span><span style="display:flex;"><span>    - <span style="color:#0ff;font-weight:bold">&#34;4800&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">image</span>: ubuntu
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">name</span>: ubuntu-sleeper
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">securityContext</span>:
</span></span><span style="display:flex;"><span>      <span style="font-weight:bold">capabilities</span>:
</span></span><span style="display:flex;"><span>        <span style="font-weight:bold">add</span>: [<span style="color:#0ff;font-weight:bold">&#34;SYS_TIME&#34;</span>]
</span></span></code></pre></div><h3 id="network-policy">Network Policy<a hidden class="anchor" aria-hidden="true" href="#network-policy">#</a></h3>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#007f7f"># 列出networkpolicy</span>
</span></span><span style="display:flex;"><span>k get networkpolicies.networking.k8s.io
</span></span><span style="display:flex;"><span>k get netpol
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># 查看netpol详情</span>
</span></span><span style="display:flex;"><span>k describe netpol &lt;netpol-name&gt; 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># 使用netpol中对应的selector查询应用的pod</span>
</span></span><span style="display:flex;"><span>k get pods --selector name=payroll
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># 或者</span>
</span></span><span style="display:flex;"><span>k get po --show-labels
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># 创建network policy使得Internal只能访问mysql和payroll</span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># 注意同时放开了53端口，因为需要通过53端口访问DNS</span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># 使用如下yaml实现</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="font-weight:bold">apiVersion</span>: networking.k8s.io/v1
</span></span><span style="display:flex;"><span><span style="font-weight:bold">kind</span>: NetworkPolicy
</span></span><span style="display:flex;"><span><span style="font-weight:bold">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="font-weight:bold">name</span>: internal-policy
</span></span><span style="display:flex;"><span>  <span style="font-weight:bold">namespace</span>: default
</span></span><span style="display:flex;"><span><span style="font-weight:bold">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="font-weight:bold">podSelector</span>:
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">matchLabels</span>:
</span></span><span style="display:flex;"><span>      <span style="font-weight:bold">name</span>: internal
</span></span><span style="display:flex;"><span>  <span style="font-weight:bold">policyTypes</span>:
</span></span><span style="display:flex;"><span>  - Egress
</span></span><span style="display:flex;"><span>  - Ingress
</span></span><span style="display:flex;"><span>  <span style="font-weight:bold">ingress</span>:
</span></span><span style="display:flex;"><span>    - {}
</span></span><span style="display:flex;"><span>  <span style="font-weight:bold">egress</span>:
</span></span><span style="display:flex;"><span>  - <span style="font-weight:bold">to</span>:
</span></span><span style="display:flex;"><span>    - <span style="font-weight:bold">podSelector</span>:
</span></span><span style="display:flex;"><span>        <span style="font-weight:bold">matchLabels</span>:
</span></span><span style="display:flex;"><span>          <span style="font-weight:bold">name</span>: mysql
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">ports</span>:
</span></span><span style="display:flex;"><span>    - <span style="font-weight:bold">protocol</span>: TCP
</span></span><span style="display:flex;"><span>      <span style="font-weight:bold">port</span>: <span style="color:#ff0;font-weight:bold">3306</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  - <span style="font-weight:bold">to</span>:
</span></span><span style="display:flex;"><span>    - <span style="font-weight:bold">podSelector</span>:
</span></span><span style="display:flex;"><span>        <span style="font-weight:bold">matchLabels</span>:
</span></span><span style="display:flex;"><span>          <span style="font-weight:bold">name</span>: payroll
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">ports</span>:
</span></span><span style="display:flex;"><span>    - <span style="font-weight:bold">protocol</span>: TCP
</span></span><span style="display:flex;"><span>      <span style="font-weight:bold">port</span>: <span style="color:#ff0;font-weight:bold">8080</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  - <span style="font-weight:bold">ports</span>:
</span></span><span style="display:flex;"><span>    - <span style="font-weight:bold">port</span>: <span style="color:#ff0;font-weight:bold">53</span>
</span></span><span style="display:flex;"><span>      <span style="font-weight:bold">protocol</span>: UDP
</span></span><span style="display:flex;"><span>    - <span style="font-weight:bold">port</span>: <span style="color:#ff0;font-weight:bold">53</span>
</span></span><span style="display:flex;"><span>      <span style="font-weight:bold">protocol</span>: TCP
</span></span></code></pre></div><h2 id="存储storage">存储Storage<a hidden class="anchor" aria-hidden="true" href="#存储storage">#</a></h2>
<h3 id="persistent-volume-claim">Persistent Volume Claim<a hidden class="anchor" aria-hidden="true" href="#persistent-volume-claim">#</a></h3>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#007f7f"># 查看pod内的日志</span>
</span></span><span style="display:flex;"><span>kubectl <span style="color:#fff;font-weight:bold">exec</span> &lt;pod-name&gt; -- cat /log/app.log
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># 为pod添加持久化的日志卷</span>
</span></span><span style="display:flex;"><span>kubectl get po webapp -o yaml &gt; webapp.yaml
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># 配置hostpath类型的volume</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="font-weight:bold">apiVersion</span>: v1
</span></span><span style="display:flex;"><span><span style="font-weight:bold">kind</span>: Pod
</span></span><span style="display:flex;"><span><span style="font-weight:bold">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="font-weight:bold">name</span>: webapp
</span></span><span style="display:flex;"><span><span style="font-weight:bold">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="font-weight:bold">containers</span>:
</span></span><span style="display:flex;"><span>  - <span style="font-weight:bold">name</span>: event-simulator
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">image</span>: kodekloud/event-simulator
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">env</span>:
</span></span><span style="display:flex;"><span>    - <span style="font-weight:bold">name</span>: LOG_HANDLERS
</span></span><span style="display:flex;"><span>      <span style="font-weight:bold">value</span>: file
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">volumeMounts</span>:
</span></span><span style="display:flex;"><span>    - <span style="font-weight:bold">mountPath</span>: /log
</span></span><span style="display:flex;"><span>      <span style="font-weight:bold">name</span>: log-volume
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="font-weight:bold">volumes</span>:
</span></span><span style="display:flex;"><span>  - <span style="font-weight:bold">name</span>: log-volume
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">hostPath</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#007f7f"># directory location on host</span>
</span></span><span style="display:flex;"><span>      <span style="font-weight:bold">path</span>: /var/log/webapp
</span></span><span style="display:flex;"><span>      <span style="color:#007f7f"># this field is optional</span>
</span></span><span style="display:flex;"><span>      <span style="font-weight:bold">type</span>: Directory
</span></span></code></pre></div><blockquote>
<p>用如下yaml创建Persistent Volume</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="font-weight:bold">apiVersion</span>: v1
</span></span><span style="display:flex;"><span><span style="font-weight:bold">kind</span>: PersistentVolume
</span></span><span style="display:flex;"><span><span style="font-weight:bold">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="font-weight:bold">name</span>: pv-log
</span></span><span style="display:flex;"><span><span style="font-weight:bold">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="font-weight:bold">persistentVolumeReclaimPolicy</span>: Retain
</span></span><span style="display:flex;"><span>  <span style="font-weight:bold">accessModes</span>:
</span></span><span style="display:flex;"><span>    - ReadWriteMany
</span></span><span style="display:flex;"><span>  <span style="font-weight:bold">capacity</span>:
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">storage</span>: 100Mi
</span></span><span style="display:flex;"><span>  <span style="font-weight:bold">hostPath</span>:
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">path</span>: /pv/log
</span></span></code></pre></div><blockquote>
<p>创建Persistent Volume Claim</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="font-weight:bold">kind</span>: PersistentVolumeClaim
</span></span><span style="display:flex;"><span><span style="font-weight:bold">apiVersion</span>: v1
</span></span><span style="display:flex;"><span><span style="font-weight:bold">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="font-weight:bold">name</span>: claim-log-1
</span></span><span style="display:flex;"><span><span style="font-weight:bold">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="font-weight:bold">accessModes</span>:
</span></span><span style="display:flex;"><span>    - ReadWriteOnce
</span></span><span style="display:flex;"><span>  <span style="font-weight:bold">resources</span>:
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">requests</span>:
</span></span><span style="display:flex;"><span>      <span style="font-weight:bold">storage</span>: 50Mi
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#007f7f"># 列出persistent volume</span>
</span></span><span style="display:flex;"><span>k get persistentvolume
</span></span><span style="display:flex;"><span>k get pv
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># 列出persistent volume claim</span>
</span></span><span style="display:flex;"><span>k get pvc
</span></span><span style="display:flex;"><span>k get persistentvolumeclaims
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># 列出多种资源</span>
</span></span><span style="display:flex;"><span>k get pv,pvc
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># pod中使用pvc</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="font-weight:bold">apiVersion</span>: v1
</span></span><span style="display:flex;"><span><span style="font-weight:bold">kind</span>: Pod
</span></span><span style="display:flex;"><span><span style="font-weight:bold">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="font-weight:bold">name</span>: webapp
</span></span><span style="display:flex;"><span><span style="font-weight:bold">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="font-weight:bold">containers</span>:
</span></span><span style="display:flex;"><span>  - <span style="font-weight:bold">name</span>: event-simulator
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">image</span>: kodekloud/event-simulator
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">env</span>:
</span></span><span style="display:flex;"><span>    - <span style="font-weight:bold">name</span>: LOG_HANDLERS
</span></span><span style="display:flex;"><span>      <span style="font-weight:bold">value</span>: file
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">volumeMounts</span>:
</span></span><span style="display:flex;"><span>    - <span style="font-weight:bold">mountPath</span>: /log
</span></span><span style="display:flex;"><span>      <span style="font-weight:bold">name</span>: log-volume
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="font-weight:bold">volumes</span>:
</span></span><span style="display:flex;"><span>  - <span style="font-weight:bold">name</span>: log-volume
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">persistentVolumeClaim</span>:
</span></span><span style="display:flex;"><span>      <span style="font-weight:bold">claimName</span>: claim-log-1
</span></span></code></pre></div><blockquote>
<p>被pod使用中的PVC无法直接删除，需要等到pod删除后才能删掉PVC</p>
</blockquote>
<h3 id="storage-class">Storage Class<a hidden class="anchor" aria-hidden="true" href="#storage-class">#</a></h3>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#007f7f"># 列出storage class</span>
</span></span><span style="display:flex;"><span>k get storageclasses.storage.k8s.io
</span></span><span style="display:flex;"><span>k get sc
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># 查看sc详情</span>
</span></span><span style="display:flex;"><span>k describe sc &lt;sc-name&gt;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># 创建storage class，使用如下yaml</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span><span style="font-weight:bold">apiVersion</span>: storage.k8s.io/v1
</span></span><span style="display:flex;"><span><span style="font-weight:bold">kind</span>: StorageClass
</span></span><span style="display:flex;"><span><span style="font-weight:bold">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="font-weight:bold">name</span>: delayed-volume-sc
</span></span><span style="display:flex;"><span><span style="font-weight:bold">provisioner</span>: kubernetes.io/no-provisioner
</span></span><span style="display:flex;"><span><span style="font-weight:bold">volumeBindingMode</span>: WaitForFirstConsumer
</span></span></code></pre></div><blockquote>
<p>注意WaitForFirstConsume模式的storage，pvc绑定pv时，不会立刻申请存储，而是处于PENDING状态，等到使用pvc的pod被调度时，才会实际上申请存储</p>
<p>如下为一个使用pvc的yaml</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span><span style="font-weight:bold">apiVersion</span>: v1
</span></span><span style="display:flex;"><span><span style="font-weight:bold">kind</span>: Pod
</span></span><span style="display:flex;"><span><span style="font-weight:bold">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="font-weight:bold">name</span>: nginx
</span></span><span style="display:flex;"><span>  <span style="font-weight:bold">labels</span>:
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">name</span>: nginx
</span></span><span style="display:flex;"><span><span style="font-weight:bold">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="font-weight:bold">containers</span>:
</span></span><span style="display:flex;"><span>  - <span style="font-weight:bold">name</span>: nginx
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">image</span>: nginx:alpine
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">volumeMounts</span>:
</span></span><span style="display:flex;"><span>      - <span style="font-weight:bold">name</span>: local-persistent-storage
</span></span><span style="display:flex;"><span>        <span style="font-weight:bold">mountPath</span>: /var/www/html
</span></span><span style="display:flex;"><span>  <span style="font-weight:bold">volumes</span>:
</span></span><span style="display:flex;"><span>    - <span style="font-weight:bold">name</span>: local-persistent-storage
</span></span><span style="display:flex;"><span>      <span style="font-weight:bold">persistentVolumeClaim</span>:
</span></span><span style="display:flex;"><span>        <span style="font-weight:bold">claimName</span>: local-pvc
</span></span></code></pre></div><h2 id="网络networking">网络Networking<a hidden class="anchor" aria-hidden="true" href="#网络networking">#</a></h2>
<h3 id="网络基本命令">网络基本命令<a hidden class="anchor" aria-hidden="true" href="#网络基本命令">#</a></h3>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#007f7f"># 查看node的internal ip地址</span>
</span></span><span style="display:flex;"><span>k get nodes -o wide
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># 查看ip地址对应的网口</span>
</span></span><span style="display:flex;"><span>ip a | grep &lt;ip&gt;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># 查看网口的mac地址/状态</span>
</span></span><span style="display:flex;"><span>ip link show &lt;interface-name&gt;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># 查看Containerd创建的网口(Container Network Interface)</span>
</span></span><span style="display:flex;"><span>ip link | grep cni
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># 查看路由表</span>
</span></span><span style="display:flex;"><span>ip route list
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># 查看默认路由</span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># 默认路由：默认路由是指当目标网络不在路由表中时，数据包将被发送到的默认网关</span>
</span></span><span style="display:flex;"><span>ip route show default
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># 查看kube服务监听的port</span>
</span></span><span style="display:flex;"><span>netstat -ntpl | grep kube
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># 查看etcd的tcp监听服务</span>
</span></span><span style="display:flex;"><span>netstat -ntpl | grep etcd
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># 查看etcd的所有链接（包含client）</span>
</span></span><span style="display:flex;"><span>netstat -anp | grep etcd
</span></span></code></pre></div><h3 id="cni">CNI<a hidden class="anchor" aria-hidden="true" href="#cni">#</a></h3>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#007f7f"># 查看kubelet的container runtime endpoint</span>
</span></span><span style="display:flex;"><span>ps aux | grep kubelet | grep runtime
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># 查看cni的插件</span>
</span></span><span style="display:flex;"><span>ls /opt/cni/bin/
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># 查看当前cluster配置的cni插件</span>
</span></span><span style="display:flex;"><span>ls /etc/cni/net.d/
</span></span></code></pre></div><h3 id="部署weave-net">部署weave net<a hidden class="anchor" aria-hidden="true" href="#部署weave-net">#</a></h3>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#007f7f"># 部署weave-net</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>k apply -f weave-daemonset-k8s.yaml
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># serviceaccount/weave-net created</span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># clusterrole.rbac.authorization.k8s.io/weave-net created</span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># clusterrolebinding.rbac.authorization.k8s.io/weave-net created</span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># role.rbac.authorization.k8s.io/weave-net created</span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># rolebinding.rbac.authorization.k8s.io/weave-net created</span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># daemonset.apps/weave-net created</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="font-weight:bold">apiVersion</span>: v1
</span></span><span style="display:flex;"><span><span style="font-weight:bold">kind</span>: List
</span></span><span style="display:flex;"><span><span style="font-weight:bold">items</span>:
</span></span><span style="display:flex;"><span>  - <span style="font-weight:bold">apiVersion</span>: v1
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">kind</span>: ServiceAccount
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">metadata</span>:
</span></span><span style="display:flex;"><span>      <span style="font-weight:bold">name</span>: weave-net
</span></span><span style="display:flex;"><span>      <span style="font-weight:bold">labels</span>:
</span></span><span style="display:flex;"><span>        <span style="font-weight:bold">name</span>: weave-net
</span></span><span style="display:flex;"><span>      <span style="font-weight:bold">namespace</span>: kube-system
</span></span><span style="display:flex;"><span>  - <span style="font-weight:bold">apiVersion</span>: rbac.authorization.k8s.io/v1
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">kind</span>: ClusterRole
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">metadata</span>:
</span></span><span style="display:flex;"><span>      <span style="font-weight:bold">name</span>: weave-net
</span></span><span style="display:flex;"><span>      <span style="font-weight:bold">labels</span>:
</span></span><span style="display:flex;"><span>        <span style="font-weight:bold">name</span>: weave-net
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">rules</span>:
</span></span><span style="display:flex;"><span>      - <span style="font-weight:bold">apiGroups</span>:
</span></span><span style="display:flex;"><span>          - <span style="color:#0ff;font-weight:bold">&#39;&#39;</span>
</span></span><span style="display:flex;"><span>        <span style="font-weight:bold">resources</span>:
</span></span><span style="display:flex;"><span>          - pods
</span></span><span style="display:flex;"><span>          - namespaces
</span></span><span style="display:flex;"><span>          - nodes
</span></span><span style="display:flex;"><span>        <span style="font-weight:bold">verbs</span>:
</span></span><span style="display:flex;"><span>          - get
</span></span><span style="display:flex;"><span>          - list
</span></span><span style="display:flex;"><span>          - watch
</span></span><span style="display:flex;"><span>      - <span style="font-weight:bold">apiGroups</span>:
</span></span><span style="display:flex;"><span>          - extensions
</span></span><span style="display:flex;"><span>        <span style="font-weight:bold">resources</span>:
</span></span><span style="display:flex;"><span>          - networkpolicies
</span></span><span style="display:flex;"><span>        <span style="font-weight:bold">verbs</span>:
</span></span><span style="display:flex;"><span>          - get
</span></span><span style="display:flex;"><span>          - list
</span></span><span style="display:flex;"><span>          - watch
</span></span><span style="display:flex;"><span>      - <span style="font-weight:bold">apiGroups</span>:
</span></span><span style="display:flex;"><span>          - <span style="color:#0ff;font-weight:bold">&#39;networking.k8s.io&#39;</span>
</span></span><span style="display:flex;"><span>        <span style="font-weight:bold">resources</span>:
</span></span><span style="display:flex;"><span>          - networkpolicies
</span></span><span style="display:flex;"><span>        <span style="font-weight:bold">verbs</span>:
</span></span><span style="display:flex;"><span>          - get
</span></span><span style="display:flex;"><span>          - list
</span></span><span style="display:flex;"><span>          - watch
</span></span><span style="display:flex;"><span>      - <span style="font-weight:bold">apiGroups</span>:
</span></span><span style="display:flex;"><span>        - <span style="color:#0ff;font-weight:bold">&#39;&#39;</span>
</span></span><span style="display:flex;"><span>        <span style="font-weight:bold">resources</span>:
</span></span><span style="display:flex;"><span>        - nodes/status
</span></span><span style="display:flex;"><span>        <span style="font-weight:bold">verbs</span>:
</span></span><span style="display:flex;"><span>        - patch
</span></span><span style="display:flex;"><span>        - update
</span></span><span style="display:flex;"><span>  - <span style="font-weight:bold">apiVersion</span>: rbac.authorization.k8s.io/v1
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">kind</span>: ClusterRoleBinding
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">metadata</span>:
</span></span><span style="display:flex;"><span>      <span style="font-weight:bold">name</span>: weave-net
</span></span><span style="display:flex;"><span>      <span style="font-weight:bold">labels</span>:
</span></span><span style="display:flex;"><span>        <span style="font-weight:bold">name</span>: weave-net
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">roleRef</span>:
</span></span><span style="display:flex;"><span>      <span style="font-weight:bold">kind</span>: ClusterRole
</span></span><span style="display:flex;"><span>      <span style="font-weight:bold">name</span>: weave-net
</span></span><span style="display:flex;"><span>      <span style="font-weight:bold">apiGroup</span>: rbac.authorization.k8s.io
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">subjects</span>:
</span></span><span style="display:flex;"><span>      - <span style="font-weight:bold">kind</span>: ServiceAccount
</span></span><span style="display:flex;"><span>        <span style="font-weight:bold">name</span>: weave-net
</span></span><span style="display:flex;"><span>        <span style="font-weight:bold">namespace</span>: kube-system
</span></span><span style="display:flex;"><span>  - <span style="font-weight:bold">apiVersion</span>: rbac.authorization.k8s.io/v1
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">kind</span>: Role
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">metadata</span>:
</span></span><span style="display:flex;"><span>      <span style="font-weight:bold">name</span>: weave-net
</span></span><span style="display:flex;"><span>      <span style="font-weight:bold">namespace</span>: kube-system
</span></span><span style="display:flex;"><span>      <span style="font-weight:bold">labels</span>:
</span></span><span style="display:flex;"><span>        <span style="font-weight:bold">name</span>: weave-net
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">rules</span>:
</span></span><span style="display:flex;"><span>      - <span style="font-weight:bold">apiGroups</span>:
</span></span><span style="display:flex;"><span>          - <span style="color:#0ff;font-weight:bold">&#39;&#39;</span>
</span></span><span style="display:flex;"><span>        <span style="font-weight:bold">resources</span>:
</span></span><span style="display:flex;"><span>          - configmaps
</span></span><span style="display:flex;"><span>        <span style="font-weight:bold">resourceNames</span>:
</span></span><span style="display:flex;"><span>          - weave-net
</span></span><span style="display:flex;"><span>        <span style="font-weight:bold">verbs</span>:
</span></span><span style="display:flex;"><span>          - get
</span></span><span style="display:flex;"><span>          - update
</span></span><span style="display:flex;"><span>      - <span style="font-weight:bold">apiGroups</span>:
</span></span><span style="display:flex;"><span>          - <span style="color:#0ff;font-weight:bold">&#39;&#39;</span>
</span></span><span style="display:flex;"><span>        <span style="font-weight:bold">resources</span>:
</span></span><span style="display:flex;"><span>          - configmaps
</span></span><span style="display:flex;"><span>        <span style="font-weight:bold">verbs</span>:
</span></span><span style="display:flex;"><span>          - create
</span></span><span style="display:flex;"><span>  - <span style="font-weight:bold">apiVersion</span>: rbac.authorization.k8s.io/v1
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">kind</span>: RoleBinding
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">metadata</span>:
</span></span><span style="display:flex;"><span>      <span style="font-weight:bold">name</span>: weave-net
</span></span><span style="display:flex;"><span>      <span style="font-weight:bold">namespace</span>: kube-system
</span></span><span style="display:flex;"><span>      <span style="font-weight:bold">labels</span>:
</span></span><span style="display:flex;"><span>        <span style="font-weight:bold">name</span>: weave-net
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">roleRef</span>:
</span></span><span style="display:flex;"><span>      <span style="font-weight:bold">kind</span>: Role
</span></span><span style="display:flex;"><span>      <span style="font-weight:bold">name</span>: weave-net
</span></span><span style="display:flex;"><span>      <span style="font-weight:bold">apiGroup</span>: rbac.authorization.k8s.io
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">subjects</span>:
</span></span><span style="display:flex;"><span>      - <span style="font-weight:bold">kind</span>: ServiceAccount
</span></span><span style="display:flex;"><span>        <span style="font-weight:bold">name</span>: weave-net
</span></span><span style="display:flex;"><span>        <span style="font-weight:bold">namespace</span>: kube-system
</span></span><span style="display:flex;"><span>  - <span style="font-weight:bold">apiVersion</span>: apps/v1
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">kind</span>: DaemonSet
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">metadata</span>:
</span></span><span style="display:flex;"><span>      <span style="font-weight:bold">name</span>: weave-net
</span></span><span style="display:flex;"><span>      <span style="font-weight:bold">labels</span>:
</span></span><span style="display:flex;"><span>        <span style="font-weight:bold">name</span>: weave-net
</span></span><span style="display:flex;"><span>      <span style="font-weight:bold">namespace</span>: kube-system
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">spec</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#007f7f"># Wait 5 seconds to let pod connect before rolling next pod</span>
</span></span><span style="display:flex;"><span>      <span style="font-weight:bold">selector</span>:
</span></span><span style="display:flex;"><span>        <span style="font-weight:bold">matchLabels</span>:
</span></span><span style="display:flex;"><span>          <span style="font-weight:bold">name</span>: weave-net
</span></span><span style="display:flex;"><span>      <span style="font-weight:bold">minReadySeconds</span>: <span style="color:#ff0;font-weight:bold">5</span>
</span></span><span style="display:flex;"><span>      <span style="font-weight:bold">template</span>:
</span></span><span style="display:flex;"><span>        <span style="font-weight:bold">metadata</span>:
</span></span><span style="display:flex;"><span>          <span style="font-weight:bold">labels</span>:
</span></span><span style="display:flex;"><span>            <span style="font-weight:bold">name</span>: weave-net
</span></span><span style="display:flex;"><span>        <span style="font-weight:bold">spec</span>:
</span></span><span style="display:flex;"><span>          <span style="font-weight:bold">initContainers</span>:
</span></span><span style="display:flex;"><span>            - <span style="font-weight:bold">name</span>: weave-init
</span></span><span style="display:flex;"><span>              <span style="font-weight:bold">image</span>: <span style="color:#0ff;font-weight:bold">&#39;weaveworks/weave-kube:2.8.1&#39;</span>
</span></span><span style="display:flex;"><span>              <span style="font-weight:bold">command</span>:
</span></span><span style="display:flex;"><span>                - /home/weave/init.sh
</span></span><span style="display:flex;"><span>              <span style="font-weight:bold">env</span>:
</span></span><span style="display:flex;"><span>              <span style="font-weight:bold">securityContext</span>:
</span></span><span style="display:flex;"><span>                <span style="font-weight:bold">privileged</span>: <span style="color:#fff;font-weight:bold">true</span>
</span></span><span style="display:flex;"><span>              <span style="font-weight:bold">volumeMounts</span>:
</span></span><span style="display:flex;"><span>                - <span style="font-weight:bold">name</span>: cni-bin
</span></span><span style="display:flex;"><span>                  <span style="font-weight:bold">mountPath</span>: /host/opt
</span></span><span style="display:flex;"><span>                - <span style="font-weight:bold">name</span>: cni-bin2
</span></span><span style="display:flex;"><span>                  <span style="font-weight:bold">mountPath</span>: /host/home
</span></span><span style="display:flex;"><span>                - <span style="font-weight:bold">name</span>: cni-conf
</span></span><span style="display:flex;"><span>                  <span style="font-weight:bold">mountPath</span>: /host/etc
</span></span><span style="display:flex;"><span>                - <span style="font-weight:bold">name</span>: lib-modules
</span></span><span style="display:flex;"><span>                  <span style="font-weight:bold">mountPath</span>: /lib/modules
</span></span><span style="display:flex;"><span>                - <span style="font-weight:bold">name</span>: xtables-lock
</span></span><span style="display:flex;"><span>                  <span style="font-weight:bold">mountPath</span>: /run/xtables.lock
</span></span><span style="display:flex;"><span>                  <span style="font-weight:bold">readOnly</span>: <span style="color:#fff;font-weight:bold">false</span>
</span></span><span style="display:flex;"><span>          <span style="font-weight:bold">containers</span>:
</span></span><span style="display:flex;"><span>            - <span style="font-weight:bold">name</span>: weave
</span></span><span style="display:flex;"><span>              <span style="font-weight:bold">command</span>:
</span></span><span style="display:flex;"><span>                - /home/weave/launch.sh
</span></span><span style="display:flex;"><span>              <span style="font-weight:bold">env</span>:
</span></span><span style="display:flex;"><span>                - <span style="font-weight:bold">name</span>: IPALLOC_RANGE
</span></span><span style="display:flex;"><span>                  <span style="font-weight:bold">value</span>: <span style="color:#ff0;font-weight:bold">10.32.1.0</span>/24
</span></span><span style="display:flex;"><span>                - <span style="font-weight:bold">name</span>: INIT_CONTAINER
</span></span><span style="display:flex;"><span>                  <span style="font-weight:bold">value</span>: <span style="color:#0ff;font-weight:bold">&#34;true&#34;</span>
</span></span><span style="display:flex;"><span>                - <span style="font-weight:bold">name</span>: HOSTNAME
</span></span><span style="display:flex;"><span>                  <span style="font-weight:bold">valueFrom</span>:
</span></span><span style="display:flex;"><span>                    <span style="font-weight:bold">fieldRef</span>:
</span></span><span style="display:flex;"><span>                      <span style="font-weight:bold">apiVersion</span>: v1
</span></span><span style="display:flex;"><span>                      <span style="font-weight:bold">fieldPath</span>: spec.nodeName
</span></span><span style="display:flex;"><span>              <span style="font-weight:bold">image</span>: <span style="color:#0ff;font-weight:bold">&#39;weaveworks/weave-kube:2.8.1&#39;</span>
</span></span><span style="display:flex;"><span>              <span style="font-weight:bold">readinessProbe</span>:
</span></span><span style="display:flex;"><span>                <span style="font-weight:bold">httpGet</span>:
</span></span><span style="display:flex;"><span>                  <span style="font-weight:bold">host</span>: <span style="color:#ff0;font-weight:bold">127.0.0.1</span>
</span></span><span style="display:flex;"><span>                  <span style="font-weight:bold">path</span>: /status
</span></span><span style="display:flex;"><span>                  <span style="font-weight:bold">port</span>: <span style="color:#ff0;font-weight:bold">6784</span>
</span></span><span style="display:flex;"><span>              <span style="font-weight:bold">resources</span>:
</span></span><span style="display:flex;"><span>                <span style="font-weight:bold">requests</span>:
</span></span><span style="display:flex;"><span>                  <span style="font-weight:bold">cpu</span>: 50m
</span></span><span style="display:flex;"><span>              <span style="font-weight:bold">securityContext</span>:
</span></span><span style="display:flex;"><span>                <span style="font-weight:bold">privileged</span>: <span style="color:#fff;font-weight:bold">true</span>
</span></span><span style="display:flex;"><span>              <span style="font-weight:bold">volumeMounts</span>:
</span></span><span style="display:flex;"><span>                - <span style="font-weight:bold">name</span>: weavedb
</span></span><span style="display:flex;"><span>                  <span style="font-weight:bold">mountPath</span>: /weavedb
</span></span><span style="display:flex;"><span>                - <span style="font-weight:bold">name</span>: dbus
</span></span><span style="display:flex;"><span>                  <span style="font-weight:bold">mountPath</span>: /host/var/lib/dbus
</span></span><span style="display:flex;"><span>                  <span style="font-weight:bold">readOnly</span>: <span style="color:#fff;font-weight:bold">true</span>
</span></span><span style="display:flex;"><span>                - <span style="font-weight:bold">mountPath</span>: /host/etc/machine-id
</span></span><span style="display:flex;"><span>                  <span style="font-weight:bold">name</span>: cni-machine-id
</span></span><span style="display:flex;"><span>                  <span style="font-weight:bold">readOnly</span>: <span style="color:#fff;font-weight:bold">true</span>
</span></span><span style="display:flex;"><span>                - <span style="font-weight:bold">name</span>: xtables-lock
</span></span><span style="display:flex;"><span>                  <span style="font-weight:bold">mountPath</span>: /run/xtables.lock
</span></span><span style="display:flex;"><span>                  <span style="font-weight:bold">readOnly</span>: <span style="color:#fff;font-weight:bold">false</span>
</span></span><span style="display:flex;"><span>            - <span style="font-weight:bold">name</span>: weave-npc
</span></span><span style="display:flex;"><span>              <span style="font-weight:bold">env</span>:
</span></span><span style="display:flex;"><span>                - <span style="font-weight:bold">name</span>: HOSTNAME
</span></span><span style="display:flex;"><span>                  <span style="font-weight:bold">valueFrom</span>:
</span></span><span style="display:flex;"><span>                    <span style="font-weight:bold">fieldRef</span>:
</span></span><span style="display:flex;"><span>                      <span style="font-weight:bold">apiVersion</span>: v1
</span></span><span style="display:flex;"><span>                      <span style="font-weight:bold">fieldPath</span>: spec.nodeName
</span></span><span style="display:flex;"><span>              <span style="font-weight:bold">image</span>: <span style="color:#0ff;font-weight:bold">&#39;weaveworks/weave-npc:2.8.1&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">#npc-args</span>
</span></span><span style="display:flex;"><span>              <span style="font-weight:bold">resources</span>:
</span></span><span style="display:flex;"><span>                <span style="font-weight:bold">requests</span>:
</span></span><span style="display:flex;"><span>                  <span style="font-weight:bold">cpu</span>: 50m
</span></span><span style="display:flex;"><span>              <span style="font-weight:bold">securityContext</span>:
</span></span><span style="display:flex;"><span>                <span style="font-weight:bold">privileged</span>: <span style="color:#fff;font-weight:bold">true</span>
</span></span><span style="display:flex;"><span>              <span style="font-weight:bold">volumeMounts</span>:
</span></span><span style="display:flex;"><span>                - <span style="font-weight:bold">name</span>: xtables-lock
</span></span><span style="display:flex;"><span>                  <span style="font-weight:bold">mountPath</span>: /run/xtables.lock
</span></span><span style="display:flex;"><span>                  <span style="font-weight:bold">readOnly</span>: <span style="color:#fff;font-weight:bold">false</span>
</span></span><span style="display:flex;"><span>          <span style="font-weight:bold">hostNetwork</span>: <span style="color:#fff;font-weight:bold">true</span>
</span></span><span style="display:flex;"><span>          <span style="font-weight:bold">dnsPolicy</span>: ClusterFirstWithHostNet
</span></span><span style="display:flex;"><span>          <span style="font-weight:bold">hostPID</span>: <span style="color:#fff;font-weight:bold">false</span>
</span></span><span style="display:flex;"><span>          <span style="font-weight:bold">restartPolicy</span>: Always
</span></span><span style="display:flex;"><span>          <span style="font-weight:bold">securityContext</span>:
</span></span><span style="display:flex;"><span>            <span style="font-weight:bold">seLinuxOptions</span>: {}
</span></span><span style="display:flex;"><span>          <span style="font-weight:bold">serviceAccountName</span>: weave-net
</span></span><span style="display:flex;"><span>          <span style="font-weight:bold">tolerations</span>:
</span></span><span style="display:flex;"><span>            - <span style="font-weight:bold">effect</span>: NoSchedule
</span></span><span style="display:flex;"><span>              <span style="font-weight:bold">operator</span>: Exists
</span></span><span style="display:flex;"><span>            - <span style="font-weight:bold">effect</span>: NoExecute
</span></span><span style="display:flex;"><span>              <span style="font-weight:bold">operator</span>: Exists
</span></span><span style="display:flex;"><span>          <span style="font-weight:bold">volumes</span>:
</span></span><span style="display:flex;"><span>            - <span style="font-weight:bold">name</span>: weavedb
</span></span><span style="display:flex;"><span>              <span style="font-weight:bold">hostPath</span>:
</span></span><span style="display:flex;"><span>                <span style="font-weight:bold">path</span>: /var/lib/weave
</span></span><span style="display:flex;"><span>            - <span style="font-weight:bold">name</span>: cni-bin
</span></span><span style="display:flex;"><span>              <span style="font-weight:bold">hostPath</span>:
</span></span><span style="display:flex;"><span>                <span style="font-weight:bold">path</span>: /opt
</span></span><span style="display:flex;"><span>            - <span style="font-weight:bold">name</span>: cni-bin2
</span></span><span style="display:flex;"><span>              <span style="font-weight:bold">hostPath</span>:
</span></span><span style="display:flex;"><span>                <span style="font-weight:bold">path</span>: /home
</span></span><span style="display:flex;"><span>            - <span style="font-weight:bold">name</span>: cni-conf
</span></span><span style="display:flex;"><span>              <span style="font-weight:bold">hostPath</span>:
</span></span><span style="display:flex;"><span>                <span style="font-weight:bold">path</span>: /etc
</span></span><span style="display:flex;"><span>            - <span style="font-weight:bold">name</span>: cni-machine-id
</span></span><span style="display:flex;"><span>              <span style="font-weight:bold">hostPath</span>:
</span></span><span style="display:flex;"><span>                <span style="font-weight:bold">path</span>: /etc/machine-id
</span></span><span style="display:flex;"><span>            - <span style="font-weight:bold">name</span>: dbus
</span></span><span style="display:flex;"><span>              <span style="font-weight:bold">hostPath</span>:
</span></span><span style="display:flex;"><span>                <span style="font-weight:bold">path</span>: /var/lib/dbus
</span></span><span style="display:flex;"><span>            - <span style="font-weight:bold">name</span>: lib-modules
</span></span><span style="display:flex;"><span>              <span style="font-weight:bold">hostPath</span>:
</span></span><span style="display:flex;"><span>                <span style="font-weight:bold">path</span>: /lib/modules
</span></span><span style="display:flex;"><span>            - <span style="font-weight:bold">name</span>: xtables-lock
</span></span><span style="display:flex;"><span>              <span style="font-weight:bold">hostPath</span>:
</span></span><span style="display:flex;"><span>                <span style="font-weight:bold">path</span>: /run/xtables.lock
</span></span><span style="display:flex;"><span>                <span style="font-weight:bold">type</span>: FileOrCreate
</span></span><span style="display:flex;"><span>          <span style="font-weight:bold">priorityClassName</span>: system-node-critical
</span></span><span style="display:flex;"><span>      <span style="font-weight:bold">updateStrategy</span>:
</span></span><span style="display:flex;"><span>        <span style="font-weight:bold">type</span>: RollingUpdate
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#007f7f"># 查看weave的agent/peer</span>
</span></span><span style="display:flex;"><span>k get pods --all-namespaces | grep weave
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># weave pod在每个节点上存在一个（包括master和work node）</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># 查看weave创建的网口</span>
</span></span><span style="display:flex;"><span>ip link | grep weave
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># 查看weave网口的ip地址段</span>
</span></span><span style="display:flex;"><span>ip addr show weave
</span></span><span style="display:flex;"><span>ip route list
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># 查看work node上weave net的默认网关，首先登录到work node</span>
</span></span><span style="display:flex;"><span>ip route | gre weave
</span></span></code></pre></div><h3 id="service-networking">Service Networking<a hidden class="anchor" aria-hidden="true" href="#service-networking">#</a></h3>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#007f7f"># 查看整个cluster的网络范围</span>
</span></span><span style="display:flex;"><span>ip addr | grep eth0
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># 215: eth0@if216: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1450 qdisc noqueue state UP group default </span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">#    inet 192.4.210.9/24 brd 192.4.210.255 scope global eth0</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>ipcalc -b 192.4.210.9
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># 计算的cluster的地址范围192.4.210.0/24</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># 查看cluster中pod的网络地址范围</span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># 若pod使用weave网络，使用如下查询方式</span>
</span></span><span style="display:flex;"><span>k logs -n kube-system weave-net-8v8hr  | grep ipalloc-range
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># pod地址范围是10.244.0.0/16</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># 查看service的网络地址范围</span>
</span></span><span style="display:flex;"><span>cat /etc/kubernetes/manifests/kube-apiserver.yaml | grep cluster-ip-range
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># --service-cluster-ip-range=10.96.0.0/12</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># 查看kube-proxy的类型</span>
</span></span><span style="display:flex;"><span>k logs -n kube-system &lt;kube-proxy-pod-name&gt;
</span></span></code></pre></div><h3 id="coredns">CoreDNS<a hidden class="anchor" aria-hidden="true" href="#coredns">#</a></h3>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#007f7f"># 查看cluster的DNS解决方案</span>
</span></span><span style="display:flex;"><span>k get pods -n kube-system | grep dns
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># 查看dns service</span>
</span></span><span style="display:flex;"><span>k get service --all-namespaces | grep dns
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># 查看coredns的配置文件</span>
</span></span><span style="display:flex;"><span>k -n kube-system describe deployments.apps coredns | grep -A2 Args
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># 查看Corefile的注入方式</span>
</span></span><span style="display:flex;"><span>k get po -n kube-system coredns-5d78c9869d-5sxxz  -o yaml
</span></span><span style="display:flex;"><span>k describe cm -n kube-system coredns
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># service的DNS规则如下：service.namespace.svc.cluster.local</span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># web-service.payroll.svc.cluster.local</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># 查看DNS结果</span>
</span></span><span style="display:flex;"><span>kubectl <span style="color:#fff;font-weight:bold">exec</span> -it hr -- nslookup mysql.payroll &gt; /root/CKA/nslookup.out
</span></span></code></pre></div><h3 id="ingress">Ingress<a hidden class="anchor" aria-hidden="true" href="#ingress">#</a></h3>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#007f7f"># 查看ingress</span>
</span></span><span style="display:flex;"><span>kubectl get all -A | grep -i ingress
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>k get ingress -A
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># 查看ingress详情</span>
</span></span><span style="display:flex;"><span>kubectl describe ingress &lt;ingress-name&gt;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># 编辑ingress修改rules</span>
</span></span><span style="display:flex;"><span>kubectl edit ingress
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># 创建ingress，注意如下命令缺少annotation，创建的yaml添加annotation才能正常工作</span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># pathType: Exact</span>
</span></span><span style="display:flex;"><span>k create ingress -n critical-space test-ingress --rule=/pay=pay-service:8282  --dry-run=client -o yaml
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># pathType: Prefix</span>
</span></span><span style="display:flex;"><span>k create ingress -n critical-space test-ingress --rule=/pay*=pay-service:8282   --dry-run=client -o yaml
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="font-weight:bold">apiVersion</span>: networking.k8s.io/v1
</span></span><span style="display:flex;"><span><span style="font-weight:bold">kind</span>: Ingress
</span></span><span style="display:flex;"><span><span style="font-weight:bold">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="font-weight:bold">annotations</span>:
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">nginx.ingress.kubernetes.io/rewrite-target</span>: /
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">nginx.ingress.kubernetes.io/ssl-redirect</span>: <span style="color:#0ff;font-weight:bold">&#34;false&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="font-weight:bold">name</span>: ingress-wear-watch
</span></span><span style="display:flex;"><span>  <span style="font-weight:bold">namespace</span>: app-space
</span></span><span style="display:flex;"><span><span style="font-weight:bold">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="font-weight:bold">rules</span>:
</span></span><span style="display:flex;"><span>  - <span style="font-weight:bold">http</span>:
</span></span><span style="display:flex;"><span>      <span style="font-weight:bold">paths</span>:
</span></span><span style="display:flex;"><span>      - <span style="font-weight:bold">backend</span>:
</span></span><span style="display:flex;"><span>          <span style="font-weight:bold">service</span>:
</span></span><span style="display:flex;"><span>            <span style="font-weight:bold">name</span>: wear-service
</span></span><span style="display:flex;"><span>            <span style="font-weight:bold">port</span>: 
</span></span><span style="display:flex;"><span>              <span style="font-weight:bold">number</span>: <span style="color:#ff0;font-weight:bold">8080</span>
</span></span><span style="display:flex;"><span>        <span style="font-weight:bold">path</span>: /wear
</span></span><span style="display:flex;"><span>        <span style="font-weight:bold">pathType</span>: Prefix
</span></span><span style="display:flex;"><span>      - <span style="font-weight:bold">backend</span>:
</span></span><span style="display:flex;"><span>          <span style="font-weight:bold">service</span>:
</span></span><span style="display:flex;"><span>            <span style="font-weight:bold">name</span>: video-service
</span></span><span style="display:flex;"><span>            <span style="font-weight:bold">port</span>: 
</span></span><span style="display:flex;"><span>              <span style="font-weight:bold">number</span>: <span style="color:#ff0;font-weight:bold">8080</span>
</span></span><span style="display:flex;"><span>        <span style="font-weight:bold">path</span>: /stream
</span></span><span style="display:flex;"><span>        <span style="font-weight:bold">pathType</span>: Prefix
</span></span></code></pre></div><blockquote>
<p>如下为cluster创建ingress controller</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#007f7f"># 创建ingress独立的namespace(便于隔离)</span>
</span></span><span style="display:flex;"><span>k create namespace ingress-nginx
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># 创建configmap</span>
</span></span><span style="display:flex;"><span>kubectl create configmap ingress-nginx-controller --namespace ingress-nginx
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># 创建service account</span>
</span></span><span style="display:flex;"><span>k create sa ingress-nginx -n ingress-nginx
</span></span><span style="display:flex;"><span>k create sa ingress-nginx-admission -n ingress-nginx
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># 创建role，rolebinding，clusterrole，clusterrolebinding</span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># 略</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># ingress controller 的yaml如下</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="font-weight:bold">apiVersion</span>: apps/v1
</span></span><span style="display:flex;"><span><span style="font-weight:bold">kind</span>: Deployment
</span></span><span style="display:flex;"><span><span style="font-weight:bold">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="font-weight:bold">labels</span>:
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">app.kubernetes.io/component</span>: controller
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">app.kubernetes.io/instance</span>: ingress-nginx
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">app.kubernetes.io/managed-by</span>: Helm
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">app.kubernetes.io/name</span>: ingress-nginx
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">app.kubernetes.io/part-of</span>: ingress-nginx
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">app.kubernetes.io/version</span>: <span style="color:#ff0;font-weight:bold">1.1.2</span>
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">helm.sh/chart</span>: ingress-nginx-4.0.18
</span></span><span style="display:flex;"><span>  <span style="font-weight:bold">name</span>: ingress-nginx-controller
</span></span><span style="display:flex;"><span>  <span style="font-weight:bold">namespace</span>: ingress-nginx
</span></span><span style="display:flex;"><span><span style="font-weight:bold">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="font-weight:bold">replicas</span>: <span style="color:#ff0;font-weight:bold">1</span>
</span></span><span style="display:flex;"><span>  <span style="font-weight:bold">minReadySeconds</span>: <span style="color:#ff0;font-weight:bold">0</span>
</span></span><span style="display:flex;"><span>  <span style="font-weight:bold">revisionHistoryLimit</span>: <span style="color:#ff0;font-weight:bold">10</span>
</span></span><span style="display:flex;"><span>  <span style="font-weight:bold">selector</span>:
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">matchLabels</span>:
</span></span><span style="display:flex;"><span>      <span style="font-weight:bold">app.kubernetes.io/component</span>: controller
</span></span><span style="display:flex;"><span>      <span style="font-weight:bold">app.kubernetes.io/instance</span>: ingress-nginx
</span></span><span style="display:flex;"><span>      <span style="font-weight:bold">app.kubernetes.io/name</span>: ingress-nginx
</span></span><span style="display:flex;"><span>  <span style="font-weight:bold">template</span>:
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">metadata</span>:
</span></span><span style="display:flex;"><span>      <span style="font-weight:bold">labels</span>:
</span></span><span style="display:flex;"><span>        <span style="font-weight:bold">app.kubernetes.io/component</span>: controller
</span></span><span style="display:flex;"><span>        <span style="font-weight:bold">app.kubernetes.io/instance</span>: ingress-nginx
</span></span><span style="display:flex;"><span>        <span style="font-weight:bold">app.kubernetes.io/name</span>: ingress-nginx
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">spec</span>:
</span></span><span style="display:flex;"><span>      <span style="font-weight:bold">containers</span>:
</span></span><span style="display:flex;"><span>      - <span style="font-weight:bold">args</span>:
</span></span><span style="display:flex;"><span>        - /nginx-ingress-controller
</span></span><span style="display:flex;"><span>        - --publish-service=$(POD_NAMESPACE)/ingress-nginx-controller
</span></span><span style="display:flex;"><span>        - --election-id=ingress-controller-leader
</span></span><span style="display:flex;"><span>        - --watch-ingress-without-class=true
</span></span><span style="display:flex;"><span>        - --default-backend-service=app-space/default-http-backend
</span></span><span style="display:flex;"><span>        - --controller-class=k8s.io/ingress-nginx
</span></span><span style="display:flex;"><span>        - --ingress-class=nginx
</span></span><span style="display:flex;"><span>        - --configmap=$(POD_NAMESPACE)/ingress-nginx-controller
</span></span><span style="display:flex;"><span>        - --validating-webhook=:8443
</span></span><span style="display:flex;"><span>        - --validating-webhook-certificate=/usr/local/certificates/cert
</span></span><span style="display:flex;"><span>        - --validating-webhook-key=/usr/local/certificates/key
</span></span><span style="display:flex;"><span>        <span style="font-weight:bold">env</span>:
</span></span><span style="display:flex;"><span>        - <span style="font-weight:bold">name</span>: POD_NAME
</span></span><span style="display:flex;"><span>          <span style="font-weight:bold">valueFrom</span>:
</span></span><span style="display:flex;"><span>            <span style="font-weight:bold">fieldRef</span>:
</span></span><span style="display:flex;"><span>              <span style="font-weight:bold">fieldPath</span>: metadata.name
</span></span><span style="display:flex;"><span>        - <span style="font-weight:bold">name</span>: POD_NAMESPACE
</span></span><span style="display:flex;"><span>          <span style="font-weight:bold">valueFrom</span>:
</span></span><span style="display:flex;"><span>            <span style="font-weight:bold">fieldRef</span>:
</span></span><span style="display:flex;"><span>              <span style="font-weight:bold">fieldPath</span>: metadata.namespace
</span></span><span style="display:flex;"><span>        - <span style="font-weight:bold">name</span>: LD_PRELOAD
</span></span><span style="display:flex;"><span>          <span style="font-weight:bold">value</span>: /usr/local/lib/libmimalloc.so
</span></span><span style="display:flex;"><span>        <span style="font-weight:bold">image</span>: registry.k8s.io/ingress-nginx/controller:v1.1.2@sha256:28b11ce69e57843de44e3db6413e98d09de0f6688e33d4bd384002a44f78405c
</span></span><span style="display:flex;"><span>        <span style="font-weight:bold">imagePullPolicy</span>: IfNotPresent
</span></span><span style="display:flex;"><span>        <span style="font-weight:bold">lifecycle</span>:
</span></span><span style="display:flex;"><span>          <span style="font-weight:bold">preStop</span>:
</span></span><span style="display:flex;"><span>            <span style="font-weight:bold">exec</span>:
</span></span><span style="display:flex;"><span>              <span style="font-weight:bold">command</span>:
</span></span><span style="display:flex;"><span>              - /wait-shutdown
</span></span><span style="display:flex;"><span>        <span style="font-weight:bold">livenessProbe</span>:
</span></span><span style="display:flex;"><span>          <span style="font-weight:bold">failureThreshold</span>: <span style="color:#ff0;font-weight:bold">5</span>
</span></span><span style="display:flex;"><span>          <span style="font-weight:bold">httpGet</span>:
</span></span><span style="display:flex;"><span>            <span style="font-weight:bold">path</span>: /healthz
</span></span><span style="display:flex;"><span>            <span style="font-weight:bold">port</span>: <span style="color:#ff0;font-weight:bold">10254</span>
</span></span><span style="display:flex;"><span>            <span style="font-weight:bold">scheme</span>: HTTP
</span></span><span style="display:flex;"><span>          <span style="font-weight:bold">initialDelaySeconds</span>: <span style="color:#ff0;font-weight:bold">10</span>
</span></span><span style="display:flex;"><span>          <span style="font-weight:bold">periodSeconds</span>: <span style="color:#ff0;font-weight:bold">10</span>
</span></span><span style="display:flex;"><span>          <span style="font-weight:bold">successThreshold</span>: <span style="color:#ff0;font-weight:bold">1</span>
</span></span><span style="display:flex;"><span>          <span style="font-weight:bold">timeoutSeconds</span>: <span style="color:#ff0;font-weight:bold">1</span>
</span></span><span style="display:flex;"><span>        <span style="font-weight:bold">name</span>: controller
</span></span><span style="display:flex;"><span>        <span style="font-weight:bold">ports</span>:
</span></span><span style="display:flex;"><span>        - <span style="font-weight:bold">name</span>: http
</span></span><span style="display:flex;"><span>          <span style="font-weight:bold">containerPort</span>: <span style="color:#ff0;font-weight:bold">80</span>
</span></span><span style="display:flex;"><span>          <span style="font-weight:bold">protocol</span>: TCP
</span></span><span style="display:flex;"><span>        - <span style="font-weight:bold">containerPort</span>: <span style="color:#ff0;font-weight:bold">443</span>
</span></span><span style="display:flex;"><span>          <span style="font-weight:bold">name</span>: https
</span></span><span style="display:flex;"><span>          <span style="font-weight:bold">protocol</span>: TCP
</span></span><span style="display:flex;"><span>        - <span style="font-weight:bold">containerPort</span>: <span style="color:#ff0;font-weight:bold">8443</span>
</span></span><span style="display:flex;"><span>          <span style="font-weight:bold">name</span>: webhook
</span></span><span style="display:flex;"><span>          <span style="font-weight:bold">protocol</span>: TCP
</span></span><span style="display:flex;"><span>        <span style="font-weight:bold">readinessProbe</span>:
</span></span><span style="display:flex;"><span>          <span style="font-weight:bold">failureThreshold</span>: <span style="color:#ff0;font-weight:bold">3</span>
</span></span><span style="display:flex;"><span>          <span style="font-weight:bold">httpGet</span>:
</span></span><span style="display:flex;"><span>            <span style="font-weight:bold">path</span>: /healthz
</span></span><span style="display:flex;"><span>            <span style="font-weight:bold">port</span>: <span style="color:#ff0;font-weight:bold">10254</span>
</span></span><span style="display:flex;"><span>            <span style="font-weight:bold">scheme</span>: HTTP
</span></span><span style="display:flex;"><span>          <span style="font-weight:bold">initialDelaySeconds</span>: <span style="color:#ff0;font-weight:bold">10</span>
</span></span><span style="display:flex;"><span>          <span style="font-weight:bold">periodSeconds</span>: <span style="color:#ff0;font-weight:bold">10</span>
</span></span><span style="display:flex;"><span>          <span style="font-weight:bold">successThreshold</span>: <span style="color:#ff0;font-weight:bold">1</span>
</span></span><span style="display:flex;"><span>          <span style="font-weight:bold">timeoutSeconds</span>: <span style="color:#ff0;font-weight:bold">1</span>
</span></span><span style="display:flex;"><span>        <span style="font-weight:bold">resources</span>:
</span></span><span style="display:flex;"><span>          <span style="font-weight:bold">requests</span>:
</span></span><span style="display:flex;"><span>            <span style="font-weight:bold">cpu</span>: 100m
</span></span><span style="display:flex;"><span>            <span style="font-weight:bold">memory</span>: 90Mi
</span></span><span style="display:flex;"><span>        <span style="font-weight:bold">securityContext</span>:
</span></span><span style="display:flex;"><span>          <span style="font-weight:bold">allowPrivilegeEscalation</span>: <span style="color:#fff;font-weight:bold">true</span>
</span></span><span style="display:flex;"><span>          <span style="font-weight:bold">capabilities</span>:
</span></span><span style="display:flex;"><span>            <span style="font-weight:bold">add</span>:
</span></span><span style="display:flex;"><span>            - NET_BIND_SERVICE
</span></span><span style="display:flex;"><span>            <span style="font-weight:bold">drop</span>:
</span></span><span style="display:flex;"><span>            - ALL
</span></span><span style="display:flex;"><span>          <span style="font-weight:bold">runAsUser</span>: <span style="color:#ff0;font-weight:bold">101</span>
</span></span><span style="display:flex;"><span>        <span style="font-weight:bold">volumeMounts</span>:
</span></span><span style="display:flex;"><span>        - <span style="font-weight:bold">mountPath</span>: /usr/local/certificates/
</span></span><span style="display:flex;"><span>          <span style="font-weight:bold">name</span>: webhook-cert
</span></span><span style="display:flex;"><span>          <span style="font-weight:bold">readOnly</span>: <span style="color:#fff;font-weight:bold">true</span>
</span></span><span style="display:flex;"><span>      <span style="font-weight:bold">dnsPolicy</span>: ClusterFirst
</span></span><span style="display:flex;"><span>      <span style="font-weight:bold">nodeSelector</span>:
</span></span><span style="display:flex;"><span>        <span style="font-weight:bold">kubernetes.io/os</span>: linux
</span></span><span style="display:flex;"><span>      <span style="font-weight:bold">serviceAccountName</span>: ingress-nginx
</span></span><span style="display:flex;"><span>      <span style="font-weight:bold">terminationGracePeriodSeconds</span>: <span style="color:#ff0;font-weight:bold">300</span>
</span></span><span style="display:flex;"><span>      <span style="font-weight:bold">volumes</span>:
</span></span><span style="display:flex;"><span>      - <span style="font-weight:bold">name</span>: webhook-cert
</span></span><span style="display:flex;"><span>        <span style="font-weight:bold">secret</span>:
</span></span><span style="display:flex;"><span>          <span style="font-weight:bold">secretName</span>: ingress-nginx-admission
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="font-weight:bold">apiVersion</span>: v1
</span></span><span style="display:flex;"><span><span style="font-weight:bold">kind</span>: Service
</span></span><span style="display:flex;"><span><span style="font-weight:bold">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="font-weight:bold">creationTimestamp</span>: <span style="color:#fff;font-weight:bold">null</span>
</span></span><span style="display:flex;"><span>  <span style="font-weight:bold">labels</span>:
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">app.kubernetes.io/component</span>: controller
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">app.kubernetes.io/instance</span>: ingress-nginx
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">app.kubernetes.io/managed-by</span>: Helm
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">app.kubernetes.io/name</span>: ingress-nginx
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">app.kubernetes.io/part-of</span>: ingress-nginx
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">app.kubernetes.io/version</span>: <span style="color:#ff0;font-weight:bold">1.1.2</span>
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">helm.sh/chart</span>: ingress-nginx-4.0.18
</span></span><span style="display:flex;"><span>  <span style="font-weight:bold">name</span>: ingress-nginx-controller
</span></span><span style="display:flex;"><span>  <span style="font-weight:bold">namespace</span>: ingress-nginx
</span></span><span style="display:flex;"><span><span style="font-weight:bold">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="font-weight:bold">ports</span>:
</span></span><span style="display:flex;"><span>  - <span style="font-weight:bold">port</span>: <span style="color:#ff0;font-weight:bold">80</span>
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">protocol</span>: TCP
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">targetPort</span>: <span style="color:#ff0;font-weight:bold">80</span>
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">nodePort</span>: <span style="color:#ff0;font-weight:bold">30080</span>
</span></span><span style="display:flex;"><span>  <span style="font-weight:bold">selector</span>:
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">app.kubernetes.io/component</span>: controller
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">app.kubernetes.io/instance</span>: ingress-nginx
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">app.kubernetes.io/name</span>: ingress-nginx
</span></span><span style="display:flex;"><span>  <span style="font-weight:bold">type</span>: NodePort
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#007f7f"># 接着创建ingress，ingress资源是在namespace范围下的，所以ingress要和service同一个namespace</span>
</span></span><span style="display:flex;"><span>k create ingress -n app-space --rule /wear*=wear-service:8080 --rule /watch*=video-service:8080 --annotation nginx.ingress.kubernetes.io/rewrite-target=/ --annotation nginx.ingress.kubernetes.io/ssl-redirect=<span style="color:#fff;font-weight:bold">false</span> test-ingress --dry-run=client -o yaml
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="font-weight:bold">apiVersion</span>: networking.k8s.io/v1
</span></span><span style="display:flex;"><span><span style="font-weight:bold">kind</span>: Ingress
</span></span><span style="display:flex;"><span><span style="font-weight:bold">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="font-weight:bold">annotations</span>:
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">nginx.ingress.kubernetes.io/rewrite-target</span>: /
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">nginx.ingress.kubernetes.io/ssl-redirect</span>: <span style="color:#0ff;font-weight:bold">&#34;false&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="font-weight:bold">creationTimestamp</span>: <span style="color:#fff;font-weight:bold">null</span>
</span></span><span style="display:flex;"><span>  <span style="font-weight:bold">name</span>: test-ingress
</span></span><span style="display:flex;"><span>  <span style="font-weight:bold">namespace</span>: app-space
</span></span><span style="display:flex;"><span><span style="font-weight:bold">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="font-weight:bold">rules</span>:
</span></span><span style="display:flex;"><span>  - <span style="font-weight:bold">http</span>:
</span></span><span style="display:flex;"><span>      <span style="font-weight:bold">paths</span>:
</span></span><span style="display:flex;"><span>      - <span style="font-weight:bold">backend</span>:
</span></span><span style="display:flex;"><span>          <span style="font-weight:bold">service</span>:
</span></span><span style="display:flex;"><span>            <span style="font-weight:bold">name</span>: wear-service
</span></span><span style="display:flex;"><span>            <span style="font-weight:bold">port</span>:
</span></span><span style="display:flex;"><span>              <span style="font-weight:bold">number</span>: <span style="color:#ff0;font-weight:bold">8080</span>
</span></span><span style="display:flex;"><span>        <span style="font-weight:bold">path</span>: /wear
</span></span><span style="display:flex;"><span>        <span style="font-weight:bold">pathType</span>: Prefix
</span></span><span style="display:flex;"><span>      - <span style="font-weight:bold">backend</span>:
</span></span><span style="display:flex;"><span>          <span style="font-weight:bold">service</span>:
</span></span><span style="display:flex;"><span>            <span style="font-weight:bold">name</span>: video-service
</span></span><span style="display:flex;"><span>            <span style="font-weight:bold">port</span>:
</span></span><span style="display:flex;"><span>              <span style="font-weight:bold">number</span>: <span style="color:#ff0;font-weight:bold">8080</span>
</span></span><span style="display:flex;"><span>        <span style="font-weight:bold">path</span>: /watch
</span></span><span style="display:flex;"><span>        <span style="font-weight:bold">pathType</span>: Prefix
</span></span><span style="display:flex;"><span><span style="font-weight:bold">status</span>:
</span></span><span style="display:flex;"><span>  <span style="font-weight:bold">loadBalancer</span>: {}
</span></span></code></pre></div><h2 id="部署k8s">部署K8S<a hidden class="anchor" aria-hidden="true" href="#部署k8s">#</a></h2>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#007f7f"># 在每个节点上执行如下安装操作</span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># step1: 修改网络策略</span>
</span></span><span style="display:flex;"><span>cat <span style="color:#0ff;font-weight:bold">&lt;&lt;EOF | sudo tee /etc/modules-load.d/k8s.conf
</span></span></span><span style="display:flex;"><span><span style="color:#0ff;font-weight:bold">br_netfilter
</span></span></span><span style="display:flex;"><span><span style="color:#0ff;font-weight:bold">EOF</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>cat <span style="color:#0ff;font-weight:bold">&lt;&lt;EOF | sudo tee /etc/sysctl.d/k8s.conf
</span></span></span><span style="display:flex;"><span><span style="color:#0ff;font-weight:bold">net.bridge.bridge-nf-call-ip6tables = 1
</span></span></span><span style="display:flex;"><span><span style="color:#0ff;font-weight:bold">net.bridge.bridge-nf-call-iptables = 1
</span></span></span><span style="display:flex;"><span><span style="color:#0ff;font-weight:bold">EOF</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>sudo sysctl --system
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># step2: 安装包</span>
</span></span><span style="display:flex;"><span>sudo apt-get update
</span></span><span style="display:flex;"><span>sudo apt-get install -y apt-transport-https ca-certificates curl
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>sudo mkdir -m <span style="color:#ff0;font-weight:bold">755</span> /etc/apt/keyrings
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>curl -fsSL https://pkgs.k8s.io/core:/stable:/v1.27/deb/Release.key | sudo gpg --dearmor -o /etc/apt/keyrings/kubernetes-apt-keyring.gpg
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">echo</span> <span style="color:#0ff;font-weight:bold">&#39;deb [signed-by=/etc/apt/keyrings/kubernetes-apt-keyring.gpg] https://pkgs.k8s.io/core:/stable:/v1.27/deb/ /&#39;</span> | sudo tee /etc/apt/sources.list.d/kubernetes.list
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>sudo apt-get update
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># To see the new version labels</span>
</span></span><span style="display:flex;"><span>sudo apt-cache madison kubeadm
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>sudo apt-get install -y kubelet=1.27.0-2.1 kubeadm=1.27.0-2.1 kubectl=1.27.0-2.1
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>sudo apt-mark hold kubelet kubeadm kubectl
</span></span></code></pre></div><p><a href="https://kubernetes.io/docs/setup/production-environment/tools/kubeadm/install-kubeadm/">Installing kubeadm | Kubernetes</a></p>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#007f7f"># step3: 查看kubelet版本</span>
</span></span><span style="display:flex;"><span>kubelet --version
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># step4: 使用kubeadm启动kubernetes集群</span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># step4-1: 启动controlplane</span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># 查看eth0网口ip地址</span>
</span></span><span style="display:flex;"><span>ifconfig eth0
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># 假设上一步eth0地址是192.17.132.9</span>
</span></span><span style="display:flex;"><span>kubeadm init --apiserver-cert-extra-sans=controlplane --apiserver-advertise-address 192.17.132.9 --pod-network-cidr=10.244.0.0/16
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># 或者执行如下命令</span>
</span></span><span style="display:flex;"><span>IP_ADDR=<span style="color:#fff;font-weight:bold">$(</span>ip addr show eth0 | grep -oP <span style="color:#0ff;font-weight:bold">&#39;(?&lt;=inet\s)\d+(\.\d+){3}&#39;</span><span style="color:#fff;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>kubeadm init --apiserver-cert-extra-sans=controlplane --apiserver-advertise-address $IP_ADDR --pod-network-cidr=10.244.0.0/16
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># 执行完毕后，配置kubeconfig</span>
</span></span><span style="display:flex;"><span>mkdir -p $HOME/.kube
</span></span><span style="display:flex;"><span>sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config
</span></span><span style="display:flex;"><span>sudo chown <span style="color:#fff;font-weight:bold">$(</span>id -u<span style="color:#fff;font-weight:bold">)</span>:<span style="color:#fff;font-weight:bold">$(</span>id -g<span style="color:#fff;font-weight:bold">)</span> $HOME/.kube/config
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>You should now deploy a pod network to the cluster.
</span></span><span style="display:flex;"><span>Run <span style="color:#0ff;font-weight:bold">&#34;kubectl apply -f [podnetwork].yaml&#34;</span> with one of the options listed at:
</span></span><span style="display:flex;"><span>  https://kubernetes.io/docs/concepts/cluster-administration/addons/
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Then you can join any number of worker nodes by running the following on each as root:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>kubeadm join 192.17.132.9:6443 --token b2134k.u3alyaj4iwkjhm6w <span style="color:#0ff;font-weight:bold">\
</span></span></span><span style="display:flex;"><span><span style="color:#0ff;font-weight:bold"></span>        --discovery-token-ca-cert-hash sha256:23471ecdb6d52790d13880d333fa0a667cc249297ed26faa7b75171b84157c46 
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#007f7f"># Step 4-2: 将node01加入到cluster</span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># kubeadm生成join token</span>
</span></span><span style="display:flex;"><span>kubeadm token generate
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># 或</span>
</span></span><span style="display:flex;"><span>kubeadm token create --print-join-command
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># 生成如下命令，ssh登录到node01上执行</span>
</span></span><span style="display:flex;"><span>kubeadm join 192.17.132.9:6443 --token 2uh5xs.qoh26441ba0l4du4 --discovery-token-ca-cert-hash sha256:23471ecdb6d52790d13880d333fa0a667cc249297ed26faa7b75171b84157c46
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># Step5: 安装Flannel网络</span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># 下载kube-flannel.yml</span>
</span></span><span style="display:flex;"><span>curl -LO https://raw.githubusercontent.com/flannel-io/flannel/v0.20.2/Documentation/kube-flannel.yml
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># 编辑kube-flannel.yml</span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># 定位到</span>
</span></span><span style="display:flex;"><span>  args:
</span></span><span style="display:flex;"><span>  - --ip-masq
</span></span><span style="display:flex;"><span>  - --kube-subnet-mgr
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># 添加参数</span>
</span></span><span style="display:flex;"><span>  - --iface=eth0
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>kubectl apply -f kube-flannel.yml
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># 网络创建成功后，node状态变成Ready</span>
</span></span></code></pre></div><pre tabindex="0"><code>controlplane ~ ➜  kubectl get nodes
NAME           STATUS   ROLES           AGE   VERSION
controlplane   Ready    control-plane   15m   v1.27.0
node01         Ready    &lt;none&gt;          15m   v1.27.0
</code></pre><h2 id="trouble-shooting">Trouble Shooting<a hidden class="anchor" aria-hidden="true" href="#trouble-shooting">#</a></h2>
<p>Application Failure：</p>
<ul>
<li>dns解析的service名称不对</li>
<li>service中selector没有选中工作的pod</li>
<li>service的targetPort配置错误</li>
<li>db的用户名密码错误</li>
<li>service暴露的node端口错误</li>
</ul>
<p>Control Plane Failure：</p>
<ul>
<li>kube-scheduler故障，修改/etc/kubernetes/manifests/下的yaml</li>
<li>scale无响应，查看kube-controller故障</li>
</ul>
<p>Work Node Failure:</p>
<ul>
<li>计算节点containerd服务或者kubelet服务停掉了，用systemctl命令手动启动</li>
<li><code>/var/lib/kubelet/config.yaml</code>配置文件有问题</li>
<li><code>/etc/kubernetes/kubelet.conf</code>中kube-api的端口配置</li>
</ul>
<p>Network Failure:</p>
<ul>
<li>
<p>缺少网络插件<a href="https://kubernetes.io/docs/setup/production-environment/tools/kubeadm/create-cluster-kubeadm/#pod-network">Creating a cluster with kubeadm | Kubernetes</a></p>
<p><code>curl -L https://github.com/weaveworks/weave/releases/download/latest_release/weave-daemonset-k8s-1.11.yaml | kubectl apply -f -</code></p>
</li>
<li>
<p>查看所有kube-proxy是否运行正常，查看关联的configMap是否正确，修改daemonset</p>
</li>
</ul>
<h2 id="lighting-lab">Lighting Lab<a hidden class="anchor" aria-hidden="true" href="#lighting-lab">#</a></h2>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#007f7f"># json path定义输出</span>
</span></span><span style="display:flex;"><span>kubectl get deployments.apps -n admin2406 -o custom-columns=DEPLOYMENT:.metadata.name,CONTAINER_IMAGE:.spec.template.spec.containers[*].image,READY_REPLICAS:.status.readyReplicas,NAMESPACE:.metadata.namespace --sort-by=.metadata.name
</span></span></code></pre></div><h3 id="参考">参考<a hidden class="anchor" aria-hidden="true" href="#参考">#</a></h3>
<p><a href="https://www.geeksforgeeks.org/kubectl-cheatsheet/">Kubectl Command Cheat Sheet - Learn Essential Kubernetes Commands</a></p>
<p><a href="https://www.bluematador.com/learn/kubectl-cheatsheet">Kubectl Cheatsheet | Free Cheatsheet</a></p>
<p><a href="https://training.linuxfoundation.cn/news/308">LF 认证考试攻略｜认证考试流程全介绍&ndash;购买、注册及预约考试篇（建议收藏）-Linux Foundation开源软件学园</a></p>
<p><a href="https://training.linuxfoundation.cn/certificates/1">CKA (Certified Kubernetes Administrator)</a></p>
<p><a href="https://killer.sh/dashboard">Killer Shell - Exam Simulators</a></p>
<p><a href="https://docs.linuxfoundation.org/tc-docs/certification/lf-handbook2">Linux Foundation Certification Exam: Candidate Handbook (using PSI BRIDGE Proctoring platform) - T&amp;C DOCS (Candidate Facing Resources)</a></p>
<p><a href="https://trainingportal.linuxfoundation.org/learn/course/certified-kubernetes-administrator-china-exam-cka-cn/exam/exam">考试入口Certified Kubernetes Administrator China Exam (CKA-CN) - Exam | The Linux Foundation</a></p>
<p><a href="https://www.cnblogs.com/itzgr/p/12165908.html">CKA考试心得分享 - 木二 - 博客园</a></p>
<p><a href="https://www.jianshu.com/p/135c1d618a79">CKA考试经验总结 - 简书</a></p>
<p><a href="https://kodekloud.com/topic/introduction-to-yaml-3/">Introduction to YAML - KodeKloud</a></p>
<p><a href="https://zhuanlan.zhihu.com/p/564737349">互联网最全cka真题解析-2022.9.9 - 知乎</a></p>
<p><a href="https://www.cnblogs.com/even160941/p/17710997.html">2023年CKA考试真题及注意事项 - jiayou111 - 博客园</a></p>
<p><a href="https://blog.csdn.net/zhouwenjun0820/article/details/105881669">Kubernetes CKA真题解析-20200402真题_check to see how many nodes are ready (not includi-CSDN博客</a></p>

  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="https://blog.niuhemoon.win/tags/kubernetes/">Kubernetes</a></li>
    </ul>
<div class="footer-comments">
  <p>For comments, please   <a href="mailto:carlton2tang@gmail.com" class="email-button" style="font-size: inherit; padding: 5px 10px; background-color: #3f6b9a; color: white; text-decoration: none; border-radius: 3px; transition: background-color 0.3s;">
    send an email
</a> to me</p>

</div>
<nav class="paginav">
  <a class="prev" href="https://blog.niuhemoon.win/posts/tech/pytorch-model-view/">
    <span class="title">« 上一页</span>
    <br>
    <span>Pytorch模型可视化</span>
  </a>
  <a class="next" href="https://blog.niuhemoon.win/posts/tech/text2sql-prompt-engineering/">
    <span class="title">下一页 »</span>
    <br>
    <span>text2sql Prompt 调优笔记</span>
  </a>
</nav>

  </footer>
</article>
    </main>
    
<footer class="footer">
      
    <span>&copy; 2024 <a href="https://blog.niuhemoon.win">Niuhe&#39;s Blog</a></span>
    <span xmlns:cc="http://creativecommons.org/ns#" xmlns:dct="http://purl.org/dc/terms/">
        Licensed under
        <a
          href="http://creativecommons.org/licenses/by-nc-sa/4.0/?ref=chooser-v1"
          target="_blank"
          rel="license noopener noreferrer"
          style="display:inline-block;"
          >CC BY-NC-SA 4.0 </a></span>
    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = '📄复制';

        function copyingDone() {
            copybutton.innerHTML = '👌🏻已复制!';
            setTimeout(() => {
                copybutton.innerHTML = '📄复制';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
