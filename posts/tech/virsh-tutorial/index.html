<!DOCTYPE html>
<html lang="zh" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>Virshå‘½ä»¤å’Œè™šæ‹Ÿæœº | Niuhe&#39;s Blog</title>
<meta name="keywords" content="KVM, Openstack">
<meta name="description" content="è™šæ‹Ÿæœºç”Ÿå‘½å‘¨æœŸå’ŒvirshåŸºæœ¬å‘½ä»¤è¡Œæ“ä½œï¼ŒåŒ…å«cpuã€å†…å­˜å’Œå­˜å‚¨ï¼Œä¸åŒ…æ‹¬ç½‘ç»œå†…å®¹">
<meta name="author" content="
ä½œè€…:&nbsp;Niuhe">
<link rel="canonical" href="https://blog.niuhemoon.win/posts/tech/virsh-tutorial/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.bc1149f4a72aa4858d3a9f71462f75e5884ffe8073ea9d6d5761d5663d651e20.css" integrity="sha256-vBFJ9KcqpIWNOp9xRi915YhP/oBz6p1tV2HVZj1lHiA=" rel="preload stylesheet" as="style">
<script defer crossorigin="anonymous" src="/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js" integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG&#43;9vmJ0cTS&#43;ovo0FeA="
    onload="hljs.initHighlightingOnLoad();"></script>


<link rel="icon" href="https://blog.niuhemoon.win/base/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="https://blog.niuhemoon.win/base/favicon.ico">
<link rel="icon" type="image/png" sizes="32x32" href="https://blog.niuhemoon.win/base/favicon.ico">
<link rel="apple-touch-icon" href="https://blog.niuhemoon.win/base/avatar.jpeg">
<link rel="mask-icon" href="https://blog.niuhemoon.win/base/avatar.jpeg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --hljs-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript>
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
	ga('create', 'UA-116933089-1', 'auto');
	
	ga('send', 'pageview');
}
</script><meta property="og:title" content="Virshå‘½ä»¤å’Œè™šæ‹Ÿæœº" />
<meta property="og:description" content="è™šæ‹Ÿæœºç”Ÿå‘½å‘¨æœŸå’ŒvirshåŸºæœ¬å‘½ä»¤è¡Œæ“ä½œï¼ŒåŒ…å«cpuã€å†…å­˜å’Œå­˜å‚¨ï¼Œä¸åŒ…æ‹¬ç½‘ç»œå†…å®¹" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://blog.niuhemoon.win/posts/tech/virsh-tutorial/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2020-10-22T00:00:00+00:00" />
<meta property="article:modified_time" content="2020-10-22T00:00:00+00:00" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Virshå‘½ä»¤å’Œè™šæ‹Ÿæœº"/>
<meta name="twitter:description" content="è™šæ‹Ÿæœºç”Ÿå‘½å‘¨æœŸå’ŒvirshåŸºæœ¬å‘½ä»¤è¡Œæ“ä½œï¼ŒåŒ…å«cpuã€å†…å­˜å’Œå­˜å‚¨ï¼Œä¸åŒ…æ‹¬ç½‘ç»œå†…å®¹"/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "ğŸ“šæ–‡ç« ",
      "item": "https://blog.niuhemoon.win/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  3 ,
      "name": "ğŸ‘¨ğŸ»â€ğŸ’» æŠ€æœ¯",
      "item": "https://blog.niuhemoon.win/posts/tech/"
    }, 
    {
      "@type": "ListItem",
      "position":  4 ,
      "name": "Virshå‘½ä»¤å’Œè™šæ‹Ÿæœº",
      "item": "https://blog.niuhemoon.win/posts/tech/virsh-tutorial/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "Virshå‘½ä»¤å’Œè™šæ‹Ÿæœº",
  "name": "Virshå‘½ä»¤å’Œè™šæ‹Ÿæœº",
  "description": "è™šæ‹Ÿæœºç”Ÿå‘½å‘¨æœŸå’ŒvirshåŸºæœ¬å‘½ä»¤è¡Œæ“ä½œï¼ŒåŒ…å«cpuã€å†…å­˜å’Œå­˜å‚¨ï¼Œä¸åŒ…æ‹¬ç½‘ç»œå†…å®¹",
  "keywords": [
    "KVM", "Openstack"
  ],
  "articleBody": "ç¯å¢ƒæ­å»ºå’Œå‡†å¤‡ # æŸ¥çœ‹cpuæ˜¯å¦æ”¯æŒç¡¬ä»¶è™šæ‹ŸåŒ– grep -E -c \"vmx|svm\" /proc/cpuinfo sudo apt install -y qemu qemu-kvm libvirt-daemon bridge-utils virt-manager virtinst # if centos # yum install -y kvm virt-manager libvirt libvirt-python python-virtinst virt-install qemu-kvm lsmod | grep -i kvm sudo systemctl status libvirtd.service # å¦‚æœæœåŠ¡æœªå¯åŠ¨ sudo systemctl enable libvirtd --now # é…ç½®ç½‘æ¡¥ä½¿å¾—libvirtå¯ä»¥ä»å¤–éƒ¨è®¿é—® cat /etc/netplan/00-installer-config.yaml # å¯é€‰ï¼ŒGUIç®¡ç†å·¥å…· sudo apt-get install virt-manager python-spice-client-gtk ä¸‹è½½è°ƒè¯•é•œåƒï¼š ä»å®˜æ–¹åœ°å€ä¸‹è½½cirrosé•œåƒï¼Œç”¨æ¥è°ƒè¯•è™šæ‹Ÿæœºï¼Œç”¨æˆ·åå’Œå¯†ç å¦‚ä¸‹\nuser:cirros pass:cubswin:) # ä¸åŒç‰ˆæœ¬å¯†ç ä¸åŒ é€šå¸¸å°†cirrosé•œåƒæ”¾ç½®åˆ°/var/lib/libvirt/bootè·¯å¾„ä¸‹\nå¯ä»¥æŸ¥çœ‹é•œåƒä¿¡æ¯\nqemu-img info cirros-0.5.0-x86_64-disk.img è‡³æ­¤ï¼Œvrishå­¦ä¹ çš„åŸºæœ¬ç¯å¢ƒå°±æ­å»ºå®Œæˆ\nLibvirtåŸºæœ¬æ¦‚å¿µ virshå‘½ä»¤å¤§æ¦‚åˆ†ç»„\nDomain Managementï¼ˆåŸŸç®¡ç†ï¼‰ Domain Monitoringï¼ˆåŸŸç›‘æ§ï¼‰ Host and Hypervisorï¼ˆä¸»æœºåŠè™šæ‹ŸåŒ–ï¼‰ Interfaceï¼ˆç½‘å¡æ¥å£ï¼‰ Network Filterï¼ˆç½‘ç»œé˜²ç«å¢™ï¼‰ Networkingï¼ˆç½‘ç»œï¼‰ Node Deviceï¼ˆèŠ‚ç‚¹è®¾å¤‡é©±åŠ¨ï¼‰å­˜åœ¨ Secret Snapshotï¼ˆå¿«ç…§ï¼‰ Storage Poolï¼ˆå­˜å‚¨æ± æˆ–å­˜å‚¨ç­–ç•¥ï¼‰ Storage Volumeï¼ˆå­˜å‚¨å·ï¼‰ Virsh itselfï¼ˆvirsh shellè‡ªèº«ç›¸å…³ï¼‰ å®šä¹‰è¿‡çš„æˆ–è€…èƒ½å¤Ÿè¢«libvirtæ„ŸçŸ¥åˆ°çš„è™šæœºçš„é…ç½®æ–‡ä»¶éƒ½åœ¨/etc/libvirtç›®å½•ä¸‹\nè™šæ‹Ÿæœºæ–‡ä»¶å’Œå…¶å®ƒçš„ç›¸å…³æ–‡ä»¶éƒ½ä¿å­˜åœ¨ /var/lib/libvirt/ ä¸‹\né•œåƒçš„é»˜è®¤è·¯å¾„æ˜¯ /var/lib/libvirt/boot/ã€‚\nä¸Šå›¾æ—¶ä¸€ä¸ªlibvirtè™šæ‹Ÿæœºçš„ç”Ÿå‘½å‘¨æœŸå›¾ï¼Œè™šæ‹Ÿæœºåˆ†ä¸ºä¸¤ç§ï¼š\næŒä¹…æ€§çš„ çŸ­æš‚æ€§çš„ æŒä¹…æ€§è™šæ‹Ÿæœºä¼šä¸€ç›´å­˜åœ¨ï¼Œç›´åˆ°è¢«åˆ é™¤ï¼›\nçŸ­æš‚æ€§çš„è™šæ‹Ÿæœºåªæœ‰åœ¨è™šæ‹Ÿæœºè¢«å…³æœºæˆ–é‡å¯å‰å­˜åœ¨\nè™šæ‹Ÿæœºå¸¸ç”¨å‘½ä»¤ virshå’Œqemuçš„å‘½ä»¤éå¸¸å¤šï¼Œä¸‹é¢ç½—åˆ—ä¸€äº›å¸¸ç”¨çš„å‘½ä»¤\nvirsh help\t# æŸ¥çœ‹å¸®åŠ©ä¿¡æ¯ virsh version\t# æŸ¥çœ‹qemuç‰ˆæœ¬ virsh help \u003cç‰¹å®šå‘½ä»¤\u003e\t# æŸ¥çœ‹ç‰¹å®šå‘½ä»¤å¸®åŠ©ä¿¡æ¯ virsh \u003cç‰¹å®šå‘½ä»¤\u003e --help\t# æŸ¥çœ‹ç‰¹å®šå‘½ä»¤å¸®åŠ©ä¿¡æ¯ virsh nodeinfo\t# æŸ¥çœ‹å®¿ä¸»æœºä¿¡æ¯ virsh uri # æŸ¥çœ‹å½“å‰ä¸»æœºhypervisoçš„è¿æ¥è·¯å¾„ï¼› virsh connect # è¿æ¥åˆ°ç‰¹å®šhypervisor,é»˜è®¤qemu:///system virsh sysinfo\t# æŸ¥çœ‹hypervisroä¿¡æ¯ virsh start \u003cè™šæ‹Ÿæœºåç§°\u003e # å¯åŠ¨ä¸€ä¸ªä¹‹å‰å·²ç»å®šä¹‰defineè¿‡çš„è™šæ‹Ÿæœºï¼ˆdomain) virsh shutdown \u003cè™šæ‹Ÿæœºåç§°\u003e\t# å…³é—­è™šæ‹Ÿæœº,ç±»ä¼¼è™šæ‹Ÿæœºå†…æ‰§è¡Œå…³æœº virsh reboot \u003cè™šæ‹Ÿæœºåç§°\u003e\t# é‡å¯è™šæ‹Ÿæœº virsh destroy \u003cè™šæ‹Ÿæœºåç§°\u003e\t# å¼ºåˆ¶å…³é—­è™šæ‹Ÿæœºï¼Œç±»ä¼¼äºæ–­ç”µ virsh suspend \u003cè™šæ‹Ÿæœºåç§°\u003e # æŒ‚èµ·è™šæ‹Ÿæœºï¼Œå°†å½“å‰çŠ¶æ€ä¿å­˜åœ¨å†…å­˜ä¸­ virsh resume \u003cè™šæ‹Ÿæœºåç§°\u003e\t# æ¢å¤è™šæ‹ŸæœºæŒ‚èµ·çŠ¶æ€ï¼Œä»å†…å­˜ä¸­æ¢å¤è™šæ‹ŸæœºçŠ¶æ€ virsh save \u003cè™šæ‹Ÿæœºåç§°\u003e # æš‚åœè™šæ‹Ÿæœºï¼Œå°†è™šæ‹ŸæœºçŠ¶æ€ä¿å­˜åœ¨ç£ç›˜é•œåƒæ–‡ä»¶ä¸­ virsh restore #é‡æ–°è½½å…¥æš‚åœçš„è™šæ‹Ÿæœº virsh autostart \u003cè™šæ‹Ÿæœºåç§°\u003e\t# è™šæ‹Ÿæœºéšç€ç‰©ç†æœºå¯åŠ¨è‡ªåŠ¨å¯åŠ¨ virsh autostart \u003cè™šæ‹Ÿæœºåç§°\u003e --disable\t# ç¦æ­¢å¼€æœºå¯åŠ¨ virsh dominfo \u003cè™šæ‹Ÿæœºåç§°\u003e\t# æŸ¥çœ‹è™šæ‹Ÿæœºdomainä¿¡æ¯ virsh domblklist \u003cè™šæ‹Ÿæœºåç§°\u003e\t# åˆ—å‡ºè™šæ‹Ÿæœºæ‰€æœ‰å—å­˜å‚¨è®¾å¤‡ virsh console \u003cè™šæ‹Ÿæœºåç§°\u003e\t# æ§åˆ¶å°è¿æ¥è™šæ‹Ÿæœº virsh dumpxml \u003cè™šæ‹Ÿæœºåç§°\u003e\t# æŸ¥çœ‹è™šæ‹Ÿæœºxmlæ–‡ä»¶ virsh edit \u003cè™šæ‹Ÿæœºåç§°\u003e\t# ç¼–è¾‘è™šæ‹Ÿæœºxmlæ–‡ä»¶ virsh managedsave \u003cè™šæ‹Ÿæœºåç§°\u003e\t# ä¿å­˜çŠ¶æ€saveå¹¶å…³é—­è™šæ‹Ÿæœºï¼Œä¸‹æ¬¡å¯åŠ¨ä¼šæ¢å¤åˆ°ä¹‹å‰ä¿å­˜çš„çŠ¶æ€ virsh start \u003cè™šæ‹Ÿæœºåç§°\u003e\t# å¯åŠ¨å¹¶æ¢å¤managedsaveä¿å­˜çš„çŠ¶æ€ virsh reset \u003cè™šæ‹Ÿæœºåç§°\u003e\t# å¯¹è™šæ‹Ÿæœºæ‰§è¡Œå¼ºåˆ¶é‡å¯ï¼Œç±»ä¼¼é‡ç½®ç”µæºæŒ‰é’® virsh create \u003cè™šæ‹Ÿæœºxmlæ–‡ä»¶\u003e # ä»xmlæ–‡ä»¶ä¸­åˆ›å»ºdomainï¼Œåˆ›å»ºå®Œæˆåä¼šè‡ªåŠ¨å¯åŠ¨ï¼› # ä¸€ä¸ªxmlå¯¹åº”ä¸€ä¸ªdomainè™šæ‹Ÿæœº virsh define \u003cè™šæ‹Ÿæœºxmlæ–‡ä»¶\u003e\t# ä»xmlæ–‡ä»¶å®šä¹‰defineæ–°çš„domainï¼Œä¸ä¼šè‡ªåŠ¨å¯åŠ¨ virsh undefine \u003cè™šæ‹Ÿæœºåç§°\u003e\t# å¯¹äºè¿è¡Œä¸­çš„æŒä¹…æ€§è™šæ‹Ÿæœºï¼Œå°†çŠ¶æ€è½¬æ¢ä¸ºæš‚æ—¶çš„ï¼Œå…³æœºåvirshæ— æ³•æ„ŸçŸ¥å…¶å­˜åœ¨ # å¯¹äºéæ´»åŠ¨çš„è™šæ‹Ÿæœºï¼Œundefineåvirshå°†æ— æ³•æ„ŸçŸ¥å…¶å­˜åœ¨ # undefineåç£ç›˜ä¾ç„¶å­˜åœ¨ï¼Œåªæ˜¯åˆ é™¤è™šæ‹Ÿæœºçš„é…ç½®æ–‡ä»¶/etc/libvirt/qemu virsh undefine \u003cè™šæ‹Ÿæœºåç§°\u003e --remove-all-storage\t# åˆ é™¤è™šæ‹Ÿæœºå¹¶åˆ é™¤æ‰€æœ‰ç£ç›˜æ–‡ä»¶ virsh snapshot-create-as \u003cè™šæ‹Ÿæœºåç§°\u003e --name \u003cå¿«ç…§åç§°\u003e # ä»å‘½ä»¤è¡Œåˆ›å»ºå¿«ç…§ virsh snapshot-create \u003cè™šæ‹Ÿæœºåç§°\u003e\t# ä»xmlæ–‡ä»¶åˆ›å»ºå¿«ç…§ virsh snapshot-list \u003cè™šæ‹Ÿæœºåç§°\u003e\t# æŸ¥çœ‹è™šæ‹Ÿæœºå¿«ç…§åˆ—è¡¨ virsh snapshot-parent \u003cè™šæ‹Ÿæœºåç§°\u003e --current\t# æŸ¥çœ‹å½“å‰å¿«ç…§çš„ä¸Šä¸€çº§å¿«ç…§ virsh snapshot-edit \u003cè™šæ‹Ÿæœºåç§°\u003e --snapshotname \u003cå¿«ç…§å\u003e\t# ç¼–è¾‘å¿«ç…§ virsh snapshot-revert \u003cè™šæ‹Ÿæœºåç§°\u003e --snapshotname \u003cå¿«ç…§å\u003e\t# æ¢å¤å¿«ç…§ virsh snapshot-delete \u003cè™šæ‹Ÿæœºåç§°\u003e --snapshotname \u003cå¿«ç…§å\u003e\t# åˆ é™¤å¿«ç…§ virsh list\t# æŸ¥çœ‹æ´»åŠ¨è™šæ‹ŸæœºçŠ¶æ€ virsh list --all\t# æŸ¥çœ‹æ‰€æœ‰è™šæ‹ŸæœºçŠ¶æ€ virsh setvcpus \u003cè™šæ‹Ÿæœºåç§°\u003e 4 --maximum --config # è®¾ç½®æœ€å¤§vcpuæ•°ï¼ˆåªèƒ½ç”¨--configï¼Œä¸‹æ¬¡è¿è¡Œç”Ÿæ•ˆï¼‰ virsh setvcpus \u003cè™šæ‹Ÿæœºåç§°\u003e 4 --config # ä¸‹æ¬¡å¯åŠ¨ä½¿ç”¨vcpuæ•° virsh vcpuinfo \u003cè™šæ‹Ÿæœºåç§°\u003e # æŸ¥çœ‹vcpuä¿¡æ¯ virsh vcpupin \u003cè™šæ‹Ÿæœºåç§°\u003e\t# æŸ¥è¯¢åŸŸ vcpuäº²å’Œæ€§,å³vcpuå’Œç‰©ç†cpuä¹‹é—´å…³ç³» virsh maxvcpus\t# æ˜¾ç¤ºæœ¬æœºvcpuæœ€å¤§å€¼ virsh setmaxmem \u003cè™šæ‹Ÿæœºåç§°\u003e [--size] 2G --current # è®¾ç½®æœ€å¤§å†…å­˜é™åˆ¶å€¼ virsh setmem \u003cè™šæ‹Ÿæœºåç§°\u003e [--size] 2G --current # è®¾ç½®å†…å­˜åˆ†é… virsh domblklist cirros\t# æŸ¥çœ‹è™šæ‹Ÿæœºçš„å­˜å‚¨å—è®¾å¤‡ åˆ›å»ºç£ç›˜æ–‡ä»¶ #qcow2æ˜¯æ–‡ä»¶ç±»å‹ï¼Œtest1-add1.qcow2æ˜¯ç£ç›˜æ–‡ä»¶ï¼Œ5Gæ˜¯å¤§å° qemu-img create -f qcow2 /var/lib/libvirt/images/test1-add1.qcow2 5G qemu-img info \u003cè™šæ‹Ÿæœºé•œåƒ\u003e\t# æŸ¥çœ‹é•œåƒä¿¡æ¯ virt-install \u003cå‘½ä»¤è¡Œ\u003e # é€šè¿‡å‘½ä»¤è¡ŒæŒ‡å®šæ¥åˆ›å»ºè™šæ‹Ÿæœº virsh attach-disk \u003cè™šæ‹Ÿæœºåç§°\u003e virsh attach-device \u003cè™šæ‹Ÿæœºåç§°\u003e /etc/libvirt/qemu/test2-add.xml --persistent\t# ä»XMLæ–‡ä»¶é™„åŠ è®¾å¤‡ virsh detach-device \u003cè™šæ‹Ÿæœºåç§°\u003e /etc/libvirt/qemu/test2-add.xml --persistent\t# å¸è½½è®¾å¤‡ è™šæ‹Ÿæœºæ“ä½œå®è·µ å®éªŒ1ï¼šä¿®æ”¹è™šæ‹Ÿæœºvcpu ä¿®æ”¹è™šæ‹Ÿæœºçš„æœ€å¤§vcpuæ•°é‡ï¼Œå¯ä»¥ä¿®æ”¹maximum config å’Œcurrent configçš„å€¼\n# æŸ¥çœ‹vcpué…ç½® âœ ~ virsh vcpucount cirros maximum config 2\t# æŒ‡å®šä¸‹æ¬¡é‡å¯è™šæ‹Ÿæœºåå¯ç”¨çš„æœ€å¤§vcpuæ•°é‡ maximum live 2\t# æŒ‡å®šè¿è¡Œ/æš‚åœçŠ¶æ€ä¸‹è™šæ‹Ÿæœºå¯ç”¨çš„æœ€å¤§vcpuæ•°é‡,é‡å¯åå’Œmaximum configä¸€è‡´ current config 2\t# ä¸‹æ¬¡é‡å¯æ—¶è™šæ‹Ÿæœºä½¿ç”¨çš„vcpuæ•°é‡ current live 2\t# æ­£åœ¨è¿è¡Œçš„è™šæ‹Ÿæœºvcpuå®é™…æ•°é‡ é€šè¿‡ä¿®æ”¹xmlæ–‡ä»¶ä¿®æ”¹vcpuæ•°é‡\nvirsh edit cirros # 2 # ä¿®æ”¹ä¸º 'static'\u003e3 å…³é—­å¹¶é‡æ–°å¯åŠ¨è™šæ‹Ÿæœº\nvirsh shutdown cirros virsh list --all # ç¡®è®¤å·²ç»æ˜¯shut offçŠ¶æ€ virsh start cirros å†æ¬¡æŸ¥çœ‹vcpuæ•°é‡ï¼Œå‘ç°å·²ç»æ”¹å˜\nâœ ~ virsh vcpucount cirros maximum config 3 maximum live 3 current config 3 current live 3 åŒæ ·æ–¹å¼ï¼Œä¿®æ”¹xmlæ–‡ä»¶ï¼Œæ¢å¤ä¸º2ä¸ªvcpuï¼Œæ‰§è¡Œvirsh reboot åå¹¶æ²¡é‡Šæ”¾vcpu\nâœ ~ virsh vcpucount cirros maximum config 2 maximum live 3 current config 2 current live 3 å¿…é¡»æ‰§è¡Œshutdownæˆ–è€…destoryï¼Œç„¶åé‡æ–°startæ‰èƒ½æ”¹å˜è¿è¡Œæ—¶çš„vcpu\nâœ ~ virsh vcpucount cirros maximum config 2 maximum live 2 current config 2 current live 2 è¿˜å¯ä»¥é€šè¿‡å‘½ä»¤è¡Œä¿®æ”¹vcpuçš„å„ä¸ªé…ç½®å€¼\nâœ ~ virsh setvcpus cirros 3 --maximum --config âœ ~ virsh vcpucount cirros maximum config 3 maximum live 2 current config 2 current live 2 âœ ~ virsh setvcpus cirros 3 --config # ä¿®æ”¹current config âœ ~ virsh vcpucount cirros maximum config 3 maximum live 2 current config 3 current live 2 # é‡å¯è™šæ‹Ÿæœºä½¿å…¶ç”Ÿæ•ˆ âœ ~ virsh shutdown cirros âœ ~ virsh start cirros âœ ~ virsh vcpucount cirros maximum config 3 maximum live 3 current config 3 current live 3 åœ¨å®¿ä¸»æœºä¸Šæ— æ³•è®¾ç½®vcpuçš„current liveå°äºcurrent configï¼Œåªèƒ½åœ¨è™šæ‹Ÿæœºå†…éƒ¨æ‰§è¡ŒchcpuæŒ‡ä»¤æ¥ä¿®æ”¹ï¼Œä½¿å¾—vcpuç¦»çº¿\nä¹Ÿå¯ä»¥å°†æœ€å¤§å¯ç”¨vcpuè®¾ç½®è¾ƒå¤§ï¼Œæ–¹ä¾¿åç»­åœ¨è™šæ‹Ÿæœºè¿è¡Œæ—¶å¯ä»¥åŠ¨æ€è°ƒæ•´vcpuçš„æ•°é‡\nâœ ~ virsh setvcpus cirros 5 --maximum --config âœ ~ virsh setvcpus cirros 2 --config âœ ~ virsh shutdown cirros âœ ~ virsh start cirros âœ ~ virsh vcpucount cirros maximum config 5 maximum live 5 current config 2 current live 2 âœ ~ virsh setvcpus cirros 3\t# åŠ¨æ€è°ƒæ•´vcpuæ•°é‡ï¼Œè°ƒæ•´èŒƒå›´[current configï¼Œæ¯”maximum config] âœ ~ virsh vcpucount cirros maximum config 5 maximum live 5 current config 2 current live 3 âœ ~ virsh setvcpus cirros 2\tâœ ~ virsh vcpucount cirros maximum config 5 maximum live 5 current config 2 current live 2 âœ ~ virsh vcpuinfo cirros\t# æŸ¥çœ‹vcpuè¿è¡ŒçŠ¶æ€ å®éªŒ2ï¼šä¿®æ”¹è™šæ‹Ÿæœºçš„å†…å­˜ é€šè¿‡ä¿®æ”¹xmlé…ç½®æ–‡ä»¶å¹¶é‡æ–°å¯åŠ¨è™šæ‹Ÿæœº\n# ä¿®æ”¹é¡¹ï¼Œä¿®æ”¹å®Œæˆå 'KiB'\u003e462144\t# å¯åŠ¨åæœ€å¤§å…è®¸å¯ç”¨å†…å­˜ 'KiB'\u003e262144# å¯åŠ¨æ—¶ä½¿ç”¨çš„å†…å­˜å¤§å° åœ¨æœ€å¤§å¯ç”¨å†…å­˜èŒƒå›´å†…ï¼Œå¯ä»¥åœ¨è™šæ‹Ÿæœºè¿è¡Œæ—¶è°ƒæ•´å†…å­˜ä½¿ç”¨\nè™šæ‹Ÿæœºæœ€å¤§å†…å­˜åªèƒ½åœ¨è™šæ‹Ÿæœºå…³é—­çŠ¶æ€æ›´æ”¹ï¼Œé‡å¯åç”Ÿæ•ˆ\nä½¿ç”¨virsh setmaxmemå‘½ä»¤ï¼Œå’Œç›´æ¥ä¿®æ”¹xmlæ–‡ä»¶ç­‰æ•ˆ\nâœ ~ virsh dominfo cirros | grep memory # è™šæ‹Ÿæœºå¯åŠ¨æ—¶æ˜¾ç¤ºçš„used memoryä¸å‡†ç¡® Max memory: 462144 KiB Used memory: 262144 KiB âœ ~ virsh setmem cirros 300000 âœ ~ virsh dominfo cirros | grep memory Max memory: 462144 KiB Used memory: 300000 KiB âœ ~ virsh shutdown cirros âœ ~ virsh setmaxmem cirros 700000 å®éªŒ3ï¼šè°ƒæ•´è™šæ‹Ÿæœºçš„ç£ç›˜ è™šæ‹Ÿæœºæ”¯æŒåœ¨è™šæ‹Ÿæœºå¼€æœºæ—¶åŠ¨æ€æŒ‚è½½æ–°çš„ç£ç›˜\nâœ ~ qemu-img create -f qcow2 -o size=20M,preallocation=metadata /var/lib/libvirt/boot/second.qcow2 Formatting '/var/lib/libvirt/boot/second.qcow2', fmt=qcow2 size=20971520 cluster_size=65536 preallocation=metadata lazy_refcounts=off refcount_bits=16 âœ ~ qemu-img info /var/lib/libvirt/boot/second.qcow2 image: /var/lib/libvirt/boot/second.qcow2 file format: qcow2 virtual size: 20 MiB (20971520 bytes) disk size: 260 KiB cluster_size: 65536 Format specific information: compat: 1.1 lazy refcounts: false refcount bits: 16 corrupt: false virsh attach-disk cirros /images/cirros/second.qcow2 vda --targetbus virtio # å¸è½½ç£ç›˜ï¼ˆå‰ææ—¶æ²¡æœ‰åˆ†åŒºæˆ–è€…æŒ‚è½½ virsh detach-disk 26 vda ä¹Ÿå¯ä»¥æ‰‹åŠ¨ä¿®æ”¹xmlæ–‡ä»¶ï¼Œç„¶åé‡å¯è™šæ‹Ÿæœº\n# é¦–å…ˆåˆ›å»ºä¸€ä¸ªqcow2ç£ç›˜æˆ–è€…rawç£ç›˜ # ddå‘½ä»¤åˆ›å»ºä¸€ä¸ªéç¨€ç–çš„ç£ç›˜ dd if=/dev/zero of=/vm-images/vm1-add.img bs=1M count=1024 # åœ¨xmlæ–‡ä»¶ä¸­åŠ å…¥ä¸€ä¸ªæ–°çš„xmlæ®µ 'file' device='disk'\u003e 'qemu' type='raw' cache='none' io='threads'/\u003e \u003csource file='/vm-images/vm1-add.img'/\u003e 'vdb' bus='virtio'/\u003e 'pci' domain='0x0000' bus='0x00' slot='0x06' function='0x0'/\u003e å®éªŒ4ï¼šåˆ›å»ºè™šæ‹Ÿæœº virt-install --name=cirros --ram=256 --vcpus=1 --disk path=/var/lib/libvirt/boot/cirros-0.5.0-x86_64-disk.img,format=qcow2 --import --network network:default --vnc --vncport=5920 # ä¹Ÿå¯ä»¥é€šè¿‡xmlæ–‡ä»¶æ¥åˆ›å»º å®éªŒ5ï¼šå¤åˆ¶è™šæ‹Ÿæœº å¯ä»¥é€šè¿‡å‘½ä»¤è¡Œå¤åˆ¶ä¸€ä¸ªè™šæ‹Ÿæœºï¼Œä¹Ÿå¯ä»¥é€šè¿‡æ‹·è´å¹¶ä¿®æ”¹é…ç½®æ–‡ä»¶å’Œå­˜å‚¨å·æ–‡ä»¶è¿›è¡Œå¤åˆ¶\n# é€šè¿‡virt-cloneå‘½ä»¤å¤åˆ¶ # virt-clone -o \u003cè™šæ‹Ÿæœºåç§°\u003e -n \u003cæ–°è™šæ‹Ÿæœºåç§°\u003e -f /var/lib/libvirt/images/test4.qcow2 # qcow2ç£ç›˜ä¸éœ€è¦é¢„å…ˆåˆ›å»ºï¼Œåˆ›å»ºå®Œæˆåéœ€è¦è¿›è™šæ‹Ÿæœºæ‰‹åŠ¨æ”¹å˜ipåœ°å€å’Œç”¨æˆ·å âœ ~ virt-clone -o cirros -n cirros1 -f /var/lib/libvirt/boot/cirros1.qcow2 # è‡ªåŠ¨ç”Ÿäº§ä¸ä¸€æ ·çš„macåœ°å€å’Œuuid âœ ~ diff cirros.xml cirros1.xml \u003c cirros \u003c 874fe199-47ea-45d1-a25d-98d0535dddb3 --- \u003e cirros1 \u003e fba2f776-432d-4870-a7ec-bbf73fa1b086 39c39 \u003c \u003csource file='/var/lib/libvirt/boot/cirros-0.5.0-x86_64-disk.img'/\u003e --- \u003e \u003csource file='/var/lib/libvirt/boot/cirros1.qcow2'/\u003e 63c63 \u003c '52:54:00:fa:5c:d3'/\u003e --- \u003e '52:54:00:29:8d:06'/\u003e 81c81 \u003c 'vnc' port='5921' autoport='no'\u003e --- \u003e 'vnc' port='-1' autoport='yes'\u003e #virt-clone -fæŒ‡å®šçš„æ–‡ä»¶ä¸è¦äº‹å…ˆåˆ›å»ºï¼Œå¦‚æœæœ‰å¤šä¸ªç£ç›˜æ–‡ä»¶å°±ç”¨å¤šä¸ª-fé€‰é¡¹ å¦‚ virt-clone -o \u003cè™šæ‹Ÿæœºåç§°\u003e -n \u003cæ–°è™šæ‹Ÿæœºåç§°\u003e -f /home/lib/libvirt/images/test4.qcow2 -f /mnt/images/test4-add1.qcow2 å¯ä»¥æ‰‹åŠ¨å¤åˆ¶xmlæ–‡ä»¶å’Œç£ç›˜é•œåƒæ¥å¤åˆ¶\nâœ qemu cp cirros.xml cirros3.xml # ä¿®æ”¹xmlæ–‡ä»¶ä¸­çš„domain nameå’Œmacåœ°å€ç­‰ä¿¡æ¯ âœ qemu vim cirros3.xml âœ qemu cd /var/lib/libvirt/boot # åœ¨defineæ–°çš„å…‹éš†è™šæ‹Ÿæœºä¹‹å‰å‡†å¤‡å¥½æ‰€éœ€çš„ç£ç›˜ âœ boot cp cirros-0.5.0-x86_64-disk.img cirros3.img âœ boot qemu-img info cirros3.img image: cirros3.img file format: qcow2 virtual size: 112 MiB (117440512 bytes) disk size: 198 MiB cluster_size: 65536 Snapshot list: ID TAG VM SIZE DATE VM CLOCK 1 1603292226 101 MiB 2020-10-21 22:57:06 94:39:31.435 Format specific information: compat: 1.1 lazy refcounts: false refcount bits: 16 corrupt: false âœ ~ virsh define /etc/libvirt/qemu/cirros3.xml Domain cirros3 defined from /etc/libvirt/qemu/cirros3.xml âœ ~ virsh list --all Id Name State -------------------------- 2 cirros running - cirros3 shut off âœ ~ virsh start cirros3 Domain cirros3 started # æ­¤æ—¶ï¼Œä¸€ä¸ªæ–°çš„å…‹éš†è™šæ‹Ÿæœºå°±åˆ›å»ºå®Œæˆ # éœ€è¦æ‰‹åŠ¨ä¿®æ”¹IPå’Œhostname å®éªŒ6ï¼šè¯¯åˆ è™šæ‹Ÿæœºæ¢å¤ # è¯¯åˆ é™¤è™šæ‹Ÿæœº âœ ~ virsh undefine cirros1 Domain cirros1 has been undefined âœ ~ virsh dominfo cirros1 Id: 1 Name: cirros1 UUID: fba2f776-432d-4870-a7ec-bbf73fa1b086 OS Type: hvm State: running CPU(s): 2 CPU time: 41.7s Max memory: 700416 KiB Used memory: 262144 KiB Persistent: no\t# å·²ç»å˜ä¸ºéæŒä¹…åŒ–çš„ï¼Œæ— æ³•é‡æ–°å¯åŠ¨ Autostart: disable Managed save: no Security model: apparmor Security DOI: 0 Security label: libvirt-fba2f776-432d-4870-a7ec-bbf73fa1b086 (enforcing) âœ ~ virsh shutdown cirros1 # å…³æœºåå†ä¹Ÿå¯åŠ¨ä¸äº†äº† âœ ~ ls /etc/libvirt/qemu # cirros1çš„xmlæ–‡ä»¶å·²ç»ä¸å­˜åœ¨ âœ ~ ls /var/lib/libvirt/boot # cirros1çš„qcow2é•œåƒä»ç„¶å­˜åœ¨ # éœ€è¦åœ¨å…³é—­è™šæ‹Ÿæœºä¹‹å‰ï¼Œé‡æ–°å®šä¹‰defineä¸€ä¸ªé…ç½®æ–‡ä»¶å³å¯æ¢å¤ virsh dumpxml centos-C \u003e /etc/libvirt/qemu/centos-C.xml virsh define /etc/libvirt/qemu/centos-C.xml # å¦‚æœæ˜¯åœ¨å…³é—­ç€çš„æœåŠ¡å™¨ä¸Šæ‰§è¡Œçš„virsh undefine centos-C åˆ é™¤å‘½ä»¤ï¼Œåˆ™ä¼šæŠŠå¯¹åº”çš„é…ç½®æ–‡ä»¶æ¸…ç©ºï¼Œè™šæ‹Ÿæœºå†ä¹Ÿå¯åŠ¨ä¸äº†ï¼Œé‡æ–°å®šä¹‰ä¹Ÿä¸è¡Œ å¯¹äº å‚è€ƒ åœ¨ Ubuntu çš„ KVM ä¸­å®‰è£… Windows ç³»ç»Ÿ\nvirshä½¿ç”¨æ€»ç»“\nkvmç®¡ç†å’ŒåŸºç¡€å‘½ä»¤\nkvmå‘½ä»¤æ€»ç»“å’Œè™šæœºå™¨å¤‡ä»½è¿ç§»\nHow to Install KVM on Ubuntu 20.04 LTS Server (Focal Fossa)\nLibvirtè™šæ‹Ÿæœºç”Ÿå‘½å‘¨æœŸ\nModify cpu number ",
  "wordCount" : "4338",
  "inLanguage": "zh",
  "datePublished": "2020-10-22T00:00:00Z",
  "dateModified": "2020-10-22T00:00:00Z",
  "author":{
    "@type": "Person",
    "name": "Niuhe"
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://blog.niuhemoon.win/posts/tech/virsh-tutorial/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Niuhe's Blog",
    "logo": {
      "@type": "ImageObject",
      "url": "https://blog.niuhemoon.win/base/favicon.ico"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://blog.niuhemoon.win" accesskey="h" title="Niuhe&#39;s Blog (Alt + H)">
                <img src="https://blog.niuhemoon.win/base/avatar.jpeg" alt="" aria-label="logo"
                    height="35">Niuhe&#39;s Blog</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="https://blog.niuhemoon.win/search" title="ğŸ”æœç´¢ (Alt &#43; /)" accesskey=/>
                    <span>ğŸ”æœç´¢</span>
                </a>
            </li>
            <li>
                <a href="https://blog.niuhemoon.win/" title="ğŸ ä¸»é¡µ">
                    <span>ğŸ ä¸»é¡µ</span>
                </a>
            </li>
            <li>
                <a href="https://blog.niuhemoon.win/posts" title="ğŸ“šæ–‡ç« ">
                    <span>ğŸ“šæ–‡ç« </span>
                </a>
            </li>
            <li>
                <a href="https://blog.niuhemoon.win/archives/" title="â±æ—¶é—´è½´">
                    <span>â±æ—¶é—´è½´</span>
                </a>
            </li>
            <li>
                <a href="https://blog.niuhemoon.win/tags" title="ğŸ”–æ ‡ç­¾">
                    <span>ğŸ”–æ ‡ç­¾</span>
                </a>
            </li>
            <li>
                <a href="https://blog.niuhemoon.win/about" title="ğŸ™‹ğŸ»â€â™‚ï¸å…³äº">
                    <span>ğŸ™‹ğŸ»â€â™‚ï¸å…³äº</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="https://blog.niuhemoon.win">ğŸ ä¸»é¡µ</a>&nbsp;Â»&nbsp;<a href="https://blog.niuhemoon.win/posts/">ğŸ“šæ–‡ç« </a>&nbsp;Â»&nbsp;<a href="https://blog.niuhemoon.win/posts/tech/">ğŸ‘¨ğŸ»â€ğŸ’» æŠ€æœ¯</a></div>
    <h1 class="post-title">
      Virshå‘½ä»¤å’Œè™šæ‹Ÿæœº
    </h1>
    <div class="post-description">
      è™šæ‹Ÿæœºç”Ÿå‘½å‘¨æœŸå’ŒvirshåŸºæœ¬å‘½ä»¤è¡Œæ“ä½œï¼ŒåŒ…å«cpuã€å†…å­˜å’Œå­˜å‚¨ï¼Œä¸åŒ…æ‹¬ç½‘ç»œå†…å®¹
    </div>
    <div class="post-meta"><span title='2020-10-22 00:00:00 +0000 UTC'>åˆ›å»º: 2020-10-22</span>&nbsp;|&nbsp;æ›´æ–°:&nbsp;2020-10-22&nbsp;|&nbsp;å­—æ•°:&nbsp;4338å­—&nbsp;|&nbsp;æ—¶é•¿:&nbsp;9åˆ†é’Ÿ&nbsp;|&nbsp;
ä½œè€…:&nbsp;Niuhe<span id="busuanzi_container_page_pv">
    &nbsp;|&nbsp;æœ¬æ–‡è®¿é—®é‡: <span id="busuanzi_value_page_pv"></span>æ¬¡
</span>

</div>
  </header> <div class="toc">
    <details  open>
        <summary accesskey="c" title="(Alt + C)">
            <span class="details">æ–‡ç« ç›®å½•</span>
        </summary>

        <div class="inner"><ul>
                <li>
                    <a href="#%e7%8e%af%e5%a2%83%e6%90%ad%e5%bb%ba%e5%92%8c%e5%87%86%e5%a4%87" aria-label="ç¯å¢ƒæ­å»ºå’Œå‡†å¤‡">ç¯å¢ƒæ­å»ºå’Œå‡†å¤‡</a></li>
                <li>
                    <a href="#libvirt%e5%9f%ba%e6%9c%ac%e6%a6%82%e5%bf%b5" aria-label="LibvirtåŸºæœ¬æ¦‚å¿µ">LibvirtåŸºæœ¬æ¦‚å¿µ</a></li>
                <li>
                    <a href="#%e8%99%9a%e6%8b%9f%e6%9c%ba%e5%b8%b8%e7%94%a8%e5%91%bd%e4%bb%a4" aria-label="è™šæ‹Ÿæœºå¸¸ç”¨å‘½ä»¤">è™šæ‹Ÿæœºå¸¸ç”¨å‘½ä»¤</a></li>
                <li>
                    <a href="#%e8%99%9a%e6%8b%9f%e6%9c%ba%e6%93%8d%e4%bd%9c%e5%ae%9e%e8%b7%b5" aria-label="è™šæ‹Ÿæœºæ“ä½œå®è·µ">è™šæ‹Ÿæœºæ“ä½œå®è·µ</a><ul>
                        
                <li>
                    <a href="#%e5%ae%9e%e9%aa%8c1%e4%bf%ae%e6%94%b9%e8%99%9a%e6%8b%9f%e6%9c%bavcpu" aria-label="å®éªŒ1ï¼šä¿®æ”¹è™šæ‹Ÿæœºvcpu">å®éªŒ1ï¼šä¿®æ”¹è™šæ‹Ÿæœºvcpu</a></li>
                <li>
                    <a href="#%e5%ae%9e%e9%aa%8c2%e4%bf%ae%e6%94%b9%e8%99%9a%e6%8b%9f%e6%9c%ba%e7%9a%84%e5%86%85%e5%ad%98" aria-label="å®éªŒ2ï¼šä¿®æ”¹è™šæ‹Ÿæœºçš„å†…å­˜">å®éªŒ2ï¼šä¿®æ”¹è™šæ‹Ÿæœºçš„å†…å­˜</a></li>
                <li>
                    <a href="#%e5%ae%9e%e9%aa%8c3%e8%b0%83%e6%95%b4%e8%99%9a%e6%8b%9f%e6%9c%ba%e7%9a%84%e7%a3%81%e7%9b%98" aria-label="å®éªŒ3ï¼šè°ƒæ•´è™šæ‹Ÿæœºçš„ç£ç›˜">å®éªŒ3ï¼šè°ƒæ•´è™šæ‹Ÿæœºçš„ç£ç›˜</a></li>
                <li>
                    <a href="#%e5%ae%9e%e9%aa%8c4%e5%88%9b%e5%bb%ba%e8%99%9a%e6%8b%9f%e6%9c%ba" aria-label="å®éªŒ4ï¼šåˆ›å»ºè™šæ‹Ÿæœº">å®éªŒ4ï¼šåˆ›å»ºè™šæ‹Ÿæœº</a></li>
                <li>
                    <a href="#%e5%ae%9e%e9%aa%8c5%e5%a4%8d%e5%88%b6%e8%99%9a%e6%8b%9f%e6%9c%ba" aria-label="å®éªŒ5ï¼šå¤åˆ¶è™šæ‹Ÿæœº">å®éªŒ5ï¼šå¤åˆ¶è™šæ‹Ÿæœº</a></li>
                <li>
                    <a href="#%e5%ae%9e%e9%aa%8c6%e8%af%af%e5%88%a0%e8%99%9a%e6%8b%9f%e6%9c%ba%e6%81%a2%e5%a4%8d" aria-label="å®éªŒ6ï¼šè¯¯åˆ è™šæ‹Ÿæœºæ¢å¤">å®éªŒ6ï¼šè¯¯åˆ è™šæ‹Ÿæœºæ¢å¤</a></li></ul>
                </li>
                <li>
                    <a href="#%e5%8f%82%e8%80%83" aria-label="å‚è€ƒ">å‚è€ƒ</a>
                </li>
            </ul>
        </div>
    </details>
</div>

  <div class="post-content"><h3 id="ç¯å¢ƒæ­å»ºå’Œå‡†å¤‡">ç¯å¢ƒæ­å»ºå’Œå‡†å¤‡<a hidden class="anchor" aria-hidden="true" href="#ç¯å¢ƒæ­å»ºå’Œå‡†å¤‡">#</a></h3>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span> <span style="color:#007f7f"># æŸ¥çœ‹cpuæ˜¯å¦æ”¯æŒç¡¬ä»¶è™šæ‹ŸåŒ–</span>
</span></span><span style="display:flex;"><span> grep -E -c <span style="color:#0ff;font-weight:bold">&#34;vmx|svm&#34;</span> /proc/cpuinfo
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span> sudo apt install -y qemu qemu-kvm libvirt-daemon bridge-utils virt-manager virtinst
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># if centos</span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># yum install -y kvm virt-manager libvirt libvirt-python python-virtinst virt-install qemu-kvm</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span> lsmod | grep -i kvm
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span> sudo systemctl status libvirtd.service
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span> <span style="color:#007f7f"># å¦‚æœæœåŠ¡æœªå¯åŠ¨</span>
</span></span><span style="display:flex;"><span> sudo systemctl <span style="color:#fff;font-weight:bold">enable</span> libvirtd --now
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span> <span style="color:#007f7f"># é…ç½®ç½‘æ¡¥ä½¿å¾—libvirtå¯ä»¥ä»å¤–éƒ¨è®¿é—®</span>
</span></span><span style="display:flex;"><span> cat /etc/netplan/00-installer-config.yaml
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span> <span style="color:#007f7f"># å¯é€‰ï¼ŒGUIç®¡ç†å·¥å…·</span>
</span></span><span style="display:flex;"><span> sudo apt-get install virt-manager python-spice-client-gtk
</span></span><span style="display:flex;"><span> 
</span></span></code></pre></div><blockquote>
<p>ä¸‹è½½è°ƒè¯•é•œåƒï¼š
ä»<a href="https://download.cirros-cloud.net/">å®˜æ–¹åœ°å€</a>ä¸‹è½½cirrosé•œåƒï¼Œç”¨æ¥è°ƒè¯•è™šæ‹Ÿæœºï¼Œç”¨æˆ·åå’Œå¯†ç å¦‚ä¸‹</p>
</blockquote>
<pre tabindex="0"><code>user:cirros
pass:cubswin:)   # ä¸åŒç‰ˆæœ¬å¯†ç ä¸åŒ
</code></pre><blockquote>
<p>é€šå¸¸å°†cirrosé•œåƒæ”¾ç½®åˆ°<code>/var/lib/libvirt/boot</code>è·¯å¾„ä¸‹</p>
<p>å¯ä»¥æŸ¥çœ‹é•œåƒä¿¡æ¯</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>qemu-img info cirros-0.5.0-x86_64-disk.img
</span></span></code></pre></div><blockquote>
<p>è‡³æ­¤ï¼Œvrishå­¦ä¹ çš„åŸºæœ¬ç¯å¢ƒå°±æ­å»ºå®Œæˆ</p>
</blockquote>
<h3 id="libvirtåŸºæœ¬æ¦‚å¿µ">LibvirtåŸºæœ¬æ¦‚å¿µ<a hidden class="anchor" aria-hidden="true" href="#libvirtåŸºæœ¬æ¦‚å¿µ">#</a></h3>
<blockquote>
<p>virshå‘½ä»¤å¤§æ¦‚åˆ†ç»„</p>
<ul>
<li>Domain Managementï¼ˆåŸŸç®¡ç†ï¼‰</li>
<li>Domain Monitoringï¼ˆåŸŸç›‘æ§ï¼‰</li>
<li>Host and Hypervisorï¼ˆä¸»æœºåŠè™šæ‹ŸåŒ–ï¼‰</li>
<li>Interfaceï¼ˆç½‘å¡æ¥å£ï¼‰</li>
<li>Network Filterï¼ˆç½‘ç»œé˜²ç«å¢™ï¼‰</li>
<li>Networkingï¼ˆç½‘ç»œï¼‰</li>
<li>Node Deviceï¼ˆèŠ‚ç‚¹è®¾å¤‡é©±åŠ¨ï¼‰å­˜åœ¨</li>
<li>Secret</li>
<li>Snapshotï¼ˆå¿«ç…§ï¼‰</li>
<li>Storage Poolï¼ˆå­˜å‚¨æ± æˆ–å­˜å‚¨ç­–ç•¥ï¼‰</li>
<li>Storage Volumeï¼ˆå­˜å‚¨å·ï¼‰</li>
<li>Virsh itselfï¼ˆvirsh shellè‡ªèº«ç›¸å…³ï¼‰</li>
</ul>
</blockquote>
<hr>
<blockquote>
<p>å®šä¹‰è¿‡çš„æˆ–è€…èƒ½å¤Ÿè¢«libvirtæ„ŸçŸ¥åˆ°çš„è™šæœºçš„é…ç½®æ–‡ä»¶éƒ½åœ¨<code>/etc/libvirt</code>ç›®å½•ä¸‹</p>
<p>è™šæ‹Ÿæœºæ–‡ä»¶å’Œå…¶å®ƒçš„ç›¸å…³æ–‡ä»¶éƒ½ä¿å­˜åœ¨ <code>/var/lib/libvirt/</code> ä¸‹</p>
<p>é•œåƒçš„é»˜è®¤è·¯å¾„æ˜¯ <code>/var/lib/libvirt/boot/</code>ã€‚</p>
</blockquote>
<p><img loading="lazy" src="/img/Vm_lifecycle_graph.png" alt="Vm lifecycle graph.png"  />
</p>
<blockquote>
<p>ä¸Šå›¾æ—¶ä¸€ä¸ªlibvirtè™šæ‹Ÿæœºçš„ç”Ÿå‘½å‘¨æœŸå›¾ï¼Œè™šæ‹Ÿæœºåˆ†ä¸ºä¸¤ç§ï¼š</p>
<ul>
<li>æŒä¹…æ€§çš„</li>
<li>çŸ­æš‚æ€§çš„</li>
</ul>
<p>æŒä¹…æ€§è™šæ‹Ÿæœºä¼šä¸€ç›´å­˜åœ¨ï¼Œç›´åˆ°è¢«åˆ é™¤ï¼›</p>
<p>çŸ­æš‚æ€§çš„è™šæ‹Ÿæœºåªæœ‰åœ¨è™šæ‹Ÿæœºè¢«å…³æœºæˆ–é‡å¯å‰å­˜åœ¨</p>
</blockquote>
<h3 id="è™šæ‹Ÿæœºå¸¸ç”¨å‘½ä»¤">è™šæ‹Ÿæœºå¸¸ç”¨å‘½ä»¤<a hidden class="anchor" aria-hidden="true" href="#è™šæ‹Ÿæœºå¸¸ç”¨å‘½ä»¤">#</a></h3>
<blockquote>
<p>virshå’Œqemuçš„å‘½ä»¤éå¸¸å¤šï¼Œä¸‹é¢ç½—åˆ—ä¸€äº›å¸¸ç”¨çš„å‘½ä»¤</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>virsh <span style="color:#fff;font-weight:bold">help</span>									<span style="color:#007f7f"># æŸ¥çœ‹å¸®åŠ©ä¿¡æ¯</span>
</span></span><span style="display:flex;"><span>virsh version								<span style="color:#007f7f"># æŸ¥çœ‹qemuç‰ˆæœ¬</span>
</span></span><span style="display:flex;"><span>virsh <span style="color:#fff;font-weight:bold">help</span> &lt;ç‰¹å®šå‘½ä»¤&gt;						<span style="color:#007f7f"># æŸ¥çœ‹ç‰¹å®šå‘½ä»¤å¸®åŠ©ä¿¡æ¯</span>
</span></span><span style="display:flex;"><span>virsh &lt;ç‰¹å®šå‘½ä»¤&gt; --help						<span style="color:#007f7f"># æŸ¥çœ‹ç‰¹å®šå‘½ä»¤å¸®åŠ©ä¿¡æ¯</span>
</span></span><span style="display:flex;"><span>virsh nodeinfo								<span style="color:#007f7f"># æŸ¥çœ‹å®¿ä¸»æœºä¿¡æ¯</span>
</span></span><span style="display:flex;"><span>virsh uri                                  <span style="color:#007f7f"># æŸ¥çœ‹å½“å‰ä¸»æœºhypervisoçš„è¿æ¥è·¯å¾„ï¼›</span>
</span></span><span style="display:flex;"><span>virsh connect &lt;hypervisor uri&gt;			   <span style="color:#007f7f"># è¿æ¥åˆ°ç‰¹å®šhypervisor,é»˜è®¤qemu:///system</span>
</span></span><span style="display:flex;"><span>virsh sysinfo								<span style="color:#007f7f"># æŸ¥çœ‹hypervisroä¿¡æ¯</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>virsh start &lt;è™šæ‹Ÿæœºåç§°&gt;             		<span style="color:#007f7f"># å¯åŠ¨ä¸€ä¸ªä¹‹å‰å·²ç»å®šä¹‰defineè¿‡çš„è™šæ‹Ÿæœºï¼ˆdomain)</span>
</span></span><span style="display:flex;"><span>virsh shutdown &lt;è™šæ‹Ÿæœºåç§°&gt;					<span style="color:#007f7f"># å…³é—­è™šæ‹Ÿæœº,ç±»ä¼¼è™šæ‹Ÿæœºå†…æ‰§è¡Œå…³æœº</span>
</span></span><span style="display:flex;"><span>virsh reboot &lt;è™šæ‹Ÿæœºåç§°&gt;					<span style="color:#007f7f"># é‡å¯è™šæ‹Ÿæœº</span>
</span></span><span style="display:flex;"><span>virsh destroy &lt;è™šæ‹Ÿæœºåç§°&gt;					<span style="color:#007f7f"># å¼ºåˆ¶å…³é—­è™šæ‹Ÿæœºï¼Œç±»ä¼¼äºæ–­ç”µ</span>
</span></span><span style="display:flex;"><span>virsh <span style="color:#fff;font-weight:bold">suspend</span> &lt;è™šæ‹Ÿæœºåç§°&gt;   				<span style="color:#007f7f"># æŒ‚èµ·è™šæ‹Ÿæœºï¼Œå°†å½“å‰çŠ¶æ€ä¿å­˜åœ¨å†…å­˜ä¸­</span>
</span></span><span style="display:flex;"><span>virsh resume &lt;è™šæ‹Ÿæœºåç§°&gt;					<span style="color:#007f7f"># æ¢å¤è™šæ‹ŸæœºæŒ‚èµ·çŠ¶æ€ï¼Œä»å†…å­˜ä¸­æ¢å¤è™šæ‹ŸæœºçŠ¶æ€</span>
</span></span><span style="display:flex;"><span>virsh save &lt;è™šæ‹Ÿæœºåç§°&gt; &lt;imgé•œåƒæ–‡ä»¶å&gt;	 	 <span style="color:#007f7f"># æš‚åœè™šæ‹Ÿæœºï¼Œå°†è™šæ‹ŸæœºçŠ¶æ€ä¿å­˜åœ¨ç£ç›˜é•œåƒæ–‡ä»¶ä¸­</span>
</span></span><span style="display:flex;"><span>virsh restore &lt;imgé•œåƒæ–‡ä»¶å&gt;			 ã€€ã€€#é‡æ–°è½½å…¥æš‚åœçš„è™šæ‹Ÿæœº
</span></span><span style="display:flex;"><span>virsh autostart &lt;è™šæ‹Ÿæœºåç§°&gt;					<span style="color:#007f7f"># è™šæ‹Ÿæœºéšç€ç‰©ç†æœºå¯åŠ¨è‡ªåŠ¨å¯åŠ¨</span>
</span></span><span style="display:flex;"><span>virsh autostart &lt;è™šæ‹Ÿæœºåç§°&gt; --disable		<span style="color:#007f7f"># ç¦æ­¢å¼€æœºå¯åŠ¨</span>
</span></span><span style="display:flex;"><span>virsh dominfo &lt;è™šæ‹Ÿæœºåç§°&gt;					<span style="color:#007f7f"># æŸ¥çœ‹è™šæ‹Ÿæœºdomainä¿¡æ¯</span>
</span></span><span style="display:flex;"><span>virsh domblklist &lt;è™šæ‹Ÿæœºåç§°&gt;				<span style="color:#007f7f"># åˆ—å‡ºè™šæ‹Ÿæœºæ‰€æœ‰å—å­˜å‚¨è®¾å¤‡</span>
</span></span><span style="display:flex;"><span>virsh console &lt;è™šæ‹Ÿæœºåç§°&gt;					<span style="color:#007f7f"># æ§åˆ¶å°è¿æ¥è™šæ‹Ÿæœº</span>
</span></span><span style="display:flex;"><span>virsh dumpxml &lt;è™šæ‹Ÿæœºåç§°&gt;					<span style="color:#007f7f"># æŸ¥çœ‹è™šæ‹Ÿæœºxmlæ–‡ä»¶</span>
</span></span><span style="display:flex;"><span>virsh edit &lt;è™šæ‹Ÿæœºåç§°&gt;						<span style="color:#007f7f"># ç¼–è¾‘è™šæ‹Ÿæœºxmlæ–‡ä»¶</span>
</span></span><span style="display:flex;"><span>virsh managedsave &lt;è™šæ‹Ÿæœºåç§°&gt;				<span style="color:#007f7f"># ä¿å­˜çŠ¶æ€saveå¹¶å…³é—­è™šæ‹Ÿæœºï¼Œä¸‹æ¬¡å¯åŠ¨ä¼šæ¢å¤åˆ°ä¹‹å‰ä¿å­˜çš„çŠ¶æ€</span>
</span></span><span style="display:flex;"><span>virsh start &lt;è™šæ‹Ÿæœºåç§°&gt;						<span style="color:#007f7f"># å¯åŠ¨å¹¶æ¢å¤managedsaveä¿å­˜çš„çŠ¶æ€</span>
</span></span><span style="display:flex;"><span>virsh reset &lt;è™šæ‹Ÿæœºåç§°&gt;						<span style="color:#007f7f"># å¯¹è™šæ‹Ÿæœºæ‰§è¡Œå¼ºåˆ¶é‡å¯ï¼Œç±»ä¼¼é‡ç½®ç”µæºæŒ‰é’®</span>
</span></span><span style="display:flex;"><span>virsh create &lt;è™šæ‹Ÿæœºxmlæ–‡ä»¶&gt;                 <span style="color:#007f7f"># ä»xmlæ–‡ä»¶ä¸­åˆ›å»ºdomainï¼Œåˆ›å»ºå®Œæˆåä¼šè‡ªåŠ¨å¯åŠ¨ï¼›</span>
</span></span><span style="display:flex;"><span>											<span style="color:#007f7f"># ä¸€ä¸ªxmlå¯¹åº”ä¸€ä¸ªdomainè™šæ‹Ÿæœº</span>
</span></span><span style="display:flex;"><span>virsh define &lt;è™šæ‹Ÿæœºxmlæ–‡ä»¶&gt;					<span style="color:#007f7f"># ä»xmlæ–‡ä»¶å®šä¹‰defineæ–°çš„domainï¼Œä¸ä¼šè‡ªåŠ¨å¯åŠ¨</span>
</span></span><span style="display:flex;"><span>virsh undefine &lt;è™šæ‹Ÿæœºåç§°&gt;					<span style="color:#007f7f"># å¯¹äºè¿è¡Œä¸­çš„æŒä¹…æ€§è™šæ‹Ÿæœºï¼Œå°†çŠ¶æ€è½¬æ¢ä¸ºæš‚æ—¶çš„ï¼Œå…³æœºåvirshæ— æ³•æ„ŸçŸ¥å…¶å­˜åœ¨</span>
</span></span><span style="display:flex;"><span>											<span style="color:#007f7f"># å¯¹äºéæ´»åŠ¨çš„è™šæ‹Ÿæœºï¼Œundefineåvirshå°†æ— æ³•æ„ŸçŸ¥å…¶å­˜åœ¨</span>
</span></span><span style="display:flex;"><span>											<span style="color:#007f7f"># undefineåç£ç›˜ä¾ç„¶å­˜åœ¨ï¼Œåªæ˜¯åˆ é™¤è™šæ‹Ÿæœºçš„é…ç½®æ–‡ä»¶/etc/libvirt/qemu</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>virsh undefine &lt;è™šæ‹Ÿæœºåç§°&gt; --remove-all-storage		<span style="color:#007f7f"># åˆ é™¤è™šæ‹Ÿæœºå¹¶åˆ é™¤æ‰€æœ‰ç£ç›˜æ–‡ä»¶</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>virsh snapshot-create-as &lt;è™šæ‹Ÿæœºåç§°&gt; --name &lt;å¿«ç…§åç§°&gt;  <span style="color:#007f7f"># ä»å‘½ä»¤è¡Œåˆ›å»ºå¿«ç…§</span>
</span></span><span style="display:flex;"><span>virsh snapshot-create &lt;è™šæ‹Ÿæœºåç§°&gt;					<span style="color:#007f7f"># ä»xmlæ–‡ä»¶åˆ›å»ºå¿«ç…§</span>
</span></span><span style="display:flex;"><span>virsh snapshot-list &lt;è™šæ‹Ÿæœºåç§°&gt;						<span style="color:#007f7f"># æŸ¥çœ‹è™šæ‹Ÿæœºå¿«ç…§åˆ—è¡¨</span>
</span></span><span style="display:flex;"><span>virsh snapshot-parent &lt;è™šæ‹Ÿæœºåç§°&gt; --current			<span style="color:#007f7f"># æŸ¥çœ‹å½“å‰å¿«ç…§çš„ä¸Šä¸€çº§å¿«ç…§</span>
</span></span><span style="display:flex;"><span>virsh snapshot-edit &lt;è™šæ‹Ÿæœºåç§°&gt; --snapshotname &lt;å¿«ç…§å&gt;	<span style="color:#007f7f"># ç¼–è¾‘å¿«ç…§</span>
</span></span><span style="display:flex;"><span>virsh snapshot-revert &lt;è™šæ‹Ÿæœºåç§°&gt; --snapshotname &lt;å¿«ç…§å&gt;	<span style="color:#007f7f"># æ¢å¤å¿«ç…§</span>
</span></span><span style="display:flex;"><span>virsh snapshot-delete &lt;è™šæ‹Ÿæœºåç§°&gt; --snapshotname &lt;å¿«ç…§å&gt;	<span style="color:#007f7f"># åˆ é™¤å¿«ç…§</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>virsh list									<span style="color:#007f7f"># æŸ¥çœ‹æ´»åŠ¨è™šæ‹ŸæœºçŠ¶æ€</span>
</span></span><span style="display:flex;"><span>virsh list --all							<span style="color:#007f7f"># æŸ¥çœ‹æ‰€æœ‰è™šæ‹ŸæœºçŠ¶æ€</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>virsh setvcpus &lt;è™šæ‹Ÿæœºåç§°&gt; <span style="color:#ff0;font-weight:bold">4</span> --maximum --config <span style="color:#007f7f"># è®¾ç½®æœ€å¤§vcpuæ•°ï¼ˆåªèƒ½ç”¨--configï¼Œä¸‹æ¬¡è¿è¡Œç”Ÿæ•ˆï¼‰</span>
</span></span><span style="display:flex;"><span>virsh setvcpus &lt;è™šæ‹Ÿæœºåç§°&gt; <span style="color:#ff0;font-weight:bold">4</span> --config   		<span style="color:#007f7f"># ä¸‹æ¬¡å¯åŠ¨ä½¿ç”¨vcpuæ•°</span>
</span></span><span style="display:flex;"><span>virsh vcpuinfo &lt;è™šæ‹Ÿæœºåç§°&gt;    					<span style="color:#007f7f"># æŸ¥çœ‹vcpuä¿¡æ¯</span>
</span></span><span style="display:flex;"><span>virsh vcpupin &lt;è™šæ‹Ÿæœºåç§°&gt;						<span style="color:#007f7f"># æŸ¥è¯¢åŸŸ vcpuäº²å’Œæ€§,å³vcpuå’Œç‰©ç†cpuä¹‹é—´å…³ç³»</span>
</span></span><span style="display:flex;"><span>virsh maxvcpus								   <span style="color:#007f7f"># æ˜¾ç¤ºæœ¬æœºvcpuæœ€å¤§å€¼</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>virsh setmaxmem &lt;è™šæ‹Ÿæœºåç§°&gt; [--size] 2G --current  <span style="color:#007f7f"># è®¾ç½®æœ€å¤§å†…å­˜é™åˆ¶å€¼</span>
</span></span><span style="display:flex;"><span>virsh setmem &lt;è™šæ‹Ÿæœºåç§°&gt; [--size] 2G --current     <span style="color:#007f7f"># è®¾ç½®å†…å­˜åˆ†é…</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>virsh domblklist cirros							<span style="color:#007f7f"># æŸ¥çœ‹è™šæ‹Ÿæœºçš„å­˜å‚¨å—è®¾å¤‡</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>åˆ›å»ºç£ç›˜æ–‡ä»¶
</span></span><span style="display:flex;"><span><span style="color:#007f7f">#qcow2æ˜¯æ–‡ä»¶ç±»å‹ï¼Œtest1-add1.qcow2æ˜¯ç£ç›˜æ–‡ä»¶ï¼Œ5Gæ˜¯å¤§å°</span>
</span></span><span style="display:flex;"><span>qemu-img create -f qcow2 /var/lib/libvirt/images/test1-add1.qcow2 5G
</span></span><span style="display:flex;"><span>qemu-img info &lt;è™šæ‹Ÿæœºé•œåƒ&gt;			<span style="color:#007f7f"># æŸ¥çœ‹é•œåƒä¿¡æ¯</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>virt-install &lt;å‘½ä»¤è¡Œ&gt; 	<span style="color:#007f7f"># é€šè¿‡å‘½ä»¤è¡ŒæŒ‡å®šæ¥åˆ›å»ºè™šæ‹Ÿæœº</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>virsh attach-disk &lt;è™šæ‹Ÿæœºåç§°&gt; 
</span></span><span style="display:flex;"><span>virsh attach-device &lt;è™šæ‹Ÿæœºåç§°&gt; /etc/libvirt/qemu/test2-add.xml --persistent		<span style="color:#007f7f"># ä»XMLæ–‡ä»¶é™„åŠ è®¾å¤‡</span>
</span></span><span style="display:flex;"><span>virsh detach-device &lt;è™šæ‹Ÿæœºåç§°&gt; /etc/libvirt/qemu/test2-add.xml --persistent		<span style="color:#007f7f"># å¸è½½è®¾å¤‡</span>
</span></span></code></pre></div><h3 id="è™šæ‹Ÿæœºæ“ä½œå®è·µ">è™šæ‹Ÿæœºæ“ä½œå®è·µ<a hidden class="anchor" aria-hidden="true" href="#è™šæ‹Ÿæœºæ“ä½œå®è·µ">#</a></h3>
<h4 id="å®éªŒ1ä¿®æ”¹è™šæ‹Ÿæœºvcpu">å®éªŒ1ï¼šä¿®æ”¹è™šæ‹Ÿæœºvcpu<a hidden class="anchor" aria-hidden="true" href="#å®éªŒ1ä¿®æ”¹è™šæ‹Ÿæœºvcpu">#</a></h4>
<blockquote>
<p>ä¿®æ”¹è™šæ‹Ÿæœºçš„æœ€å¤§vcpuæ•°é‡ï¼Œå¯ä»¥ä¿®æ”¹maximum config å’Œcurrent configçš„å€¼</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#007f7f"># æŸ¥çœ‹vcpué…ç½®</span>
</span></span><span style="display:flex;"><span>âœ  ~ virsh vcpucount cirros
</span></span><span style="display:flex;"><span>maximum      config         2			<span style="color:#007f7f"># æŒ‡å®šä¸‹æ¬¡é‡å¯è™šæ‹Ÿæœºåå¯ç”¨çš„æœ€å¤§vcpuæ•°é‡</span>
</span></span><span style="display:flex;"><span>maximum      live           2			<span style="color:#007f7f"># æŒ‡å®šè¿è¡Œ/æš‚åœçŠ¶æ€ä¸‹è™šæ‹Ÿæœºå¯ç”¨çš„æœ€å¤§vcpuæ•°é‡,é‡å¯åå’Œmaximum configä¸€è‡´</span>
</span></span><span style="display:flex;"><span>current      config         2			<span style="color:#007f7f"># ä¸‹æ¬¡é‡å¯æ—¶è™šæ‹Ÿæœºä½¿ç”¨çš„vcpuæ•°é‡</span>
</span></span><span style="display:flex;"><span>current      live           2			<span style="color:#007f7f"># æ­£åœ¨è¿è¡Œçš„è™šæ‹Ÿæœºvcpuå®é™…æ•°é‡</span>
</span></span></code></pre></div><blockquote>
<p><strong>é€šè¿‡ä¿®æ”¹xmlæ–‡ä»¶ä¿®æ”¹vcpuæ•°é‡</strong></p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>virsh edit cirros
</span></span><span style="display:flex;"><span><span style="color:#007f7f">#  &lt;vcpu placement=&#39;static&#39;&gt;2&lt;/vcpu&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># ä¿®æ”¹ä¸º</span>
</span></span><span style="display:flex;"><span> &lt;vcpu placement=<span style="color:#0ff;font-weight:bold">&#39;static&#39;</span>&gt;3&lt;/vcpu&gt;
</span></span></code></pre></div><blockquote>
<p>å…³é—­å¹¶é‡æ–°å¯åŠ¨è™šæ‹Ÿæœº</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>virsh shutdown cirros
</span></span><span style="display:flex;"><span>virsh list --all   <span style="color:#007f7f"># ç¡®è®¤å·²ç»æ˜¯shut offçŠ¶æ€</span>
</span></span><span style="display:flex;"><span>virsh start cirros
</span></span></code></pre></div><blockquote>
<p>å†æ¬¡æŸ¥çœ‹vcpuæ•°é‡ï¼Œå‘ç°å·²ç»æ”¹å˜</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>âœ  ~ virsh vcpucount cirros
</span></span><span style="display:flex;"><span>maximum      config         <span style="color:#ff0;font-weight:bold">3</span>
</span></span><span style="display:flex;"><span>maximum      live           <span style="color:#ff0;font-weight:bold">3</span>
</span></span><span style="display:flex;"><span>current      config         <span style="color:#ff0;font-weight:bold">3</span>
</span></span><span style="display:flex;"><span>current      live           <span style="color:#ff0;font-weight:bold">3</span>
</span></span></code></pre></div><blockquote>
<p>åŒæ ·æ–¹å¼ï¼Œä¿®æ”¹xmlæ–‡ä»¶ï¼Œæ¢å¤ä¸º2ä¸ªvcpuï¼Œæ‰§è¡Œvirsh reboot åå¹¶æ²¡é‡Šæ”¾vcpu</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>âœ  ~ virsh vcpucount cirros
</span></span><span style="display:flex;"><span>maximum      config         <span style="color:#ff0;font-weight:bold">2</span>
</span></span><span style="display:flex;"><span>maximum      live           <span style="color:#ff0;font-weight:bold">3</span>
</span></span><span style="display:flex;"><span>current      config         <span style="color:#ff0;font-weight:bold">2</span>
</span></span><span style="display:flex;"><span>current      live           <span style="color:#ff0;font-weight:bold">3</span>
</span></span></code></pre></div><blockquote>
<p>å¿…é¡»æ‰§è¡Œshutdownæˆ–è€…destoryï¼Œç„¶åé‡æ–°startæ‰èƒ½æ”¹å˜è¿è¡Œæ—¶çš„vcpu</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>âœ  ~ virsh vcpucount cirros
</span></span><span style="display:flex;"><span>maximum      config         <span style="color:#ff0;font-weight:bold">2</span>
</span></span><span style="display:flex;"><span>maximum      live           <span style="color:#ff0;font-weight:bold">2</span>
</span></span><span style="display:flex;"><span>current      config         <span style="color:#ff0;font-weight:bold">2</span>
</span></span><span style="display:flex;"><span>current      live           <span style="color:#ff0;font-weight:bold">2</span>
</span></span></code></pre></div><blockquote>
<p>è¿˜å¯ä»¥é€šè¿‡å‘½ä»¤è¡Œä¿®æ”¹vcpuçš„å„ä¸ªé…ç½®å€¼</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>âœ  ~ virsh setvcpus cirros <span style="color:#ff0;font-weight:bold">3</span> --maximum --config 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>âœ  ~ virsh vcpucount cirros                    
</span></span><span style="display:flex;"><span>maximum      config         <span style="color:#ff0;font-weight:bold">3</span>
</span></span><span style="display:flex;"><span>maximum      live           <span style="color:#ff0;font-weight:bold">2</span>
</span></span><span style="display:flex;"><span>current      config         <span style="color:#ff0;font-weight:bold">2</span>
</span></span><span style="display:flex;"><span>current      live           <span style="color:#ff0;font-weight:bold">2</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>âœ  ~ virsh setvcpus cirros <span style="color:#ff0;font-weight:bold">3</span> --config  <span style="color:#007f7f"># ä¿®æ”¹current config</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>âœ  ~ virsh vcpucount cirros          
</span></span><span style="display:flex;"><span>maximum      config         <span style="color:#ff0;font-weight:bold">3</span>
</span></span><span style="display:flex;"><span>maximum      live           <span style="color:#ff0;font-weight:bold">2</span>
</span></span><span style="display:flex;"><span>current      config         <span style="color:#ff0;font-weight:bold">3</span>
</span></span><span style="display:flex;"><span>current      live           <span style="color:#ff0;font-weight:bold">2</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># é‡å¯è™šæ‹Ÿæœºä½¿å…¶ç”Ÿæ•ˆ</span>
</span></span><span style="display:flex;"><span>âœ  ~ virsh shutdown cirros
</span></span><span style="display:flex;"><span>âœ  ~ virsh start cirros
</span></span><span style="display:flex;"><span>âœ  ~ virsh vcpucount cirros
</span></span><span style="display:flex;"><span>maximum      config         <span style="color:#ff0;font-weight:bold">3</span>
</span></span><span style="display:flex;"><span>maximum      live           <span style="color:#ff0;font-weight:bold">3</span>
</span></span><span style="display:flex;"><span>current      config         <span style="color:#ff0;font-weight:bold">3</span>
</span></span><span style="display:flex;"><span>current      live           <span style="color:#ff0;font-weight:bold">3</span>
</span></span></code></pre></div><blockquote>
<p><strong>åœ¨å®¿ä¸»æœºä¸Šæ— æ³•è®¾ç½®vcpuçš„current liveå°äºcurrent config</strong>ï¼Œåªèƒ½åœ¨è™šæ‹Ÿæœºå†…éƒ¨æ‰§è¡Œ<code>chcpu</code>æŒ‡ä»¤æ¥ä¿®æ”¹ï¼Œä½¿å¾—vcpuç¦»çº¿</p>
<p>ä¹Ÿå¯ä»¥å°†æœ€å¤§å¯ç”¨vcpuè®¾ç½®è¾ƒå¤§ï¼Œæ–¹ä¾¿åç»­åœ¨è™šæ‹Ÿæœºè¿è¡Œæ—¶å¯ä»¥åŠ¨æ€è°ƒæ•´vcpuçš„æ•°é‡</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>âœ  ~ virsh setvcpus cirros <span style="color:#ff0;font-weight:bold">5</span> --maximum --config 
</span></span><span style="display:flex;"><span>âœ  ~  virsh setvcpus cirros <span style="color:#ff0;font-weight:bold">2</span> --config 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>âœ  ~ virsh shutdown cirros
</span></span><span style="display:flex;"><span>âœ  ~ virsh start cirros
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>âœ  ~ virsh vcpucount cirros
</span></span><span style="display:flex;"><span>maximum      config         <span style="color:#ff0;font-weight:bold">5</span>
</span></span><span style="display:flex;"><span>maximum      live           <span style="color:#ff0;font-weight:bold">5</span>
</span></span><span style="display:flex;"><span>current      config         <span style="color:#ff0;font-weight:bold">2</span>
</span></span><span style="display:flex;"><span>current      live           <span style="color:#ff0;font-weight:bold">2</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>âœ  ~ virsh setvcpus cirros 3			<span style="color:#007f7f"># åŠ¨æ€è°ƒæ•´vcpuæ•°é‡ï¼Œè°ƒæ•´èŒƒå›´[current configï¼Œæ¯”maximum config]</span>
</span></span><span style="display:flex;"><span>âœ  ~ virsh vcpucount cirros 
</span></span><span style="display:flex;"><span>maximum      config         <span style="color:#ff0;font-weight:bold">5</span>
</span></span><span style="display:flex;"><span>maximum      live           <span style="color:#ff0;font-weight:bold">5</span>
</span></span><span style="display:flex;"><span>current      config         <span style="color:#ff0;font-weight:bold">2</span>
</span></span><span style="display:flex;"><span>current      live           <span style="color:#ff0;font-weight:bold">3</span>
</span></span><span style="display:flex;"><span>âœ  ~ virsh setvcpus cirros 2			
</span></span><span style="display:flex;"><span>âœ  ~ virsh vcpucount cirros 
</span></span><span style="display:flex;"><span>maximum      config         <span style="color:#ff0;font-weight:bold">5</span>
</span></span><span style="display:flex;"><span>maximum      live           <span style="color:#ff0;font-weight:bold">5</span>
</span></span><span style="display:flex;"><span>current      config         <span style="color:#ff0;font-weight:bold">2</span>
</span></span><span style="display:flex;"><span>current      live           <span style="color:#ff0;font-weight:bold">2</span>
</span></span><span style="display:flex;"><span>âœ  ~ virsh vcpuinfo cirros				<span style="color:#007f7f"># æŸ¥çœ‹vcpuè¿è¡ŒçŠ¶æ€</span>
</span></span></code></pre></div><h4 id="å®éªŒ2ä¿®æ”¹è™šæ‹Ÿæœºçš„å†…å­˜">å®éªŒ2ï¼šä¿®æ”¹è™šæ‹Ÿæœºçš„å†…å­˜<a hidden class="anchor" aria-hidden="true" href="#å®éªŒ2ä¿®æ”¹è™šæ‹Ÿæœºçš„å†…å­˜">#</a></h4>
<blockquote>
<p>é€šè¿‡ä¿®æ”¹xmlé…ç½®æ–‡ä»¶å¹¶é‡æ–°å¯åŠ¨è™šæ‹Ÿæœº</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#007f7f"># ä¿®æ”¹é¡¹ï¼Œä¿®æ”¹å®Œæˆå</span>
</span></span><span style="display:flex;"><span>&lt;memory unit=<span style="color:#0ff;font-weight:bold">&#39;KiB&#39;</span>&gt;462144&lt;/memory&gt;				<span style="color:#007f7f"># å¯åŠ¨åæœ€å¤§å…è®¸å¯ç”¨å†…å­˜</span>
</span></span><span style="display:flex;"><span>&lt;currentMemory unit=<span style="color:#0ff;font-weight:bold">&#39;KiB&#39;</span>&gt;262144&lt;/currentMemory&gt;# å¯åŠ¨æ—¶ä½¿ç”¨çš„å†…å­˜å¤§å°
</span></span></code></pre></div><blockquote>
<p>åœ¨æœ€å¤§å¯ç”¨å†…å­˜èŒƒå›´å†…ï¼Œå¯ä»¥åœ¨è™šæ‹Ÿæœºè¿è¡Œæ—¶è°ƒæ•´å†…å­˜ä½¿ç”¨</p>
<p>è™šæ‹Ÿæœºæœ€å¤§å†…å­˜åªèƒ½åœ¨è™šæ‹Ÿæœºå…³é—­çŠ¶æ€æ›´æ”¹ï¼Œé‡å¯åç”Ÿæ•ˆ</p>
<p>ä½¿ç”¨virsh setmaxmemå‘½ä»¤ï¼Œå’Œç›´æ¥ä¿®æ”¹xmlæ–‡ä»¶ç­‰æ•ˆ</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>âœ  ~ virsh dominfo cirros | grep memory    <span style="color:#007f7f"># è™šæ‹Ÿæœºå¯åŠ¨æ—¶æ˜¾ç¤ºçš„used memoryä¸å‡†ç¡®</span>
</span></span><span style="display:flex;"><span>Max memory:     <span style="color:#ff0;font-weight:bold">462144</span> KiB
</span></span><span style="display:flex;"><span>Used memory:    <span style="color:#ff0;font-weight:bold">262144</span> KiB
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>âœ  ~ virsh setmem cirros <span style="color:#ff0;font-weight:bold">300000</span>        
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>âœ  ~ virsh dominfo cirros | grep memory
</span></span><span style="display:flex;"><span>Max memory:     <span style="color:#ff0;font-weight:bold">462144</span> KiB
</span></span><span style="display:flex;"><span>Used memory:    <span style="color:#ff0;font-weight:bold">300000</span> KiB
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>âœ  ~ virsh shutdown cirros
</span></span><span style="display:flex;"><span>âœ  ~ virsh setmaxmem cirros <span style="color:#ff0;font-weight:bold">700000</span>
</span></span></code></pre></div><h4 id="å®éªŒ3è°ƒæ•´è™šæ‹Ÿæœºçš„ç£ç›˜">å®éªŒ3ï¼šè°ƒæ•´è™šæ‹Ÿæœºçš„ç£ç›˜<a hidden class="anchor" aria-hidden="true" href="#å®éªŒ3è°ƒæ•´è™šæ‹Ÿæœºçš„ç£ç›˜">#</a></h4>
<blockquote>
<p>è™šæ‹Ÿæœºæ”¯æŒåœ¨è™šæ‹Ÿæœºå¼€æœºæ—¶åŠ¨æ€æŒ‚è½½æ–°çš„ç£ç›˜</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>âœ  ~ qemu-img create -f qcow2 -o size=20M,preallocation=metadata /var/lib/libvirt/boot/second.qcow2
</span></span><span style="display:flex;"><span>Formatting <span style="color:#0ff;font-weight:bold">&#39;/var/lib/libvirt/boot/second.qcow2&#39;</span>, fmt=qcow2 size=<span style="color:#ff0;font-weight:bold">20971520</span> cluster_size=<span style="color:#ff0;font-weight:bold">65536</span> preallocation=metadata lazy_refcounts=off refcount_bits=<span style="color:#ff0;font-weight:bold">16</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>âœ  ~ qemu-img info /var/lib/libvirt/boot/second.qcow2
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>image: /var/lib/libvirt/boot/second.qcow2
</span></span><span style="display:flex;"><span>file format: qcow2
</span></span><span style="display:flex;"><span>virtual size: <span style="color:#ff0;font-weight:bold">20</span> MiB (<span style="color:#ff0;font-weight:bold">20971520</span> bytes)
</span></span><span style="display:flex;"><span>disk size: <span style="color:#ff0;font-weight:bold">260</span> KiB
</span></span><span style="display:flex;"><span>cluster_size: <span style="color:#ff0;font-weight:bold">65536</span>
</span></span><span style="display:flex;"><span>Format specific information:
</span></span><span style="display:flex;"><span>    compat: 1.1
</span></span><span style="display:flex;"><span>    lazy refcounts: <span style="color:#fff;font-weight:bold">false</span>
</span></span><span style="display:flex;"><span>    refcount bits: <span style="color:#ff0;font-weight:bold">16</span>
</span></span><span style="display:flex;"><span>    corrupt: <span style="color:#fff;font-weight:bold">false</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>virsh attach-disk cirros /images/cirros/second.qcow2 vda --targetbus virtio 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># å¸è½½ç£ç›˜ï¼ˆå‰ææ—¶æ²¡æœ‰åˆ†åŒºæˆ–è€…æŒ‚è½½</span>
</span></span><span style="display:flex;"><span>virsh detach-disk <span style="color:#ff0;font-weight:bold">26</span> vda
</span></span></code></pre></div><blockquote>
<p>ä¹Ÿå¯ä»¥æ‰‹åŠ¨ä¿®æ”¹xmlæ–‡ä»¶ï¼Œç„¶åé‡å¯è™šæ‹Ÿæœº</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#007f7f"># é¦–å…ˆåˆ›å»ºä¸€ä¸ªqcow2ç£ç›˜æˆ–è€…rawç£ç›˜</span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># ddå‘½ä»¤åˆ›å»ºä¸€ä¸ªéç¨€ç–çš„ç£ç›˜</span>
</span></span><span style="display:flex;"><span>dd <span style="color:#fff;font-weight:bold">if</span>=/dev/zero of=/vm-images/vm1-add.img bs=1M count=<span style="color:#ff0;font-weight:bold">1024</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># åœ¨xmlæ–‡ä»¶ä¸­åŠ å…¥ä¸€ä¸ªæ–°çš„xmlæ®µ</span>
</span></span><span style="display:flex;"><span>&lt;disk type=<span style="color:#0ff;font-weight:bold">&#39;file&#39;</span> device=<span style="color:#0ff;font-weight:bold">&#39;disk&#39;</span>&gt;
</span></span><span style="display:flex;"><span>     &lt;driver name=<span style="color:#0ff;font-weight:bold">&#39;qemu&#39;</span> type=<span style="color:#0ff;font-weight:bold">&#39;raw&#39;</span> cache=<span style="color:#0ff;font-weight:bold">&#39;none&#39;</span> io=<span style="color:#0ff;font-weight:bold">&#39;threads&#39;</span>/&gt;
</span></span><span style="display:flex;"><span>     &lt;<span style="color:#fff;font-weight:bold">source</span> file=<span style="color:#0ff;font-weight:bold">&#39;/vm-images/vm1-add.img&#39;</span>/&gt;
</span></span><span style="display:flex;"><span>     &lt;target dev=<span style="color:#0ff;font-weight:bold">&#39;vdb&#39;</span> bus=<span style="color:#0ff;font-weight:bold">&#39;virtio&#39;</span>/&gt;
</span></span><span style="display:flex;"><span>     &lt;address type=<span style="color:#0ff;font-weight:bold">&#39;pci&#39;</span> domain=<span style="color:#0ff;font-weight:bold">&#39;0x0000&#39;</span> bus=<span style="color:#0ff;font-weight:bold">&#39;0x00&#39;</span> slot=<span style="color:#0ff;font-weight:bold">&#39;0x06&#39;</span> <span style="color:#fff;font-weight:bold">function</span>=<span style="color:#0ff;font-weight:bold">&#39;0x0&#39;</span>/&gt;
</span></span><span style="display:flex;"><span> &lt;/disk&gt;
</span></span></code></pre></div><h4 id="å®éªŒ4åˆ›å»ºè™šæ‹Ÿæœº">å®éªŒ4ï¼šåˆ›å»ºè™šæ‹Ÿæœº<a hidden class="anchor" aria-hidden="true" href="#å®éªŒ4åˆ›å»ºè™šæ‹Ÿæœº">#</a></h4>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>virt-install  --name=cirros --ram=<span style="color:#ff0;font-weight:bold">256</span> --vcpus=<span style="color:#ff0;font-weight:bold">1</span> --disk path=/var/lib/libvirt/boot/cirros-0.5.0-x86_64-disk.img,format=qcow2 --import --network network:default --vnc --vncport=<span style="color:#ff0;font-weight:bold">5920</span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># ä¹Ÿå¯ä»¥é€šè¿‡xmlæ–‡ä»¶æ¥åˆ›å»º</span>
</span></span></code></pre></div><h4 id="å®éªŒ5å¤åˆ¶è™šæ‹Ÿæœº">å®éªŒ5ï¼šå¤åˆ¶è™šæ‹Ÿæœº<a hidden class="anchor" aria-hidden="true" href="#å®éªŒ5å¤åˆ¶è™šæ‹Ÿæœº">#</a></h4>
<blockquote>
<p>å¯ä»¥é€šè¿‡å‘½ä»¤è¡Œå¤åˆ¶ä¸€ä¸ªè™šæ‹Ÿæœºï¼Œä¹Ÿå¯ä»¥é€šè¿‡æ‹·è´å¹¶ä¿®æ”¹é…ç½®æ–‡ä»¶å’Œå­˜å‚¨å·æ–‡ä»¶è¿›è¡Œå¤åˆ¶</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#007f7f"># é€šè¿‡virt-cloneå‘½ä»¤å¤åˆ¶</span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># virt-clone -o &lt;è™šæ‹Ÿæœºåç§°&gt; -n &lt;æ–°è™šæ‹Ÿæœºåç§°&gt; -f /var/lib/libvirt/images/test4.qcow2</span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># qcow2ç£ç›˜ä¸éœ€è¦é¢„å…ˆåˆ›å»ºï¼Œåˆ›å»ºå®Œæˆåéœ€è¦è¿›è™šæ‹Ÿæœºæ‰‹åŠ¨æ”¹å˜ipåœ°å€å’Œç”¨æˆ·å</span>
</span></span><span style="display:flex;"><span>âœ  ~ virt-clone -o cirros -n cirros1 -f /var/lib/libvirt/boot/cirros1.qcow2
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># è‡ªåŠ¨ç”Ÿäº§ä¸ä¸€æ ·çš„macåœ°å€å’Œuuid</span>
</span></span><span style="display:flex;"><span>âœ  ~ diff cirros.xml cirros1.xml
</span></span><span style="display:flex;"><span>        &lt;   &lt;name&gt;cirros&lt;/name&gt;
</span></span><span style="display:flex;"><span>        &lt;   &lt;uuid&gt;874fe199-47ea-45d1-a25d-98d0535dddb3&lt;/uuid&gt;
</span></span><span style="display:flex;"><span>        ---
</span></span><span style="display:flex;"><span>        &gt;   &lt;name&gt;cirros1&lt;/name&gt;
</span></span><span style="display:flex;"><span>        &gt;   &lt;uuid&gt;fba2f776-432d-4870-a7ec-bbf73fa1b086&lt;/uuid&gt;
</span></span><span style="display:flex;"><span>        39c39
</span></span><span style="display:flex;"><span>        &lt;       &lt;<span style="color:#fff;font-weight:bold">source</span> file=<span style="color:#0ff;font-weight:bold">&#39;/var/lib/libvirt/boot/cirros-0.5.0-x86_64-disk.img&#39;</span>/&gt;
</span></span><span style="display:flex;"><span>        ---
</span></span><span style="display:flex;"><span>        &gt;       &lt;<span style="color:#fff;font-weight:bold">source</span> file=<span style="color:#0ff;font-weight:bold">&#39;/var/lib/libvirt/boot/cirros1.qcow2&#39;</span>/&gt;
</span></span><span style="display:flex;"><span>        63c63
</span></span><span style="display:flex;"><span>        &lt;       &lt;mac address=<span style="color:#0ff;font-weight:bold">&#39;52:54:00:fa:5c:d3&#39;</span>/&gt;
</span></span><span style="display:flex;"><span>        ---
</span></span><span style="display:flex;"><span>        &gt;       &lt;mac address=<span style="color:#0ff;font-weight:bold">&#39;52:54:00:29:8d:06&#39;</span>/&gt;
</span></span><span style="display:flex;"><span>        81c81
</span></span><span style="display:flex;"><span>        &lt;     &lt;graphics type=<span style="color:#0ff;font-weight:bold">&#39;vnc&#39;</span> port=<span style="color:#0ff;font-weight:bold">&#39;5921&#39;</span> autoport=<span style="color:#0ff;font-weight:bold">&#39;no&#39;</span>&gt;
</span></span><span style="display:flex;"><span>        ---
</span></span><span style="display:flex;"><span>        &gt;     &lt;graphics type=<span style="color:#0ff;font-weight:bold">&#39;vnc&#39;</span> port=<span style="color:#0ff;font-weight:bold">&#39;-1&#39;</span> autoport=<span style="color:#0ff;font-weight:bold">&#39;yes&#39;</span>&gt;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">#virt-clone -fæŒ‡å®šçš„æ–‡ä»¶ä¸è¦äº‹å…ˆåˆ›å»ºï¼Œå¦‚æœæœ‰å¤šä¸ªç£ç›˜æ–‡ä»¶å°±ç”¨å¤šä¸ª-fé€‰é¡¹ å¦‚</span>
</span></span><span style="display:flex;"><span>virt-clone -o &lt;è™šæ‹Ÿæœºåç§°&gt; -n &lt;æ–°è™šæ‹Ÿæœºåç§°&gt; -f /home/lib/libvirt/images/test4.qcow2 -f /mnt/images/test4-add1.qcow2
</span></span></code></pre></div><blockquote>
<p>å¯ä»¥æ‰‹åŠ¨å¤åˆ¶xmlæ–‡ä»¶å’Œç£ç›˜é•œåƒæ¥å¤åˆ¶</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>âœ  qemu cp cirros.xml cirros3.xml
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># ä¿®æ”¹xmlæ–‡ä»¶ä¸­çš„domain nameå’Œmacåœ°å€ç­‰ä¿¡æ¯</span>
</span></span><span style="display:flex;"><span>âœ  qemu vim cirros3.xml 
</span></span><span style="display:flex;"><span>âœ  qemu <span style="color:#fff;font-weight:bold">cd</span> /var/lib/libvirt/boot 
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># åœ¨defineæ–°çš„å…‹éš†è™šæ‹Ÿæœºä¹‹å‰å‡†å¤‡å¥½æ‰€éœ€çš„ç£ç›˜</span>
</span></span><span style="display:flex;"><span>âœ  boot cp cirros-0.5.0-x86_64-disk.img cirros3.img
</span></span><span style="display:flex;"><span>âœ  boot qemu-img info cirros3.img 
</span></span><span style="display:flex;"><span>        image: cirros3.img
</span></span><span style="display:flex;"><span>        file format: qcow2
</span></span><span style="display:flex;"><span>        virtual size: <span style="color:#ff0;font-weight:bold">112</span> MiB (<span style="color:#ff0;font-weight:bold">117440512</span> bytes)
</span></span><span style="display:flex;"><span>        disk size: <span style="color:#ff0;font-weight:bold">198</span> MiB
</span></span><span style="display:flex;"><span>        cluster_size: <span style="color:#ff0;font-weight:bold">65536</span>
</span></span><span style="display:flex;"><span>        Snapshot list:
</span></span><span style="display:flex;"><span>        ID        TAG                     VM SIZE                DATE       VM CLOCK
</span></span><span style="display:flex;"><span>        <span style="color:#ff0;font-weight:bold">1</span>         <span style="color:#ff0;font-weight:bold">1603292226</span>              <span style="color:#ff0;font-weight:bold">101</span> MiB 2020-10-21 22:57:06   94:39:31.435
</span></span><span style="display:flex;"><span>        Format specific information:
</span></span><span style="display:flex;"><span>            compat: 1.1
</span></span><span style="display:flex;"><span>            lazy refcounts: <span style="color:#fff;font-weight:bold">false</span>
</span></span><span style="display:flex;"><span>            refcount bits: <span style="color:#ff0;font-weight:bold">16</span>
</span></span><span style="display:flex;"><span>            corrupt: <span style="color:#fff;font-weight:bold">false</span>
</span></span><span style="display:flex;"><span>âœ  ~ virsh define /etc/libvirt/qemu/cirros3.xml 
</span></span><span style="display:flex;"><span>	Domain cirros3 defined from /etc/libvirt/qemu/cirros3.xml
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>âœ  ~ virsh list --all
</span></span><span style="display:flex;"><span>     Id   Name      State
</span></span><span style="display:flex;"><span>    --------------------------
</span></span><span style="display:flex;"><span>     <span style="color:#ff0;font-weight:bold">2</span>    cirros    running
</span></span><span style="display:flex;"><span>     -    cirros3   shut off
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>âœ  ~ virsh start cirros3 
</span></span><span style="display:flex;"><span>	Domain cirros3 started
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># æ­¤æ—¶ï¼Œä¸€ä¸ªæ–°çš„å…‹éš†è™šæ‹Ÿæœºå°±åˆ›å»ºå®Œæˆ</span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># éœ€è¦æ‰‹åŠ¨ä¿®æ”¹IPå’Œhostname</span>
</span></span></code></pre></div><h4 id="å®éªŒ6è¯¯åˆ è™šæ‹Ÿæœºæ¢å¤">å®éªŒ6ï¼šè¯¯åˆ è™šæ‹Ÿæœºæ¢å¤<a hidden class="anchor" aria-hidden="true" href="#å®éªŒ6è¯¯åˆ è™šæ‹Ÿæœºæ¢å¤">#</a></h4>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#007f7f"># è¯¯åˆ é™¤è™šæ‹Ÿæœº</span>
</span></span><span style="display:flex;"><span>âœ  ~ virsh undefine cirros1
</span></span><span style="display:flex;"><span>Domain cirros1 has been undefined
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>âœ  ~ virsh dominfo cirros1
</span></span><span style="display:flex;"><span>Id:             <span style="color:#ff0;font-weight:bold">1</span>
</span></span><span style="display:flex;"><span>Name:           cirros1
</span></span><span style="display:flex;"><span>UUID:           fba2f776-432d-4870-a7ec-bbf73fa1b086
</span></span><span style="display:flex;"><span>OS Type:        hvm
</span></span><span style="display:flex;"><span>State:          running
</span></span><span style="display:flex;"><span>CPU(s):         <span style="color:#ff0;font-weight:bold">2</span>
</span></span><span style="display:flex;"><span>CPU time:       41.7s
</span></span><span style="display:flex;"><span>Max memory:     <span style="color:#ff0;font-weight:bold">700416</span> KiB
</span></span><span style="display:flex;"><span>Used memory:    <span style="color:#ff0;font-weight:bold">262144</span> KiB
</span></span><span style="display:flex;"><span>Persistent:     no								<span style="color:#007f7f"># å·²ç»å˜ä¸ºéæŒä¹…åŒ–çš„ï¼Œæ— æ³•é‡æ–°å¯åŠ¨</span>
</span></span><span style="display:flex;"><span>Autostart:      disable
</span></span><span style="display:flex;"><span>Managed save:   no
</span></span><span style="display:flex;"><span>Security model: apparmor
</span></span><span style="display:flex;"><span>Security DOI:   <span style="color:#ff0;font-weight:bold">0</span>
</span></span><span style="display:flex;"><span>Security label: libvirt-fba2f776-432d-4870-a7ec-bbf73fa1b086 (enforcing)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>âœ  ~ virsh shutdown cirros1    <span style="color:#007f7f"># å…³æœºåå†ä¹Ÿå¯åŠ¨ä¸äº†äº†</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>âœ  ~ ls /etc/libvirt/qemu      <span style="color:#007f7f"># cirros1çš„xmlæ–‡ä»¶å·²ç»ä¸å­˜åœ¨</span>
</span></span><span style="display:flex;"><span>âœ  ~ ls /var/lib/libvirt/boot  <span style="color:#007f7f"># cirros1çš„qcow2é•œåƒä»ç„¶å­˜åœ¨</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># éœ€è¦åœ¨å…³é—­è™šæ‹Ÿæœºä¹‹å‰ï¼Œé‡æ–°å®šä¹‰defineä¸€ä¸ªé…ç½®æ–‡ä»¶å³å¯æ¢å¤</span>
</span></span><span style="display:flex;"><span>virsh  dumpxml   centos-C  &gt; /etc/libvirt/qemu/centos-C.xml       
</span></span><span style="display:flex;"><span>virsh define /etc/libvirt/qemu/centos-C.xml 
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># å¦‚æœæ˜¯åœ¨å…³é—­ç€çš„æœåŠ¡å™¨ä¸Šæ‰§è¡Œçš„virsh undefine  centos-C åˆ é™¤å‘½ä»¤ï¼Œåˆ™ä¼šæŠŠå¯¹åº”çš„é…ç½®æ–‡ä»¶æ¸…ç©ºï¼Œè™šæ‹Ÿæœºå†ä¹Ÿå¯åŠ¨ä¸äº†ï¼Œé‡æ–°å®šä¹‰ä¹Ÿä¸è¡Œ</span>
</span></span><span style="display:flex;"><span>å¯¹äº
</span></span></code></pre></div><h3 id="å‚è€ƒ">å‚è€ƒ<a hidden class="anchor" aria-hidden="true" href="#å‚è€ƒ">#</a></h3>
<p><a href="https://www.jianshu.com/p/6cccc7f3e1f9">åœ¨ Ubuntu çš„ KVM ä¸­å®‰è£… Windows ç³»ç»Ÿ</a></p>
<p><a href="https://www.cnblogs.com/wn1m/p/11280804.html">virshä½¿ç”¨æ€»ç»“</a></p>
<p><a href="https://www.cnblogs.com/qiuhom-1874/p/13508231.html">kvmç®¡ç†å’ŒåŸºç¡€å‘½ä»¤</a></p>
<p><a href="https://www.cnblogs.com/yangsirs/p/6651798.html">kvmå‘½ä»¤æ€»ç»“å’Œè™šæœºå™¨å¤‡ä»½è¿ç§»</a></p>
<p><a href="https://www.linuxtechi.com/install-kvm-on-ubuntu-20-04-lts-server/">How to Install KVM on Ubuntu 20.04 LTS Server (Focal Fossa)</a></p>
<p><a href="https://www.cnblogs.com/sammyliu/p/4486712.html">Libvirtè™šæ‹Ÿæœºç”Ÿå‘½å‘¨æœŸ</a></p>
<p><a href="https://www.ibm.com/support/knowledgecenter/linuxonibm/com.ibm.linux.z.ldva/ldva_t_modifyingCPUNumber.html">Modify cpu number </a></p>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="https://blog.niuhemoon.win/tags/kvm/">KVM</a></li>
      <li><a href="https://blog.niuhemoon.win/tags/openstack/">Openstack</a></li>
    </ul>
<nav class="paginav">
  <a class="prev" href="https://blog.niuhemoon.win/posts/tech/openstack-command-tutorial/">
    <span class="title">Â« ä¸Šä¸€é¡µ</span>
    <br>
    <span>Openstackå‘½ä»¤è¡ŒåŸºç¡€</span>
  </a>
  <a class="next" href="https://blog.niuhemoon.win/posts/tech/tcpdump-usage/">
    <span class="title">ä¸‹ä¸€é¡µ Â»</span>
    <br>
    <span>tcpdumpçš„åŸºæœ¬ä½¿ç”¨ã€è¯‘ã€‘</span>
  </a>
</nav>

  </footer><head>
    
    <link
      rel="stylesheet"
      href="https://unpkg.com/@waline/client@v2/dist/waline.css"
    />
    
  </head>
  <body>
    
    <div style="margin-top: 30px;" id="waline"></div>
    <script async type="module">
      import { init } from 'https://unpkg.com/@waline/client@v2/dist/waline.mjs';
  
      init({
        el: '#waline',
        dark: '.dark',
         
        serverURL: 'https://comment.niuhemoon.win/',
      });
    </script>
  </body>
</head>
</article>
    </main>
    
<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js">
</script>  
<footer class="footer">
    <span>&copy; 2022 <a href="https://blog.niuhemoon.win">Niuhe&#39;s Blog</a></span>
    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
    <span id="busuanzi_container_site_pv">
        æœ¬ç«™æ€»è®¿é—®é‡<span id="busuanzi_value_site_pv"></span>æ¬¡
    </span>
    <span id="busuanzi_container_site_uv">
        æœ¬ç«™è®¿å®¢æ•°<span id="busuanzi_value_site_uv"></span>äººæ¬¡
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = 'ğŸ“„å¤åˆ¶';

        function copyingDone() {
            copybutton.innerHTML = 'ğŸ‘ŒğŸ»å·²å¤åˆ¶!';
            setTimeout(() => {
                copybutton.innerHTML = 'ğŸ“„å¤åˆ¶';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
