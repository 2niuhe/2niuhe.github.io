<!DOCTYPE html>
<html lang="zh" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>Python进阶下 | Niuhe&#39;s Blog</title>
<meta name="keywords" content="Python">
<meta name="description" content="Python进阶技巧总结,包含多线程和多进程基础">
<meta name="author" content="Niuhe">
<link rel="canonical" href="https://blog.niuhemoon.win/posts/tech/python-advanced-3/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.3613efbd0b1772781e8f49935e973cae632a7f61471c05b17be155505ccf87b5.css" integrity="sha256-NhPvvQsXcngej0mTXpc8rmMqf2FHHAWxe&#43;FVUFzPh7U=" rel="preload stylesheet" as="style">
<script defer crossorigin="anonymous" src="/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js" integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG&#43;9vmJ0cTS&#43;ovo0FeA="
    onload="hljs.initHighlightingOnLoad();"></script>
<link rel="icon" href="https://blog.niuhemoon.win/base/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="https://blog.niuhemoon.win/base/favicon.ico">
<link rel="icon" type="image/png" sizes="32x32" href="https://blog.niuhemoon.win/base/favicon.ico">
<link rel="apple-touch-icon" href="https://blog.niuhemoon.win/base/avatar.jpeg">
<link rel="mask-icon" href="https://blog.niuhemoon.win/base/avatar.jpeg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --hljs-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript>
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
	ga('create', 'UA-116933089-1', 'auto');
	
	ga('send', 'pageview');
}
</script><meta property="og:title" content="Python进阶下" />
<meta property="og:description" content="Python进阶技巧总结,包含多线程和多进程基础" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://blog.niuhemoon.win/posts/tech/python-advanced-3/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2020-10-13T00:00:00+00:00" />
<meta property="article:modified_time" content="2020-10-13T00:00:00+00:00" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Python进阶下"/>
<meta name="twitter:description" content="Python进阶技巧总结,包含多线程和多进程基础"/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "📚文章",
      "item": "https://blog.niuhemoon.win/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  3 ,
      "name": "👨🏻‍💻 技术",
      "item": "https://blog.niuhemoon.win/posts/tech/"
    }, 
    {
      "@type": "ListItem",
      "position":  4 ,
      "name": "Python进阶下",
      "item": "https://blog.niuhemoon.win/posts/tech/python-advanced-3/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "Python进阶下",
  "name": "Python进阶下",
  "description": "Python进阶技巧总结,包含多线程和多进程基础",
  "keywords": [
    "Python"
  ],
  "articleBody": " 有两种常用的方法可以使得代码并行执行，多线程和多进程 。因为Cython解释器的实现不是线程安全的，具有GIL锁，同一时刻，只有一个线程可以获得解释器的锁。因此，Python利用多核心的CPU只能通过多进程，而多线程只适用于IO密集型的程序。\n多进程基础 创建并开启进程 可以使用multiprocessing.Process()来创建进程，它接受两个参数：\ntarget，一个可调用的函数，当进程开始时会执行 args，一个元组，提供目标函数的参数 使用process.start()来开始执行一个进程\n调用process.join()来告诉程序等待进程结束再执行后续代码，主进程将会被阻塞\nfrom multiprocessing import Process import os def square_numbers(): for i in range(1000): result = i * i if __name__ == \"__main__\": processes = [] num_processes = os.cpu_count() # number of CPUs on the machine. Usually a good choise for the number of processes # create processes and asign a function for each process for i in range(num_processes): process = Process(target=square_numbers) processes.append(process) # start all processes for process in processes: process.start() # wait for all processes to finish # block the main programm until these processes are finished for process in processes: process.join() 进程间分享数据 因为进程的内存空间不同，需要特殊的共享内存对象来分享数据。\n数据可以保存在共享内存变量中，使用Value或者Array\nValue(type, value)创建一个ctype对象 Array(type, value)创建一个ctype类型的列表 如下程序演示年race condition资源竟态，每次执行结果都不一样，例如当两个进程读取同一个值，并对其执行+1操作，然后写会原有地址，其结果并不是预想的加2。\nfrom multiprocessing import Process, Value, Array import time def add_100(number): for _ in range(100): time.sleep(0.001) number.value += 1 def add_100_array(numbers): for _ in range(100): time.sleep(0.01) for i in range(len(numbers)): numbers[i] += 1 if __name__ == \"__main__\": shared_number = Value('i', 0) print('Value at beginning:', shared_number.value) shared_array = Array('d', [0.0, 100.0, 200.0]) print('Array at beginning:', shared_array[:]) process1 = Process(target=add_100, args=(shared_number,)) process2 = Process(target=add_100, args=(shared_number,)) process3 = Process(target=add_100_array, args=(shared_array,)) process4 = Process(target=add_100_array, args=(shared_array,)) process1.start() process2.start() process3.start() process4.start() process1.join() process2.join() process3.join() process4.join() print('Value at end:', shared_number.value) print('Array at end:', shared_array[:]) print('end main') \"\"\" Value at beginning: 0 Array at beginning: [0.0, 100.0, 200.0] Value at end: 144 Array at end: [134.0, 237.0, 339.0] end main \"\"\" 可以使用锁避免资源竟态 锁（也称为互斥锁）是一种同步机制，用于在存在许多执行进程/线程的环境中强制限制对资源的访问。锁具有两种状态：锁定和解锁。 如果状态为锁定，则在再次解除锁定状态之前，不允许其他并发进程/线程进入此代码段。\n# import Lock from multiprocessing import Lock from multiprocessing import Process, Value, Array import time def add_100(number, lock): for _ in range(100): time.sleep(0.001) # lock the state lock.acquire() number.value += 1 # unlock the state lock.release() def add_100_array(numbers, lock): for _ in range(100): time.sleep(0.01) for i in range(len(numbers)): lock.acquire() numbers[i] += 1 lock.release() if __name__ == \"__main__\": # create a lock lock1 = Lock() lock2 = Lock() shared_number = Value('i', 0) print('Value at beginning:', shared_number.value) shared_array = Array('d', [0.0, 100.0, 200.0]) print('Array at beginning:', shared_array[:]) # pass the lock to the target function process1 = Process(target=add_100, args=(shared_number, lock1)) process2 = Process(target=add_100, args=(shared_number, lock1)) process3 = Process(target=add_100_array, args=(shared_array, lock2)) process4 = Process(target=add_100_array, args=(shared_array, lock2)) process1.start() process2.start() process3.start() process4.start() process1.join() process2.join() process3.join() process4.join() print('Value at end:', shared_number.value) print('Array at end:', shared_array[:]) print('end main') \"\"\" Value at beginning: 0 Array at beginning: [0.0, 100.0, 200.0] Value at end: 200 Array at end: [200.0, 300.0, 400.0] end main \"\"\" 在上下文管理器中使用锁 使用上下文管理器管理锁的获取和释放更加安全\ndef add_100(number, lock): for _ in range(100): time.sleep(0.01) with lock: number.value += 1 多进程使用队列通信 使用队列的操作是进程安全的。多进程队列实现了队列的所有方法。done()和join()除外。\nq.get():移除队首第一个元素，默认情况，会阻塞直到有元素可用 q.put(item)将元素压到队尾，默认情况，阻塞直到队列有空的槽 q.empty()如果队列为空，返回True q.close()表明当前进程不会有新的数据放到队列中了 # communicate between processes with the multiprocessing Queue # Queues are thread and process safe from multiprocessing import Process, Queue import time def square(numbers, queue): for i in numbers: time.sleep(0.01) queue.put(i*i) def make_negative(numbers, queue): for i in numbers: time.sleep(0.01) queue.put(i*-1) if __name__ == \"__main__\": numbers = range(1, 6) q = Queue() p1 = Process(target=square, args=(numbers,q)) p2 = Process(target=make_negative, args=(numbers,q)) p1.start() p2.start() p1.join() p2.join() # order might not be sequential while not q.empty(): print(q.get()) print('end main') \"\"\" 1 -1 4 -2 9 -3 16 -4 25 -5 end main \"\"\" 进程池 进程池对象控制一些工作进程worker，可以支持超时和回调以实现异步处理，也有一些并行的map实现。它可以自动管理多个处理器，并将数据分成小块，在多个处理器上并行处理。\n重要的函数包括：\nmap(func, iterable[, chunksize])将可迭代对象切分成小块，作为独立任务提交到进程池，并行处理。函数将会阻塞，直到返回结果。 close()阻止更多任务添加到进程池，一旦任务完成，worker进程将退出 join()等待工作进程退出，在调用join()之前需要调用close()或者terminate() apply(func, args)调用func函数，参数是args。阻塞直到返回结果，func函数只在进程池中一个worker中执行 有map_async()和apply_async()这种非阻塞的异步函数 from multiprocessing import Pool import random import time def cube(number): print(\"Hi\") time.sleep(random.randint(1,2)) return number * number * number if __name__ == \"__main__\": numbers = range(10) p = Pool() # by default this allocates the maximum number of available # processors for this task --\u003e os.cpu_count() result = p.map(cube, numbers) # or # result = [p.apply(cube, args=(i,)) for i in numbers] p.close() p.join() print(result) 多线程基础 Python多线程相对比较鸡肋，其使用和多进程类似\n创建并开始线程 使用threading库实现\nfrom threading import Thread def square_numbers(): for i in range(1000): result = i * i if __name__ == \"__main__\": threads = [] num_threads = 10 # create threads and asign a function for each thread for i in range(num_threads): thread = Thread(target=square_numbers) threads.append(thread) # start all threads for thread in threads: thread.start() # wait for all threads to finish # block the main thread until these threads are finished for thread in threads: thread.join() 线程间共享数据 线程间可以通过全局变量来共享数据，因为线程间是共享内存空间的\nfrom threading import Thread import time # all threads can access this global variable database_value = 0 def increase(): global database_value # needed to modify the global value # get a local copy (simulate data retrieving) local_copy = database_value # simulate some modifying operation local_copy += 1 time.sleep(0.1) # write the calculated new value into the global variable database_value = local_copy if __name__ == \"__main__\": print('Start value: ', database_value) t1 = Thread(target=increase) t2 = Thread(target=increase) t1.start() t2.start() t1.join() t2.join() print('End value:', database_value) print('end main') \"\"\" Start value: 0 End value: 1 end main \"\"\" 使用锁处理资源竟态 # import Lock from threading import Thread, Lock import time database_value = 0 def increase(lock): global database_value # lock the state lock.acquire() local_copy = database_value local_copy += 1 time.sleep(0.1) database_value = local_copy # unlock the state lock.release() if __name__ == \"__main__\": # create a lock lock = Lock() print('Start value: ', database_value) # pass the lock to the target function t1 = Thread(target=increase, args=(lock,)) # notice the comma after lock since args must be a tuple t2 = Thread(target=increase, args=(lock,)) t1.start() t2.start() t1.join() t2.join() print('End value:', database_value) print('end main') 使用上下文管理器\ndef increase(lock): global database_value with lock: local_copy = database_value local_copy += 1 time.sleep(0.1) database_value = local_copy 多线程消息队列通信 对队列的操作是线程安全的\nfrom threading import Thread, Lock, current_thread from queue import Queue def worker(q, lock): while True: value = q.get() # blocks until the item is available # do stuff... with lock: # prevent printing at the same time with this lock print(f\"in {current_thread().name} got {value}\") # ... # For each get(), a subsequent call to task_done() tells the queue # that the processing on this item is complete. # If all tasks are done, q.join() can unblock q.task_done() if __name__ == '__main__': q = Queue() num_threads = 10 lock = Lock() for i in range(num_threads): t = Thread(name=f\"Thread{i+1}\", target=worker, args=(q, lock)) t.daemon = True # dies when the main thread dies t.start() # fill the queue with items for x in range(20): q.put(x) q.join() # Blocks until all items in the queue have been gotten and processed. print('main done') \"\"\" in Thread1 got 0 in Thread2 got 1 in Thread2 got 11 in Thread2 got 12 in Thread2 got 13 in Thread2 got 14 in Thread2 got 15 in Thread2 got 16 in Thread2 got 17 in Thread2 got 18 in Thread2 got 19 in Thread8 got 5 in Thread4 got 9 in Thread1 got 10 in Thread5 got 2 in Thread6 got 3 in Thread9 got 6 in Thread7 got 4 in Thread10 got 7 in Thread3 got 8 main done \"\"\" Python标准库自带的一些小工具 # 查看包安装路径 python -m site # 开启简单的http server python -m http.server # base64编码和解码 echo \"hello\" | python -m base64 # top level await console python -m asyncio # 查看tokenize和ast结果 python -m tokenize cgi.py pythono -m ast cgi.py # json美化输出 echo '{\"foo\": \"bar\"}' | python -m json.tool # 显示日历 python -m calendar 参考 Python多线程和多进程 CLI tools hidden in the Python standard library | Simon Willison’s TILs\n",
  "wordCount" : "2417",
  "inLanguage": "zh",
  "datePublished": "2020-10-13T00:00:00Z",
  "dateModified": "2020-10-13T00:00:00Z",
  "author":{
    "@type": "Person",
    "name": "Niuhe"
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://blog.niuhemoon.win/posts/tech/python-advanced-3/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Niuhe's Blog",
    "logo": {
      "@type": "ImageObject",
      "url": "https://blog.niuhemoon.win/base/favicon.ico"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://blog.niuhemoon.win" accesskey="h" title="Niuhe&#39;s Blog (Alt + H)">
                <img src="https://blog.niuhemoon.win/base/avatar.jpeg" alt="" aria-label="logo"
                    height="35">Niuhe&#39;s Blog</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="https://blog.niuhemoon.win/search" title="🔍搜索 (Alt &#43; /)" accesskey=/>
                    <span>🔍搜索</span>
                </a>
            </li>
            <li>
                <a href="https://blog.niuhemoon.win/" title="🏠主页">
                    <span>🏠主页</span>
                </a>
            </li>
            <li>
                <a href="https://blog.niuhemoon.win/posts" title="📚文章">
                    <span>📚文章</span>
                </a>
            </li>
            <li>
                <a href="https://blog.niuhemoon.win/tags" title="🔖标签">
                    <span>🔖标签</span>
                </a>
            </li>
            <li>
                <a href="https://blog.niuhemoon.win/archives/" title="⏱时间轴">
                    <span>⏱时间轴</span>
                </a>
            </li>
            <li>
                <a href="https://blog.niuhemoon.win/about" title="🙋🏻‍♂️关于">
                    <span>🙋🏻‍♂️关于</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="https://blog.niuhemoon.win">🏠主页</a>&nbsp;»&nbsp;<a href="https://blog.niuhemoon.win/posts/">📚文章</a>&nbsp;»&nbsp;<a href="https://blog.niuhemoon.win/posts/tech/">👨🏻‍💻 技术</a></div>
    <h1 class="post-title">
      Python进阶下
    </h1>
    <div class="post-description">
      Python进阶技巧总结,包含多线程和多进程基础
    </div>
    <div class="post-meta"><span title='2020-10-13 00:00:00 +0000 UTC'>2020-10-13</span>&nbsp;·&nbsp;5 min&nbsp;·&nbsp;2417 字&nbsp;·&nbsp;Niuhe

</div>
  </header> <div class="toc">
    <details  open>
        <summary accesskey="c" title="(Alt + C)">
            <span class="details">文章目录</span>
        </summary>

        <div class="inner"><ul>
                <li>
                    <a href="#%e5%a4%9a%e8%bf%9b%e7%a8%8b%e5%9f%ba%e7%a1%80" aria-label="多进程基础">多进程基础</a><ul>
                        <ul>
                        
                <li>
                    <a href="#%e5%88%9b%e5%bb%ba%e5%b9%b6%e5%bc%80%e5%90%af%e8%bf%9b%e7%a8%8b" aria-label="创建并开启进程">创建并开启进程</a></li>
                <li>
                    <a href="#%e8%bf%9b%e7%a8%8b%e9%97%b4%e5%88%86%e4%ba%ab%e6%95%b0%e6%8d%ae" aria-label="进程间分享数据">进程间分享数据</a></li>
                <li>
                    <a href="#%e5%8f%af%e4%bb%a5%e4%bd%bf%e7%94%a8%e9%94%81%e9%81%bf%e5%85%8d%e8%b5%84%e6%ba%90%e7%ab%9f%e6%80%81" aria-label="可以使用锁避免资源竟态">可以使用锁避免资源竟态</a></li>
                <li>
                    <a href="#%e5%9c%a8%e4%b8%8a%e4%b8%8b%e6%96%87%e7%ae%a1%e7%90%86%e5%99%a8%e4%b8%ad%e4%bd%bf%e7%94%a8%e9%94%81" aria-label="在上下文管理器中使用锁">在上下文管理器中使用锁</a></li>
                <li>
                    <a href="#%e5%a4%9a%e8%bf%9b%e7%a8%8b%e4%bd%bf%e7%94%a8%e9%98%9f%e5%88%97%e9%80%9a%e4%bf%a1" aria-label="多进程使用队列通信">多进程使用队列通信</a></li>
                <li>
                    <a href="#%e8%bf%9b%e7%a8%8b%e6%b1%a0" aria-label="进程池">进程池</a></li></ul>
                    </ul>
                </li>
                <li>
                    <a href="#%e5%a4%9a%e7%ba%bf%e7%a8%8b%e5%9f%ba%e7%a1%80" aria-label="多线程基础">多线程基础</a><ul>
                        <ul>
                        
                <li>
                    <a href="#%e5%88%9b%e5%bb%ba%e5%b9%b6%e5%bc%80%e5%a7%8b%e7%ba%bf%e7%a8%8b" aria-label="创建并开始线程">创建并开始线程</a></li>
                <li>
                    <a href="#%e7%ba%bf%e7%a8%8b%e9%97%b4%e5%85%b1%e4%ba%ab%e6%95%b0%e6%8d%ae" aria-label="线程间共享数据">线程间共享数据</a></li>
                <li>
                    <a href="#%e4%bd%bf%e7%94%a8%e9%94%81%e5%a4%84%e7%90%86%e8%b5%84%e6%ba%90%e7%ab%9f%e6%80%81" aria-label="使用锁处理资源竟态">使用锁处理资源竟态</a></li>
                <li>
                    <a href="#%e5%a4%9a%e7%ba%bf%e7%a8%8b%e6%b6%88%e6%81%af%e9%98%9f%e5%88%97%e9%80%9a%e4%bf%a1" aria-label="多线程消息队列通信">多线程消息队列通信</a></li></ul>
                    
                <li>
                    <a href="#python%e6%a0%87%e5%87%86%e5%ba%93%e8%87%aa%e5%b8%a6%e7%9a%84%e4%b8%80%e4%ba%9b%e5%b0%8f%e5%b7%a5%e5%85%b7" aria-label="Python标准库自带的一些小工具">Python标准库自带的一些小工具</a></li></ul>
                </li>
                <li>
                    <a href="#%e5%8f%82%e8%80%83" aria-label="参考">参考</a>
                </li>
            </ul>
        </div>
    </details>
</div>

  <div class="post-content"><blockquote>
<p>有两种常用的方法可以使得代码并行执行，多线程和多进程 。因为Cython解释器的实现不是线程安全的，具有GIL锁，同一时刻，只有一个线程可以获得解释器的锁。因此，Python利用多核心的CPU只能通过多进程，而多线程只适用于IO密集型的程序。</p>
</blockquote>
<h3 id="多进程基础">多进程基础<a hidden class="anchor" aria-hidden="true" href="#多进程基础">#</a></h3>
<h5 id="创建并开启进程">创建并开启进程<a hidden class="anchor" aria-hidden="true" href="#创建并开启进程">#</a></h5>
<blockquote>
<p>可以使用<code>multiprocessing.Process()</code>来创建进程，它接受两个参数：</p>
<ul>
<li>target，一个可调用的函数，当进程开始时会执行</li>
<li>args，一个元组，提供目标函数的参数</li>
</ul>
<p>使用<code>process.start()</code>来开始执行一个进程</p>
<p>调用<code>process.join()</code>来告诉程序等待进程结束再执行后续代码，主进程将会被阻塞</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">from</span> multiprocessing <span style="color:#fff;font-weight:bold">import</span> Process
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> os
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">def</span> square_numbers():
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">for</span> i in <span style="color:#fff;font-weight:bold">range</span>(<span style="color:#ff0;font-weight:bold">1000</span>):
</span></span><span style="display:flex;"><span>        result = i * i
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">if</span> __name__ == <span style="color:#0ff;font-weight:bold">&#34;__main__&#34;</span>:        
</span></span><span style="display:flex;"><span>    processes = []
</span></span><span style="display:flex;"><span>    num_processes = os.cpu_count()
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f"># number of CPUs on the machine. Usually a good choise for the number of processes</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f"># create processes and asign a function for each process</span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">for</span> i in <span style="color:#fff;font-weight:bold">range</span>(num_processes):
</span></span><span style="display:flex;"><span>        process = Process(target=square_numbers)
</span></span><span style="display:flex;"><span>        processes.append(process)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f"># start all processes</span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">for</span> process in processes:
</span></span><span style="display:flex;"><span>        process.start()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f"># wait for all processes to finish</span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f"># block the main programm until these processes are finished</span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">for</span> process in processes:
</span></span><span style="display:flex;"><span>        process.join()
</span></span></code></pre></div><h5 id="进程间分享数据">进程间分享数据<a hidden class="anchor" aria-hidden="true" href="#进程间分享数据">#</a></h5>
<blockquote>
<p>因为进程的内存空间不同，需要特殊的共享内存对象来分享数据。</p>
<p>数据可以保存在共享内存变量中，使用<code>Value</code>或者<code>Array</code></p>
<ul>
<li>Value(type, value)创建一个<code>ctype</code>对象</li>
<li>Array(type, value)创建一个<code>ctype</code>类型的列表</li>
</ul>
<p>如下程序演示年race condition资源竟态，每次执行结果都不一样，例如当两个进程读取同一个值，并对其执行+1操作，然后写会原有地址，其结果并不是预想的加2。</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">from</span> multiprocessing <span style="color:#fff;font-weight:bold">import</span> Process, Value, Array
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> time
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">def</span> add_100(number):
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">for</span> _ in <span style="color:#fff;font-weight:bold">range</span>(<span style="color:#ff0;font-weight:bold">100</span>):
</span></span><span style="display:flex;"><span>        time.sleep(<span style="color:#ff0;font-weight:bold">0.001</span>)
</span></span><span style="display:flex;"><span>        number.value += <span style="color:#ff0;font-weight:bold">1</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">def</span> add_100_array(numbers):
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">for</span> _ in <span style="color:#fff;font-weight:bold">range</span>(<span style="color:#ff0;font-weight:bold">100</span>):
</span></span><span style="display:flex;"><span>        time.sleep(<span style="color:#ff0;font-weight:bold">0.01</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">for</span> i in <span style="color:#fff;font-weight:bold">range</span>(<span style="color:#fff;font-weight:bold">len</span>(numbers)):
</span></span><span style="display:flex;"><span>            numbers[i] += <span style="color:#ff0;font-weight:bold">1</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">if</span> __name__ == <span style="color:#0ff;font-weight:bold">&#34;__main__&#34;</span>:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    shared_number = Value(<span style="color:#0ff;font-weight:bold">&#39;i&#39;</span>, <span style="color:#ff0;font-weight:bold">0</span>) 
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">print</span>(<span style="color:#0ff;font-weight:bold">&#39;Value at beginning:&#39;</span>, shared_number.value)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    shared_array = Array(<span style="color:#0ff;font-weight:bold">&#39;d&#39;</span>, [<span style="color:#ff0;font-weight:bold">0.0</span>, <span style="color:#ff0;font-weight:bold">100.0</span>, <span style="color:#ff0;font-weight:bold">200.0</span>])
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">print</span>(<span style="color:#0ff;font-weight:bold">&#39;Array at beginning:&#39;</span>, shared_array[:])
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    process1 = Process(target=add_100, args=(shared_number,))
</span></span><span style="display:flex;"><span>    process2 = Process(target=add_100, args=(shared_number,))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    process3 = Process(target=add_100_array, args=(shared_array,))
</span></span><span style="display:flex;"><span>    process4 = Process(target=add_100_array, args=(shared_array,))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    process1.start()
</span></span><span style="display:flex;"><span>    process2.start()
</span></span><span style="display:flex;"><span>    process3.start()
</span></span><span style="display:flex;"><span>    process4.start()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    process1.join()
</span></span><span style="display:flex;"><span>    process2.join()
</span></span><span style="display:flex;"><span>    process3.join()
</span></span><span style="display:flex;"><span>    process4.join()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">print</span>(<span style="color:#0ff;font-weight:bold">&#39;Value at end:&#39;</span>, shared_number.value)
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">print</span>(<span style="color:#0ff;font-weight:bold">&#39;Array at end:&#39;</span>, shared_array[:])
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">print</span>(<span style="color:#0ff;font-weight:bold">&#39;end main&#39;</span>)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span><span style="color:#0ff;font-weight:bold">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#0ff;font-weight:bold">    Value at beginning: 0
</span></span></span><span style="display:flex;"><span><span style="color:#0ff;font-weight:bold">    Array at beginning: [0.0, 100.0, 200.0]
</span></span></span><span style="display:flex;"><span><span style="color:#0ff;font-weight:bold">    Value at end: 144
</span></span></span><span style="display:flex;"><span><span style="color:#0ff;font-weight:bold">    Array at end: [134.0, 237.0, 339.0]
</span></span></span><span style="display:flex;"><span><span style="color:#0ff;font-weight:bold">    end main
</span></span></span><span style="display:flex;"><span><span style="color:#0ff;font-weight:bold">&#34;&#34;&#34;</span>
</span></span></code></pre></div><h5 id="可以使用锁避免资源竟态">可以使用锁避免资源竟态<a hidden class="anchor" aria-hidden="true" href="#可以使用锁避免资源竟态">#</a></h5>
<blockquote>
<p>锁（也称为互斥锁）是一种同步机制，用于在存在许多执行进程/线程的环境中强制限制对资源的访问。锁具有两种状态：锁定和解锁。 如果状态为锁定，则在再次解除锁定状态之前，不允许其他并发进程/线程进入此代码段。</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#007f7f"># import Lock</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">from</span> multiprocessing <span style="color:#fff;font-weight:bold">import</span> Lock
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">from</span> multiprocessing <span style="color:#fff;font-weight:bold">import</span> Process, Value, Array
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> time
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">def</span> add_100(number, lock):
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">for</span> _ in <span style="color:#fff;font-weight:bold">range</span>(<span style="color:#ff0;font-weight:bold">100</span>):
</span></span><span style="display:flex;"><span>        time.sleep(<span style="color:#ff0;font-weight:bold">0.001</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f"># lock the state</span>
</span></span><span style="display:flex;"><span>        lock.acquire()
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        number.value += <span style="color:#ff0;font-weight:bold">1</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f"># unlock the state</span>
</span></span><span style="display:flex;"><span>        lock.release()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">def</span> add_100_array(numbers, lock):
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">for</span> _ in <span style="color:#fff;font-weight:bold">range</span>(<span style="color:#ff0;font-weight:bold">100</span>):
</span></span><span style="display:flex;"><span>        time.sleep(<span style="color:#ff0;font-weight:bold">0.01</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">for</span> i in <span style="color:#fff;font-weight:bold">range</span>(<span style="color:#fff;font-weight:bold">len</span>(numbers)):
</span></span><span style="display:flex;"><span>            lock.acquire()
</span></span><span style="display:flex;"><span>            numbers[i] += <span style="color:#ff0;font-weight:bold">1</span>
</span></span><span style="display:flex;"><span>            lock.release()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">if</span> __name__ == <span style="color:#0ff;font-weight:bold">&#34;__main__&#34;</span>:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f"># create a lock</span>
</span></span><span style="display:flex;"><span>    lock1 = Lock()
</span></span><span style="display:flex;"><span>    lock2 = Lock()
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    shared_number = Value(<span style="color:#0ff;font-weight:bold">&#39;i&#39;</span>, <span style="color:#ff0;font-weight:bold">0</span>) 
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">print</span>(<span style="color:#0ff;font-weight:bold">&#39;Value at beginning:&#39;</span>, shared_number.value)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    shared_array = Array(<span style="color:#0ff;font-weight:bold">&#39;d&#39;</span>, [<span style="color:#ff0;font-weight:bold">0.0</span>, <span style="color:#ff0;font-weight:bold">100.0</span>, <span style="color:#ff0;font-weight:bold">200.0</span>])
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">print</span>(<span style="color:#0ff;font-weight:bold">&#39;Array at beginning:&#39;</span>, shared_array[:])
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f"># pass the lock to the target function</span>
</span></span><span style="display:flex;"><span>    process1 = Process(target=add_100, args=(shared_number, lock1))
</span></span><span style="display:flex;"><span>    process2 = Process(target=add_100, args=(shared_number, lock1))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    process3 = Process(target=add_100_array, args=(shared_array, lock2))
</span></span><span style="display:flex;"><span>    process4 = Process(target=add_100_array, args=(shared_array, lock2))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    process1.start()
</span></span><span style="display:flex;"><span>    process2.start()
</span></span><span style="display:flex;"><span>    process3.start()
</span></span><span style="display:flex;"><span>    process4.start()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    process1.join()
</span></span><span style="display:flex;"><span>    process2.join()
</span></span><span style="display:flex;"><span>    process3.join()
</span></span><span style="display:flex;"><span>    process4.join()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">print</span>(<span style="color:#0ff;font-weight:bold">&#39;Value at end:&#39;</span>, shared_number.value)
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">print</span>(<span style="color:#0ff;font-weight:bold">&#39;Array at end:&#39;</span>, shared_array[:])
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">print</span>(<span style="color:#0ff;font-weight:bold">&#39;end main&#39;</span>)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span><span style="color:#0ff;font-weight:bold">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#0ff;font-weight:bold">Value at beginning: 0
</span></span></span><span style="display:flex;"><span><span style="color:#0ff;font-weight:bold">Array at beginning: [0.0, 100.0, 200.0]
</span></span></span><span style="display:flex;"><span><span style="color:#0ff;font-weight:bold">Value at end: 200
</span></span></span><span style="display:flex;"><span><span style="color:#0ff;font-weight:bold">Array at end: [200.0, 300.0, 400.0]
</span></span></span><span style="display:flex;"><span><span style="color:#0ff;font-weight:bold">end main
</span></span></span><span style="display:flex;"><span><span style="color:#0ff;font-weight:bold">&#34;&#34;&#34;</span>
</span></span></code></pre></div><h5 id="在上下文管理器中使用锁">在上下文管理器中使用锁<a hidden class="anchor" aria-hidden="true" href="#在上下文管理器中使用锁">#</a></h5>
<blockquote>
<p>使用上下文管理器管理锁的获取和释放更加安全</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">def</span> add_100(number, lock):
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">for</span> _ in <span style="color:#fff;font-weight:bold">range</span>(<span style="color:#ff0;font-weight:bold">100</span>):
</span></span><span style="display:flex;"><span>        time.sleep(<span style="color:#ff0;font-weight:bold">0.01</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">with</span> lock:
</span></span><span style="display:flex;"><span>            number.value += <span style="color:#ff0;font-weight:bold">1</span>
</span></span></code></pre></div><h5 id="多进程使用队列通信">多进程使用队列通信<a hidden class="anchor" aria-hidden="true" href="#多进程使用队列通信">#</a></h5>
<blockquote>
<p>使用队列的操作是进程安全的。多进程队列实现了队列的所有方法。done()和join()除外。</p>
<ul>
<li><code>q.get()</code>:移除队首第一个元素，默认情况，会阻塞直到有元素可用</li>
<li><code>q.put(item)</code>将元素压到队尾，默认情况，阻塞直到队列有空的槽</li>
<li><code>q.empty()</code>如果队列为空，返回True</li>
<li><code>q.close()</code>表明当前进程不会有新的数据放到队列中了</li>
</ul>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#007f7f"># communicate between processes with the multiprocessing Queue</span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># Queues are thread and process safe</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">from</span> multiprocessing <span style="color:#fff;font-weight:bold">import</span> Process, Queue
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> time 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">def</span> square(numbers, queue):
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">for</span> i in numbers:
</span></span><span style="display:flex;"><span>        time.sleep(<span style="color:#ff0;font-weight:bold">0.01</span>)
</span></span><span style="display:flex;"><span>        queue.put(i*i)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">def</span> make_negative(numbers, queue):
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">for</span> i in numbers:
</span></span><span style="display:flex;"><span>        time.sleep(<span style="color:#ff0;font-weight:bold">0.01</span>)
</span></span><span style="display:flex;"><span>        queue.put(i*-<span style="color:#ff0;font-weight:bold">1</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">if</span> __name__ == <span style="color:#0ff;font-weight:bold">&#34;__main__&#34;</span>:
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    numbers = <span style="color:#fff;font-weight:bold">range</span>(<span style="color:#ff0;font-weight:bold">1</span>, <span style="color:#ff0;font-weight:bold">6</span>)
</span></span><span style="display:flex;"><span>    q = Queue()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    p1 = Process(target=square, args=(numbers,q))
</span></span><span style="display:flex;"><span>    p2 = Process(target=make_negative, args=(numbers,q))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    p1.start()
</span></span><span style="display:flex;"><span>    p2.start()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    p1.join()
</span></span><span style="display:flex;"><span>    p2.join()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f"># order might not be sequential</span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">while</span> not q.empty():
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">print</span>(q.get())
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">print</span>(<span style="color:#0ff;font-weight:bold">&#39;end main&#39;</span>)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span><span style="color:#0ff;font-weight:bold">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#0ff;font-weight:bold">1
</span></span></span><span style="display:flex;"><span><span style="color:#0ff;font-weight:bold">-1
</span></span></span><span style="display:flex;"><span><span style="color:#0ff;font-weight:bold">4
</span></span></span><span style="display:flex;"><span><span style="color:#0ff;font-weight:bold">-2
</span></span></span><span style="display:flex;"><span><span style="color:#0ff;font-weight:bold">9
</span></span></span><span style="display:flex;"><span><span style="color:#0ff;font-weight:bold">-3
</span></span></span><span style="display:flex;"><span><span style="color:#0ff;font-weight:bold">16
</span></span></span><span style="display:flex;"><span><span style="color:#0ff;font-weight:bold">-4
</span></span></span><span style="display:flex;"><span><span style="color:#0ff;font-weight:bold">25
</span></span></span><span style="display:flex;"><span><span style="color:#0ff;font-weight:bold">-5
</span></span></span><span style="display:flex;"><span><span style="color:#0ff;font-weight:bold">end main
</span></span></span><span style="display:flex;"><span><span style="color:#0ff;font-weight:bold">&#34;&#34;&#34;</span>
</span></span></code></pre></div><h5 id="进程池">进程池<a hidden class="anchor" aria-hidden="true" href="#进程池">#</a></h5>
<blockquote>
<p>进程池对象控制一些工作进程worker，可以支持超时和回调以实现异步处理，也有一些并行的map实现。它可以自动管理多个处理器，并将数据分成小块，在多个处理器上并行处理。</p>
<p>重要的函数包括：</p>
<ul>
<li><code>map(func, iterable[, chunksize])</code>将可迭代对象切分成小块，作为独立任务提交到进程池，并行处理。函数将会阻塞，直到返回结果。</li>
<li><code>close()</code>阻止更多任务添加到进程池，一旦任务完成，worker进程将退出</li>
<li><code>join()</code>等待工作进程退出，在调用<code>join()</code>之前需要调用<code>close()</code>或者<code>terminate()</code></li>
<li><code>apply(func, args)</code>调用<code>func</code>函数，参数是<code>args</code>。阻塞直到返回结果，<code>func</code>函数只在进程池中一个worker中执行</li>
<li>有<code>map_async()</code>和<code>apply_async()</code>这种非阻塞的异步函数</li>
</ul>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">from</span> multiprocessing <span style="color:#fff;font-weight:bold">import</span> Pool 
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> random
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> time
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">def</span> cube(number):
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">print</span>(<span style="color:#0ff;font-weight:bold">&#34;Hi&#34;</span>)
</span></span><span style="display:flex;"><span>    time.sleep(random.randint(<span style="color:#ff0;font-weight:bold">1</span>,<span style="color:#ff0;font-weight:bold">2</span>))
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">return</span> number * number * number
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">if</span> __name__ == <span style="color:#0ff;font-weight:bold">&#34;__main__&#34;</span>:
</span></span><span style="display:flex;"><span>    numbers = <span style="color:#fff;font-weight:bold">range</span>(<span style="color:#ff0;font-weight:bold">10</span>)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    p = Pool()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f"># by default this allocates the maximum number of available </span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f"># processors for this task --&gt; os.cpu_count()</span>
</span></span><span style="display:flex;"><span>    result = p.map(cube,  numbers)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f"># or </span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f"># result = [p.apply(cube, args=(i,)) for i in numbers]</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    p.close()
</span></span><span style="display:flex;"><span>    p.join()
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">print</span>(result)
</span></span></code></pre></div><h3 id="多线程基础">多线程基础<a hidden class="anchor" aria-hidden="true" href="#多线程基础">#</a></h3>
<blockquote>
<p>Python多线程相对比较鸡肋，其使用和多进程类似</p>
</blockquote>
<h5 id="创建并开始线程">创建并开始线程<a hidden class="anchor" aria-hidden="true" href="#创建并开始线程">#</a></h5>
<blockquote>
<p>使用threading库实现</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">from</span> threading <span style="color:#fff;font-weight:bold">import</span> Thread
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">def</span> square_numbers():
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">for</span> i in <span style="color:#fff;font-weight:bold">range</span>(<span style="color:#ff0;font-weight:bold">1000</span>):
</span></span><span style="display:flex;"><span>        result = i * i
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">if</span> __name__ == <span style="color:#0ff;font-weight:bold">&#34;__main__&#34;</span>:        
</span></span><span style="display:flex;"><span>    threads = []
</span></span><span style="display:flex;"><span>    num_threads = <span style="color:#ff0;font-weight:bold">10</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f"># create threads and asign a function for each thread</span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">for</span> i in <span style="color:#fff;font-weight:bold">range</span>(num_threads):
</span></span><span style="display:flex;"><span>        thread = Thread(target=square_numbers)
</span></span><span style="display:flex;"><span>        threads.append(thread)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f"># start all threads</span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">for</span> thread in threads:
</span></span><span style="display:flex;"><span>        thread.start()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f"># wait for all threads to finish</span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f"># block the main thread until these threads are finished</span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">for</span> thread in threads:
</span></span><span style="display:flex;"><span>        thread.join()
</span></span></code></pre></div><h5 id="线程间共享数据">线程间共享数据<a hidden class="anchor" aria-hidden="true" href="#线程间共享数据">#</a></h5>
<blockquote>
<p>线程间可以通过全局变量来共享数据，因为线程间是共享内存空间的</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">from</span> threading <span style="color:#fff;font-weight:bold">import</span> Thread
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> time
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># all threads can access this global variable</span>
</span></span><span style="display:flex;"><span>database_value = <span style="color:#ff0;font-weight:bold">0</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">def</span> increase():
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">global</span> database_value <span style="color:#007f7f"># needed to modify the global value</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f"># get a local copy (simulate data retrieving)</span>
</span></span><span style="display:flex;"><span>    local_copy = database_value
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f"># simulate some modifying operation</span>
</span></span><span style="display:flex;"><span>    local_copy += <span style="color:#ff0;font-weight:bold">1</span>
</span></span><span style="display:flex;"><span>    time.sleep(<span style="color:#ff0;font-weight:bold">0.1</span>)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f"># write the calculated new value into the global variable</span>
</span></span><span style="display:flex;"><span>    database_value = local_copy
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">if</span> __name__ == <span style="color:#0ff;font-weight:bold">&#34;__main__&#34;</span>:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">print</span>(<span style="color:#0ff;font-weight:bold">&#39;Start value: &#39;</span>, database_value)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    t1 = Thread(target=increase)
</span></span><span style="display:flex;"><span>    t2 = Thread(target=increase)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    t1.start()
</span></span><span style="display:flex;"><span>    t2.start()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    t1.join()
</span></span><span style="display:flex;"><span>    t2.join()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">print</span>(<span style="color:#0ff;font-weight:bold">&#39;End value:&#39;</span>, database_value)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">print</span>(<span style="color:#0ff;font-weight:bold">&#39;end main&#39;</span>)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span><span style="color:#0ff;font-weight:bold">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#0ff;font-weight:bold">    Start value:  0
</span></span></span><span style="display:flex;"><span><span style="color:#0ff;font-weight:bold">    End value: 1
</span></span></span><span style="display:flex;"><span><span style="color:#0ff;font-weight:bold">    end main
</span></span></span><span style="display:flex;"><span><span style="color:#0ff;font-weight:bold">&#34;&#34;&#34;</span>
</span></span></code></pre></div><h5 id="使用锁处理资源竟态">使用锁处理资源竟态<a hidden class="anchor" aria-hidden="true" href="#使用锁处理资源竟态">#</a></h5>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#007f7f"># import Lock</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">from</span> threading <span style="color:#fff;font-weight:bold">import</span> Thread, Lock
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> time
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>database_value = <span style="color:#ff0;font-weight:bold">0</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">def</span> increase(lock):
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">global</span> database_value 
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f"># lock the state</span>
</span></span><span style="display:flex;"><span>    lock.acquire()
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    local_copy = database_value
</span></span><span style="display:flex;"><span>    local_copy += <span style="color:#ff0;font-weight:bold">1</span>
</span></span><span style="display:flex;"><span>    time.sleep(<span style="color:#ff0;font-weight:bold">0.1</span>)
</span></span><span style="display:flex;"><span>    database_value = local_copy
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f"># unlock the state</span>
</span></span><span style="display:flex;"><span>    lock.release()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">if</span> __name__ == <span style="color:#0ff;font-weight:bold">&#34;__main__&#34;</span>:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f"># create a lock</span>
</span></span><span style="display:flex;"><span>    lock = Lock()
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">print</span>(<span style="color:#0ff;font-weight:bold">&#39;Start value: &#39;</span>, database_value)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f"># pass the lock to the target function</span>
</span></span><span style="display:flex;"><span>    t1 = Thread(target=increase, args=(lock,)) <span style="color:#007f7f"># notice the comma after lock since args must be a tuple</span>
</span></span><span style="display:flex;"><span>    t2 = Thread(target=increase, args=(lock,))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    t1.start()
</span></span><span style="display:flex;"><span>    t2.start()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    t1.join()
</span></span><span style="display:flex;"><span>    t2.join()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">print</span>(<span style="color:#0ff;font-weight:bold">&#39;End value:&#39;</span>, database_value)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">print</span>(<span style="color:#0ff;font-weight:bold">&#39;end main&#39;</span>)
</span></span></code></pre></div><blockquote>
<p>使用上下文管理器</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">def</span> increase(lock):
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">global</span> database_value 
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">with</span> lock: 
</span></span><span style="display:flex;"><span>        local_copy = database_value
</span></span><span style="display:flex;"><span>        local_copy += <span style="color:#ff0;font-weight:bold">1</span>
</span></span><span style="display:flex;"><span>        time.sleep(<span style="color:#ff0;font-weight:bold">0.1</span>)
</span></span><span style="display:flex;"><span>        database_value = local_copy
</span></span></code></pre></div><h5 id="多线程消息队列通信">多线程消息队列通信<a hidden class="anchor" aria-hidden="true" href="#多线程消息队列通信">#</a></h5>
<blockquote>
<p>对队列的操作是线程安全的</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">from</span> threading <span style="color:#fff;font-weight:bold">import</span> Thread, Lock, current_thread
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">from</span> queue <span style="color:#fff;font-weight:bold">import</span> Queue
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">def</span> worker(q, lock):
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">while</span> <span style="color:#fff;font-weight:bold">True</span>:
</span></span><span style="display:flex;"><span>        value = q.get()  <span style="color:#007f7f"># blocks until the item is available</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f"># do stuff...</span>
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">with</span> lock:
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f"># prevent printing at the same time with this lock</span>
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">print</span>(<span style="color:#0ff;font-weight:bold">f</span><span style="color:#0ff;font-weight:bold">&#34;in </span><span style="color:#0ff;font-weight:bold">{</span>current_thread().name<span style="color:#0ff;font-weight:bold">}</span><span style="color:#0ff;font-weight:bold"> got </span><span style="color:#0ff;font-weight:bold">{</span>value<span style="color:#0ff;font-weight:bold">}</span><span style="color:#0ff;font-weight:bold">&#34;</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f"># ...</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f"># For each get(), a subsequent call to task_done() tells the queue</span>
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f"># that the processing on this item is complete.</span>
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f"># If all tasks are done, q.join() can unblock</span>
</span></span><span style="display:flex;"><span>        q.task_done()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">if</span> __name__ == <span style="color:#0ff;font-weight:bold">&#39;__main__&#39;</span>:
</span></span><span style="display:flex;"><span>    q = Queue()
</span></span><span style="display:flex;"><span>    num_threads = <span style="color:#ff0;font-weight:bold">10</span>
</span></span><span style="display:flex;"><span>    lock = Lock()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">for</span> i in <span style="color:#fff;font-weight:bold">range</span>(num_threads):
</span></span><span style="display:flex;"><span>        t = Thread(name=<span style="color:#0ff;font-weight:bold">f</span><span style="color:#0ff;font-weight:bold">&#34;Thread</span><span style="color:#0ff;font-weight:bold">{</span>i+<span style="color:#ff0;font-weight:bold">1</span><span style="color:#0ff;font-weight:bold">}</span><span style="color:#0ff;font-weight:bold">&#34;</span>, target=worker, args=(q, lock))
</span></span><span style="display:flex;"><span>        t.daemon = <span style="color:#fff;font-weight:bold">True</span>  <span style="color:#007f7f"># dies when the main thread dies</span>
</span></span><span style="display:flex;"><span>        t.start()
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f"># fill the queue with items</span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">for</span> x in <span style="color:#fff;font-weight:bold">range</span>(<span style="color:#ff0;font-weight:bold">20</span>):
</span></span><span style="display:flex;"><span>        q.put(x)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    q.join()  <span style="color:#007f7f"># Blocks until all items in the queue have been gotten and processed.</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">print</span>(<span style="color:#0ff;font-weight:bold">&#39;main done&#39;</span>)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span><span style="color:#0ff;font-weight:bold">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#0ff;font-weight:bold">in Thread1 got 0
</span></span></span><span style="display:flex;"><span><span style="color:#0ff;font-weight:bold">    in Thread2 got 1
</span></span></span><span style="display:flex;"><span><span style="color:#0ff;font-weight:bold">    in Thread2 got 11
</span></span></span><span style="display:flex;"><span><span style="color:#0ff;font-weight:bold">    in Thread2 got 12
</span></span></span><span style="display:flex;"><span><span style="color:#0ff;font-weight:bold">    in Thread2 got 13
</span></span></span><span style="display:flex;"><span><span style="color:#0ff;font-weight:bold">    in Thread2 got 14
</span></span></span><span style="display:flex;"><span><span style="color:#0ff;font-weight:bold">    in Thread2 got 15
</span></span></span><span style="display:flex;"><span><span style="color:#0ff;font-weight:bold">    in Thread2 got 16
</span></span></span><span style="display:flex;"><span><span style="color:#0ff;font-weight:bold">    in Thread2 got 17
</span></span></span><span style="display:flex;"><span><span style="color:#0ff;font-weight:bold">    in Thread2 got 18
</span></span></span><span style="display:flex;"><span><span style="color:#0ff;font-weight:bold">    in Thread2 got 19
</span></span></span><span style="display:flex;"><span><span style="color:#0ff;font-weight:bold">    in Thread8 got 5
</span></span></span><span style="display:flex;"><span><span style="color:#0ff;font-weight:bold">    in Thread4 got 9
</span></span></span><span style="display:flex;"><span><span style="color:#0ff;font-weight:bold">    in Thread1 got 10
</span></span></span><span style="display:flex;"><span><span style="color:#0ff;font-weight:bold">    in Thread5 got 2
</span></span></span><span style="display:flex;"><span><span style="color:#0ff;font-weight:bold">    in Thread6 got 3
</span></span></span><span style="display:flex;"><span><span style="color:#0ff;font-weight:bold">    in Thread9 got 6
</span></span></span><span style="display:flex;"><span><span style="color:#0ff;font-weight:bold">    in Thread7 got 4
</span></span></span><span style="display:flex;"><span><span style="color:#0ff;font-weight:bold">    in Thread10 got 7
</span></span></span><span style="display:flex;"><span><span style="color:#0ff;font-weight:bold">    in Thread3 got 8
</span></span></span><span style="display:flex;"><span><span style="color:#0ff;font-weight:bold">    main done
</span></span></span><span style="display:flex;"><span><span style="color:#0ff;font-weight:bold">&#34;&#34;&#34;</span>
</span></span></code></pre></div><h4 id="python标准库自带的一些小工具">Python标准库自带的一些小工具<a hidden class="anchor" aria-hidden="true" href="#python标准库自带的一些小工具">#</a></h4>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#007f7f"># 查看包安装路径</span>
</span></span><span style="display:flex;"><span>python -m site
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># 开启简单的http server</span>
</span></span><span style="display:flex;"><span>python -m http.server 
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># base64编码和解码</span>
</span></span><span style="display:flex;"><span>echo <span style="color:#0ff;font-weight:bold">&#34;hello&#34;</span> | python -m base64
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># top level await console</span>
</span></span><span style="display:flex;"><span>python -m asyncio
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># 查看tokenize和ast结果</span>
</span></span><span style="display:flex;"><span>python -m tokenize cgi.py
</span></span><span style="display:flex;"><span>pythono -m ast cgi.py
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># json美化输出</span>
</span></span><span style="display:flex;"><span>echo <span style="color:#0ff;font-weight:bold">&#39;{&#34;foo&#34;: &#34;bar&#34;}&#39;</span> | python -m json.tool
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># 显示日历</span>
</span></span><span style="display:flex;"><span>python -m calendar
</span></span></code></pre></div><h3 id="参考">参考<a hidden class="anchor" aria-hidden="true" href="#参考">#</a></h3>
<p><a href="https://www.python-engineer.com/courses/advancedpython/15-thread-vs-process/">Python多线程和多进程</a>
<a href="https://til.simonwillison.net/python/stdlib-cli-tools">CLI tools hidden in the Python standard library | Simon Willison’s TILs</a></p>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="https://blog.niuhemoon.win/tags/python/">Python</a></li>
    </ul>
<div class="footer-comments">
  <p>For comments, please   <a href="mailto:carlton2tang@gmail.com" class="email-button" style="font-size: inherit; padding: 5px 10px; background-color: #3f6b9a; color: white; text-decoration: none; border-radius: 3px; transition: background-color 0.3s;">
    send an email
</a> to me</p>

</div>
<nav class="paginav">
  <a class="prev" href="https://blog.niuhemoon.win/posts/tech/gdb-debug-python/">
    <span class="title">« 上一页</span>
    <br>
    <span>GDB调试Python代码</span>
  </a>
  <a class="next" href="https://blog.niuhemoon.win/posts/tech/python-advanced-2/">
    <span class="title">下一页 »</span>
    <br>
    <span>Python进阶中</span>
  </a>
</nav>

  </footer>
</article>
    </main>
    
<footer class="footer">
      
    <span>&copy; 2025 <a href="https://blog.niuhemoon.win">Niuhe&#39;s Blog</a></span>
    <span xmlns:cc="http://creativecommons.org/ns#" xmlns:dct="http://purl.org/dc/terms/">
        Licensed under
        <a
          href="http://creativecommons.org/licenses/by-nc-sa/4.0/?ref=chooser-v1"
          target="_blank"
          rel="license noopener noreferrer"
          style="display:inline-block;"
          >CC BY-NC-SA 4.0 </a></span>
    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = '📄复制';

        function copyingDone() {
            copybutton.innerHTML = '👌🏻已复制!';
            setTimeout(() => {
                copybutton.innerHTML = '📄复制';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
