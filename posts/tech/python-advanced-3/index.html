<!DOCTYPE html>
<html lang="zh" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>Pythonè¿›é˜¶ä¸‹ | Niuhe&#39;s Blog</title>
<meta name="keywords" content="Python">
<meta name="description" content="Pythonè¿›é˜¶æŠ€å·§æ€»ç»“,åŒ…å«å¤šçº¿ç¨‹å’Œå¤šè¿›ç¨‹åŸºç¡€">
<meta name="author" content="Niuhe">
<link rel="canonical" href="https://blog.niuhemoon.win/posts/tech/python-advanced-3/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.3613efbd0b1772781e8f49935e973cae632a7f61471c05b17be155505ccf87b5.css" integrity="sha256-NhPvvQsXcngej0mTXpc8rmMqf2FHHAWxe&#43;FVUFzPh7U=" rel="preload stylesheet" as="style">
<script defer crossorigin="anonymous" src="/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js" integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG&#43;9vmJ0cTS&#43;ovo0FeA="
    onload="hljs.initHighlightingOnLoad();"></script>
<link rel="icon" href="https://blog.niuhemoon.win/base/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="https://blog.niuhemoon.win/base/favicon.ico">
<link rel="icon" type="image/png" sizes="32x32" href="https://blog.niuhemoon.win/base/favicon.ico">
<link rel="apple-touch-icon" href="https://blog.niuhemoon.win/base/avatar.jpeg">
<link rel="mask-icon" href="https://blog.niuhemoon.win/base/avatar.jpeg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --hljs-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript>
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
	ga('create', 'UA-116933089-1', 'auto');
	
	ga('send', 'pageview');
}
</script><meta property="og:title" content="Pythonè¿›é˜¶ä¸‹" />
<meta property="og:description" content="Pythonè¿›é˜¶æŠ€å·§æ€»ç»“,åŒ…å«å¤šçº¿ç¨‹å’Œå¤šè¿›ç¨‹åŸºç¡€" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://blog.niuhemoon.win/posts/tech/python-advanced-3/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2020-10-13T00:00:00+00:00" />
<meta property="article:modified_time" content="2020-10-13T00:00:00+00:00" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Pythonè¿›é˜¶ä¸‹"/>
<meta name="twitter:description" content="Pythonè¿›é˜¶æŠ€å·§æ€»ç»“,åŒ…å«å¤šçº¿ç¨‹å’Œå¤šè¿›ç¨‹åŸºç¡€"/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "ğŸ“šæ–‡ç« ",
      "item": "https://blog.niuhemoon.win/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  3 ,
      "name": "ğŸ‘¨ğŸ»â€ğŸ’» æŠ€æœ¯",
      "item": "https://blog.niuhemoon.win/posts/tech/"
    }, 
    {
      "@type": "ListItem",
      "position":  4 ,
      "name": "Pythonè¿›é˜¶ä¸‹",
      "item": "https://blog.niuhemoon.win/posts/tech/python-advanced-3/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "Pythonè¿›é˜¶ä¸‹",
  "name": "Pythonè¿›é˜¶ä¸‹",
  "description": "Pythonè¿›é˜¶æŠ€å·§æ€»ç»“,åŒ…å«å¤šçº¿ç¨‹å’Œå¤šè¿›ç¨‹åŸºç¡€",
  "keywords": [
    "Python"
  ],
  "articleBody": " æœ‰ä¸¤ç§å¸¸ç”¨çš„æ–¹æ³•å¯ä»¥ä½¿å¾—ä»£ç å¹¶è¡Œæ‰§è¡Œï¼Œå¤šçº¿ç¨‹å’Œå¤šè¿›ç¨‹ ã€‚å› ä¸ºCythonè§£é‡Šå™¨çš„å®ç°ä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œå…·æœ‰GILé”ï¼ŒåŒä¸€æ—¶åˆ»ï¼Œåªæœ‰ä¸€ä¸ªçº¿ç¨‹å¯ä»¥è·å¾—è§£é‡Šå™¨çš„é”ã€‚å› æ­¤ï¼ŒPythonåˆ©ç”¨å¤šæ ¸å¿ƒçš„CPUåªèƒ½é€šè¿‡å¤šè¿›ç¨‹ï¼Œè€Œå¤šçº¿ç¨‹åªé€‚ç”¨äºIOå¯†é›†å‹çš„ç¨‹åºã€‚\nå¤šè¿›ç¨‹åŸºç¡€ åˆ›å»ºå¹¶å¼€å¯è¿›ç¨‹ å¯ä»¥ä½¿ç”¨multiprocessing.Process()æ¥åˆ›å»ºè¿›ç¨‹ï¼Œå®ƒæ¥å—ä¸¤ä¸ªå‚æ•°ï¼š\ntargetï¼Œä¸€ä¸ªå¯è°ƒç”¨çš„å‡½æ•°ï¼Œå½“è¿›ç¨‹å¼€å§‹æ—¶ä¼šæ‰§è¡Œ argsï¼Œä¸€ä¸ªå…ƒç»„ï¼Œæä¾›ç›®æ ‡å‡½æ•°çš„å‚æ•° ä½¿ç”¨process.start()æ¥å¼€å§‹æ‰§è¡Œä¸€ä¸ªè¿›ç¨‹\nè°ƒç”¨process.join()æ¥å‘Šè¯‰ç¨‹åºç­‰å¾…è¿›ç¨‹ç»“æŸå†æ‰§è¡Œåç»­ä»£ç ï¼Œä¸»è¿›ç¨‹å°†ä¼šè¢«é˜»å¡\nfrom multiprocessing import Process import os def square_numbers(): for i in range(1000): result = i * i if __name__ == \"__main__\": processes = [] num_processes = os.cpu_count() # number of CPUs on the machine. Usually a good choise for the number of processes # create processes and asign a function for each process for i in range(num_processes): process = Process(target=square_numbers) processes.append(process) # start all processes for process in processes: process.start() # wait for all processes to finish # block the main programm until these processes are finished for process in processes: process.join() è¿›ç¨‹é—´åˆ†äº«æ•°æ® å› ä¸ºè¿›ç¨‹çš„å†…å­˜ç©ºé—´ä¸åŒï¼Œéœ€è¦ç‰¹æ®Šçš„å…±äº«å†…å­˜å¯¹è±¡æ¥åˆ†äº«æ•°æ®ã€‚\næ•°æ®å¯ä»¥ä¿å­˜åœ¨å…±äº«å†…å­˜å˜é‡ä¸­ï¼Œä½¿ç”¨Valueæˆ–è€…Array\nValue(type, value)åˆ›å»ºä¸€ä¸ªctypeå¯¹è±¡ Array(type, value)åˆ›å»ºä¸€ä¸ªctypeç±»å‹çš„åˆ—è¡¨ å¦‚ä¸‹ç¨‹åºæ¼”ç¤ºå¹´race conditionèµ„æºç«Ÿæ€ï¼Œæ¯æ¬¡æ‰§è¡Œç»“æœéƒ½ä¸ä¸€æ ·ï¼Œä¾‹å¦‚å½“ä¸¤ä¸ªè¿›ç¨‹è¯»å–åŒä¸€ä¸ªå€¼ï¼Œå¹¶å¯¹å…¶æ‰§è¡Œ+1æ“ä½œï¼Œç„¶åå†™ä¼šåŸæœ‰åœ°å€ï¼Œå…¶ç»“æœå¹¶ä¸æ˜¯é¢„æƒ³çš„åŠ 2ã€‚\nfrom multiprocessing import Process, Value, Array import time def add_100(number): for _ in range(100): time.sleep(0.001) number.value += 1 def add_100_array(numbers): for _ in range(100): time.sleep(0.01) for i in range(len(numbers)): numbers[i] += 1 if __name__ == \"__main__\": shared_number = Value('i', 0) print('Value at beginning:', shared_number.value) shared_array = Array('d', [0.0, 100.0, 200.0]) print('Array at beginning:', shared_array[:]) process1 = Process(target=add_100, args=(shared_number,)) process2 = Process(target=add_100, args=(shared_number,)) process3 = Process(target=add_100_array, args=(shared_array,)) process4 = Process(target=add_100_array, args=(shared_array,)) process1.start() process2.start() process3.start() process4.start() process1.join() process2.join() process3.join() process4.join() print('Value at end:', shared_number.value) print('Array at end:', shared_array[:]) print('end main') \"\"\" Value at beginning: 0 Array at beginning: [0.0, 100.0, 200.0] Value at end: 144 Array at end: [134.0, 237.0, 339.0] end main \"\"\" å¯ä»¥ä½¿ç”¨é”é¿å…èµ„æºç«Ÿæ€ é”ï¼ˆä¹Ÿç§°ä¸ºäº’æ–¥é”ï¼‰æ˜¯ä¸€ç§åŒæ­¥æœºåˆ¶ï¼Œç”¨äºåœ¨å­˜åœ¨è®¸å¤šæ‰§è¡Œè¿›ç¨‹/çº¿ç¨‹çš„ç¯å¢ƒä¸­å¼ºåˆ¶é™åˆ¶å¯¹èµ„æºçš„è®¿é—®ã€‚é”å…·æœ‰ä¸¤ç§çŠ¶æ€ï¼šé”å®šå’Œè§£é”ã€‚ å¦‚æœçŠ¶æ€ä¸ºé”å®šï¼Œåˆ™åœ¨å†æ¬¡è§£é™¤é”å®šçŠ¶æ€ä¹‹å‰ï¼Œä¸å…è®¸å…¶ä»–å¹¶å‘è¿›ç¨‹/çº¿ç¨‹è¿›å…¥æ­¤ä»£ç æ®µã€‚\n# import Lock from multiprocessing import Lock from multiprocessing import Process, Value, Array import time def add_100(number, lock): for _ in range(100): time.sleep(0.001) # lock the state lock.acquire() number.value += 1 # unlock the state lock.release() def add_100_array(numbers, lock): for _ in range(100): time.sleep(0.01) for i in range(len(numbers)): lock.acquire() numbers[i] += 1 lock.release() if __name__ == \"__main__\": # create a lock lock1 = Lock() lock2 = Lock() shared_number = Value('i', 0) print('Value at beginning:', shared_number.value) shared_array = Array('d', [0.0, 100.0, 200.0]) print('Array at beginning:', shared_array[:]) # pass the lock to the target function process1 = Process(target=add_100, args=(shared_number, lock1)) process2 = Process(target=add_100, args=(shared_number, lock1)) process3 = Process(target=add_100_array, args=(shared_array, lock2)) process4 = Process(target=add_100_array, args=(shared_array, lock2)) process1.start() process2.start() process3.start() process4.start() process1.join() process2.join() process3.join() process4.join() print('Value at end:', shared_number.value) print('Array at end:', shared_array[:]) print('end main') \"\"\" Value at beginning: 0 Array at beginning: [0.0, 100.0, 200.0] Value at end: 200 Array at end: [200.0, 300.0, 400.0] end main \"\"\" åœ¨ä¸Šä¸‹æ–‡ç®¡ç†å™¨ä¸­ä½¿ç”¨é” ä½¿ç”¨ä¸Šä¸‹æ–‡ç®¡ç†å™¨ç®¡ç†é”çš„è·å–å’Œé‡Šæ”¾æ›´åŠ å®‰å…¨\ndef add_100(number, lock): for _ in range(100): time.sleep(0.01) with lock: number.value += 1 å¤šè¿›ç¨‹ä½¿ç”¨é˜Ÿåˆ—é€šä¿¡ ä½¿ç”¨é˜Ÿåˆ—çš„æ“ä½œæ˜¯è¿›ç¨‹å®‰å…¨çš„ã€‚å¤šè¿›ç¨‹é˜Ÿåˆ—å®ç°äº†é˜Ÿåˆ—çš„æ‰€æœ‰æ–¹æ³•ã€‚done()å’Œjoin()é™¤å¤–ã€‚\nq.get():ç§»é™¤é˜Ÿé¦–ç¬¬ä¸€ä¸ªå…ƒç´ ï¼Œé»˜è®¤æƒ…å†µï¼Œä¼šé˜»å¡ç›´åˆ°æœ‰å…ƒç´ å¯ç”¨ q.put(item)å°†å…ƒç´ å‹åˆ°é˜Ÿå°¾ï¼Œé»˜è®¤æƒ…å†µï¼Œé˜»å¡ç›´åˆ°é˜Ÿåˆ—æœ‰ç©ºçš„æ§½ q.empty()å¦‚æœé˜Ÿåˆ—ä¸ºç©ºï¼Œè¿”å›True q.close()è¡¨æ˜å½“å‰è¿›ç¨‹ä¸ä¼šæœ‰æ–°çš„æ•°æ®æ”¾åˆ°é˜Ÿåˆ—ä¸­äº† # communicate between processes with the multiprocessing Queue # Queues are thread and process safe from multiprocessing import Process, Queue import time def square(numbers, queue): for i in numbers: time.sleep(0.01) queue.put(i*i) def make_negative(numbers, queue): for i in numbers: time.sleep(0.01) queue.put(i*-1) if __name__ == \"__main__\": numbers = range(1, 6) q = Queue() p1 = Process(target=square, args=(numbers,q)) p2 = Process(target=make_negative, args=(numbers,q)) p1.start() p2.start() p1.join() p2.join() # order might not be sequential while not q.empty(): print(q.get()) print('end main') \"\"\" 1 -1 4 -2 9 -3 16 -4 25 -5 end main \"\"\" è¿›ç¨‹æ±  è¿›ç¨‹æ± å¯¹è±¡æ§åˆ¶ä¸€äº›å·¥ä½œè¿›ç¨‹workerï¼Œå¯ä»¥æ”¯æŒè¶…æ—¶å’Œå›è°ƒä»¥å®ç°å¼‚æ­¥å¤„ç†ï¼Œä¹Ÿæœ‰ä¸€äº›å¹¶è¡Œçš„mapå®ç°ã€‚å®ƒå¯ä»¥è‡ªåŠ¨ç®¡ç†å¤šä¸ªå¤„ç†å™¨ï¼Œå¹¶å°†æ•°æ®åˆ†æˆå°å—ï¼Œåœ¨å¤šä¸ªå¤„ç†å™¨ä¸Šå¹¶è¡Œå¤„ç†ã€‚\né‡è¦çš„å‡½æ•°åŒ…æ‹¬ï¼š\nmap(func, iterable[, chunksize])å°†å¯è¿­ä»£å¯¹è±¡åˆ‡åˆ†æˆå°å—ï¼Œä½œä¸ºç‹¬ç«‹ä»»åŠ¡æäº¤åˆ°è¿›ç¨‹æ± ï¼Œå¹¶è¡Œå¤„ç†ã€‚å‡½æ•°å°†ä¼šé˜»å¡ï¼Œç›´åˆ°è¿”å›ç»“æœã€‚ close()é˜»æ­¢æ›´å¤šä»»åŠ¡æ·»åŠ åˆ°è¿›ç¨‹æ± ï¼Œä¸€æ—¦ä»»åŠ¡å®Œæˆï¼Œworkerè¿›ç¨‹å°†é€€å‡º join()ç­‰å¾…å·¥ä½œè¿›ç¨‹é€€å‡ºï¼Œåœ¨è°ƒç”¨join()ä¹‹å‰éœ€è¦è°ƒç”¨close()æˆ–è€…terminate() apply(func, args)è°ƒç”¨funcå‡½æ•°ï¼Œå‚æ•°æ˜¯argsã€‚é˜»å¡ç›´åˆ°è¿”å›ç»“æœï¼Œfuncå‡½æ•°åªåœ¨è¿›ç¨‹æ± ä¸­ä¸€ä¸ªworkerä¸­æ‰§è¡Œ æœ‰map_async()å’Œapply_async()è¿™ç§éé˜»å¡çš„å¼‚æ­¥å‡½æ•° from multiprocessing import Pool import random import time def cube(number): print(\"Hi\") time.sleep(random.randint(1,2)) return number * number * number if __name__ == \"__main__\": numbers = range(10) p = Pool() # by default this allocates the maximum number of available # processors for this task --\u003e os.cpu_count() result = p.map(cube, numbers) # or # result = [p.apply(cube, args=(i,)) for i in numbers] p.close() p.join() print(result) å¤šçº¿ç¨‹åŸºç¡€ Pythonå¤šçº¿ç¨‹ç›¸å¯¹æ¯”è¾ƒé¸¡è‚‹ï¼Œå…¶ä½¿ç”¨å’Œå¤šè¿›ç¨‹ç±»ä¼¼\nåˆ›å»ºå¹¶å¼€å§‹çº¿ç¨‹ ä½¿ç”¨threadingåº“å®ç°\nfrom threading import Thread def square_numbers(): for i in range(1000): result = i * i if __name__ == \"__main__\": threads = [] num_threads = 10 # create threads and asign a function for each thread for i in range(num_threads): thread = Thread(target=square_numbers) threads.append(thread) # start all threads for thread in threads: thread.start() # wait for all threads to finish # block the main thread until these threads are finished for thread in threads: thread.join() çº¿ç¨‹é—´å…±äº«æ•°æ® çº¿ç¨‹é—´å¯ä»¥é€šè¿‡å…¨å±€å˜é‡æ¥å…±äº«æ•°æ®ï¼Œå› ä¸ºçº¿ç¨‹é—´æ˜¯å…±äº«å†…å­˜ç©ºé—´çš„\nfrom threading import Thread import time # all threads can access this global variable database_value = 0 def increase(): global database_value # needed to modify the global value # get a local copy (simulate data retrieving) local_copy = database_value # simulate some modifying operation local_copy += 1 time.sleep(0.1) # write the calculated new value into the global variable database_value = local_copy if __name__ == \"__main__\": print('Start value: ', database_value) t1 = Thread(target=increase) t2 = Thread(target=increase) t1.start() t2.start() t1.join() t2.join() print('End value:', database_value) print('end main') \"\"\" Start value: 0 End value: 1 end main \"\"\" ä½¿ç”¨é”å¤„ç†èµ„æºç«Ÿæ€ # import Lock from threading import Thread, Lock import time database_value = 0 def increase(lock): global database_value # lock the state lock.acquire() local_copy = database_value local_copy += 1 time.sleep(0.1) database_value = local_copy # unlock the state lock.release() if __name__ == \"__main__\": # create a lock lock = Lock() print('Start value: ', database_value) # pass the lock to the target function t1 = Thread(target=increase, args=(lock,)) # notice the comma after lock since args must be a tuple t2 = Thread(target=increase, args=(lock,)) t1.start() t2.start() t1.join() t2.join() print('End value:', database_value) print('end main') ä½¿ç”¨ä¸Šä¸‹æ–‡ç®¡ç†å™¨\ndef increase(lock): global database_value with lock: local_copy = database_value local_copy += 1 time.sleep(0.1) database_value = local_copy å¤šçº¿ç¨‹æ¶ˆæ¯é˜Ÿåˆ—é€šä¿¡ å¯¹é˜Ÿåˆ—çš„æ“ä½œæ˜¯çº¿ç¨‹å®‰å…¨çš„\nfrom threading import Thread, Lock, current_thread from queue import Queue def worker(q, lock): while True: value = q.get() # blocks until the item is available # do stuff... with lock: # prevent printing at the same time with this lock print(f\"in {current_thread().name} got {value}\") # ... # For each get(), a subsequent call to task_done() tells the queue # that the processing on this item is complete. # If all tasks are done, q.join() can unblock q.task_done() if __name__ == '__main__': q = Queue() num_threads = 10 lock = Lock() for i in range(num_threads): t = Thread(name=f\"Thread{i+1}\", target=worker, args=(q, lock)) t.daemon = True # dies when the main thread dies t.start() # fill the queue with items for x in range(20): q.put(x) q.join() # Blocks until all items in the queue have been gotten and processed. print('main done') \"\"\" in Thread1 got 0 in Thread2 got 1 in Thread2 got 11 in Thread2 got 12 in Thread2 got 13 in Thread2 got 14 in Thread2 got 15 in Thread2 got 16 in Thread2 got 17 in Thread2 got 18 in Thread2 got 19 in Thread8 got 5 in Thread4 got 9 in Thread1 got 10 in Thread5 got 2 in Thread6 got 3 in Thread9 got 6 in Thread7 got 4 in Thread10 got 7 in Thread3 got 8 main done \"\"\" Pythonæ ‡å‡†åº“è‡ªå¸¦çš„ä¸€äº›å°å·¥å…· # æŸ¥çœ‹åŒ…å®‰è£…è·¯å¾„ python -m site # å¼€å¯ç®€å•çš„http server python -m http.server # base64ç¼–ç å’Œè§£ç  echo \"hello\" | python -m base64 # top level await console python -m asyncio # æŸ¥çœ‹tokenizeå’Œastç»“æœ python -m tokenize cgi.py pythono -m ast cgi.py # jsonç¾åŒ–è¾“å‡º echo '{\"foo\": \"bar\"}' | python -m json.tool # æ˜¾ç¤ºæ—¥å† python -m calendar å‚è€ƒ Pythonå¤šçº¿ç¨‹å’Œå¤šè¿›ç¨‹ CLI tools hidden in the Python standard library | Simon Willisonâ€™s TILs\n",
  "wordCount" : "2417",
  "inLanguage": "zh",
  "datePublished": "2020-10-13T00:00:00Z",
  "dateModified": "2020-10-13T00:00:00Z",
  "author":{
    "@type": "Person",
    "name": "Niuhe"
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://blog.niuhemoon.win/posts/tech/python-advanced-3/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Niuhe's Blog",
    "logo": {
      "@type": "ImageObject",
      "url": "https://blog.niuhemoon.win/base/favicon.ico"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://blog.niuhemoon.win" accesskey="h" title="Niuhe&#39;s Blog (Alt + H)">
                <img src="https://blog.niuhemoon.win/base/avatar.jpeg" alt="" aria-label="logo"
                    height="35">Niuhe&#39;s Blog</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="https://blog.niuhemoon.win/search" title="ğŸ”æœç´¢ (Alt &#43; /)" accesskey=/>
                    <span>ğŸ”æœç´¢</span>
                </a>
            </li>
            <li>
                <a href="https://blog.niuhemoon.win/" title="ğŸ ä¸»é¡µ">
                    <span>ğŸ ä¸»é¡µ</span>
                </a>
            </li>
            <li>
                <a href="https://blog.niuhemoon.win/posts" title="ğŸ“šæ–‡ç« ">
                    <span>ğŸ“šæ–‡ç« </span>
                </a>
            </li>
            <li>
                <a href="https://blog.niuhemoon.win/tags" title="ğŸ”–æ ‡ç­¾">
                    <span>ğŸ”–æ ‡ç­¾</span>
                </a>
            </li>
            <li>
                <a href="https://blog.niuhemoon.win/archives/" title="â±æ—¶é—´è½´">
                    <span>â±æ—¶é—´è½´</span>
                </a>
            </li>
            <li>
                <a href="https://blog.niuhemoon.win/about" title="ğŸ™‹ğŸ»â€â™‚ï¸å…³äº">
                    <span>ğŸ™‹ğŸ»â€â™‚ï¸å…³äº</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="https://blog.niuhemoon.win">ğŸ ä¸»é¡µ</a>&nbsp;Â»&nbsp;<a href="https://blog.niuhemoon.win/posts/">ğŸ“šæ–‡ç« </a>&nbsp;Â»&nbsp;<a href="https://blog.niuhemoon.win/posts/tech/">ğŸ‘¨ğŸ»â€ğŸ’» æŠ€æœ¯</a></div>
    <h1 class="post-title">
      Pythonè¿›é˜¶ä¸‹
    </h1>
    <div class="post-description">
      Pythonè¿›é˜¶æŠ€å·§æ€»ç»“,åŒ…å«å¤šçº¿ç¨‹å’Œå¤šè¿›ç¨‹åŸºç¡€
    </div>
    <div class="post-meta"><span title='2020-10-13 00:00:00 +0000 UTC'>2020-10-13</span>&nbsp;Â·&nbsp;5 min&nbsp;Â·&nbsp;2417 å­—&nbsp;Â·&nbsp;Niuhe

</div>
  </header> <div class="toc">
    <details  open>
        <summary accesskey="c" title="(Alt + C)">
            <span class="details">æ–‡ç« ç›®å½•</span>
        </summary>

        <div class="inner"><ul>
                <li>
                    <a href="#%e5%a4%9a%e8%bf%9b%e7%a8%8b%e5%9f%ba%e7%a1%80" aria-label="å¤šè¿›ç¨‹åŸºç¡€">å¤šè¿›ç¨‹åŸºç¡€</a><ul>
                        <ul>
                        
                <li>
                    <a href="#%e5%88%9b%e5%bb%ba%e5%b9%b6%e5%bc%80%e5%90%af%e8%bf%9b%e7%a8%8b" aria-label="åˆ›å»ºå¹¶å¼€å¯è¿›ç¨‹">åˆ›å»ºå¹¶å¼€å¯è¿›ç¨‹</a></li>
                <li>
                    <a href="#%e8%bf%9b%e7%a8%8b%e9%97%b4%e5%88%86%e4%ba%ab%e6%95%b0%e6%8d%ae" aria-label="è¿›ç¨‹é—´åˆ†äº«æ•°æ®">è¿›ç¨‹é—´åˆ†äº«æ•°æ®</a></li>
                <li>
                    <a href="#%e5%8f%af%e4%bb%a5%e4%bd%bf%e7%94%a8%e9%94%81%e9%81%bf%e5%85%8d%e8%b5%84%e6%ba%90%e7%ab%9f%e6%80%81" aria-label="å¯ä»¥ä½¿ç”¨é”é¿å…èµ„æºç«Ÿæ€">å¯ä»¥ä½¿ç”¨é”é¿å…èµ„æºç«Ÿæ€</a></li>
                <li>
                    <a href="#%e5%9c%a8%e4%b8%8a%e4%b8%8b%e6%96%87%e7%ae%a1%e7%90%86%e5%99%a8%e4%b8%ad%e4%bd%bf%e7%94%a8%e9%94%81" aria-label="åœ¨ä¸Šä¸‹æ–‡ç®¡ç†å™¨ä¸­ä½¿ç”¨é”">åœ¨ä¸Šä¸‹æ–‡ç®¡ç†å™¨ä¸­ä½¿ç”¨é”</a></li>
                <li>
                    <a href="#%e5%a4%9a%e8%bf%9b%e7%a8%8b%e4%bd%bf%e7%94%a8%e9%98%9f%e5%88%97%e9%80%9a%e4%bf%a1" aria-label="å¤šè¿›ç¨‹ä½¿ç”¨é˜Ÿåˆ—é€šä¿¡">å¤šè¿›ç¨‹ä½¿ç”¨é˜Ÿåˆ—é€šä¿¡</a></li>
                <li>
                    <a href="#%e8%bf%9b%e7%a8%8b%e6%b1%a0" aria-label="è¿›ç¨‹æ± ">è¿›ç¨‹æ± </a></li></ul>
                    </ul>
                </li>
                <li>
                    <a href="#%e5%a4%9a%e7%ba%bf%e7%a8%8b%e5%9f%ba%e7%a1%80" aria-label="å¤šçº¿ç¨‹åŸºç¡€">å¤šçº¿ç¨‹åŸºç¡€</a><ul>
                        <ul>
                        
                <li>
                    <a href="#%e5%88%9b%e5%bb%ba%e5%b9%b6%e5%bc%80%e5%a7%8b%e7%ba%bf%e7%a8%8b" aria-label="åˆ›å»ºå¹¶å¼€å§‹çº¿ç¨‹">åˆ›å»ºå¹¶å¼€å§‹çº¿ç¨‹</a></li>
                <li>
                    <a href="#%e7%ba%bf%e7%a8%8b%e9%97%b4%e5%85%b1%e4%ba%ab%e6%95%b0%e6%8d%ae" aria-label="çº¿ç¨‹é—´å…±äº«æ•°æ®">çº¿ç¨‹é—´å…±äº«æ•°æ®</a></li>
                <li>
                    <a href="#%e4%bd%bf%e7%94%a8%e9%94%81%e5%a4%84%e7%90%86%e8%b5%84%e6%ba%90%e7%ab%9f%e6%80%81" aria-label="ä½¿ç”¨é”å¤„ç†èµ„æºç«Ÿæ€">ä½¿ç”¨é”å¤„ç†èµ„æºç«Ÿæ€</a></li>
                <li>
                    <a href="#%e5%a4%9a%e7%ba%bf%e7%a8%8b%e6%b6%88%e6%81%af%e9%98%9f%e5%88%97%e9%80%9a%e4%bf%a1" aria-label="å¤šçº¿ç¨‹æ¶ˆæ¯é˜Ÿåˆ—é€šä¿¡">å¤šçº¿ç¨‹æ¶ˆæ¯é˜Ÿåˆ—é€šä¿¡</a></li></ul>
                    
                <li>
                    <a href="#python%e6%a0%87%e5%87%86%e5%ba%93%e8%87%aa%e5%b8%a6%e7%9a%84%e4%b8%80%e4%ba%9b%e5%b0%8f%e5%b7%a5%e5%85%b7" aria-label="Pythonæ ‡å‡†åº“è‡ªå¸¦çš„ä¸€äº›å°å·¥å…·">Pythonæ ‡å‡†åº“è‡ªå¸¦çš„ä¸€äº›å°å·¥å…·</a></li></ul>
                </li>
                <li>
                    <a href="#%e5%8f%82%e8%80%83" aria-label="å‚è€ƒ">å‚è€ƒ</a>
                </li>
            </ul>
        </div>
    </details>
</div>

  <div class="post-content"><blockquote>
<p>æœ‰ä¸¤ç§å¸¸ç”¨çš„æ–¹æ³•å¯ä»¥ä½¿å¾—ä»£ç å¹¶è¡Œæ‰§è¡Œï¼Œå¤šçº¿ç¨‹å’Œå¤šè¿›ç¨‹ ã€‚å› ä¸ºCythonè§£é‡Šå™¨çš„å®ç°ä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œå…·æœ‰GILé”ï¼ŒåŒä¸€æ—¶åˆ»ï¼Œåªæœ‰ä¸€ä¸ªçº¿ç¨‹å¯ä»¥è·å¾—è§£é‡Šå™¨çš„é”ã€‚å› æ­¤ï¼ŒPythonåˆ©ç”¨å¤šæ ¸å¿ƒçš„CPUåªèƒ½é€šè¿‡å¤šè¿›ç¨‹ï¼Œè€Œå¤šçº¿ç¨‹åªé€‚ç”¨äºIOå¯†é›†å‹çš„ç¨‹åºã€‚</p>
</blockquote>
<h3 id="å¤šè¿›ç¨‹åŸºç¡€">å¤šè¿›ç¨‹åŸºç¡€<a hidden class="anchor" aria-hidden="true" href="#å¤šè¿›ç¨‹åŸºç¡€">#</a></h3>
<h5 id="åˆ›å»ºå¹¶å¼€å¯è¿›ç¨‹">åˆ›å»ºå¹¶å¼€å¯è¿›ç¨‹<a hidden class="anchor" aria-hidden="true" href="#åˆ›å»ºå¹¶å¼€å¯è¿›ç¨‹">#</a></h5>
<blockquote>
<p>å¯ä»¥ä½¿ç”¨<code>multiprocessing.Process()</code>æ¥åˆ›å»ºè¿›ç¨‹ï¼Œå®ƒæ¥å—ä¸¤ä¸ªå‚æ•°ï¼š</p>
<ul>
<li>targetï¼Œä¸€ä¸ªå¯è°ƒç”¨çš„å‡½æ•°ï¼Œå½“è¿›ç¨‹å¼€å§‹æ—¶ä¼šæ‰§è¡Œ</li>
<li>argsï¼Œä¸€ä¸ªå…ƒç»„ï¼Œæä¾›ç›®æ ‡å‡½æ•°çš„å‚æ•°</li>
</ul>
<p>ä½¿ç”¨<code>process.start()</code>æ¥å¼€å§‹æ‰§è¡Œä¸€ä¸ªè¿›ç¨‹</p>
<p>è°ƒç”¨<code>process.join()</code>æ¥å‘Šè¯‰ç¨‹åºç­‰å¾…è¿›ç¨‹ç»“æŸå†æ‰§è¡Œåç»­ä»£ç ï¼Œä¸»è¿›ç¨‹å°†ä¼šè¢«é˜»å¡</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">from</span> multiprocessing <span style="color:#fff;font-weight:bold">import</span> Process
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> os
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">def</span> square_numbers():
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">for</span> i in <span style="color:#fff;font-weight:bold">range</span>(<span style="color:#ff0;font-weight:bold">1000</span>):
</span></span><span style="display:flex;"><span>        result = i * i
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">if</span> __name__ == <span style="color:#0ff;font-weight:bold">&#34;__main__&#34;</span>:        
</span></span><span style="display:flex;"><span>    processes = []
</span></span><span style="display:flex;"><span>    num_processes = os.cpu_count()
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f"># number of CPUs on the machine. Usually a good choise for the number of processes</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f"># create processes and asign a function for each process</span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">for</span> i in <span style="color:#fff;font-weight:bold">range</span>(num_processes):
</span></span><span style="display:flex;"><span>        process = Process(target=square_numbers)
</span></span><span style="display:flex;"><span>        processes.append(process)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f"># start all processes</span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">for</span> process in processes:
</span></span><span style="display:flex;"><span>        process.start()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f"># wait for all processes to finish</span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f"># block the main programm until these processes are finished</span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">for</span> process in processes:
</span></span><span style="display:flex;"><span>        process.join()
</span></span></code></pre></div><h5 id="è¿›ç¨‹é—´åˆ†äº«æ•°æ®">è¿›ç¨‹é—´åˆ†äº«æ•°æ®<a hidden class="anchor" aria-hidden="true" href="#è¿›ç¨‹é—´åˆ†äº«æ•°æ®">#</a></h5>
<blockquote>
<p>å› ä¸ºè¿›ç¨‹çš„å†…å­˜ç©ºé—´ä¸åŒï¼Œéœ€è¦ç‰¹æ®Šçš„å…±äº«å†…å­˜å¯¹è±¡æ¥åˆ†äº«æ•°æ®ã€‚</p>
<p>æ•°æ®å¯ä»¥ä¿å­˜åœ¨å…±äº«å†…å­˜å˜é‡ä¸­ï¼Œä½¿ç”¨<code>Value</code>æˆ–è€…<code>Array</code></p>
<ul>
<li>Value(type, value)åˆ›å»ºä¸€ä¸ª<code>ctype</code>å¯¹è±¡</li>
<li>Array(type, value)åˆ›å»ºä¸€ä¸ª<code>ctype</code>ç±»å‹çš„åˆ—è¡¨</li>
</ul>
<p>å¦‚ä¸‹ç¨‹åºæ¼”ç¤ºå¹´race conditionèµ„æºç«Ÿæ€ï¼Œæ¯æ¬¡æ‰§è¡Œç»“æœéƒ½ä¸ä¸€æ ·ï¼Œä¾‹å¦‚å½“ä¸¤ä¸ªè¿›ç¨‹è¯»å–åŒä¸€ä¸ªå€¼ï¼Œå¹¶å¯¹å…¶æ‰§è¡Œ+1æ“ä½œï¼Œç„¶åå†™ä¼šåŸæœ‰åœ°å€ï¼Œå…¶ç»“æœå¹¶ä¸æ˜¯é¢„æƒ³çš„åŠ 2ã€‚</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">from</span> multiprocessing <span style="color:#fff;font-weight:bold">import</span> Process, Value, Array
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> time
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">def</span> add_100(number):
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">for</span> _ in <span style="color:#fff;font-weight:bold">range</span>(<span style="color:#ff0;font-weight:bold">100</span>):
</span></span><span style="display:flex;"><span>        time.sleep(<span style="color:#ff0;font-weight:bold">0.001</span>)
</span></span><span style="display:flex;"><span>        number.value += <span style="color:#ff0;font-weight:bold">1</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">def</span> add_100_array(numbers):
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">for</span> _ in <span style="color:#fff;font-weight:bold">range</span>(<span style="color:#ff0;font-weight:bold">100</span>):
</span></span><span style="display:flex;"><span>        time.sleep(<span style="color:#ff0;font-weight:bold">0.01</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">for</span> i in <span style="color:#fff;font-weight:bold">range</span>(<span style="color:#fff;font-weight:bold">len</span>(numbers)):
</span></span><span style="display:flex;"><span>            numbers[i] += <span style="color:#ff0;font-weight:bold">1</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">if</span> __name__ == <span style="color:#0ff;font-weight:bold">&#34;__main__&#34;</span>:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    shared_number = Value(<span style="color:#0ff;font-weight:bold">&#39;i&#39;</span>, <span style="color:#ff0;font-weight:bold">0</span>) 
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">print</span>(<span style="color:#0ff;font-weight:bold">&#39;Value at beginning:&#39;</span>, shared_number.value)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    shared_array = Array(<span style="color:#0ff;font-weight:bold">&#39;d&#39;</span>, [<span style="color:#ff0;font-weight:bold">0.0</span>, <span style="color:#ff0;font-weight:bold">100.0</span>, <span style="color:#ff0;font-weight:bold">200.0</span>])
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">print</span>(<span style="color:#0ff;font-weight:bold">&#39;Array at beginning:&#39;</span>, shared_array[:])
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    process1 = Process(target=add_100, args=(shared_number,))
</span></span><span style="display:flex;"><span>    process2 = Process(target=add_100, args=(shared_number,))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    process3 = Process(target=add_100_array, args=(shared_array,))
</span></span><span style="display:flex;"><span>    process4 = Process(target=add_100_array, args=(shared_array,))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    process1.start()
</span></span><span style="display:flex;"><span>    process2.start()
</span></span><span style="display:flex;"><span>    process3.start()
</span></span><span style="display:flex;"><span>    process4.start()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    process1.join()
</span></span><span style="display:flex;"><span>    process2.join()
</span></span><span style="display:flex;"><span>    process3.join()
</span></span><span style="display:flex;"><span>    process4.join()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">print</span>(<span style="color:#0ff;font-weight:bold">&#39;Value at end:&#39;</span>, shared_number.value)
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">print</span>(<span style="color:#0ff;font-weight:bold">&#39;Array at end:&#39;</span>, shared_array[:])
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">print</span>(<span style="color:#0ff;font-weight:bold">&#39;end main&#39;</span>)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span><span style="color:#0ff;font-weight:bold">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#0ff;font-weight:bold">    Value at beginning: 0
</span></span></span><span style="display:flex;"><span><span style="color:#0ff;font-weight:bold">    Array at beginning: [0.0, 100.0, 200.0]
</span></span></span><span style="display:flex;"><span><span style="color:#0ff;font-weight:bold">    Value at end: 144
</span></span></span><span style="display:flex;"><span><span style="color:#0ff;font-weight:bold">    Array at end: [134.0, 237.0, 339.0]
</span></span></span><span style="display:flex;"><span><span style="color:#0ff;font-weight:bold">    end main
</span></span></span><span style="display:flex;"><span><span style="color:#0ff;font-weight:bold">&#34;&#34;&#34;</span>
</span></span></code></pre></div><h5 id="å¯ä»¥ä½¿ç”¨é”é¿å…èµ„æºç«Ÿæ€">å¯ä»¥ä½¿ç”¨é”é¿å…èµ„æºç«Ÿæ€<a hidden class="anchor" aria-hidden="true" href="#å¯ä»¥ä½¿ç”¨é”é¿å…èµ„æºç«Ÿæ€">#</a></h5>
<blockquote>
<p>é”ï¼ˆä¹Ÿç§°ä¸ºäº’æ–¥é”ï¼‰æ˜¯ä¸€ç§åŒæ­¥æœºåˆ¶ï¼Œç”¨äºåœ¨å­˜åœ¨è®¸å¤šæ‰§è¡Œè¿›ç¨‹/çº¿ç¨‹çš„ç¯å¢ƒä¸­å¼ºåˆ¶é™åˆ¶å¯¹èµ„æºçš„è®¿é—®ã€‚é”å…·æœ‰ä¸¤ç§çŠ¶æ€ï¼šé”å®šå’Œè§£é”ã€‚ å¦‚æœçŠ¶æ€ä¸ºé”å®šï¼Œåˆ™åœ¨å†æ¬¡è§£é™¤é”å®šçŠ¶æ€ä¹‹å‰ï¼Œä¸å…è®¸å…¶ä»–å¹¶å‘è¿›ç¨‹/çº¿ç¨‹è¿›å…¥æ­¤ä»£ç æ®µã€‚</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#007f7f"># import Lock</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">from</span> multiprocessing <span style="color:#fff;font-weight:bold">import</span> Lock
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">from</span> multiprocessing <span style="color:#fff;font-weight:bold">import</span> Process, Value, Array
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> time
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">def</span> add_100(number, lock):
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">for</span> _ in <span style="color:#fff;font-weight:bold">range</span>(<span style="color:#ff0;font-weight:bold">100</span>):
</span></span><span style="display:flex;"><span>        time.sleep(<span style="color:#ff0;font-weight:bold">0.001</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f"># lock the state</span>
</span></span><span style="display:flex;"><span>        lock.acquire()
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        number.value += <span style="color:#ff0;font-weight:bold">1</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f"># unlock the state</span>
</span></span><span style="display:flex;"><span>        lock.release()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">def</span> add_100_array(numbers, lock):
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">for</span> _ in <span style="color:#fff;font-weight:bold">range</span>(<span style="color:#ff0;font-weight:bold">100</span>):
</span></span><span style="display:flex;"><span>        time.sleep(<span style="color:#ff0;font-weight:bold">0.01</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">for</span> i in <span style="color:#fff;font-weight:bold">range</span>(<span style="color:#fff;font-weight:bold">len</span>(numbers)):
</span></span><span style="display:flex;"><span>            lock.acquire()
</span></span><span style="display:flex;"><span>            numbers[i] += <span style="color:#ff0;font-weight:bold">1</span>
</span></span><span style="display:flex;"><span>            lock.release()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">if</span> __name__ == <span style="color:#0ff;font-weight:bold">&#34;__main__&#34;</span>:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f"># create a lock</span>
</span></span><span style="display:flex;"><span>    lock1 = Lock()
</span></span><span style="display:flex;"><span>    lock2 = Lock()
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    shared_number = Value(<span style="color:#0ff;font-weight:bold">&#39;i&#39;</span>, <span style="color:#ff0;font-weight:bold">0</span>) 
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">print</span>(<span style="color:#0ff;font-weight:bold">&#39;Value at beginning:&#39;</span>, shared_number.value)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    shared_array = Array(<span style="color:#0ff;font-weight:bold">&#39;d&#39;</span>, [<span style="color:#ff0;font-weight:bold">0.0</span>, <span style="color:#ff0;font-weight:bold">100.0</span>, <span style="color:#ff0;font-weight:bold">200.0</span>])
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">print</span>(<span style="color:#0ff;font-weight:bold">&#39;Array at beginning:&#39;</span>, shared_array[:])
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f"># pass the lock to the target function</span>
</span></span><span style="display:flex;"><span>    process1 = Process(target=add_100, args=(shared_number, lock1))
</span></span><span style="display:flex;"><span>    process2 = Process(target=add_100, args=(shared_number, lock1))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    process3 = Process(target=add_100_array, args=(shared_array, lock2))
</span></span><span style="display:flex;"><span>    process4 = Process(target=add_100_array, args=(shared_array, lock2))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    process1.start()
</span></span><span style="display:flex;"><span>    process2.start()
</span></span><span style="display:flex;"><span>    process3.start()
</span></span><span style="display:flex;"><span>    process4.start()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    process1.join()
</span></span><span style="display:flex;"><span>    process2.join()
</span></span><span style="display:flex;"><span>    process3.join()
</span></span><span style="display:flex;"><span>    process4.join()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">print</span>(<span style="color:#0ff;font-weight:bold">&#39;Value at end:&#39;</span>, shared_number.value)
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">print</span>(<span style="color:#0ff;font-weight:bold">&#39;Array at end:&#39;</span>, shared_array[:])
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">print</span>(<span style="color:#0ff;font-weight:bold">&#39;end main&#39;</span>)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span><span style="color:#0ff;font-weight:bold">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#0ff;font-weight:bold">Value at beginning: 0
</span></span></span><span style="display:flex;"><span><span style="color:#0ff;font-weight:bold">Array at beginning: [0.0, 100.0, 200.0]
</span></span></span><span style="display:flex;"><span><span style="color:#0ff;font-weight:bold">Value at end: 200
</span></span></span><span style="display:flex;"><span><span style="color:#0ff;font-weight:bold">Array at end: [200.0, 300.0, 400.0]
</span></span></span><span style="display:flex;"><span><span style="color:#0ff;font-weight:bold">end main
</span></span></span><span style="display:flex;"><span><span style="color:#0ff;font-weight:bold">&#34;&#34;&#34;</span>
</span></span></code></pre></div><h5 id="åœ¨ä¸Šä¸‹æ–‡ç®¡ç†å™¨ä¸­ä½¿ç”¨é”">åœ¨ä¸Šä¸‹æ–‡ç®¡ç†å™¨ä¸­ä½¿ç”¨é”<a hidden class="anchor" aria-hidden="true" href="#åœ¨ä¸Šä¸‹æ–‡ç®¡ç†å™¨ä¸­ä½¿ç”¨é”">#</a></h5>
<blockquote>
<p>ä½¿ç”¨ä¸Šä¸‹æ–‡ç®¡ç†å™¨ç®¡ç†é”çš„è·å–å’Œé‡Šæ”¾æ›´åŠ å®‰å…¨</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">def</span> add_100(number, lock):
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">for</span> _ in <span style="color:#fff;font-weight:bold">range</span>(<span style="color:#ff0;font-weight:bold">100</span>):
</span></span><span style="display:flex;"><span>        time.sleep(<span style="color:#ff0;font-weight:bold">0.01</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">with</span> lock:
</span></span><span style="display:flex;"><span>            number.value += <span style="color:#ff0;font-weight:bold">1</span>
</span></span></code></pre></div><h5 id="å¤šè¿›ç¨‹ä½¿ç”¨é˜Ÿåˆ—é€šä¿¡">å¤šè¿›ç¨‹ä½¿ç”¨é˜Ÿåˆ—é€šä¿¡<a hidden class="anchor" aria-hidden="true" href="#å¤šè¿›ç¨‹ä½¿ç”¨é˜Ÿåˆ—é€šä¿¡">#</a></h5>
<blockquote>
<p>ä½¿ç”¨é˜Ÿåˆ—çš„æ“ä½œæ˜¯è¿›ç¨‹å®‰å…¨çš„ã€‚å¤šè¿›ç¨‹é˜Ÿåˆ—å®ç°äº†é˜Ÿåˆ—çš„æ‰€æœ‰æ–¹æ³•ã€‚done()å’Œjoin()é™¤å¤–ã€‚</p>
<ul>
<li><code>q.get()</code>:ç§»é™¤é˜Ÿé¦–ç¬¬ä¸€ä¸ªå…ƒç´ ï¼Œé»˜è®¤æƒ…å†µï¼Œä¼šé˜»å¡ç›´åˆ°æœ‰å…ƒç´ å¯ç”¨</li>
<li><code>q.put(item)</code>å°†å…ƒç´ å‹åˆ°é˜Ÿå°¾ï¼Œé»˜è®¤æƒ…å†µï¼Œé˜»å¡ç›´åˆ°é˜Ÿåˆ—æœ‰ç©ºçš„æ§½</li>
<li><code>q.empty()</code>å¦‚æœé˜Ÿåˆ—ä¸ºç©ºï¼Œè¿”å›True</li>
<li><code>q.close()</code>è¡¨æ˜å½“å‰è¿›ç¨‹ä¸ä¼šæœ‰æ–°çš„æ•°æ®æ”¾åˆ°é˜Ÿåˆ—ä¸­äº†</li>
</ul>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#007f7f"># communicate between processes with the multiprocessing Queue</span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># Queues are thread and process safe</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">from</span> multiprocessing <span style="color:#fff;font-weight:bold">import</span> Process, Queue
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> time 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">def</span> square(numbers, queue):
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">for</span> i in numbers:
</span></span><span style="display:flex;"><span>        time.sleep(<span style="color:#ff0;font-weight:bold">0.01</span>)
</span></span><span style="display:flex;"><span>        queue.put(i*i)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">def</span> make_negative(numbers, queue):
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">for</span> i in numbers:
</span></span><span style="display:flex;"><span>        time.sleep(<span style="color:#ff0;font-weight:bold">0.01</span>)
</span></span><span style="display:flex;"><span>        queue.put(i*-<span style="color:#ff0;font-weight:bold">1</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">if</span> __name__ == <span style="color:#0ff;font-weight:bold">&#34;__main__&#34;</span>:
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    numbers = <span style="color:#fff;font-weight:bold">range</span>(<span style="color:#ff0;font-weight:bold">1</span>, <span style="color:#ff0;font-weight:bold">6</span>)
</span></span><span style="display:flex;"><span>    q = Queue()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    p1 = Process(target=square, args=(numbers,q))
</span></span><span style="display:flex;"><span>    p2 = Process(target=make_negative, args=(numbers,q))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    p1.start()
</span></span><span style="display:flex;"><span>    p2.start()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    p1.join()
</span></span><span style="display:flex;"><span>    p2.join()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f"># order might not be sequential</span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">while</span> not q.empty():
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">print</span>(q.get())
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">print</span>(<span style="color:#0ff;font-weight:bold">&#39;end main&#39;</span>)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span><span style="color:#0ff;font-weight:bold">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#0ff;font-weight:bold">1
</span></span></span><span style="display:flex;"><span><span style="color:#0ff;font-weight:bold">-1
</span></span></span><span style="display:flex;"><span><span style="color:#0ff;font-weight:bold">4
</span></span></span><span style="display:flex;"><span><span style="color:#0ff;font-weight:bold">-2
</span></span></span><span style="display:flex;"><span><span style="color:#0ff;font-weight:bold">9
</span></span></span><span style="display:flex;"><span><span style="color:#0ff;font-weight:bold">-3
</span></span></span><span style="display:flex;"><span><span style="color:#0ff;font-weight:bold">16
</span></span></span><span style="display:flex;"><span><span style="color:#0ff;font-weight:bold">-4
</span></span></span><span style="display:flex;"><span><span style="color:#0ff;font-weight:bold">25
</span></span></span><span style="display:flex;"><span><span style="color:#0ff;font-weight:bold">-5
</span></span></span><span style="display:flex;"><span><span style="color:#0ff;font-weight:bold">end main
</span></span></span><span style="display:flex;"><span><span style="color:#0ff;font-weight:bold">&#34;&#34;&#34;</span>
</span></span></code></pre></div><h5 id="è¿›ç¨‹æ± ">è¿›ç¨‹æ± <a hidden class="anchor" aria-hidden="true" href="#è¿›ç¨‹æ± ">#</a></h5>
<blockquote>
<p>è¿›ç¨‹æ± å¯¹è±¡æ§åˆ¶ä¸€äº›å·¥ä½œè¿›ç¨‹workerï¼Œå¯ä»¥æ”¯æŒè¶…æ—¶å’Œå›è°ƒä»¥å®ç°å¼‚æ­¥å¤„ç†ï¼Œä¹Ÿæœ‰ä¸€äº›å¹¶è¡Œçš„mapå®ç°ã€‚å®ƒå¯ä»¥è‡ªåŠ¨ç®¡ç†å¤šä¸ªå¤„ç†å™¨ï¼Œå¹¶å°†æ•°æ®åˆ†æˆå°å—ï¼Œåœ¨å¤šä¸ªå¤„ç†å™¨ä¸Šå¹¶è¡Œå¤„ç†ã€‚</p>
<p>é‡è¦çš„å‡½æ•°åŒ…æ‹¬ï¼š</p>
<ul>
<li><code>map(func, iterable[, chunksize])</code>å°†å¯è¿­ä»£å¯¹è±¡åˆ‡åˆ†æˆå°å—ï¼Œä½œä¸ºç‹¬ç«‹ä»»åŠ¡æäº¤åˆ°è¿›ç¨‹æ± ï¼Œå¹¶è¡Œå¤„ç†ã€‚å‡½æ•°å°†ä¼šé˜»å¡ï¼Œç›´åˆ°è¿”å›ç»“æœã€‚</li>
<li><code>close()</code>é˜»æ­¢æ›´å¤šä»»åŠ¡æ·»åŠ åˆ°è¿›ç¨‹æ± ï¼Œä¸€æ—¦ä»»åŠ¡å®Œæˆï¼Œworkerè¿›ç¨‹å°†é€€å‡º</li>
<li><code>join()</code>ç­‰å¾…å·¥ä½œè¿›ç¨‹é€€å‡ºï¼Œåœ¨è°ƒç”¨<code>join()</code>ä¹‹å‰éœ€è¦è°ƒç”¨<code>close()</code>æˆ–è€…<code>terminate()</code></li>
<li><code>apply(func, args)</code>è°ƒç”¨<code>func</code>å‡½æ•°ï¼Œå‚æ•°æ˜¯<code>args</code>ã€‚é˜»å¡ç›´åˆ°è¿”å›ç»“æœï¼Œ<code>func</code>å‡½æ•°åªåœ¨è¿›ç¨‹æ± ä¸­ä¸€ä¸ªworkerä¸­æ‰§è¡Œ</li>
<li>æœ‰<code>map_async()</code>å’Œ<code>apply_async()</code>è¿™ç§éé˜»å¡çš„å¼‚æ­¥å‡½æ•°</li>
</ul>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">from</span> multiprocessing <span style="color:#fff;font-weight:bold">import</span> Pool 
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> random
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> time
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">def</span> cube(number):
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">print</span>(<span style="color:#0ff;font-weight:bold">&#34;Hi&#34;</span>)
</span></span><span style="display:flex;"><span>    time.sleep(random.randint(<span style="color:#ff0;font-weight:bold">1</span>,<span style="color:#ff0;font-weight:bold">2</span>))
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">return</span> number * number * number
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">if</span> __name__ == <span style="color:#0ff;font-weight:bold">&#34;__main__&#34;</span>:
</span></span><span style="display:flex;"><span>    numbers = <span style="color:#fff;font-weight:bold">range</span>(<span style="color:#ff0;font-weight:bold">10</span>)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    p = Pool()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f"># by default this allocates the maximum number of available </span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f"># processors for this task --&gt; os.cpu_count()</span>
</span></span><span style="display:flex;"><span>    result = p.map(cube,  numbers)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f"># or </span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f"># result = [p.apply(cube, args=(i,)) for i in numbers]</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    p.close()
</span></span><span style="display:flex;"><span>    p.join()
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">print</span>(result)
</span></span></code></pre></div><h3 id="å¤šçº¿ç¨‹åŸºç¡€">å¤šçº¿ç¨‹åŸºç¡€<a hidden class="anchor" aria-hidden="true" href="#å¤šçº¿ç¨‹åŸºç¡€">#</a></h3>
<blockquote>
<p>Pythonå¤šçº¿ç¨‹ç›¸å¯¹æ¯”è¾ƒé¸¡è‚‹ï¼Œå…¶ä½¿ç”¨å’Œå¤šè¿›ç¨‹ç±»ä¼¼</p>
</blockquote>
<h5 id="åˆ›å»ºå¹¶å¼€å§‹çº¿ç¨‹">åˆ›å»ºå¹¶å¼€å§‹çº¿ç¨‹<a hidden class="anchor" aria-hidden="true" href="#åˆ›å»ºå¹¶å¼€å§‹çº¿ç¨‹">#</a></h5>
<blockquote>
<p>ä½¿ç”¨threadingåº“å®ç°</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">from</span> threading <span style="color:#fff;font-weight:bold">import</span> Thread
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">def</span> square_numbers():
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">for</span> i in <span style="color:#fff;font-weight:bold">range</span>(<span style="color:#ff0;font-weight:bold">1000</span>):
</span></span><span style="display:flex;"><span>        result = i * i
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">if</span> __name__ == <span style="color:#0ff;font-weight:bold">&#34;__main__&#34;</span>:        
</span></span><span style="display:flex;"><span>    threads = []
</span></span><span style="display:flex;"><span>    num_threads = <span style="color:#ff0;font-weight:bold">10</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f"># create threads and asign a function for each thread</span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">for</span> i in <span style="color:#fff;font-weight:bold">range</span>(num_threads):
</span></span><span style="display:flex;"><span>        thread = Thread(target=square_numbers)
</span></span><span style="display:flex;"><span>        threads.append(thread)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f"># start all threads</span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">for</span> thread in threads:
</span></span><span style="display:flex;"><span>        thread.start()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f"># wait for all threads to finish</span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f"># block the main thread until these threads are finished</span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">for</span> thread in threads:
</span></span><span style="display:flex;"><span>        thread.join()
</span></span></code></pre></div><h5 id="çº¿ç¨‹é—´å…±äº«æ•°æ®">çº¿ç¨‹é—´å…±äº«æ•°æ®<a hidden class="anchor" aria-hidden="true" href="#çº¿ç¨‹é—´å…±äº«æ•°æ®">#</a></h5>
<blockquote>
<p>çº¿ç¨‹é—´å¯ä»¥é€šè¿‡å…¨å±€å˜é‡æ¥å…±äº«æ•°æ®ï¼Œå› ä¸ºçº¿ç¨‹é—´æ˜¯å…±äº«å†…å­˜ç©ºé—´çš„</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">from</span> threading <span style="color:#fff;font-weight:bold">import</span> Thread
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> time
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># all threads can access this global variable</span>
</span></span><span style="display:flex;"><span>database_value = <span style="color:#ff0;font-weight:bold">0</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">def</span> increase():
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">global</span> database_value <span style="color:#007f7f"># needed to modify the global value</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f"># get a local copy (simulate data retrieving)</span>
</span></span><span style="display:flex;"><span>    local_copy = database_value
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f"># simulate some modifying operation</span>
</span></span><span style="display:flex;"><span>    local_copy += <span style="color:#ff0;font-weight:bold">1</span>
</span></span><span style="display:flex;"><span>    time.sleep(<span style="color:#ff0;font-weight:bold">0.1</span>)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f"># write the calculated new value into the global variable</span>
</span></span><span style="display:flex;"><span>    database_value = local_copy
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">if</span> __name__ == <span style="color:#0ff;font-weight:bold">&#34;__main__&#34;</span>:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">print</span>(<span style="color:#0ff;font-weight:bold">&#39;Start value: &#39;</span>, database_value)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    t1 = Thread(target=increase)
</span></span><span style="display:flex;"><span>    t2 = Thread(target=increase)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    t1.start()
</span></span><span style="display:flex;"><span>    t2.start()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    t1.join()
</span></span><span style="display:flex;"><span>    t2.join()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">print</span>(<span style="color:#0ff;font-weight:bold">&#39;End value:&#39;</span>, database_value)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">print</span>(<span style="color:#0ff;font-weight:bold">&#39;end main&#39;</span>)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span><span style="color:#0ff;font-weight:bold">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#0ff;font-weight:bold">    Start value:  0
</span></span></span><span style="display:flex;"><span><span style="color:#0ff;font-weight:bold">    End value: 1
</span></span></span><span style="display:flex;"><span><span style="color:#0ff;font-weight:bold">    end main
</span></span></span><span style="display:flex;"><span><span style="color:#0ff;font-weight:bold">&#34;&#34;&#34;</span>
</span></span></code></pre></div><h5 id="ä½¿ç”¨é”å¤„ç†èµ„æºç«Ÿæ€">ä½¿ç”¨é”å¤„ç†èµ„æºç«Ÿæ€<a hidden class="anchor" aria-hidden="true" href="#ä½¿ç”¨é”å¤„ç†èµ„æºç«Ÿæ€">#</a></h5>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#007f7f"># import Lock</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">from</span> threading <span style="color:#fff;font-weight:bold">import</span> Thread, Lock
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> time
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>database_value = <span style="color:#ff0;font-weight:bold">0</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">def</span> increase(lock):
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">global</span> database_value 
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f"># lock the state</span>
</span></span><span style="display:flex;"><span>    lock.acquire()
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    local_copy = database_value
</span></span><span style="display:flex;"><span>    local_copy += <span style="color:#ff0;font-weight:bold">1</span>
</span></span><span style="display:flex;"><span>    time.sleep(<span style="color:#ff0;font-weight:bold">0.1</span>)
</span></span><span style="display:flex;"><span>    database_value = local_copy
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f"># unlock the state</span>
</span></span><span style="display:flex;"><span>    lock.release()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">if</span> __name__ == <span style="color:#0ff;font-weight:bold">&#34;__main__&#34;</span>:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f"># create a lock</span>
</span></span><span style="display:flex;"><span>    lock = Lock()
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">print</span>(<span style="color:#0ff;font-weight:bold">&#39;Start value: &#39;</span>, database_value)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f"># pass the lock to the target function</span>
</span></span><span style="display:flex;"><span>    t1 = Thread(target=increase, args=(lock,)) <span style="color:#007f7f"># notice the comma after lock since args must be a tuple</span>
</span></span><span style="display:flex;"><span>    t2 = Thread(target=increase, args=(lock,))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    t1.start()
</span></span><span style="display:flex;"><span>    t2.start()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    t1.join()
</span></span><span style="display:flex;"><span>    t2.join()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">print</span>(<span style="color:#0ff;font-weight:bold">&#39;End value:&#39;</span>, database_value)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">print</span>(<span style="color:#0ff;font-weight:bold">&#39;end main&#39;</span>)
</span></span></code></pre></div><blockquote>
<p>ä½¿ç”¨ä¸Šä¸‹æ–‡ç®¡ç†å™¨</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">def</span> increase(lock):
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">global</span> database_value 
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">with</span> lock: 
</span></span><span style="display:flex;"><span>        local_copy = database_value
</span></span><span style="display:flex;"><span>        local_copy += <span style="color:#ff0;font-weight:bold">1</span>
</span></span><span style="display:flex;"><span>        time.sleep(<span style="color:#ff0;font-weight:bold">0.1</span>)
</span></span><span style="display:flex;"><span>        database_value = local_copy
</span></span></code></pre></div><h5 id="å¤šçº¿ç¨‹æ¶ˆæ¯é˜Ÿåˆ—é€šä¿¡">å¤šçº¿ç¨‹æ¶ˆæ¯é˜Ÿåˆ—é€šä¿¡<a hidden class="anchor" aria-hidden="true" href="#å¤šçº¿ç¨‹æ¶ˆæ¯é˜Ÿåˆ—é€šä¿¡">#</a></h5>
<blockquote>
<p>å¯¹é˜Ÿåˆ—çš„æ“ä½œæ˜¯çº¿ç¨‹å®‰å…¨çš„</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">from</span> threading <span style="color:#fff;font-weight:bold">import</span> Thread, Lock, current_thread
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">from</span> queue <span style="color:#fff;font-weight:bold">import</span> Queue
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">def</span> worker(q, lock):
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">while</span> <span style="color:#fff;font-weight:bold">True</span>:
</span></span><span style="display:flex;"><span>        value = q.get()  <span style="color:#007f7f"># blocks until the item is available</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f"># do stuff...</span>
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">with</span> lock:
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f"># prevent printing at the same time with this lock</span>
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">print</span>(<span style="color:#0ff;font-weight:bold">f</span><span style="color:#0ff;font-weight:bold">&#34;in </span><span style="color:#0ff;font-weight:bold">{</span>current_thread().name<span style="color:#0ff;font-weight:bold">}</span><span style="color:#0ff;font-weight:bold"> got </span><span style="color:#0ff;font-weight:bold">{</span>value<span style="color:#0ff;font-weight:bold">}</span><span style="color:#0ff;font-weight:bold">&#34;</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f"># ...</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f"># For each get(), a subsequent call to task_done() tells the queue</span>
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f"># that the processing on this item is complete.</span>
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f"># If all tasks are done, q.join() can unblock</span>
</span></span><span style="display:flex;"><span>        q.task_done()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">if</span> __name__ == <span style="color:#0ff;font-weight:bold">&#39;__main__&#39;</span>:
</span></span><span style="display:flex;"><span>    q = Queue()
</span></span><span style="display:flex;"><span>    num_threads = <span style="color:#ff0;font-weight:bold">10</span>
</span></span><span style="display:flex;"><span>    lock = Lock()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">for</span> i in <span style="color:#fff;font-weight:bold">range</span>(num_threads):
</span></span><span style="display:flex;"><span>        t = Thread(name=<span style="color:#0ff;font-weight:bold">f</span><span style="color:#0ff;font-weight:bold">&#34;Thread</span><span style="color:#0ff;font-weight:bold">{</span>i+<span style="color:#ff0;font-weight:bold">1</span><span style="color:#0ff;font-weight:bold">}</span><span style="color:#0ff;font-weight:bold">&#34;</span>, target=worker, args=(q, lock))
</span></span><span style="display:flex;"><span>        t.daemon = <span style="color:#fff;font-weight:bold">True</span>  <span style="color:#007f7f"># dies when the main thread dies</span>
</span></span><span style="display:flex;"><span>        t.start()
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f"># fill the queue with items</span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">for</span> x in <span style="color:#fff;font-weight:bold">range</span>(<span style="color:#ff0;font-weight:bold">20</span>):
</span></span><span style="display:flex;"><span>        q.put(x)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    q.join()  <span style="color:#007f7f"># Blocks until all items in the queue have been gotten and processed.</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">print</span>(<span style="color:#0ff;font-weight:bold">&#39;main done&#39;</span>)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span><span style="color:#0ff;font-weight:bold">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#0ff;font-weight:bold">in Thread1 got 0
</span></span></span><span style="display:flex;"><span><span style="color:#0ff;font-weight:bold">    in Thread2 got 1
</span></span></span><span style="display:flex;"><span><span style="color:#0ff;font-weight:bold">    in Thread2 got 11
</span></span></span><span style="display:flex;"><span><span style="color:#0ff;font-weight:bold">    in Thread2 got 12
</span></span></span><span style="display:flex;"><span><span style="color:#0ff;font-weight:bold">    in Thread2 got 13
</span></span></span><span style="display:flex;"><span><span style="color:#0ff;font-weight:bold">    in Thread2 got 14
</span></span></span><span style="display:flex;"><span><span style="color:#0ff;font-weight:bold">    in Thread2 got 15
</span></span></span><span style="display:flex;"><span><span style="color:#0ff;font-weight:bold">    in Thread2 got 16
</span></span></span><span style="display:flex;"><span><span style="color:#0ff;font-weight:bold">    in Thread2 got 17
</span></span></span><span style="display:flex;"><span><span style="color:#0ff;font-weight:bold">    in Thread2 got 18
</span></span></span><span style="display:flex;"><span><span style="color:#0ff;font-weight:bold">    in Thread2 got 19
</span></span></span><span style="display:flex;"><span><span style="color:#0ff;font-weight:bold">    in Thread8 got 5
</span></span></span><span style="display:flex;"><span><span style="color:#0ff;font-weight:bold">    in Thread4 got 9
</span></span></span><span style="display:flex;"><span><span style="color:#0ff;font-weight:bold">    in Thread1 got 10
</span></span></span><span style="display:flex;"><span><span style="color:#0ff;font-weight:bold">    in Thread5 got 2
</span></span></span><span style="display:flex;"><span><span style="color:#0ff;font-weight:bold">    in Thread6 got 3
</span></span></span><span style="display:flex;"><span><span style="color:#0ff;font-weight:bold">    in Thread9 got 6
</span></span></span><span style="display:flex;"><span><span style="color:#0ff;font-weight:bold">    in Thread7 got 4
</span></span></span><span style="display:flex;"><span><span style="color:#0ff;font-weight:bold">    in Thread10 got 7
</span></span></span><span style="display:flex;"><span><span style="color:#0ff;font-weight:bold">    in Thread3 got 8
</span></span></span><span style="display:flex;"><span><span style="color:#0ff;font-weight:bold">    main done
</span></span></span><span style="display:flex;"><span><span style="color:#0ff;font-weight:bold">&#34;&#34;&#34;</span>
</span></span></code></pre></div><h4 id="pythonæ ‡å‡†åº“è‡ªå¸¦çš„ä¸€äº›å°å·¥å…·">Pythonæ ‡å‡†åº“è‡ªå¸¦çš„ä¸€äº›å°å·¥å…·<a hidden class="anchor" aria-hidden="true" href="#pythonæ ‡å‡†åº“è‡ªå¸¦çš„ä¸€äº›å°å·¥å…·">#</a></h4>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#007f7f"># æŸ¥çœ‹åŒ…å®‰è£…è·¯å¾„</span>
</span></span><span style="display:flex;"><span>python -m site
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># å¼€å¯ç®€å•çš„http server</span>
</span></span><span style="display:flex;"><span>python -m http.server 
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># base64ç¼–ç å’Œè§£ç </span>
</span></span><span style="display:flex;"><span>echo <span style="color:#0ff;font-weight:bold">&#34;hello&#34;</span> | python -m base64
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># top level await console</span>
</span></span><span style="display:flex;"><span>python -m asyncio
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># æŸ¥çœ‹tokenizeå’Œastç»“æœ</span>
</span></span><span style="display:flex;"><span>python -m tokenize cgi.py
</span></span><span style="display:flex;"><span>pythono -m ast cgi.py
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># jsonç¾åŒ–è¾“å‡º</span>
</span></span><span style="display:flex;"><span>echo <span style="color:#0ff;font-weight:bold">&#39;{&#34;foo&#34;: &#34;bar&#34;}&#39;</span> | python -m json.tool
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># æ˜¾ç¤ºæ—¥å†</span>
</span></span><span style="display:flex;"><span>python -m calendar
</span></span></code></pre></div><h3 id="å‚è€ƒ">å‚è€ƒ<a hidden class="anchor" aria-hidden="true" href="#å‚è€ƒ">#</a></h3>
<p><a href="https://www.python-engineer.com/courses/advancedpython/15-thread-vs-process/">Pythonå¤šçº¿ç¨‹å’Œå¤šè¿›ç¨‹</a>
<a href="https://til.simonwillison.net/python/stdlib-cli-tools">CLI tools hidden in the Python standard library | Simon Willisonâ€™s TILs</a></p>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="https://blog.niuhemoon.win/tags/python/">Python</a></li>
    </ul>
<div class="footer-comments">
  <p>For comments, please   <a href="mailto:carlton2tang@gmail.com" class="email-button" style="font-size: inherit; padding: 5px 10px; background-color: #3f6b9a; color: white; text-decoration: none; border-radius: 3px; transition: background-color 0.3s;">
    send an email
</a> to me</p>

</div>
<nav class="paginav">
  <a class="prev" href="https://blog.niuhemoon.win/posts/tech/gdb-debug-python/">
    <span class="title">Â« ä¸Šä¸€é¡µ</span>
    <br>
    <span>GDBè°ƒè¯•Pythonä»£ç </span>
  </a>
  <a class="next" href="https://blog.niuhemoon.win/posts/tech/python-advanced-2/">
    <span class="title">ä¸‹ä¸€é¡µ Â»</span>
    <br>
    <span>Pythonè¿›é˜¶ä¸­</span>
  </a>
</nav>

  </footer>
</article>
    </main>
    
<footer class="footer">
      
    <span>&copy; 2025 <a href="https://blog.niuhemoon.win">Niuhe&#39;s Blog</a></span>
    <span xmlns:cc="http://creativecommons.org/ns#" xmlns:dct="http://purl.org/dc/terms/">
        Licensed under
        <a
          href="http://creativecommons.org/licenses/by-nc-sa/4.0/?ref=chooser-v1"
          target="_blank"
          rel="license noopener noreferrer"
          style="display:inline-block;"
          >CC BY-NC-SA 4.0 </a></span>
    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = 'ğŸ“„å¤åˆ¶';

        function copyingDone() {
            copybutton.innerHTML = 'ğŸ‘ŒğŸ»å·²å¤åˆ¶!';
            setTimeout(() => {
                copybutton.innerHTML = 'ğŸ“„å¤åˆ¶';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
