<!DOCTYPE html>
<html lang="zh" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>Python æ€§èƒ½ä¼˜åŒ–ï¼šä½¿ç”¨ ZeroMQ çªç ´ GIL é™åˆ¶ | Niuhe&#39;s Blog</title>
<meta name="keywords" content="ZeroMQ, æ€§èƒ½ä¼˜åŒ–, åˆ†å¸ƒå¼è®¡ç®—">
<meta name="description" content="é€šè¿‡ ZeroMQ åˆ†å¸ƒå¼æ¶ˆæ¯é˜Ÿåˆ—åº“çªç ´ Python GIL é™åˆ¶ï¼Œä¼˜åŒ– CPU å¯†é›†å‹ä»»åŠ¡æ€§èƒ½">
<meta name="author" content="Niuhe">
<link rel="canonical" href="https://blog.niuhemoon.win/posts/tech/python-zeromq-gil/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.3613efbd0b1772781e8f49935e973cae632a7f61471c05b17be155505ccf87b5.css" integrity="sha256-NhPvvQsXcngej0mTXpc8rmMqf2FHHAWxe&#43;FVUFzPh7U=" rel="preload stylesheet" as="style">
<script defer crossorigin="anonymous" src="/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js" integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG&#43;9vmJ0cTS&#43;ovo0FeA="
    onload="hljs.initHighlightingOnLoad();"></script>
<link rel="icon" href="https://blog.niuhemoon.win/base/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="https://blog.niuhemoon.win/base/favicon.ico">
<link rel="icon" type="image/png" sizes="32x32" href="https://blog.niuhemoon.win/base/favicon.ico">
<link rel="apple-touch-icon" href="https://blog.niuhemoon.win/base/avatar.jpeg">
<link rel="mask-icon" href="https://blog.niuhemoon.win/base/avatar.jpeg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --hljs-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript>
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
	ga('create', 'UA-116933089-1', 'auto');
	
	ga('send', 'pageview');
}
</script><meta property="og:title" content="Python æ€§èƒ½ä¼˜åŒ–ï¼šä½¿ç”¨ ZeroMQ çªç ´ GIL é™åˆ¶" />
<meta property="og:description" content="é€šè¿‡ ZeroMQ åˆ†å¸ƒå¼æ¶ˆæ¯é˜Ÿåˆ—åº“çªç ´ Python GIL é™åˆ¶ï¼Œä¼˜åŒ– CPU å¯†é›†å‹ä»»åŠ¡æ€§èƒ½" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://blog.niuhemoon.win/posts/tech/python-zeromq-gil/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2025-05-06T00:00:00+00:00" />
<meta property="article:modified_time" content="2025-05-06T00:00:00+00:00" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Python æ€§èƒ½ä¼˜åŒ–ï¼šä½¿ç”¨ ZeroMQ çªç ´ GIL é™åˆ¶"/>
<meta name="twitter:description" content="é€šè¿‡ ZeroMQ åˆ†å¸ƒå¼æ¶ˆæ¯é˜Ÿåˆ—åº“çªç ´ Python GIL é™åˆ¶ï¼Œä¼˜åŒ– CPU å¯†é›†å‹ä»»åŠ¡æ€§èƒ½"/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "ğŸ“šæ–‡ç« ",
      "item": "https://blog.niuhemoon.win/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  3 ,
      "name": "ğŸ‘¨ğŸ»â€ğŸ’» æŠ€æœ¯",
      "item": "https://blog.niuhemoon.win/posts/tech/"
    }, 
    {
      "@type": "ListItem",
      "position":  4 ,
      "name": "Python æ€§èƒ½ä¼˜åŒ–ï¼šä½¿ç”¨ ZeroMQ çªç ´ GIL é™åˆ¶",
      "item": "https://blog.niuhemoon.win/posts/tech/python-zeromq-gil/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "Python æ€§èƒ½ä¼˜åŒ–ï¼šä½¿ç”¨ ZeroMQ çªç ´ GIL é™åˆ¶",
  "name": "Python æ€§èƒ½ä¼˜åŒ–ï¼šä½¿ç”¨ ZeroMQ çªç ´ GIL é™åˆ¶",
  "description": "é€šè¿‡ ZeroMQ åˆ†å¸ƒå¼æ¶ˆæ¯é˜Ÿåˆ—åº“çªç ´ Python GIL é™åˆ¶ï¼Œä¼˜åŒ– CPU å¯†é›†å‹ä»»åŠ¡æ€§èƒ½",
  "keywords": [
    "ZeroMQ", "æ€§èƒ½ä¼˜åŒ–", "åˆ†å¸ƒå¼è®¡ç®—"
  ],
  "articleBody": "åœ¨ Python ç¼–ç¨‹ä¸­ï¼Œå…¨å±€è§£é‡Šå™¨é”ï¼ˆGlobal Interpreter Lockï¼Œç®€ç§° GILï¼‰ä¸€ç›´æ˜¯åˆ¶çº¦ CPU å¯†é›†å‹ä»»åŠ¡æ€§èƒ½çš„ä¸»è¦ç“¶é¢ˆã€‚æœ¬æ–‡å°†ä»‹ç»å¦‚ä½•ä½¿ç”¨ ZeroMQ è¿™ä¸€é«˜æ€§èƒ½åˆ†å¸ƒå¼æ¶ˆæ¯é˜Ÿåˆ—åº“æ¥çªç ´ GIL é™åˆ¶ï¼Œé€šè¿‡å°†å•ä¸€è¿›ç¨‹æ‹†åˆ†ä¸ºå¤šä¸ªé€šè¿‡æ¶ˆæ¯é€šä¿¡çš„è¿›ç¨‹ï¼Œä»è€Œå……åˆ†åˆ©ç”¨å¤šæ ¸ CPU èµ„æºï¼Œæ˜¾è‘—æå‡æ€§èƒ½ã€‚\nç¯å¢ƒé…ç½®ä¸å®‰è£… é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦åˆ›å»ºä¸€ä¸ªè™šæ‹Ÿç¯å¢ƒå¹¶å®‰è£…å¿…è¦çš„ä¾èµ–åŒ…ã€‚è¿™é‡Œæˆ‘ä»¬ä½¿ç”¨ uv å‘½ä»¤æ¥åˆ›å»ºå’Œç®¡ç†è™šæ‹Ÿç¯å¢ƒ\nuv venv .venv source .venv/bin/activate \u0026\u0026 uv pip install pyzmq numpy matplotlib tqdm ZeroMQ æ ¸å¿ƒæ¦‚å¿µ ZeroMQ (ä¹Ÿå†™ä½œ Ã˜MQ, 0MQ æˆ– zmq) æ˜¯ä¸€ä¸ªé«˜æ€§èƒ½çš„å¼‚æ­¥æ¶ˆæ¯ä¼ é€’åº“ï¼Œæ—¨åœ¨ç”¨äºåˆ†å¸ƒå¼æˆ–å¹¶å‘åº”ç”¨ç¨‹åºã€‚å®ƒæä¾›äº†ä¸€ä¸ªæ¶ˆæ¯é˜Ÿåˆ—ï¼Œä½†ä¸ä¼ ç»Ÿçš„æ¶ˆæ¯é˜Ÿåˆ—ä¸åŒï¼Œå®ƒå¯ä»¥åœ¨æ²¡æœ‰ä¸“é—¨çš„æ¶ˆæ¯ä»£ç†ï¼ˆbrokerï¼‰çš„æƒ…å†µä¸‹è¿è¡Œã€‚\nInfo\nZeroMQ æä¾›äº†ä¸€ç§è½»é‡çº§çš„æ¶ˆæ¯ä¼ é€’æœºåˆ¶ï¼Œéå¸¸é€‚åˆç”¨äºæ„å»ºåˆ†å¸ƒå¼ç³»ç»Ÿå’Œå¹¶è¡Œè®¡ç®—åº”ç”¨ã€‚\nZeroMQ çš„ä¸»è¦ç‰¹ç‚¹ æ— ä»£ç†è®¾è®¡ï¼šä¸éœ€è¦ä¸­å¤®æ¶ˆæ¯æœåŠ¡å™¨ å¼‚æ­¥ I/O æ¨¡å‹ï¼šéé˜»å¡æ“ä½œï¼Œæé«˜å¹¶å‘æ€§èƒ½ å¤šç§é€šä¿¡æ¨¡å¼ï¼šæ”¯æŒè¯·æ±‚-å›å¤ã€å‘å¸ƒ-è®¢é˜…ã€æ¨é€-æ‹‰å–ç­‰æ¨¡å¼ å¤šç§ä¼ è¾“åè®®ï¼šæ”¯æŒ TCPã€IPCã€è¿›ç¨‹å†…é€šä¿¡ç­‰ è·¨è¯­è¨€æ”¯æŒï¼šæä¾›å¤šç§ç¼–ç¨‹è¯­è¨€çš„ç»‘å®š ZeroMQ çš„å¸¸ç”¨é€šä¿¡æ¨¡å¼ è¯·æ±‚-å›å¤ (REQ-REP)ï¼šå®¢æˆ·ç«¯å‘é€è¯·æ±‚ï¼ŒæœåŠ¡å™¨å›å¤ å‘å¸ƒ-è®¢é˜… (PUB-SUB)ï¼šå‘å¸ƒè€…å‘é€æ¶ˆæ¯ï¼Œè®¢é˜…è€…æ¥æ”¶ æ¨é€-æ‹‰å– (PUSH-PULL)ï¼šä»»åŠ¡åˆ†å‘å’Œç»“æœæ”¶é›†ï¼Œé€‚åˆå¹¶è¡Œå¤„ç† è·¯ç”±-ç»é”€å•† (ROUTER-DEALER)ï¼šé«˜çº§å¼‚æ­¥é€šä¿¡æ¨¡å¼ åŸºæœ¬çš„ ZeroMQ ç¤ºä¾‹ ä»¥ä¸‹æ˜¯ä¸€ä¸ªç®€å•çš„è¯·æ±‚-å›å¤æ¨¡å¼ç¤ºä¾‹ï¼Œå±•ç¤ºäº† ZeroMQ çš„åŸºæœ¬ç”¨æ³•ï¼š\nåŸºæœ¬çš„ ZeroMQ REQ-REP æ¨¡å¼ç¤ºä¾‹ #!/usr/bin/env python # åŸºæœ¬çš„ ZeroMQ REQ-REP æ¨¡å¼ç¤ºä¾‹ import zmq import time import sys import threading def server(): # åˆ›å»ºä¸Šä¸‹æ–‡å’Œ socket context = zmq.Context() socket = context.socket(zmq.REP) socket.bind(\"tcp://*:5555\") print(\"æœåŠ¡å™¨å·²å¯åŠ¨ï¼Œç­‰å¾…è¯·æ±‚...\") # æœåŠ¡å¾ªç¯ while True: # ç­‰å¾…å®¢æˆ·ç«¯è¯·æ±‚ message = socket.recv() print(f\"æ”¶åˆ°è¯·æ±‚: {message.decode()}\") # æ¨¡æ‹Ÿå·¥ä½œ time.sleep(1) # å‘é€å›å¤ socket.send(b\"Request processed\") def client(): # åˆ›å»ºä¸Šä¸‹æ–‡å’Œ socket context = zmq.Context() socket = context.socket(zmq.REQ) socket.connect(\"tcp://localhost:5555\") # å‘é€è¯·æ±‚ for i in range(5): print(f\"å‘é€è¯·æ±‚ {i}...\") socket.send(f\"è¯·æ±‚ #{i}\".encode()) # è·å–å›å¤ message = socket.recv() print(f\"æ”¶åˆ°å›å¤: {message.decode()}\") if __name__ == \"__main__\": if len(sys.argv) \u003c 2: print(\"ç”¨æ³•: python zmq_basic.py [server|client]\") sys.exit(1) if sys.argv[1] == \"server\": server() elif sys.argv[1] == \"client\": client() elif sys.argv[1] == \"both\": # åœ¨å•ç‹¬çš„çº¿ç¨‹ä¸­å¯åŠ¨æœåŠ¡å™¨ server_thread = threading.Thread(target=server) server_thread.daemon = True server_thread.start() # ç»™æœåŠ¡å™¨ä¸€ç‚¹æ—¶é—´å¯åŠ¨ time.sleep(1) # è¿è¡Œå®¢æˆ·ç«¯ client() else: print(\"ç”¨æ³•: python zmq_basic.py [server|client|both]\") è¿™ä¸ªç®€å•ç¤ºä¾‹å±•ç¤ºäº† ZeroMQ çš„åŸºæœ¬é€šä¿¡æ¨¡å¼ã€‚æœåŠ¡å™¨åˆ›å»ºä¸€ä¸ª REP å¥—æ¥å­—å¹¶ç»‘å®šåˆ°ç‰¹å®šç«¯å£ï¼Œå®¢æˆ·ç«¯åˆ›å»ºä¸€ä¸ª REQ å¥—æ¥å­—å¹¶è¿æ¥åˆ°æœåŠ¡å™¨ã€‚å®¢æˆ·ç«¯å‘é€è¯·æ±‚ï¼ŒæœåŠ¡å™¨å¤„ç†åå›å¤ã€‚\nGIL é™åˆ¶ä¸‹çš„æ€§èƒ½é—®é¢˜ åœ¨æ·±å…¥ ZeroMQ è§£å†³æ–¹æ¡ˆä¹‹å‰ï¼Œè®©æˆ‘ä»¬å…ˆäº†è§£ Python ä¸­çš„ GIL é—®é¢˜ä»¥åŠå®ƒå¦‚ä½•å½±å“ CPU å¯†é›†å‹ä»»åŠ¡çš„æ€§èƒ½ã€‚\nGILï¼ˆå…¨å±€è§£é‡Šå™¨é”ï¼‰æ˜¯ CPython è§£é‡Šå™¨ä¸­çš„ä¸€ä¸ªäº’æ–¥é”ï¼Œå®ƒç¡®ä¿åŒä¸€æ—¶åˆ»åªæœ‰ä¸€ä¸ªçº¿ç¨‹å¯ä»¥æ‰§è¡Œ Python å­—èŠ‚ç ã€‚è¿™æ„å‘³ç€å³ä½¿åœ¨å¤šæ ¸å¤„ç†å™¨ä¸Šï¼Œæ ‡å‡†çš„ Python çº¿ç¨‹ä¹Ÿæ— æ³•å®ç°çœŸæ­£çš„å¹¶è¡Œè®¡ç®—ã€‚\nWarning\nç”±äº GIL çš„å­˜åœ¨ï¼ŒPython å¤šçº¿ç¨‹åœ¨ CPU å¯†é›†å‹ä»»åŠ¡ä¸Šé€šå¸¸æ— æ³•æä¾›æ€§èƒ½æå‡ï¼Œæœ‰æ—¶ç”²è‡³ä¼šå› ä¸ºçº¿ç¨‹åˆ‡æ¢å¼€é”€è€Œå¯¼è‡´æ€§èƒ½ä¸‹é™ã€‚\næ¼”ç¤º GIL é™åˆ¶çš„ç¤ºä¾‹ç¨‹åº ä¸‹é¢æ˜¯ä¸€ä¸ª CPU å¯†é›†å‹ä»»åŠ¡çš„ç¤ºä¾‹ï¼Œå®ƒæ¨¡æ‹Ÿäº†å›¾åƒå¤„ç†ä¸­çš„æ¨¡ç³Šæ»¤é•œæ“ä½œï¼š\nCPUå¯†é›†å‹ä»»åŠ¡ç¤ºä¾‹ - å—GILé™åˆ¶çš„æ¨¡ç³Šæ»¤é•œæ“ä½œ #!/usr/bin/env python # filename: cpu_bound_demo.py # CPUå¯†é›†å‹ä»»åŠ¡ç¤ºä¾‹ - å—GILé™åˆ¶çš„æ€§èƒ½é—®é¢˜ import numpy as np import time import matplotlib.pyplot as plt from matplotlib.figure import Figure from matplotlib.backends.backend_agg import FigureCanvasAgg as FigureCanvas def generate_data(size=1000): \"\"\"ç”Ÿæˆéšæœºæ•°æ®çŸ©é˜µ\"\"\" return np.random.random((size, size)) def process_data(data, kernel_size=5): \"\"\"å¯¹æ•°æ®åº”ç”¨ç®€å•çš„æ¨¡ç³Šæ»¤é•œ (CPUå¯†é›†å‹æ“ä½œ)\"\"\" result = np.zeros_like(data) rows, cols = data.shape # ç®€å•çš„æ»‘åŠ¨çª—å£å¹³å‡ (æ¨¡æ‹Ÿæ¨¡ç³Šæ“ä½œ) for i in range(kernel_size//2, rows - kernel_size//2): for j in range(kernel_size//2, cols - kernel_size//2): # æå–çª—å£ window = data[i-kernel_size//2:i+kernel_size//2+1, j-kernel_size//2:j+kernel_size//2+1] # è®¡ç®—å¹³å‡å€¼ result[i, j] = np.mean(window) return result def visualize_results(original, processed, execution_time, title): \"\"\"å¯è§†åŒ–åŸå§‹æ•°æ®å’Œå¤„ç†åçš„æ•°æ®\"\"\" fig = Figure(figsize=(10, 5)) canvas = FigureCanvas(fig) ax1 = fig.add_subplot(121) ax1.imshow(original, cmap='viridis') ax1.set_title('Original Data') ax1.axis('off') ax2 = fig.add_subplot(122) ax2.imshow(processed, cmap='viridis') ax2.set_title(f'Processed Data\\nExecution Time: {execution_time:.2f} seconds') ax2.axis('off') fig.suptitle(title) fig.tight_layout() # ä¿å­˜å›¾åƒ fig.savefig(f\"{title.replace(' ', '_').lower()}.png\") print(f\"ç»“æœå·²ä¿å­˜ä¸º {title.replace(' ', '_').lower()}.png\") def run_single_process(data_size=500, kernel_size=5): \"\"\"åœ¨å•ä¸ªè¿›ç¨‹ä¸­è¿è¡Œæ•°æ®å¤„ç†\"\"\" print(f\"ç”Ÿæˆ {data_size}x{data_size} çš„æ•°æ®çŸ©é˜µ...\") data = generate_data(data_size) print(\"å¼€å§‹å¤„ç†æ•°æ®...\") start_time = time.time() result = process_data(data, kernel_size) end_time = time.time() execution_time = end_time - start_time print(f\"å¤„ç†å®Œæˆï¼Œè€—æ—¶: {execution_time:.2f} ç§’\") # å¯è§†åŒ–ç»“æœ visualize_results(data, result, execution_time, \"Single Process\") return execution_time if __name__ == \"__main__\": # è¿è¡Œå•è¿›ç¨‹ç‰ˆæœ¬ execution_time = run_single_process(data_size=500, kernel_size=5) print(f\"å•è¿›ç¨‹æ‰§è¡Œæ—¶é—´: {execution_time:.2f} ç§’\") è¿™ä¸ªç¨‹åºç”Ÿæˆä¸€ä¸ªéšæœºæ•°æ®çŸ©é˜µï¼Œç„¶åå¯¹å…¶åº”ç”¨æ¨¡ç³Šæ»¤é•œæ“ä½œã€‚ç”±äºæ“ä½œæ˜¯ CPU å¯†é›†å‹çš„ï¼Œä¸”åœ¨å•ä¸ªè¿›ç¨‹ä¸­è¿è¡Œï¼Œå› æ­¤å—åˆ° GIL çš„é™åˆ¶ï¼Œæ— æ³•å……åˆ†åˆ©ç”¨å¤šæ ¸å¤„ç†å™¨çš„ä¼˜åŠ¿ã€‚\nä½¿ç”¨ ZeroMQ æ‹†åˆ†è¿›ç¨‹\nä¸ºäº†çªç ´ GIL é™åˆ¶ï¼Œæˆ‘ä»¬å¯ä»¥å°†ä»»åŠ¡æ‹†åˆ†æˆå¤šä¸ªç‹¬ç«‹çš„è¿›ç¨‹ï¼Œæ¯ä¸ªè¿›ç¨‹å¤„ç†æ•°æ®çš„ä¸€éƒ¨åˆ†ï¼Œç„¶åä½¿ç”¨ ZeroMQ è¿›è¡Œè¿›ç¨‹é—´é€šä¿¡ã€‚\nInfo\nZeroMQ å…è®¸æˆ‘ä»¬åˆ›å»ºå¤šä¸ªç‹¬ç«‹è¿›ç¨‹ï¼Œæ¯ä¸ªè¿›ç¨‹å¯ä»¥å……åˆ†åˆ©ç”¨ä¸€ä¸ª CPU æ ¸å¿ƒï¼Œä»è€Œç»•è¿‡ GIL é™åˆ¶ï¼Œå®ç°çœŸæ­£çš„å¹¶è¡Œè®¡ç®—ã€‚\næˆ‘ä»¬å°†é‡‡ç”¨ä»¥ä¸‹æ¶æ„ï¼š\nä¸»è¿›ç¨‹ï¼šè´Ÿè´£æ•°æ®åˆ†å‰²ã€ä»»åŠ¡åˆ†å‘å’Œç»“æœæ”¶é›† å·¥ä½œè¿›ç¨‹ï¼šæ¥æ”¶æ•°æ®å—ï¼Œè¿›è¡Œå¤„ç†ï¼Œå¹¶è¿”å›ç»“æœ é€šä¿¡æ¨¡å¼ï¼šä½¿ç”¨ PUSH-PULL æ¨¡å¼è¿›è¡Œä»»åŠ¡åˆ†å‘å’Œç»“æœæ”¶é›† å®ç°åˆ†å¸ƒå¼å¤„ç† ä¸‹é¢æ˜¯ä½¿ç”¨ ZeroMQ å®ç°åˆ†å¸ƒå¼å¤„ç†çš„ä»£ç ï¼š\nZeroMQ åˆ†å¸ƒå¼å¤„ç†å®ç° #!/usr/bin/env python # filename: zmq_distributed_demo.py # ä½¿ç”¨ä¸åŒå¹¶è¡Œå¤„ç†æ–¹æ³•å¯¹æ¯”CPUå¯†é›†å‹ä»»åŠ¡çš„æ€§èƒ½ import numpy as np import time import zmq import pickle import multiprocessing from multiprocessing import Pool, Process, Queue, cpu_count import os import matplotlib.pyplot as plt from matplotlib.figure import Figure from matplotlib.backends.backend_agg import FigureCanvasAgg as FigureCanvas import hashlib # å¯¼å…¥å•è¿›ç¨‹ç‰ˆæœ¬ä¸­çš„å‡½æ•° from cpu_bound_demo import generate_data, process_data, visualize_results def worker(worker_id): \"\"\"å·¥ä½œè¿›ç¨‹ - æ¥æ”¶æ•°æ®å—å¹¶å¤„ç†\"\"\" context = zmq.Context() # è®¾ç½®æ¥æ”¶ä»»åŠ¡çš„PULL socket receiver = context.socket(zmq.PULL) receiver.connect(\"tcp://localhost:5557\") # è®¾ç½®å‘é€ç»“æœçš„PUSH socket sender = context.socket(zmq.PUSH) sender.connect(\"tcp://localhost:5558\") print(f\"å·¥ä½œè¿›ç¨‹ {worker_id} å·²å¯åŠ¨\") # å¤„ç†å¾ªç¯ while True: try: # æ¥æ”¶ä»»åŠ¡ task = receiver.recv_pyobj() # æ£€æŸ¥æ˜¯å¦æ˜¯ç»ˆæ­¢ä¿¡å· if task == \"DONE\": print(f\"å·¥ä½œè¿›ç¨‹ {worker_id} æ”¶åˆ°ç»ˆæ­¢ä¿¡å·\") break # è§£åŒ…ä»»åŠ¡æ•°æ® chunk_id, data_chunk, kernel_size = task # å¤„ç†æ•°æ® result_chunk = process_data(data_chunk, kernel_size) # å‘é€ç»“æœ sender.send_pyobj((chunk_id, result_chunk)) except Exception as e: print(f\"å·¥ä½œè¿›ç¨‹ {worker_id} é”™è¯¯: {e}\") # å…³é—­è¿æ¥ receiver.close() sender.close() context.term() print(f\"å·¥ä½œè¿›ç¨‹ {worker_id} å·²ç»ˆæ­¢\") def split_data(data, num_chunks, kernel_size=5, overlap=True): \"\"\"å°†æ•°æ®åˆ†å‰²æˆå¤šä¸ªå—ï¼Œå¯é€‰æ·»åŠ é‡å åŒºåŸŸä»¥è§£å†³è¾¹ç•Œé—®é¢˜\"\"\" rows, cols = data.shape chunk_size = rows // num_chunks chunks = [] chunk_bounds = [] # è®°å½•æ¯ä¸ªå—çš„æœ‰æ•ˆè¾¹ç•Œï¼ˆä¸åŒ…æ‹¬é‡å åŒºåŸŸï¼‰ # è®¡ç®—é‡å å¤§å°ï¼Œè‡³å°‘éœ€è¦kernel_size//2çš„é‡å  overlap_size = kernel_size // 2 if overlap else 0 for i in range(num_chunks): # è®¡ç®—å—çš„èµ·å§‹å’Œç»“æŸè¡Œï¼ŒåŒ…æ‹¬é‡å åŒºåŸŸ start_row = max(0, i * chunk_size - overlap_size) end_row = min(rows, (i + 1) * chunk_size + overlap_size if i \u003c num_chunks - 1 else rows) # è®¡ç®—æœ‰æ•ˆè¾¹ç•Œï¼ˆä¸åŒ…æ‹¬é‡å åŒºåŸŸï¼‰ valid_start = i * chunk_size valid_end = min(rows, (i + 1) * chunk_size) # å­˜å‚¨å—åŠå…¶æœ‰æ•ˆè¾¹ç•Œ chunks.append(data[start_row:end_row, :].copy()) # ä½¿ç”¨copy()ç¡®ä¿æ•°æ®ç‹¬ç«‹ chunk_bounds.append((valid_start - start_row, valid_end - start_row)) return chunks, chunk_bounds def run_distributed_process(data_size=500, kernel_size=5, num_workers=None, input_data=None): \"\"\"ä½¿ç”¨ZeroMQåˆ†å¸ƒå¼è¿è¡Œæ•°æ®å¤„ç†\"\"\" # å¦‚æœæ²¡æœ‰æŒ‡å®šå·¥ä½œè¿›ç¨‹æ•°ï¼Œä½¿ç”¨CPUæ ¸å¿ƒæ•° if num_workers is None: num_workers = multiprocessing.cpu_count() if input_data is None: print(f\"ç”Ÿæˆ {data_size}x{data_size} çš„æ•°æ®çŸ©é˜µ...\") data = generate_data(data_size) else: print(f\"ä½¿ç”¨æä¾›çš„è¾“å…¥æ•°æ®...\") data = input_data # åˆ†å‰²æ•°æ®ï¼Œå¹¶æ·»åŠ é‡å åŒºåŸŸ print(f\"å°†æ•°æ®åˆ†å‰²æˆ {num_workers} å—ï¼Œå¹¶æ·»åŠ é‡å åŒºåŸŸ...\") data_chunks, chunk_bounds = split_data(data, num_workers, kernel_size) # åˆ›å»ºZeroMQä¸Šä¸‹æ–‡ context = zmq.Context() # è®¾ç½®ä»»åŠ¡åˆ†å‘çš„PUSH socket task_sender = context.socket(zmq.PUSH) task_sender.bind(\"tcp://*:5557\") # è®¾ç½®ç»“æœæ”¶é›†çš„PULL socket result_receiver = context.socket(zmq.PULL) result_receiver.bind(\"tcp://*:5558\") # å¯åŠ¨å·¥ä½œè¿›ç¨‹ processes = [] for i in range(num_workers): p = multiprocessing.Process(target=worker, args=(i,)) p.daemon = True p.start() processes.append(p) # ç»™å·¥ä½œè¿›ç¨‹ä¸€ç‚¹æ—¶é—´å¯åŠ¨ time.sleep(0.5) # å¼€å§‹è®¡æ—¶ print(\"å¼€å§‹åˆ†å¸ƒå¼å¤„ç†æ•°æ®...\") start_time = time.time() # å‘é€ä»»åŠ¡åˆ°å·¥ä½œè¿›ç¨‹ for i, chunk in enumerate(data_chunks): task_sender.send_pyobj((i, chunk, kernel_size)) # æ”¶é›†ç»“æœ results = [None] * len(data_chunks) for _ in range(len(data_chunks)): chunk_id, result_chunk = result_receiver.recv_pyobj() results[chunk_id] = result_chunk # åˆå¹¶ç»“æœï¼Œåªä¿ç•™æ¯ä¸ªå—çš„æœ‰æ•ˆåŒºåŸŸ final_results = [] for i, result_chunk in enumerate(results): valid_start, valid_end = chunk_bounds[i] final_results.append(result_chunk[valid_start:valid_end, :]) # åˆå¹¶æœ‰æ•ˆåŒºåŸŸ result = np.vstack(final_results) # ç»“æŸè®¡æ—¶ end_time = time.time() execution_time = end_time - start_time print(f\"å¤„ç†å®Œæˆï¼Œè€—æ—¶: {execution_time:.2f} ç§’\") # å‘é€ç»ˆæ­¢ä¿¡å·ç»™å·¥ä½œè¿›ç¨‹ for _ in range(num_workers): task_sender.send_pyobj(\"DONE\") # ç­‰å¾…å·¥ä½œè¿›ç¨‹ç»ˆæ­¢ for p in processes: p.join(timeout=1) # å…³é—­ZeroMQè¿æ¥ task_sender.close() result_receiver.close() context.term() # å¯è§†åŒ–ç»“æœ visualize_results(data, result, execution_time, \"ZeroMQ Distributed\") return execution_time, result # æ–°å¢çš„ç›´æ¥ä½¿ç”¨å¤šè¿›ç¨‹çš„å®ç° def mp_worker(data_chunk, kernel_size, result_queue, chunk_id): \"\"\"å¤šè¿›ç¨‹å·¥ä½œå‡½æ•° - å¤„ç†æ•°æ®å—å¹¶å°†ç»“æœæ”¾å…¥é˜Ÿåˆ—\"\"\" try: # å¤„ç†æ•°æ® result_chunk = process_data(data_chunk, kernel_size) # å°†ç»“æœæ”¾å…¥é˜Ÿåˆ— result_queue.put((chunk_id, result_chunk)) except Exception as e: print(f\"å¤šè¿›ç¨‹å·¥ä½œå‡½æ•°é”™è¯¯: {e}\") def run_multiprocessing(data_size=500, kernel_size=5, num_workers=None, input_data=None): \"\"\"ä½¿ç”¨PythonåŸç”Ÿå¤šè¿›ç¨‹è¿è¡Œæ•°æ®å¤„ç†\"\"\" # å¦‚æœæ²¡æœ‰æŒ‡å®šå·¥ä½œè¿›ç¨‹æ•°ï¼Œä½¿ç”¨CPUæ ¸å¿ƒæ•° if num_workers is None: num_workers = cpu_count() if input_data is None: print(f\"ç”Ÿæˆ {data_size}x{data_size} çš„æ•°æ®çŸ©é˜µ...\") data = generate_data(data_size) else: print(f\"ä½¿ç”¨æä¾›çš„è¾“å…¥æ•°æ®...\") data = input_data # åˆ†å‰²æ•°æ®ï¼Œå¹¶æ·»åŠ é‡å åŒºåŸŸ print(f\"å°†æ•°æ®åˆ†å‰²æˆ {num_workers} å—ï¼Œå¹¶æ·»åŠ é‡å åŒºåŸŸ...\") data_chunks, chunk_bounds = split_data(data, num_workers, kernel_size) # åˆ›å»ºç»“æœé˜Ÿåˆ— result_queue = Queue() # åˆ›å»ºè¿›ç¨‹ processes = [] # å¼€å§‹è®¡æ—¶ print(\"å¼€å§‹å¤šè¿›ç¨‹å¤„ç†æ•°æ®...\") start_time = time.time() # å¯åŠ¨å·¥ä½œè¿›ç¨‹ for i, chunk in enumerate(data_chunks): p = Process(target=mp_worker, args=(chunk, kernel_size, result_queue, i)) processes.append(p) p.start() # æ”¶é›†ç»“æœ results = [None] * len(data_chunks) for _ in range(len(data_chunks)): chunk_id, result_chunk = result_queue.get() results[chunk_id] = result_chunk # ç­‰å¾…æ‰€æœ‰è¿›ç¨‹å®Œæˆ for p in processes: p.join() # åˆå¹¶ç»“æœï¼Œåªä¿ç•™æ¯ä¸ªå—çš„æœ‰æ•ˆåŒºåŸŸ final_results = [] for i, result_chunk in enumerate(results): valid_start, valid_end = chunk_bounds[i] final_results.append(result_chunk[valid_start:valid_end, :]) # åˆå¹¶æœ‰æ•ˆåŒºåŸŸ result = np.vstack(final_results) # ç»“æŸè®¡æ—¶ end_time = time.time() execution_time = end_time - start_time print(f\"å¤„ç†å®Œæˆï¼Œè€—æ—¶: {execution_time:.2f} ç§’\") # å¯è§†åŒ–ç»“æœ visualize_results(data, result, execution_time, \"Multiprocessing\") return execution_time, result # ç”¨äºéªŒè¯ç»“æœä¸€è‡´æ€§çš„å‡½æ•° def calculate_result_hash(result): \"\"\"è®¡ç®—ç»“æœæ•°ç»„çš„å“ˆå¸Œå€¼ä»¥éªŒè¯ä¸€è‡´æ€§\"\"\" # å°†numpyæ•°ç»„è½¬æ¢ä¸ºå­—èŠ‚åºåˆ— # å…ˆå››èˆäº”å…¥åˆ°å›ºå®šå°æ•°ä½æ•°ï¼Œé¿å…æµ®ç‚¹æ•°è¯¯å·®å¼•èµ·çš„ä¸ä¸€è‡´ rounded_result = np.round(result, 6) result_bytes = rounded_result.tobytes() # è®¡ç®—SHA-256å“ˆå¸Œ return hashlib.sha256(result_bytes).hexdigest() def compare_performance(): \"\"\"æ¯”è¾ƒä¸‰ç§å®ç°çš„æ€§èƒ½å¹¶éªŒè¯ç»“æœä¸€è‡´æ€§\"\"\" print(\"\\n===== æ€§èƒ½å¯¹æ¯” =====\") data_size = 2000 kernel_size = 5 # è®¾ç½®éšæœºç§å­ä»¥ç¡®ä¿å¯é‡ç°æ€§ np.random.seed(42) # è¿è¡Œå•è¿›ç¨‹ç‰ˆæœ¬ print(\"\\nè¿è¡Œå•è¿›ç¨‹ç‰ˆæœ¬...\") single_data = generate_data(data_size) # ä¿è¯æ‰€æœ‰å®ç°ä½¿ç”¨ç›¸åŒçš„è¾“å…¥æ•°æ® # ä¸ºäº†ç¡®ä¿ç»“æœä¸€è‡´æ€§ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨ä¸åˆ†å¸ƒå¼å®ç°ç›¸åŒçš„å¤„ç†æ–¹å¼ # å°†æ•°æ®åˆ†å‰²ï¼Œå¤„ç†ï¼Œç„¶åå†åˆå¹¶ num_workers = cpu_count() data_chunks, chunk_bounds = split_data(single_data, num_workers, kernel_size) single_start = time.time() # å¤„ç†æ¯ä¸ªå— result_chunks = [] for chunk in data_chunks: result_chunk = process_data(chunk, kernel_size) result_chunks.append(result_chunk) # åˆå¹¶ç»“æœï¼Œåªä¿ç•™æ¯ä¸ªå—çš„æœ‰æ•ˆåŒºåŸŸ final_results = [] for i, result_chunk in enumerate(result_chunks): valid_start, valid_end = chunk_bounds[i] final_results.append(result_chunk[valid_start:valid_end, :]) # åˆå¹¶æœ‰æ•ˆåŒºåŸŸ single_result = np.vstack(final_results) single_time = time.time() - single_start print(f\"å¤„ç†å®Œæˆï¼Œè€—æ—¶: {single_time:.2f} ç§’\") visualize_results(single_data, single_result, single_time, \"Single Process\") # è¿è¡Œåˆ†å¸ƒå¼ç‰ˆæœ¬ print(\"\\nè¿è¡ŒZeroMQåˆ†å¸ƒå¼ç‰ˆæœ¬...\") zmq_time, zmq_result = run_distributed_process(data_size=data_size, kernel_size=kernel_size, input_data=single_data) # è¿è¡ŒåŸç”Ÿå¤šè¿›ç¨‹ç‰ˆæœ¬ print(\"\\nè¿è¡ŒåŸç”Ÿå¤šè¿›ç¨‹ç‰ˆæœ¬...\") mp_time, mp_result = run_multiprocessing(data_size=data_size, kernel_size=kernel_size, input_data=single_data) # éªŒè¯ç»“æœä¸€è‡´æ€§ single_hash = calculate_result_hash(single_result) zmq_hash = calculate_result_hash(zmq_result) mp_hash = calculate_result_hash(mp_result) print(f\"\\nå“ˆå¸Œå€¼æ£€æŸ¥:\") print(f\" å•è¿›ç¨‹ç»“æœå“ˆå¸Œ: {single_hash[:10]}...\") print(f\" ZeroMQç»“æœå“ˆå¸Œ: {zmq_hash[:10]}...\") print(f\" å¤šè¿›ç¨‹ç»“æœå“ˆå¸Œ: {mp_hash[:10]}...\") # æ£€æŸ¥ç»“æœæ˜¯å¦ç›¸åŒ if single_hash == zmq_hash and single_hash == mp_hash: print(\" ç»“æœä¸€è‡´æ€§æ£€æŸ¥: é€šè¿‡ \\u2705\") else: print(\" ç»“æœä¸€è‡´æ€§æ£€æŸ¥: å¤±è´¥ \\u274c\") if single_hash != zmq_hash: print(\" - å•è¿›ç¨‹ä¸ZeroMQç»“æœä¸ä¸€è‡´\") if single_hash != mp_hash: print(\" - å•è¿›ç¨‹ä¸å¤šè¿›ç¨‹ç»“æœä¸ä¸€è‡´\") if zmq_hash != mp_hash: print(\" - ZeroMQä¸å¤šè¿›ç¨‹ç»“æœä¸ä¸€è‡´\") # æ£€æŸ¥ç»“æœæ˜¯å¦ç›¸åŒ zmq_match = (single_hash == zmq_hash) mp_match = (single_hash == mp_hash) results_match = zmq_match and mp_match # è®¡ç®—åŠ é€Ÿæ¯” zmq_speedup = single_time / zmq_time mp_speedup = single_time / mp_time print(\"\\n===== ç»“æœå¯¹æ¯” =====\") print(f\"å•è¿›ç¨‹æ‰§è¡Œæ—¶é—´: {single_time:.2f} ç§’\") print(f\"ZeroMQåˆ†å¸ƒå¼æ‰§è¡Œæ—¶é—´: {zmq_time:.2f} ç§’ (åŠ é€Ÿæ¯”: {zmq_speedup:.2f}x)\") print(f\"åŸç”Ÿå¤šè¿›ç¨‹æ‰§è¡Œæ—¶é—´: {mp_time:.2f} ç§’ (åŠ é€Ÿæ¯”: {mp_speedup:.2f}x)\") print(f\"ç»“æœä¸€è‡´æ€§æ£€æŸ¥: {'é€šè¿‡' if results_match else 'å¤±è´¥'}\") # ç»˜åˆ¶æ€§èƒ½å¯¹æ¯”å›¾ fig = Figure(figsize=(10, 6)) canvas = FigureCanvas(fig) ax = fig.add_subplot(111) methods = ['Single Process', 'ZeroMQ Distributed', 'Python Multiprocessing'] times = [single_time, zmq_time, mp_time] colors = ['blue', 'green', 'orange'] ax.bar(methods, times, color=colors) ax.set_ylabel('Execution Time (seconds)') ax.set_title('Performance Comparison') # æ·»åŠ æ•°å€¼æ ‡ç­¾ for i, v in enumerate(times): ax.text(i, v + 0.1, f\"{v:.2f}s\", ha='center') # æ·»åŠ åŠ é€Ÿæ¯” ax.text(1, times[1] * 0.5, f\"Speedup: {zmq_speedup:.2f}x\", ha='center', fontsize=10, bbox=dict(facecolor='white', alpha=0.8)) ax.text(2, times[2] * 0.5, f\"Speedup: {mp_speedup:.2f}x\", ha='center', fontsize=10, bbox=dict(facecolor='white', alpha=0.8)) fig.tight_layout() fig.savefig(\"performance_comparison_all.png\") print(\"æ€§èƒ½å¯¹æ¯”å›¾å·²ä¿å­˜ä¸º performance_comparison_all.png\") if __name__ == \"__main__\": # æ¯”è¾ƒæ€§èƒ½ compare_performance() æ€§èƒ½å¯¹æ¯”åˆ†æ ä¸ºäº†éªŒè¯ ZeroMQ åˆ†å¸ƒå¼å¤„ç†çš„æ•ˆæœï¼Œæˆ‘ä»¬å°†å…¶ä¸å•è¿›ç¨‹ç‰ˆæœ¬å’Œ Python åŸç”Ÿå¤šè¿›ç¨‹ç‰ˆæœ¬è¿›è¡Œå¯¹æ¯”ã€‚\næˆ‘ä»¬ä½¿ç”¨ç›¸åŒçš„è¾“å…¥æ•°æ®ï¼Œåˆ†åˆ«ç”¨ä¸‰ç§æ–¹æ³•å¤„ç†ï¼Œå¹¶è®°å½•æ‰§è¡Œæ—¶é—´ï¼š\nå•è¿›ç¨‹ç‰ˆæœ¬ï¼šæ‰€æœ‰è®¡ç®—åœ¨ä¸€ä¸ªè¿›ç¨‹ä¸­å®Œæˆ ZeroMQ åˆ†å¸ƒå¼ç‰ˆæœ¬ï¼šä½¿ç”¨ ZeroMQ è¿›è¡Œè¿›ç¨‹é—´é€šä¿¡ Python åŸç”Ÿå¤šè¿›ç¨‹ç‰ˆæœ¬ï¼šä½¿ç”¨ Python çš„ multiprocessing æ¨¡å— æ€§èƒ½æµ‹è¯•ç»“æœ\n===== ç»“æœå¯¹æ¯” ===== å•è¿›ç¨‹æ‰§è¡Œæ—¶é—´: 9.75 ç§’ ZeroMQåˆ†å¸ƒå¼æ‰§è¡Œæ—¶é—´: 1.28 ç§’ (åŠ é€Ÿæ¯”: 7.62x) åŸç”Ÿå¤šè¿›ç¨‹æ‰§è¡Œæ—¶é—´: 1.27 ç§’ (åŠ é€Ÿæ¯”: 7.66x) ç»“æœä¸€è‡´æ€§æ£€æŸ¥: é€šè¿‡ vLLM æ¶æ„æ¨¡æ‹Ÿï¼šCPU-GPU å¹¶è¡Œä¼˜åŒ– é™¤äº†è§£å†³ CPU å¯†é›†å‹ä»»åŠ¡çš„ GIL é™åˆ¶ï¼ŒZeroMQ è¿˜å¯ä»¥ç”¨äºä¼˜åŒ– CPU å’Œ GPU ä¹‹é—´çš„åä½œã€‚è¿™é‡Œæˆ‘ä»¬æ¨¡æ‹Ÿäº†ç±»ä¼¼ vLLMï¼ˆä¸€ç§é«˜æ•ˆçš„å¤§è¯­è¨€æ¨¡å‹æ¨ç†æ¡†æ¶ï¼‰çš„æ¶æ„ï¼Œé€šè¿‡ ZeroMQ å®ç° CPU å’Œ GPU ä»»åŠ¡çš„å¹¶è¡Œå¤„ç†ã€‚\nä¼ ç»Ÿé¡ºåºå¤„ç†çš„é—®é¢˜\nåœ¨ä¼ ç»Ÿçš„æ·±åº¦å­¦ä¹ æ¨ç†ä¸­ï¼Œå¤„ç†æµç¨‹é€šå¸¸æ˜¯é¡ºåºçš„ï¼š\nCPU è¿›è¡Œé¢„å¤„ç† ç­‰å¾… GPU å®Œæˆè®¡ç®— CPU è¿›è¡Œåå¤„ç† è¿™ç§æ–¹å¼å¯¼è‡´ GPU åœ¨ CPU å¤„ç†æœŸé—´å¤„äºç©ºé—²çŠ¶æ€ï¼Œæ— æ³•å……åˆ†åˆ©ç”¨è®¡ç®—èµ„æºã€‚\nä½¿ç”¨ ZeroMQ å®ç° CPU-GPU å¹¶è¡Œ é€šè¿‡ ZeroMQï¼Œæˆ‘ä»¬å¯ä»¥å®ç° CPU å’Œ GPU çš„å¹¶è¡Œå·¥ä½œï¼š\næ¨¡æ‹Ÿvllmæ‹†åˆ†cpuå’Œgpuå·¥ä½œè´Ÿè½½ #!/usr/bin/env python # æ¨¡æ‹ŸvLLMæ¶æ„çš„ç®€åŒ–ç‰ˆæœ¬ï¼Œä½¿ç”¨ZeroMQåˆ†ç¦»GPUå’ŒCPUå·¥ä½œè´Ÿè½½ import numpy as np import time import zmq import multiprocessing import threading import queue import json import argparse from tqdm import tqdm import matplotlib.pyplot as plt from matplotlib.figure import Figure from matplotlib.backends.backend_agg import FigureCanvasAgg as FigureCanvas # æ¨¡æ‹ŸGPUè®¡ç®—çš„å‡½æ•° def simulate_gpu_computation(input_data, computation_time=0.1): \"\"\"æ¨¡æ‹ŸGPUä¸Šçš„çŸ©é˜µä¹˜æ³•è®¡ç®—\"\"\" # å®é™…ä¸Šæ˜¯åœ¨CPUä¸Šè¿è¡Œï¼Œä½†æˆ‘ä»¬ç”¨sleepæ¥æ¨¡æ‹ŸGPUè®¡ç®—æ—¶é—´ time.sleep(computation_time) # æ¨¡æ‹ŸçŸ©é˜µä¹˜æ³• result = np.dot(input_data, input_data.T) return result # æ¨¡æ‹ŸCPUå¤„ç†çš„å‡½æ•° def simulate_cpu_preprocessing(request_id, size=100, processing_time=0.05): \"\"\"æ¨¡æ‹ŸCPUä¸Šçš„é¢„å¤„ç†æ“ä½œ\"\"\" # æ¨¡æ‹Ÿé¢„å¤„ç†è€—æ—¶ time.sleep(processing_time) # ç”Ÿæˆéšæœºè¾“å…¥æ•°æ® input_data = np.random.random((size, size)) return input_data def simulate_cpu_postprocessing(request_id, result, processing_time=0.05): \"\"\"æ¨¡æ‹ŸCPUä¸Šçš„åå¤„ç†æ“ä½œ\"\"\" # æ¨¡æ‹Ÿåå¤„ç†è€—æ—¶ time.sleep(processing_time) # ç®€å•å¤„ç†ç»“æœ processed_result = np.mean(result) return processed_result # ä¼ ç»Ÿæ–¹å¼ï¼šå•è¿›ç¨‹ä¸­é¡ºåºæ‰§è¡ŒCPUå’ŒGPUæ“ä½œ def traditional_approach(num_requests=10, matrix_size=100, preprocess_time=0.05, gpu_time=0.1, postprocess_time=0.05): \"\"\"ä¼ ç»Ÿæ–¹å¼ï¼šåœ¨å•ä¸€è¿›ç¨‹ä¸­é¡ºåºæ‰§è¡ŒCPUå’ŒGPUæ“ä½œ\"\"\" print(\"\\nè¿è¡Œä¼ ç»Ÿæ–¹å¼ï¼ˆå•è¿›ç¨‹é¡ºåºæ‰§è¡Œï¼‰...\") start_time = time.time() gpu_active_time = 0 for i in tqdm(range(num_requests), desc=\"å¤„ç†è¯·æ±‚\"): request_id = f\"req_{i}\" # CPUé¢„å¤„ç† preprocess_start = time.time() input_data = simulate_cpu_preprocessing(request_id, matrix_size, preprocess_time) preprocess_end = time.time() # GPUè®¡ç®— gpu_start = time.time() result = simulate_gpu_computation(input_data, gpu_time) gpu_end = time.time() gpu_active_time += (gpu_end - gpu_start) # CPUåå¤„ç† postprocess_start = time.time() final_result = simulate_cpu_postprocessing(request_id, result, postprocess_time) postprocess_end = time.time() end_time = time.time() total_time = end_time - start_time gpu_utilization = gpu_active_time / total_time * 100 print(f\"ä¼ ç»Ÿæ–¹å¼å®Œæˆæ—¶é—´: {total_time:.2f} ç§’\") print(f\"GPUæ´»è·ƒæ—¶é—´: {gpu_active_time:.2f} ç§’\") print(f\"GPUåˆ©ç”¨ç‡: {gpu_utilization:.2f}%\") return total_time, gpu_utilization # GPUè¿›ç¨‹ï¼šæ¥æ”¶è¾“å…¥æ•°æ®ï¼Œæ‰§è¡ŒGPUè®¡ç®—ï¼Œè¿”å›ç»“æœ def gpu_worker(port_recv=5555, port_send=5556): \"\"\"GPUå·¥ä½œè¿›ç¨‹ï¼Œæ¥æ”¶è¾“å…¥æ•°æ®ï¼Œæ‰§è¡ŒGPUè®¡ç®—ï¼Œå‘é€ç»“æœ\"\"\" context = zmq.Context() # è®¾ç½®æ¥æ”¶è¾“å…¥æ•°æ®çš„PULL socket receiver = context.socket(zmq.PULL) receiver.bind(f\"tcp://*:{port_recv}\") # è®¾ç½®å‘é€ç»“æœçš„PUSH socket sender = context.socket(zmq.PUSH) sender.bind(f\"tcp://*:{port_send}\") print(\"GPUå·¥ä½œè¿›ç¨‹å·²å¯åŠ¨\") gpu_active_time = 0 processed_count = 0 start_time = time.time() # è®°å½•æ¯æ¬¡GPUæ´»åŠ¨çš„å¼€å§‹å’Œç»“æŸæ—¶é—´ gpu_activity_periods = [] try: while True: # æ¥æ”¶ä»»åŠ¡ message = receiver.recv_pyobj() # æ£€æŸ¥æ˜¯å¦æ˜¯ç»ˆæ­¢ä¿¡å· if message == \"DONE\": print(\"GPUå·¥ä½œè¿›ç¨‹æ”¶åˆ°ç»ˆæ­¢ä¿¡å·\") # å‘é€GPUåˆ©ç”¨ç‡ä¿¡æ¯ total_time = time.time() - start_time gpu_utilization = gpu_active_time / total_time * 100 if total_time \u003e 0 else 0 sender.send_pyobj({ \"type\": \"STATS\", \"gpu_active_time\": gpu_active_time, \"total_time\": total_time, \"gpu_utilization\": gpu_utilization, \"processed_count\": processed_count, \"gpu_activity_periods\": gpu_activity_periods }) break # è§£åŒ…ä»»åŠ¡æ•°æ® request_id, input_data, gpu_time = message # æ‰§è¡ŒGPUè®¡ç®— gpu_start = time.time() result = simulate_gpu_computation(input_data, gpu_time) gpu_end = time.time() # è®°å½•GPUæ´»åŠ¨æ—¶é—´æ®µ gpu_activity_periods.append((gpu_start, gpu_end)) # æ›´æ–°GPUæ´»è·ƒæ—¶é—´ gpu_active_time += (gpu_end - gpu_start) processed_count += 1 # å‘é€ç»“æœ sender.send_pyobj((request_id, result)) except Exception as e: print(f\"GPUå·¥ä½œè¿›ç¨‹é”™è¯¯: {e}\") finally: # å…³é—­è¿æ¥ receiver.close() sender.close() context.term() print(\"GPUå·¥ä½œè¿›ç¨‹å·²ç»ˆæ­¢\") # CPUè¿›ç¨‹ï¼šç”Ÿæˆè¯·æ±‚ï¼Œé¢„å¤„ç†ï¼Œå‘é€åˆ°GPUï¼Œæ¥æ”¶ç»“æœï¼Œåå¤„ç† def zmq_approach(num_requests=10, matrix_size=100, preprocess_time=0.05, gpu_time=0.1, postprocess_time=0.05): \"\"\"ä½¿ç”¨ZeroMQåˆ†ç¦»CPUå’ŒGPUæ“ä½œ\"\"\" print(\"\\nè¿è¡ŒZeroMQæ–¹å¼ï¼ˆåˆ†ç¦»CPUå’ŒGPUæ“ä½œï¼‰...\") # å¯åŠ¨GPUå·¥ä½œè¿›ç¨‹ gpu_process = multiprocessing.Process(target=gpu_worker) gpu_process.daemon = True gpu_process.start() # ç»™GPUè¿›ç¨‹ä¸€ç‚¹æ—¶é—´å¯åŠ¨ time.sleep(0.5) # åˆ›å»ºZeroMQä¸Šä¸‹æ–‡ context = zmq.Context() # è®¾ç½®å‘é€è¾“å…¥æ•°æ®çš„PUSH socket sender = context.socket(zmq.PUSH) sender.connect(\"tcp://localhost:5555\") # è®¾ç½®æ¥æ”¶ç»“æœçš„PULL socket receiver = context.socket(zmq.PULL) receiver.connect(\"tcp://localhost:5556\") # å¼€å§‹è®¡æ—¶ start_time = time.time() # åˆ›å»ºç»“æœå­—å…¸ results = {} # è®°å½•CPUæ´»åŠ¨æ—¶é—´æ®µ cpu_activity_periods = [] # å¯åŠ¨é¢„å¤„ç†å’Œå‘é€çº¿ç¨‹ def preprocess_and_send(): for i in range(num_requests): request_id = f\"req_{i}\" # CPUé¢„å¤„ç†å¼€å§‹ cpu_start = time.time() # CPUé¢„å¤„ç† input_data = simulate_cpu_preprocessing(request_id, matrix_size, preprocess_time) # CPUé¢„å¤„ç†ç»“æŸ cpu_end = time.time() # è®°å½•CPUé¢„å¤„ç†æ—¶é—´æ®µ cpu_activity_periods.append((\"preprocess\", cpu_start, cpu_end)) # å‘é€åˆ°GPUè¿›ç¨‹ sender.send_pyobj((request_id, input_data, gpu_time)) # ç®€å•çš„è¿›åº¦æ˜¾ç¤º if (i + 1) % 10 == 0 or i == num_requests - 1: print(f\"å·²å‘é€ {i + 1}/{num_requests} ä¸ªè¯·æ±‚\") send_thread = threading.Thread(target=preprocess_and_send) send_thread.daemon = True send_thread.start() # æ¥æ”¶ç»“æœå’Œåå¤„ç† for _ in tqdm(range(num_requests), desc=\"æ¥æ”¶å’Œå¤„ç†ç»“æœ\"): # æ¥æ”¶ç»“æœ message = receiver.recv_pyobj() # å¤„ç†ç»“æœ if isinstance(message, dict) and message.get(\"type\") == \"STATS\": # è¿™æ˜¯GPUè¿›ç¨‹å‘é€çš„ç»Ÿè®¡ä¿¡æ¯ gpu_stats = message continue request_id, result = message # CPUåå¤„ç†å¼€å§‹ cpu_start = time.time() # CPUåå¤„ç† final_result = simulate_cpu_postprocessing(request_id, result, postprocess_time) # CPUåå¤„ç†ç»“æŸ cpu_end = time.time() # è®°å½•CPUåå¤„ç†æ—¶é—´æ®µ cpu_activity_periods.append((\"postprocess\", cpu_start, cpu_end)) # å­˜å‚¨ç»“æœ results[request_id] = final_result # å‘é€ç»ˆæ­¢ä¿¡å·ç»™GPUè¿›ç¨‹ sender.send_pyobj(\"DONE\") # æ¥æ”¶GPUç»Ÿè®¡ä¿¡æ¯ gpu_stats = receiver.recv_pyobj() # ç­‰å¾…GPUè¿›ç¨‹ç»ˆæ­¢ gpu_process.join(timeout=1) # ç»“æŸè®¡æ—¶ end_time = time.time() total_time = end_time - start_time # è®¡ç®—CPU-GPUé‡å æ—¶é—´ gpu_periods = gpu_stats['gpu_activity_periods'] overlap_time = calculate_overlap(cpu_activity_periods, gpu_periods) overlap_percentage = (overlap_time / total_time) * 100 # å…³é—­ZeroMQè¿æ¥ sender.close() receiver.close() context.term() print(f\"ZeroMQæ–¹å¼å®Œæˆæ—¶é—´: {total_time:.2f} ç§’\") print(f\"GPUæ´»è·ƒæ—¶é—´: {gpu_stats['gpu_active_time']:.2f} ç§’\") print(f\"CPUæ´»è·ƒæ—¶é—´: {sum([end-start for _, start, end in cpu_activity_periods]):.2f} ç§’\") print(f\"CPU-GPUé‡å æ—¶é—´: {overlap_time:.2f} ç§’ ({overlap_percentage:.2f}%)\") print(f\"GPUåˆ©ç”¨ç‡: {gpu_stats['gpu_utilization']:.2f}%\") return total_time, gpu_stats['gpu_utilization'], overlap_percentage def calculate_overlap(cpu_periods, gpu_periods): \"\"\"è®¡ç®—CPUå’ŒGPUæ´»åŠ¨æ—¶é—´çš„é‡å éƒ¨åˆ†\"\"\" # å°†CPUé¢„å¤„ç†å’Œåå¤„ç†æ—¶é—´æ®µåˆå¹¶ä¸ºå•ä¸€åˆ—è¡¨ cpu_time_ranges = [(start, end) for _, start, end in cpu_periods] # åˆå§‹åŒ–é‡å æ—¶é—´ total_overlap = 0.0 # å¯¹æ¯ä¸ªGPUæ—¶é—´æ®µï¼Œè®¡ç®—ä¸æ‰€æœ‰CPUæ—¶é—´æ®µçš„é‡å  for gpu_start, gpu_end in gpu_periods: for cpu_start, cpu_end in cpu_time_ranges: # è®¡ç®—é‡å éƒ¨åˆ† overlap_start = max(gpu_start, cpu_start) overlap_end = min(gpu_end, cpu_end) # å¦‚æœæœ‰é‡å ï¼Œç´¯åŠ é‡å æ—¶é—´ if overlap_end \u003e overlap_start: total_overlap += (overlap_end - overlap_start) return total_overlap def compare_performance(num_requests=50): \"\"\"æ¯”è¾ƒä¼ ç»Ÿæ–¹å¼å’ŒZeroMQæ–¹å¼çš„æ€§èƒ½\"\"\" # è®¾ç½®å‚æ•° matrix_size = 100 preprocess_time = 0.05 # CPUé¢„å¤„ç†æ—¶é—´ gpu_time = 0.1 # GPUè®¡ç®—æ—¶é—´ postprocess_time = 0.05 # CPUåå¤„ç†æ—¶é—´ # è¿è¡Œä¼ ç»Ÿæ–¹å¼ trad_time, trad_gpu_util = traditional_approach( num_requests, matrix_size, preprocess_time, gpu_time, postprocess_time ) # è¿è¡ŒZeroMQæ–¹å¼ zmq_time, zmq_gpu_util, overlap_percentage = zmq_approach( num_requests, matrix_size, preprocess_time, gpu_time, postprocess_time ) # è®¡ç®—åŠ é€Ÿæ¯” speedup = trad_time / zmq_time print(\"\\n===== æ€§èƒ½å¯¹æ¯” =====\") print(f\"ä¼ ç»Ÿæ–¹å¼æ‰§è¡Œæ—¶é—´: {trad_time:.2f} ç§’, GPUåˆ©ç”¨ç‡: {trad_gpu_util:.2f}%\") print(f\"ZeroMQæ–¹å¼æ‰§è¡Œæ—¶é—´: {zmq_time:.2f} ç§’, GPUåˆ©ç”¨ç‡: {zmq_gpu_util:.2f}%\") print(f\"CPU-GPUé‡å æ¯”ä¾‹: {overlap_percentage:.2f}%\") print(f\"åŠ é€Ÿæ¯”: {speedup:.2f}x\") print(f\"GPUåˆ©ç”¨ç‡æå‡: {zmq_gpu_util - trad_gpu_util:.2f}%\") # ç»˜åˆ¶æ€§èƒ½å¯¹æ¯”å›¾ fig = Figure(figsize=(15, 5)) canvas = FigureCanvas(fig) # æ‰§è¡Œæ—¶é—´å¯¹æ¯” ax1 = fig.add_subplot(131) methods = ['Traditional', 'ZeroMQ'] times = [trad_time, zmq_time] ax1.bar(methods, times, color=['blue', 'green']) ax1.set_ylabel('Execution Time (seconds)') ax1.set_title('Execution Time Comparison') # æ·»åŠ æ•°å€¼æ ‡ç­¾ for i, v in enumerate(times): ax1.text(i, v + 0.1, f\"{v:.2f}s\", ha='center') # æ·»åŠ åŠ é€Ÿæ¯” ax1.text(0.5, max(times) * 0.5, f\"Speedup: {speedup:.2f}x\", ha='center', fontsize=12, bbox=dict(facecolor='white', alpha=0.8)) # GPUåˆ©ç”¨ç‡å¯¹æ¯” ax2 = fig.add_subplot(132) utils = [trad_gpu_util, zmq_gpu_util] ax2.bar(methods, utils, color=['blue', 'green']) ax2.set_ylabel('GPU Utilization (%)') ax2.set_title('GPU Utilization Comparison') ax2.set_ylim(0, 100) # æ·»åŠ æ•°å€¼æ ‡ç­¾ for i, v in enumerate(utils): ax2.text(i, v + 1, f\"{v:.2f}%\", ha='center') # æ·»åŠ åˆ©ç”¨ç‡æå‡ ax2.text(0.5, 50, f\"Improvement: {zmq_gpu_util - trad_gpu_util:.2f}%\", ha='center', fontsize=12, bbox=dict(facecolor='white', alpha=0.8)) # CPU-GPUé‡å æ¯”ä¾‹ ax3 = fig.add_subplot(133) ax3.pie([overlap_percentage, 100-overlap_percentage], labels=['Overlap', 'Non-overlap'], colors=['green', 'lightgray'], autopct='%1.1f%%', startangle=90) ax3.set_title('CPU-GPU Overlap Percentage') ax3.axis('equal') # Equal aspect ratio ensures that pie is drawn as a circle fig.tight_layout() fig.savefig(\"vllm_simulation_comparison.png\") print(\"æ€§èƒ½å¯¹æ¯”å›¾å·²ä¿å­˜ä¸º vllm_simulation_comparison.png\") if __name__ == \"__main__\": parser = argparse.ArgumentParser(description='æ¨¡æ‹ŸvLLMæ¶æ„çš„ç®€åŒ–ç‰ˆæœ¬') parser.add_argument('--requests', type=int, default=50, help='è¯·æ±‚æ•°é‡') args = parser.parse_args() # æ¯”è¾ƒæ€§èƒ½ compare_performance(args.requests) æ€§èƒ½å¯¹æ¯” æˆ‘ä»¬æ¯”è¾ƒäº†ä¼ ç»Ÿé¡ºåºå¤„ç†å’Œ ZeroMQ å¹¶è¡Œå¤„ç†çš„æ€§èƒ½å·®å¼‚ï¼š\nè¿è¡Œä¼ ç»Ÿæ–¹å¼ï¼ˆå•è¿›ç¨‹é¡ºåºæ‰§è¡Œï¼‰... å¤„ç†è¯·æ±‚: 100%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| 50/50 [00:10\u003c00:00, 4.94it/s] ä¼ ç»Ÿæ–¹å¼å®Œæˆæ—¶é—´: 10.13 ç§’ GPUæ´»è·ƒæ—¶é—´: 5.04 ç§’ GPUåˆ©ç”¨ç‡: 49.73% è¿è¡ŒZeroMQæ–¹å¼ï¼ˆåˆ†ç¦»CPUå’ŒGPUæ“ä½œï¼‰... GPUå·¥ä½œè¿›ç¨‹å·²å¯åŠ¨ æ¥æ”¶å’Œå¤„ç†ç»“æœ: 8%|â–ˆâ–ˆâ–ˆâ–ˆâ– | 4/50 [00:00\u003c00:05, 8.69it/s]å·²å‘é€ 10/50 ä¸ªè¯·æ±‚ æ¥æ”¶å’Œå¤„ç†ç»“æœ: 18%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ | 9/50 [00:01\u003c00:04, 9.73it/s]å·²å‘é€ 20/50 ä¸ªè¯·æ±‚ æ¥æ”¶å’Œå¤„ç†ç»“æœ: 28%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ– | 14/50 [00:01\u003c00:03, 9.85it/s]å·²å‘é€ 30/50 ä¸ªè¯·æ±‚ æ¥æ”¶å’Œå¤„ç†ç»“æœ: 38%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‰ | 19/50 [00:02\u003c00:03, 9.89it/s]å·²å‘é€ 40/50 ä¸ªè¯·æ±‚ æ¥æ”¶å’Œå¤„ç†ç»“æœ: 46%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ– | 23/50 [00:02\u003c00:02, 9.86it/s]å·²å‘é€ 50/50 ä¸ªè¯·æ±‚ æ¥æ”¶å’Œå¤„ç†ç»“æœ: 100%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| 50/50 [00:05\u003c00:00, 9.69it/s] GPUå·¥ä½œè¿›ç¨‹æ”¶åˆ°ç»ˆæ­¢ä¿¡å· GPUå·¥ä½œè¿›ç¨‹å·²ç»ˆæ­¢ ZeroMQæ–¹å¼å®Œæˆæ—¶é—´: 5.16 ç§’ GPUæ´»è·ƒæ—¶é—´: 5.04 ç§’ CPUæ´»è·ƒæ—¶é—´: 5.07 ç§’ CPU-GPUé‡å æ—¶é—´: 4.96 ç§’ (96.09%) GPUåˆ©ç”¨ç‡: 89.08% ===== æ€§èƒ½å¯¹æ¯” ===== ä¼ ç»Ÿæ–¹å¼æ‰§è¡Œæ—¶é—´: 10.13 ç§’, GPUåˆ©ç”¨ç‡: 49.73% ZeroMQæ–¹å¼æ‰§è¡Œæ—¶é—´: 5.16 ç§’, GPUåˆ©ç”¨ç‡: 89.08% CPU-GPUé‡å æ¯”ä¾‹: 96.09% åŠ é€Ÿæ¯”: 1.96x GPUåˆ©ç”¨ç‡æå‡: 39.35% é€šè¿‡ ZeroMQ å®ç°çš„ CPU-GPU å¹¶è¡Œå¤„ç†ï¼Œæˆ‘ä»¬è·å¾—äº†ä»¥ä¸‹ä¼˜åŠ¿ï¼š\næ›´é«˜çš„ GPU åˆ©ç”¨ç‡ æ›´çŸ­çš„æ€»æ‰§è¡Œæ—¶é—´ CPU å’Œ GPU æ›´å¥½çš„å·¥ä½œé‡å  æ€»ç»“ä¸æœ€ä½³å®è·µ é€šè¿‡æœ¬æ•™ç¨‹ï¼Œæˆ‘ä»¬å±•ç¤ºäº†å¦‚ä½•ä½¿ç”¨ ZeroMQ çªç ´ Python GIL é™åˆ¶ï¼Œæ˜¾è‘—æå‡ CPU å¯†é›†å‹ä»»åŠ¡çš„æ€§èƒ½ï¼Œä»¥åŠå¦‚ä½•ä¼˜åŒ– CPU-GPU åä½œã€‚ä»¥ä¸‹æ˜¯ä¸€äº›æœ€ä½³å®è·µï¼š\nä½•æ—¶ä½¿ç”¨ ZeroMQ è¿›è¡Œå¹¶è¡Œå¤„ç† CPU å¯†é›†å‹ä»»åŠ¡ï¼šè®¡ç®—å¯†é›†çš„æ“ä½œï¼Œå¦‚å›¾åƒå¤„ç†ã€æ•°å€¼è®¡ç®—ç­‰ å¯æ‹†åˆ†çš„ä»»åŠ¡ï¼šèƒ½å¤Ÿè¢«åˆ†å‰²æˆç‹¬ç«‹å­ä»»åŠ¡çš„é—®é¢˜ éœ€è¦çµæ´»é€šä¿¡æ¨¡å¼çš„åœºæ™¯ï¼šè¶…å‡ºç®€å•å¤šè¿›ç¨‹æ¨¡å‹çš„å¤æ‚é€šä¿¡éœ€æ±‚ CPU-GPU åä½œä¼˜åŒ–ï¼šåœ¨æ·±åº¦å­¦ä¹ æ¨ç†ç­‰åœºæ™¯ä¸­ä¼˜åŒ–èµ„æºåˆ©ç”¨ ZeroMQ vs Python åŸç”Ÿå¤šè¿›ç¨‹ ZeroMQ ä¼˜åŠ¿ï¼šæ›´çµæ´»çš„é€šä¿¡æ¨¡å¼ï¼Œæ›´å¥½çš„æ‰©å±•æ€§ï¼ˆå¯è·¨ç½‘ç»œï¼‰ï¼Œæ›´ç²¾ç»†çš„æ§åˆ¶ åŸç”Ÿå¤šè¿›ç¨‹ä¼˜åŠ¿ï¼šä½¿ç”¨æ›´ç®€å•ï¼Œé€‚åˆä¸éœ€è¦å¤æ‚é€šä¿¡çš„åœºæ™¯ æ³¨æ„äº‹é¡¹ è¿›ç¨‹é—´é€šä¿¡å¼€é”€ï¼šåˆ†å¸ƒå¼å¤„ç†è™½ç„¶èƒ½çªç ´ GIL é™åˆ¶ï¼Œä½†ä¹Ÿå¼•å…¥äº†é€šä¿¡å¼€é”€ æ•°æ®åºåˆ—åŒ–ï¼šåœ¨è¿›ç¨‹é—´ä¼ é€’æ•°æ®éœ€è¦åºåˆ—åŒ–å’Œååºåˆ—åŒ–ï¼Œå¯¹äºå¤§å‹æ•°æ®å¯èƒ½æˆä¸ºç“¶é¢ˆ ä»»åŠ¡ç²’åº¦ï¼šå¤ªå°çš„ä»»åŠ¡ä¼šä½¿é€šä¿¡å¼€é”€è¶…è¿‡å¹¶è¡Œå¤„ç†çš„æ”¶ç›Šï¼Œå¤ªå¤§çš„ä»»åŠ¡ä¼šå½±å“è´Ÿè½½å‡è¡¡ èµ„æºç®¡ç†ï¼šåœ¨ CPU-GPU å¹¶è¡Œåœºæ™¯ä¸­ï¼Œéœ€è¦åˆç†ç®¡ç†å†…å­˜å’Œè®¡ç®—èµ„æº é€šè¿‡åˆç†ä½¿ç”¨ ZeroMQ è¿›è¡Œåˆ†å¸ƒå¼å¤„ç†ï¼Œæˆ‘ä»¬å¯ä»¥å……åˆ†å‘æŒ¥å¤šæ ¸å¤„ç†å™¨å’Œ GPU çš„æ€§èƒ½ï¼Œæ˜¾è‘—æå‡ Python ç¨‹åºçš„æ‰§è¡Œæ•ˆç‡ï¼Œç‰¹åˆ«æ˜¯å¯¹äºè®¡ç®—å¯†é›†å‹ä»»åŠ¡å’Œæ·±åº¦å­¦ä¹ æ¨ç†åœºæ™¯ã€‚\n",
  "wordCount" : "8799",
  "inLanguage": "zh",
  "datePublished": "2025-05-06T00:00:00Z",
  "dateModified": "2025-05-06T00:00:00Z",
  "author":{
    "@type": "Person",
    "name": "Niuhe"
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://blog.niuhemoon.win/posts/tech/python-zeromq-gil/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Niuhe's Blog",
    "logo": {
      "@type": "ImageObject",
      "url": "https://blog.niuhemoon.win/base/favicon.ico"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://blog.niuhemoon.win" accesskey="h" title="Niuhe&#39;s Blog (Alt + H)">
                <img src="https://blog.niuhemoon.win/base/avatar.jpeg" alt="" aria-label="logo"
                    height="35">Niuhe&#39;s Blog</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="https://blog.niuhemoon.win/search" title="ğŸ”æœç´¢ (Alt &#43; /)" accesskey=/>
                    <span>ğŸ”æœç´¢</span>
                </a>
            </li>
            <li>
                <a href="https://blog.niuhemoon.win/" title="ğŸ ä¸»é¡µ">
                    <span>ğŸ ä¸»é¡µ</span>
                </a>
            </li>
            <li>
                <a href="https://blog.niuhemoon.win/posts" title="ğŸ“šæ–‡ç« ">
                    <span>ğŸ“šæ–‡ç« </span>
                </a>
            </li>
            <li>
                <a href="https://blog.niuhemoon.win/tags" title="ğŸ”–æ ‡ç­¾">
                    <span>ğŸ”–æ ‡ç­¾</span>
                </a>
            </li>
            <li>
                <a href="https://blog.niuhemoon.win/archives/" title="â±æ—¶é—´è½´">
                    <span>â±æ—¶é—´è½´</span>
                </a>
            </li>
            <li>
                <a href="https://blog.niuhemoon.win/about" title="ğŸ™‹ğŸ»â€â™‚ï¸å…³äº">
                    <span>ğŸ™‹ğŸ»â€â™‚ï¸å…³äº</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="https://blog.niuhemoon.win">ğŸ ä¸»é¡µ</a>&nbsp;Â»&nbsp;<a href="https://blog.niuhemoon.win/posts/">ğŸ“šæ–‡ç« </a>&nbsp;Â»&nbsp;<a href="https://blog.niuhemoon.win/posts/tech/">ğŸ‘¨ğŸ»â€ğŸ’» æŠ€æœ¯</a></div>
    <h1 class="post-title">
      Python æ€§èƒ½ä¼˜åŒ–ï¼šä½¿ç”¨ ZeroMQ çªç ´ GIL é™åˆ¶
    </h1>
    <div class="post-description">
      é€šè¿‡ ZeroMQ åˆ†å¸ƒå¼æ¶ˆæ¯é˜Ÿåˆ—åº“çªç ´ Python GIL é™åˆ¶ï¼Œä¼˜åŒ– CPU å¯†é›†å‹ä»»åŠ¡æ€§èƒ½
    </div>
    <div class="post-meta"><span title='2025-05-06 00:00:00 +0000 UTC'>2025-05-06</span>&nbsp;Â·&nbsp;18 min&nbsp;Â·&nbsp;8799 å­—&nbsp;Â·&nbsp;Niuhe

</div>
  </header> <div class="toc">
    <details  open>
        <summary accesskey="c" title="(Alt + C)">
            <span class="details">æ–‡ç« ç›®å½•</span>
        </summary>

        <div class="inner"><ul>
                <li>
                    <a href="#%e7%8e%af%e5%a2%83%e9%85%8d%e7%bd%ae%e4%b8%8e%e5%ae%89%e8%a3%85" aria-label="ç¯å¢ƒé…ç½®ä¸å®‰è£…">ç¯å¢ƒé…ç½®ä¸å®‰è£…</a></li>
                <li>
                    <a href="#zeromq-%e6%a0%b8%e5%bf%83%e6%a6%82%e5%bf%b5" aria-label="ZeroMQ æ ¸å¿ƒæ¦‚å¿µ">ZeroMQ æ ¸å¿ƒæ¦‚å¿µ</a><ul>
                        
                <li>
                    <a href="#zeromq-%e7%9a%84%e4%b8%bb%e8%a6%81%e7%89%b9%e7%82%b9" aria-label="ZeroMQ çš„ä¸»è¦ç‰¹ç‚¹">ZeroMQ çš„ä¸»è¦ç‰¹ç‚¹</a></li>
                <li>
                    <a href="#zeromq-%e7%9a%84%e5%b8%b8%e7%94%a8%e9%80%9a%e4%bf%a1%e6%a8%a1%e5%bc%8f" aria-label="ZeroMQ çš„å¸¸ç”¨é€šä¿¡æ¨¡å¼">ZeroMQ çš„å¸¸ç”¨é€šä¿¡æ¨¡å¼</a></li>
                <li>
                    <a href="#%e5%9f%ba%e6%9c%ac%e7%9a%84-zeromq-%e7%a4%ba%e4%be%8b" aria-label="åŸºæœ¬çš„ ZeroMQ ç¤ºä¾‹">åŸºæœ¬çš„ ZeroMQ ç¤ºä¾‹</a></li></ul>
                </li>
                <li>
                    <a href="#gil-%e9%99%90%e5%88%b6%e4%b8%8b%e7%9a%84%e6%80%a7%e8%83%bd%e9%97%ae%e9%a2%98" aria-label="GIL é™åˆ¶ä¸‹çš„æ€§èƒ½é—®é¢˜">GIL é™åˆ¶ä¸‹çš„æ€§èƒ½é—®é¢˜</a><ul>
                        
                <li>
                    <a href="#%e6%bc%94%e7%a4%ba-gil-%e9%99%90%e5%88%b6%e7%9a%84%e7%a4%ba%e4%be%8b%e7%a8%8b%e5%ba%8f" aria-label="æ¼”ç¤º GIL é™åˆ¶çš„ç¤ºä¾‹ç¨‹åº">æ¼”ç¤º GIL é™åˆ¶çš„ç¤ºä¾‹ç¨‹åº</a></li>
                <li>
                    <a href="#%e5%ae%9e%e7%8e%b0%e5%88%86%e5%b8%83%e5%bc%8f%e5%a4%84%e7%90%86" aria-label="å®ç°åˆ†å¸ƒå¼å¤„ç†">å®ç°åˆ†å¸ƒå¼å¤„ç†</a></li>
                <li>
                    <a href="#%e6%80%a7%e8%83%bd%e5%af%b9%e6%af%94%e5%88%86%e6%9e%90" aria-label="æ€§èƒ½å¯¹æ¯”åˆ†æ">æ€§èƒ½å¯¹æ¯”åˆ†æ</a></li></ul>
                </li>
                <li>
                    <a href="#vllm-%e6%9e%b6%e6%9e%84%e6%a8%a1%e6%8b%9fcpu-gpu-%e5%b9%b6%e8%a1%8c%e4%bc%98%e5%8c%96" aria-label="vLLM æ¶æ„æ¨¡æ‹Ÿï¼šCPU-GPU å¹¶è¡Œä¼˜åŒ–">vLLM æ¶æ„æ¨¡æ‹Ÿï¼šCPU-GPU å¹¶è¡Œä¼˜åŒ–</a><ul>
                        
                <li>
                    <a href="#%e4%bd%bf%e7%94%a8-zeromq-%e5%ae%9e%e7%8e%b0-cpu-gpu-%e5%b9%b6%e8%a1%8c" aria-label="ä½¿ç”¨ ZeroMQ å®ç° CPU-GPU å¹¶è¡Œ">ä½¿ç”¨ ZeroMQ å®ç° CPU-GPU å¹¶è¡Œ</a></li>
                <li>
                    <a href="#%e6%80%a7%e8%83%bd%e5%af%b9%e6%af%94" aria-label="æ€§èƒ½å¯¹æ¯”">æ€§èƒ½å¯¹æ¯”</a></li></ul>
                </li>
                <li>
                    <a href="#%e6%80%bb%e7%bb%93%e4%b8%8e%e6%9c%80%e4%bd%b3%e5%ae%9e%e8%b7%b5" aria-label="æ€»ç»“ä¸æœ€ä½³å®è·µ">æ€»ç»“ä¸æœ€ä½³å®è·µ</a><ul>
                        
                <li>
                    <a href="#%e4%bd%95%e6%97%b6%e4%bd%bf%e7%94%a8-zeromq-%e8%bf%9b%e8%a1%8c%e5%b9%b6%e8%a1%8c%e5%a4%84%e7%90%86" aria-label="ä½•æ—¶ä½¿ç”¨ ZeroMQ è¿›è¡Œå¹¶è¡Œå¤„ç†">ä½•æ—¶ä½¿ç”¨ ZeroMQ è¿›è¡Œå¹¶è¡Œå¤„ç†</a></li>
                <li>
                    <a href="#zeromq-vs-python-%e5%8e%9f%e7%94%9f%e5%a4%9a%e8%bf%9b%e7%a8%8b" aria-label="ZeroMQ vs Python åŸç”Ÿå¤šè¿›ç¨‹">ZeroMQ vs Python åŸç”Ÿå¤šè¿›ç¨‹</a></li>
                <li>
                    <a href="#%e6%b3%a8%e6%84%8f%e4%ba%8b%e9%a1%b9" aria-label="æ³¨æ„äº‹é¡¹">æ³¨æ„äº‹é¡¹</a>
                </li>
            </ul>
            </li>
            </ul>
        </div>
    </details>
</div>

  <div class="post-content"><p>åœ¨ Python ç¼–ç¨‹ä¸­ï¼Œå…¨å±€è§£é‡Šå™¨é”ï¼ˆGlobal Interpreter Lockï¼Œç®€ç§° GILï¼‰ä¸€ç›´æ˜¯åˆ¶çº¦ CPU å¯†é›†å‹ä»»åŠ¡æ€§èƒ½çš„ä¸»è¦ç“¶é¢ˆã€‚æœ¬æ–‡å°†ä»‹ç»å¦‚ä½•ä½¿ç”¨ ZeroMQ è¿™ä¸€é«˜æ€§èƒ½åˆ†å¸ƒå¼æ¶ˆæ¯é˜Ÿåˆ—åº“æ¥çªç ´ GIL é™åˆ¶ï¼Œé€šè¿‡å°†å•ä¸€è¿›ç¨‹æ‹†åˆ†ä¸ºå¤šä¸ªé€šè¿‡æ¶ˆæ¯é€šä¿¡çš„è¿›ç¨‹ï¼Œä»è€Œå……åˆ†åˆ©ç”¨å¤šæ ¸ CPU èµ„æºï¼Œæ˜¾è‘—æå‡æ€§èƒ½ã€‚</p>
<h3 id="ç¯å¢ƒé…ç½®ä¸å®‰è£…">ç¯å¢ƒé…ç½®ä¸å®‰è£…<a hidden class="anchor" aria-hidden="true" href="#ç¯å¢ƒé…ç½®ä¸å®‰è£…">#</a></h3>
<p>é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦åˆ›å»ºä¸€ä¸ªè™šæ‹Ÿç¯å¢ƒå¹¶å®‰è£…å¿…è¦çš„ä¾èµ–åŒ…ã€‚è¿™é‡Œæˆ‘ä»¬ä½¿ç”¨ <code>uv</code> å‘½ä»¤æ¥åˆ›å»ºå’Œç®¡ç†è™šæ‹Ÿç¯å¢ƒ</p>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>uv venv .venv
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">source</span> .venv/bin/activate &amp;&amp; uv pip install pyzmq numpy matplotlib tqdm
</span></span></code></pre></div><h3 id="zeromq-æ ¸å¿ƒæ¦‚å¿µ">ZeroMQ æ ¸å¿ƒæ¦‚å¿µ<a hidden class="anchor" aria-hidden="true" href="#zeromq-æ ¸å¿ƒæ¦‚å¿µ">#</a></h3>
<p>ZeroMQ (ä¹Ÿå†™ä½œ Ã˜MQ, 0MQ æˆ– zmq) æ˜¯ä¸€ä¸ªé«˜æ€§èƒ½çš„å¼‚æ­¥æ¶ˆæ¯ä¼ é€’åº“ï¼Œæ—¨åœ¨ç”¨äºåˆ†å¸ƒå¼æˆ–å¹¶å‘åº”ç”¨ç¨‹åºã€‚å®ƒæä¾›äº†ä¸€ä¸ªæ¶ˆæ¯é˜Ÿåˆ—ï¼Œä½†ä¸ä¼ ç»Ÿçš„æ¶ˆæ¯é˜Ÿåˆ—ä¸åŒï¼Œå®ƒå¯ä»¥åœ¨æ²¡æœ‰ä¸“é—¨çš„æ¶ˆæ¯ä»£ç†ï¼ˆbrokerï¼‰çš„æƒ…å†µä¸‹è¿è¡Œã€‚</p>
<style type="text/css">.notice{--root-color:#444;--root-background:#eff;--title-color:#fff;--title-background:#7bd;--warning-title:#c33;--warning-content:#fee;--info-title:#fb7;--info-content:#fec;--note-title:#6be;--note-content:#e7f2fa;--tip-title:#5a5;--tip-content:#efe}@media (prefers-color-scheme:dark){.notice{--root-color:#ddd;--root-background:#eff;--title-color:#fff;--title-background:#7bd;--warning-title:#800;--warning-content:#400;--info-title:#a50;--info-content:#420;--note-title:#069;--note-content:#023;--tip-title:#363;--tip-content:#121}}body.dark .notice{--root-color:#ddd;--root-background:#eff;--title-color:#fff;--title-background:#7bd;--warning-title:#800;--warning-content:#400;--info-title:#a50;--info-content:#420;--note-title:#069;--note-content:#023;--tip-title:#363;--tip-content:#121}.notice{padding:18px;line-height:24px;margin-bottom:24px;border-radius:4px;color:var(--root-color);background:var(--root-background)}.notice p:last-child{margin-bottom:0}.notice-title{margin:-18px -18px 12px;padding:4px 18px;border-radius:4px 4px 0 0;font-weight:700;color:var(--title-color);background:var(--title-background)}.notice.warning .notice-title{background:var(--warning-title)}.notice.warning{background:var(--warning-content)}.notice.info .notice-title{background:var(--info-title)}.notice.info{background:var(--info-content)}.notice.note .notice-title{background:var(--note-title)}.notice.note{background:var(--note-content)}.notice.tip .notice-title{background:var(--tip-title)}.notice.tip{background:var(--tip-content)}.icon-notice{display:inline-flex;align-self:center;margin-right:8px}.icon-notice img,.icon-notice svg{height:1em;width:1em;fill:currentColor}.icon-notice img,.icon-notice.baseline svg{top:.125em;position:relative}</style>
<div><svg width="0" height="0" display="none" xmlns="http://www.w3.org/2000/svg"><symbol id="tip-notice" viewBox="0 0 512 512" preserveAspectRatio="xMidYMid meet"><path d="M504 256c0 136.967-111.033 248-248 248S8 392.967 8 256 119.033 8 256 8s248 111.033 248 248zM227.314 387.314l184-184c6.248-6.248 6.248-16.379 0-22.627l-22.627-22.627c-6.248-6.249-16.379-6.249-22.628 0L216 308.118l-70.059-70.059c-6.248-6.248-16.379-6.248-22.628 0l-22.627 22.627c-6.248 6.248-6.248 16.379 0 22.627l104 104c6.249 6.249 16.379 6.249 22.628.001z"/></symbol><symbol id="note-notice" viewBox="0 0 512 512" preserveAspectRatio="xMidYMid meet"><path d="M504 256c0 136.997-111.043 248-248 248S8 392.997 8 256C8 119.083 119.043 8 256 8s248 111.083 248 248zm-248 50c-25.405 0-46 20.595-46 46s20.595 46 46 46 46-20.595 46-46-20.595-46-46-46zm-43.673-165.346l7.418 136c.347 6.364 5.609 11.346 11.982 11.346h48.546c6.373 0 11.635-4.982 11.982-11.346l7.418-136c.375-6.874-5.098-12.654-11.982-12.654h-63.383c-6.884 0-12.356 5.78-11.981 12.654z"/></symbol><symbol id="warning-notice" viewBox="0 0 576 512" preserveAspectRatio="xMidYMid meet"><path d="M569.517 440.013C587.975 472.007 564.806 512 527.94 512H48.054c-36.937 0-59.999-40.055-41.577-71.987L246.423 23.985c18.467-32.009 64.72-31.951 83.154 0l239.94 416.028zM288 354c-25.405 0-46 20.595-46 46s20.595 46 46 46 46-20.595 46-46-20.595-46-46-46zm-43.673-165.346l7.418 136c.347 6.364 5.609 11.346 11.982 11.346h48.546c6.373 0 11.635-4.982 11.982-11.346l7.418-136c.375-6.874-5.098-12.654-11.982-12.654h-63.383c-6.884 0-12.356 5.78-11.981 12.654z"/></symbol><symbol id="info-notice" viewBox="0 0 512 512" preserveAspectRatio="xMidYMid meet"><path d="M256 8C119.043 8 8 119.083 8 256c0 136.997 111.043 248 248 248s248-111.003 248-248C504 119.083 392.957 8 256 8zm0 110c23.196 0 42 18.804 42 42s-18.804 42-42 42-42-18.804-42-42 18.804-42 42-42zm56 254c0 6.627-5.373 12-12 12h-88c-6.627 0-12-5.373-12-12v-24c0-6.627 5.373-12 12-12h12v-64h-12c-6.627 0-12-5.373-12-12v-24c0-6.627 5.373-12 12-12h64c6.627 0 12 5.373 12 12v100h12c6.627 0 12 5.373 12 12v24z"/></symbol></svg></div><div class="notice info" >
<p class="first notice-title"><span class="icon-notice baseline"><svg><use href="#info-notice"></use></svg></span>Info</p><p>ZeroMQ æä¾›äº†ä¸€ç§è½»é‡çº§çš„æ¶ˆæ¯ä¼ é€’æœºåˆ¶ï¼Œéå¸¸é€‚åˆç”¨äºæ„å»ºåˆ†å¸ƒå¼ç³»ç»Ÿå’Œå¹¶è¡Œè®¡ç®—åº”ç”¨ã€‚</p></div>
<h4 id="zeromq-çš„ä¸»è¦ç‰¹ç‚¹">ZeroMQ çš„ä¸»è¦ç‰¹ç‚¹<a hidden class="anchor" aria-hidden="true" href="#zeromq-çš„ä¸»è¦ç‰¹ç‚¹">#</a></h4>
<ul>
<li><strong>æ— ä»£ç†è®¾è®¡</strong>ï¼šä¸éœ€è¦ä¸­å¤®æ¶ˆæ¯æœåŠ¡å™¨</li>
<li><strong>å¼‚æ­¥ I/O æ¨¡å‹</strong>ï¼šéé˜»å¡æ“ä½œï¼Œæé«˜å¹¶å‘æ€§èƒ½</li>
<li><strong>å¤šç§é€šä¿¡æ¨¡å¼</strong>ï¼šæ”¯æŒè¯·æ±‚-å›å¤ã€å‘å¸ƒ-è®¢é˜…ã€æ¨é€-æ‹‰å–ç­‰æ¨¡å¼</li>
<li><strong>å¤šç§ä¼ è¾“åè®®</strong>ï¼šæ”¯æŒ TCPã€IPCã€è¿›ç¨‹å†…é€šä¿¡ç­‰</li>
<li><strong>è·¨è¯­è¨€æ”¯æŒ</strong>ï¼šæä¾›å¤šç§ç¼–ç¨‹è¯­è¨€çš„ç»‘å®š</li>
</ul>
<h4 id="zeromq-çš„å¸¸ç”¨é€šä¿¡æ¨¡å¼">ZeroMQ çš„å¸¸ç”¨é€šä¿¡æ¨¡å¼<a hidden class="anchor" aria-hidden="true" href="#zeromq-çš„å¸¸ç”¨é€šä¿¡æ¨¡å¼">#</a></h4>
<ol>
<li><strong>è¯·æ±‚-å›å¤ (REQ-REP)</strong>ï¼šå®¢æˆ·ç«¯å‘é€è¯·æ±‚ï¼ŒæœåŠ¡å™¨å›å¤</li>
<li><strong>å‘å¸ƒ-è®¢é˜… (PUB-SUB)</strong>ï¼šå‘å¸ƒè€…å‘é€æ¶ˆæ¯ï¼Œè®¢é˜…è€…æ¥æ”¶</li>
<li><strong>æ¨é€-æ‹‰å– (PUSH-PULL)</strong>ï¼šä»»åŠ¡åˆ†å‘å’Œç»“æœæ”¶é›†ï¼Œé€‚åˆå¹¶è¡Œå¤„ç†</li>
<li><strong>è·¯ç”±-ç»é”€å•† (ROUTER-DEALER)</strong>ï¼šé«˜çº§å¼‚æ­¥é€šä¿¡æ¨¡å¼</li>
</ol>
<h4 id="åŸºæœ¬çš„-zeromq-ç¤ºä¾‹">åŸºæœ¬çš„ ZeroMQ ç¤ºä¾‹<a hidden class="anchor" aria-hidden="true" href="#åŸºæœ¬çš„-zeromq-ç¤ºä¾‹">#</a></h4>
<p>ä»¥ä¸‹æ˜¯ä¸€ä¸ªç®€å•çš„è¯·æ±‚-å›å¤æ¨¡å¼ç¤ºä¾‹ï¼Œå±•ç¤ºäº† ZeroMQ çš„åŸºæœ¬ç”¨æ³•ï¼š</p>


<p><details >
  <summary markdown="span">åŸºæœ¬çš„ ZeroMQ REQ-REP æ¨¡å¼ç¤ºä¾‹</summary>
  <div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#007f7f">#!/usr/bin/env python</span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># åŸºæœ¬çš„ ZeroMQ REQ-REP æ¨¡å¼ç¤ºä¾‹</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> zmq
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> time
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> sys
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> threading
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">def</span> server():
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f"># åˆ›å»ºä¸Šä¸‹æ–‡å’Œ socket</span>
</span></span><span style="display:flex;"><span>    context = zmq.Context()
</span></span><span style="display:flex;"><span>    socket = context.socket(zmq.REP)
</span></span><span style="display:flex;"><span>    socket.bind(<span style="color:#0ff;font-weight:bold">&#34;tcp://*:5555&#34;</span>)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">print</span>(<span style="color:#0ff;font-weight:bold">&#34;æœåŠ¡å™¨å·²å¯åŠ¨ï¼Œç­‰å¾…è¯·æ±‚...&#34;</span>)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f"># æœåŠ¡å¾ªç¯</span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">while</span> <span style="color:#fff;font-weight:bold">True</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f"># ç­‰å¾…å®¢æˆ·ç«¯è¯·æ±‚</span>
</span></span><span style="display:flex;"><span>        message = socket.recv()
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">print</span>(<span style="color:#0ff;font-weight:bold">f</span><span style="color:#0ff;font-weight:bold">&#34;æ”¶åˆ°è¯·æ±‚: </span><span style="color:#0ff;font-weight:bold">{</span>message.decode()<span style="color:#0ff;font-weight:bold">}</span><span style="color:#0ff;font-weight:bold">&#34;</span>)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f"># æ¨¡æ‹Ÿå·¥ä½œ</span>
</span></span><span style="display:flex;"><span>        time.sleep(<span style="color:#ff0;font-weight:bold">1</span>)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f"># å‘é€å›å¤</span>
</span></span><span style="display:flex;"><span>        socket.send(<span style="color:#0ff;font-weight:bold">b</span><span style="color:#0ff;font-weight:bold">&#34;Request processed&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">def</span> client():
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f"># åˆ›å»ºä¸Šä¸‹æ–‡å’Œ socket</span>
</span></span><span style="display:flex;"><span>    context = zmq.Context()
</span></span><span style="display:flex;"><span>    socket = context.socket(zmq.REQ)
</span></span><span style="display:flex;"><span>    socket.connect(<span style="color:#0ff;font-weight:bold">&#34;tcp://localhost:5555&#34;</span>)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f"># å‘é€è¯·æ±‚</span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">for</span> i in <span style="color:#fff;font-weight:bold">range</span>(<span style="color:#ff0;font-weight:bold">5</span>):
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">print</span>(<span style="color:#0ff;font-weight:bold">f</span><span style="color:#0ff;font-weight:bold">&#34;å‘é€è¯·æ±‚ </span><span style="color:#0ff;font-weight:bold">{</span>i<span style="color:#0ff;font-weight:bold">}</span><span style="color:#0ff;font-weight:bold">...&#34;</span>)
</span></span><span style="display:flex;"><span>        socket.send(<span style="color:#0ff;font-weight:bold">f</span><span style="color:#0ff;font-weight:bold">&#34;è¯·æ±‚ #</span><span style="color:#0ff;font-weight:bold">{</span>i<span style="color:#0ff;font-weight:bold">}</span><span style="color:#0ff;font-weight:bold">&#34;</span>.encode())
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f"># è·å–å›å¤</span>
</span></span><span style="display:flex;"><span>        message = socket.recv()
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">print</span>(<span style="color:#0ff;font-weight:bold">f</span><span style="color:#0ff;font-weight:bold">&#34;æ”¶åˆ°å›å¤: </span><span style="color:#0ff;font-weight:bold">{</span>message.decode()<span style="color:#0ff;font-weight:bold">}</span><span style="color:#0ff;font-weight:bold">&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">if</span> __name__ == <span style="color:#0ff;font-weight:bold">&#34;__main__&#34;</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">if</span> <span style="color:#fff;font-weight:bold">len</span>(sys.argv) &lt; <span style="color:#ff0;font-weight:bold">2</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">print</span>(<span style="color:#0ff;font-weight:bold">&#34;ç”¨æ³•: python zmq_basic.py [server|client]&#34;</span>)
</span></span><span style="display:flex;"><span>        sys.exit(<span style="color:#ff0;font-weight:bold">1</span>)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">if</span> sys.argv[<span style="color:#ff0;font-weight:bold">1</span>] == <span style="color:#0ff;font-weight:bold">&#34;server&#34;</span>:
</span></span><span style="display:flex;"><span>        server()
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">elif</span> sys.argv[<span style="color:#ff0;font-weight:bold">1</span>] == <span style="color:#0ff;font-weight:bold">&#34;client&#34;</span>:
</span></span><span style="display:flex;"><span>        client()
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">elif</span> sys.argv[<span style="color:#ff0;font-weight:bold">1</span>] == <span style="color:#0ff;font-weight:bold">&#34;both&#34;</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f"># åœ¨å•ç‹¬çš„çº¿ç¨‹ä¸­å¯åŠ¨æœåŠ¡å™¨</span>
</span></span><span style="display:flex;"><span>        server_thread = threading.Thread(target=server)
</span></span><span style="display:flex;"><span>        server_thread.daemon = <span style="color:#fff;font-weight:bold">True</span>
</span></span><span style="display:flex;"><span>        server_thread.start()
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f"># ç»™æœåŠ¡å™¨ä¸€ç‚¹æ—¶é—´å¯åŠ¨</span>
</span></span><span style="display:flex;"><span>        time.sleep(<span style="color:#ff0;font-weight:bold">1</span>)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f"># è¿è¡Œå®¢æˆ·ç«¯</span>
</span></span><span style="display:flex;"><span>        client()
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">else</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">print</span>(<span style="color:#0ff;font-weight:bold">&#34;ç”¨æ³•: python zmq_basic.py [server|client|both]&#34;</span>)
</span></span></code></pre></div>
</details></p>

<p>è¿™ä¸ªç®€å•ç¤ºä¾‹å±•ç¤ºäº† ZeroMQ çš„åŸºæœ¬é€šä¿¡æ¨¡å¼ã€‚æœåŠ¡å™¨åˆ›å»ºä¸€ä¸ª REP å¥—æ¥å­—å¹¶ç»‘å®šåˆ°ç‰¹å®šç«¯å£ï¼Œå®¢æˆ·ç«¯åˆ›å»ºä¸€ä¸ª REQ å¥—æ¥å­—å¹¶è¿æ¥åˆ°æœåŠ¡å™¨ã€‚å®¢æˆ·ç«¯å‘é€è¯·æ±‚ï¼ŒæœåŠ¡å™¨å¤„ç†åå›å¤ã€‚</p>
<h3 id="gil-é™åˆ¶ä¸‹çš„æ€§èƒ½é—®é¢˜">GIL é™åˆ¶ä¸‹çš„æ€§èƒ½é—®é¢˜<a hidden class="anchor" aria-hidden="true" href="#gil-é™åˆ¶ä¸‹çš„æ€§èƒ½é—®é¢˜">#</a></h3>
<p>åœ¨æ·±å…¥ ZeroMQ è§£å†³æ–¹æ¡ˆä¹‹å‰ï¼Œè®©æˆ‘ä»¬å…ˆäº†è§£ Python ä¸­çš„ GIL é—®é¢˜ä»¥åŠå®ƒå¦‚ä½•å½±å“ CPU å¯†é›†å‹ä»»åŠ¡çš„æ€§èƒ½ã€‚</p>
<blockquote>
<p>GILï¼ˆå…¨å±€è§£é‡Šå™¨é”ï¼‰æ˜¯ CPython è§£é‡Šå™¨ä¸­çš„ä¸€ä¸ªäº’æ–¥é”ï¼Œå®ƒç¡®ä¿åŒä¸€æ—¶åˆ»åªæœ‰ä¸€ä¸ªçº¿ç¨‹å¯ä»¥æ‰§è¡Œ Python å­—èŠ‚ç ã€‚è¿™æ„å‘³ç€å³ä½¿åœ¨å¤šæ ¸å¤„ç†å™¨ä¸Šï¼Œæ ‡å‡†çš„ Python çº¿ç¨‹ä¹Ÿæ— æ³•å®ç°çœŸæ­£çš„å¹¶è¡Œè®¡ç®—ã€‚</p>
</blockquote>
<div class="notice warning" >
<p class="first notice-title"><span class="icon-notice baseline"><svg><use href="#warning-notice"></use></svg></span>Warning</p><p>ç”±äº GIL çš„å­˜åœ¨ï¼ŒPython å¤šçº¿ç¨‹åœ¨ CPU å¯†é›†å‹ä»»åŠ¡ä¸Šé€šå¸¸æ— æ³•æä¾›æ€§èƒ½æå‡ï¼Œæœ‰æ—¶ç”²è‡³ä¼šå› ä¸ºçº¿ç¨‹åˆ‡æ¢å¼€é”€è€Œå¯¼è‡´æ€§èƒ½ä¸‹é™ã€‚</p></div>
<h4 id="æ¼”ç¤º-gil-é™åˆ¶çš„ç¤ºä¾‹ç¨‹åº">æ¼”ç¤º GIL é™åˆ¶çš„ç¤ºä¾‹ç¨‹åº<a hidden class="anchor" aria-hidden="true" href="#æ¼”ç¤º-gil-é™åˆ¶çš„ç¤ºä¾‹ç¨‹åº">#</a></h4>
<p>ä¸‹é¢æ˜¯ä¸€ä¸ª CPU å¯†é›†å‹ä»»åŠ¡çš„ç¤ºä¾‹ï¼Œå®ƒæ¨¡æ‹Ÿäº†å›¾åƒå¤„ç†ä¸­çš„æ¨¡ç³Šæ»¤é•œæ“ä½œï¼š</p>


<p><details >
  <summary markdown="span">CPUå¯†é›†å‹ä»»åŠ¡ç¤ºä¾‹ - å—GILé™åˆ¶çš„æ¨¡ç³Šæ»¤é•œæ“ä½œ</summary>
  <div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#007f7f">#!/usr/bin/env python</span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># filename: cpu_bound_demo.py</span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># CPUå¯†é›†å‹ä»»åŠ¡ç¤ºä¾‹ - å—GILé™åˆ¶çš„æ€§èƒ½é—®é¢˜</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> numpy <span style="color:#fff;font-weight:bold">as</span> np
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> time
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> matplotlib.pyplot <span style="color:#fff;font-weight:bold">as</span> plt
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">from</span> matplotlib.figure <span style="color:#fff;font-weight:bold">import</span> Figure
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">from</span> matplotlib.backends.backend_agg <span style="color:#fff;font-weight:bold">import</span> FigureCanvasAgg <span style="color:#fff;font-weight:bold">as</span> FigureCanvas
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">def</span> generate_data(size=<span style="color:#ff0;font-weight:bold">1000</span>):
</span></span><span style="display:flex;"><span>    <span style="color:#0ff;font-weight:bold">&#34;&#34;&#34;ç”Ÿæˆéšæœºæ•°æ®çŸ©é˜µ&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">return</span> np.random.random((size, size))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">def</span> process_data(data, kernel_size=<span style="color:#ff0;font-weight:bold">5</span>):
</span></span><span style="display:flex;"><span>    <span style="color:#0ff;font-weight:bold">&#34;&#34;&#34;å¯¹æ•°æ®åº”ç”¨ç®€å•çš„æ¨¡ç³Šæ»¤é•œ (CPUå¯†é›†å‹æ“ä½œ)&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    result = np.zeros_like(data)
</span></span><span style="display:flex;"><span>    rows, cols = data.shape
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f"># ç®€å•çš„æ»‘åŠ¨çª—å£å¹³å‡ (æ¨¡æ‹Ÿæ¨¡ç³Šæ“ä½œ)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">for</span> i in <span style="color:#fff;font-weight:bold">range</span>(kernel_size//<span style="color:#ff0;font-weight:bold">2</span>, rows - kernel_size//<span style="color:#ff0;font-weight:bold">2</span>):
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">for</span> j in <span style="color:#fff;font-weight:bold">range</span>(kernel_size//<span style="color:#ff0;font-weight:bold">2</span>, cols - kernel_size//<span style="color:#ff0;font-weight:bold">2</span>):
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f"># æå–çª—å£</span>
</span></span><span style="display:flex;"><span>            window = data[i-kernel_size//<span style="color:#ff0;font-weight:bold">2</span>:i+kernel_size//<span style="color:#ff0;font-weight:bold">2</span>+<span style="color:#ff0;font-weight:bold">1</span>, 
</span></span><span style="display:flex;"><span>                          j-kernel_size//<span style="color:#ff0;font-weight:bold">2</span>:j+kernel_size//<span style="color:#ff0;font-weight:bold">2</span>+<span style="color:#ff0;font-weight:bold">1</span>]
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f"># è®¡ç®—å¹³å‡å€¼</span>
</span></span><span style="display:flex;"><span>            result[i, j] = np.mean(window)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">return</span> result
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">def</span> visualize_results(original, processed, execution_time, title):
</span></span><span style="display:flex;"><span>    <span style="color:#0ff;font-weight:bold">&#34;&#34;&#34;å¯è§†åŒ–åŸå§‹æ•°æ®å’Œå¤„ç†åçš„æ•°æ®&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    fig = Figure(figsize=(<span style="color:#ff0;font-weight:bold">10</span>, <span style="color:#ff0;font-weight:bold">5</span>))
</span></span><span style="display:flex;"><span>    canvas = FigureCanvas(fig)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    ax1 = fig.add_subplot(<span style="color:#ff0;font-weight:bold">121</span>)
</span></span><span style="display:flex;"><span>    ax1.imshow(original, cmap=<span style="color:#0ff;font-weight:bold">&#39;viridis&#39;</span>)
</span></span><span style="display:flex;"><span>    ax1.set_title(<span style="color:#0ff;font-weight:bold">&#39;Original Data&#39;</span>)
</span></span><span style="display:flex;"><span>    ax1.axis(<span style="color:#0ff;font-weight:bold">&#39;off&#39;</span>)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    ax2 = fig.add_subplot(<span style="color:#ff0;font-weight:bold">122</span>)
</span></span><span style="display:flex;"><span>    ax2.imshow(processed, cmap=<span style="color:#0ff;font-weight:bold">&#39;viridis&#39;</span>)
</span></span><span style="display:flex;"><span>    ax2.set_title(<span style="color:#0ff;font-weight:bold">f</span><span style="color:#0ff;font-weight:bold">&#39;Processed Data</span><span style="color:#0ff;font-weight:bold">\n</span><span style="color:#0ff;font-weight:bold">Execution Time: </span><span style="color:#0ff;font-weight:bold">{</span>execution_time<span style="color:#0ff;font-weight:bold">:</span><span style="color:#0ff;font-weight:bold">.2f</span><span style="color:#0ff;font-weight:bold">}</span><span style="color:#0ff;font-weight:bold"> seconds&#39;</span>)
</span></span><span style="display:flex;"><span>    ax2.axis(<span style="color:#0ff;font-weight:bold">&#39;off&#39;</span>)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    fig.suptitle(title)
</span></span><span style="display:flex;"><span>    fig.tight_layout()
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f"># ä¿å­˜å›¾åƒ</span>
</span></span><span style="display:flex;"><span>    fig.savefig(<span style="color:#0ff;font-weight:bold">f</span><span style="color:#0ff;font-weight:bold">&#34;</span><span style="color:#0ff;font-weight:bold">{</span>title.replace(<span style="color:#0ff;font-weight:bold">&#39; &#39;</span>, <span style="color:#0ff;font-weight:bold">&#39;_&#39;</span>).lower()<span style="color:#0ff;font-weight:bold">}</span><span style="color:#0ff;font-weight:bold">.png&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">print</span>(<span style="color:#0ff;font-weight:bold">f</span><span style="color:#0ff;font-weight:bold">&#34;ç»“æœå·²ä¿å­˜ä¸º </span><span style="color:#0ff;font-weight:bold">{</span>title.replace(<span style="color:#0ff;font-weight:bold">&#39; &#39;</span>, <span style="color:#0ff;font-weight:bold">&#39;_&#39;</span>).lower()<span style="color:#0ff;font-weight:bold">}</span><span style="color:#0ff;font-weight:bold">.png&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">def</span> run_single_process(data_size=<span style="color:#ff0;font-weight:bold">500</span>, kernel_size=<span style="color:#ff0;font-weight:bold">5</span>):
</span></span><span style="display:flex;"><span>    <span style="color:#0ff;font-weight:bold">&#34;&#34;&#34;åœ¨å•ä¸ªè¿›ç¨‹ä¸­è¿è¡Œæ•°æ®å¤„ç†&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">print</span>(<span style="color:#0ff;font-weight:bold">f</span><span style="color:#0ff;font-weight:bold">&#34;ç”Ÿæˆ </span><span style="color:#0ff;font-weight:bold">{</span>data_size<span style="color:#0ff;font-weight:bold">}</span><span style="color:#0ff;font-weight:bold">x</span><span style="color:#0ff;font-weight:bold">{</span>data_size<span style="color:#0ff;font-weight:bold">}</span><span style="color:#0ff;font-weight:bold"> çš„æ•°æ®çŸ©é˜µ...&#34;</span>)
</span></span><span style="display:flex;"><span>    data = generate_data(data_size)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">print</span>(<span style="color:#0ff;font-weight:bold">&#34;å¼€å§‹å¤„ç†æ•°æ®...&#34;</span>)
</span></span><span style="display:flex;"><span>    start_time = time.time()
</span></span><span style="display:flex;"><span>    result = process_data(data, kernel_size)
</span></span><span style="display:flex;"><span>    end_time = time.time()
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    execution_time = end_time - start_time
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">print</span>(<span style="color:#0ff;font-weight:bold">f</span><span style="color:#0ff;font-weight:bold">&#34;å¤„ç†å®Œæˆï¼Œè€—æ—¶: </span><span style="color:#0ff;font-weight:bold">{</span>execution_time<span style="color:#0ff;font-weight:bold">:</span><span style="color:#0ff;font-weight:bold">.2f</span><span style="color:#0ff;font-weight:bold">}</span><span style="color:#0ff;font-weight:bold"> ç§’&#34;</span>)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f"># å¯è§†åŒ–ç»“æœ</span>
</span></span><span style="display:flex;"><span>    visualize_results(data, result, execution_time, <span style="color:#0ff;font-weight:bold">&#34;Single Process&#34;</span>)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">return</span> execution_time
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">if</span> __name__ == <span style="color:#0ff;font-weight:bold">&#34;__main__&#34;</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f"># è¿è¡Œå•è¿›ç¨‹ç‰ˆæœ¬</span>
</span></span><span style="display:flex;"><span>    execution_time = run_single_process(data_size=<span style="color:#ff0;font-weight:bold">500</span>, kernel_size=<span style="color:#ff0;font-weight:bold">5</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">print</span>(<span style="color:#0ff;font-weight:bold">f</span><span style="color:#0ff;font-weight:bold">&#34;å•è¿›ç¨‹æ‰§è¡Œæ—¶é—´: </span><span style="color:#0ff;font-weight:bold">{</span>execution_time<span style="color:#0ff;font-weight:bold">:</span><span style="color:#0ff;font-weight:bold">.2f</span><span style="color:#0ff;font-weight:bold">}</span><span style="color:#0ff;font-weight:bold"> ç§’&#34;</span>)
</span></span></code></pre></div>
</details></p>

<p>è¿™ä¸ªç¨‹åºç”Ÿæˆä¸€ä¸ªéšæœºæ•°æ®çŸ©é˜µï¼Œç„¶åå¯¹å…¶åº”ç”¨æ¨¡ç³Šæ»¤é•œæ“ä½œã€‚ç”±äºæ“ä½œæ˜¯ CPU å¯†é›†å‹çš„ï¼Œä¸”åœ¨å•ä¸ªè¿›ç¨‹ä¸­è¿è¡Œï¼Œå› æ­¤å—åˆ° GIL çš„é™åˆ¶ï¼Œæ— æ³•å……åˆ†åˆ©ç”¨å¤šæ ¸å¤„ç†å™¨çš„ä¼˜åŠ¿ã€‚</p>
<p>ä½¿ç”¨ ZeroMQ æ‹†åˆ†è¿›ç¨‹</p>
<p>ä¸ºäº†çªç ´ GIL é™åˆ¶ï¼Œæˆ‘ä»¬å¯ä»¥å°†ä»»åŠ¡æ‹†åˆ†æˆå¤šä¸ªç‹¬ç«‹çš„è¿›ç¨‹ï¼Œæ¯ä¸ªè¿›ç¨‹å¤„ç†æ•°æ®çš„ä¸€éƒ¨åˆ†ï¼Œç„¶åä½¿ç”¨ ZeroMQ è¿›è¡Œè¿›ç¨‹é—´é€šä¿¡ã€‚</p>
<div class="notice info" >
<p class="first notice-title"><span class="icon-notice baseline"><svg><use href="#info-notice"></use></svg></span>Info</p><p>ZeroMQ å…è®¸æˆ‘ä»¬åˆ›å»ºå¤šä¸ªç‹¬ç«‹è¿›ç¨‹ï¼Œæ¯ä¸ªè¿›ç¨‹å¯ä»¥å……åˆ†åˆ©ç”¨ä¸€ä¸ª CPU æ ¸å¿ƒï¼Œä»è€Œç»•è¿‡ GIL é™åˆ¶ï¼Œå®ç°çœŸæ­£çš„å¹¶è¡Œè®¡ç®—ã€‚</p></div>
<p>æˆ‘ä»¬å°†é‡‡ç”¨ä»¥ä¸‹æ¶æ„ï¼š</p>
<ol>
<li><strong>ä¸»è¿›ç¨‹</strong>ï¼šè´Ÿè´£æ•°æ®åˆ†å‰²ã€ä»»åŠ¡åˆ†å‘å’Œç»“æœæ”¶é›†</li>
<li><strong>å·¥ä½œè¿›ç¨‹</strong>ï¼šæ¥æ”¶æ•°æ®å—ï¼Œè¿›è¡Œå¤„ç†ï¼Œå¹¶è¿”å›ç»“æœ</li>
<li><strong>é€šä¿¡æ¨¡å¼</strong>ï¼šä½¿ç”¨ PUSH-PULL æ¨¡å¼è¿›è¡Œä»»åŠ¡åˆ†å‘å’Œç»“æœæ”¶é›†</li>
</ol>
<h4 id="å®ç°åˆ†å¸ƒå¼å¤„ç†">å®ç°åˆ†å¸ƒå¼å¤„ç†<a hidden class="anchor" aria-hidden="true" href="#å®ç°åˆ†å¸ƒå¼å¤„ç†">#</a></h4>
<p>ä¸‹é¢æ˜¯ä½¿ç”¨ ZeroMQ å®ç°åˆ†å¸ƒå¼å¤„ç†çš„ä»£ç ï¼š</p>


<p><details >
  <summary markdown="span">ZeroMQ åˆ†å¸ƒå¼å¤„ç†å®ç°</summary>
  <div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#007f7f">#!/usr/bin/env python</span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># filename: zmq_distributed_demo.py</span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># ä½¿ç”¨ä¸åŒå¹¶è¡Œå¤„ç†æ–¹æ³•å¯¹æ¯”CPUå¯†é›†å‹ä»»åŠ¡çš„æ€§èƒ½</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> numpy <span style="color:#fff;font-weight:bold">as</span> np
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> time
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> zmq
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> pickle
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> multiprocessing
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">from</span> multiprocessing <span style="color:#fff;font-weight:bold">import</span> Pool, Process, Queue, cpu_count
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> os
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> matplotlib.pyplot <span style="color:#fff;font-weight:bold">as</span> plt
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">from</span> matplotlib.figure <span style="color:#fff;font-weight:bold">import</span> Figure
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">from</span> matplotlib.backends.backend_agg <span style="color:#fff;font-weight:bold">import</span> FigureCanvasAgg <span style="color:#fff;font-weight:bold">as</span> FigureCanvas
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> hashlib
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># å¯¼å…¥å•è¿›ç¨‹ç‰ˆæœ¬ä¸­çš„å‡½æ•°</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">from</span> cpu_bound_demo <span style="color:#fff;font-weight:bold">import</span> generate_data, process_data, visualize_results
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">def</span> worker(worker_id):
</span></span><span style="display:flex;"><span>    <span style="color:#0ff;font-weight:bold">&#34;&#34;&#34;å·¥ä½œè¿›ç¨‹ - æ¥æ”¶æ•°æ®å—å¹¶å¤„ç†&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    context = zmq.Context()
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f"># è®¾ç½®æ¥æ”¶ä»»åŠ¡çš„PULL socket</span>
</span></span><span style="display:flex;"><span>    receiver = context.socket(zmq.PULL)
</span></span><span style="display:flex;"><span>    receiver.connect(<span style="color:#0ff;font-weight:bold">&#34;tcp://localhost:5557&#34;</span>)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f"># è®¾ç½®å‘é€ç»“æœçš„PUSH socket</span>
</span></span><span style="display:flex;"><span>    sender = context.socket(zmq.PUSH)
</span></span><span style="display:flex;"><span>    sender.connect(<span style="color:#0ff;font-weight:bold">&#34;tcp://localhost:5558&#34;</span>)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">print</span>(<span style="color:#0ff;font-weight:bold">f</span><span style="color:#0ff;font-weight:bold">&#34;å·¥ä½œè¿›ç¨‹ </span><span style="color:#0ff;font-weight:bold">{</span>worker_id<span style="color:#0ff;font-weight:bold">}</span><span style="color:#0ff;font-weight:bold"> å·²å¯åŠ¨&#34;</span>)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f"># å¤„ç†å¾ªç¯</span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">while</span> <span style="color:#fff;font-weight:bold">True</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">try</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f"># æ¥æ”¶ä»»åŠ¡</span>
</span></span><span style="display:flex;"><span>            task = receiver.recv_pyobj()
</span></span><span style="display:flex;"><span>            
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f"># æ£€æŸ¥æ˜¯å¦æ˜¯ç»ˆæ­¢ä¿¡å·</span>
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">if</span> task == <span style="color:#0ff;font-weight:bold">&#34;DONE&#34;</span>:
</span></span><span style="display:flex;"><span>                <span style="color:#fff;font-weight:bold">print</span>(<span style="color:#0ff;font-weight:bold">f</span><span style="color:#0ff;font-weight:bold">&#34;å·¥ä½œè¿›ç¨‹ </span><span style="color:#0ff;font-weight:bold">{</span>worker_id<span style="color:#0ff;font-weight:bold">}</span><span style="color:#0ff;font-weight:bold"> æ”¶åˆ°ç»ˆæ­¢ä¿¡å·&#34;</span>)
</span></span><span style="display:flex;"><span>                <span style="color:#fff;font-weight:bold">break</span>
</span></span><span style="display:flex;"><span>            
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f"># è§£åŒ…ä»»åŠ¡æ•°æ®</span>
</span></span><span style="display:flex;"><span>            chunk_id, data_chunk, kernel_size = task
</span></span><span style="display:flex;"><span>            
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f"># å¤„ç†æ•°æ®</span>
</span></span><span style="display:flex;"><span>            result_chunk = process_data(data_chunk, kernel_size)
</span></span><span style="display:flex;"><span>            
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f"># å‘é€ç»“æœ</span>
</span></span><span style="display:flex;"><span>            sender.send_pyobj((chunk_id, result_chunk))
</span></span><span style="display:flex;"><span>            
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">except</span> Exception <span style="color:#fff;font-weight:bold">as</span> e:
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">print</span>(<span style="color:#0ff;font-weight:bold">f</span><span style="color:#0ff;font-weight:bold">&#34;å·¥ä½œè¿›ç¨‹ </span><span style="color:#0ff;font-weight:bold">{</span>worker_id<span style="color:#0ff;font-weight:bold">}</span><span style="color:#0ff;font-weight:bold"> é”™è¯¯: </span><span style="color:#0ff;font-weight:bold">{</span>e<span style="color:#0ff;font-weight:bold">}</span><span style="color:#0ff;font-weight:bold">&#34;</span>)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f"># å…³é—­è¿æ¥</span>
</span></span><span style="display:flex;"><span>    receiver.close()
</span></span><span style="display:flex;"><span>    sender.close()
</span></span><span style="display:flex;"><span>    context.term()
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">print</span>(<span style="color:#0ff;font-weight:bold">f</span><span style="color:#0ff;font-weight:bold">&#34;å·¥ä½œè¿›ç¨‹ </span><span style="color:#0ff;font-weight:bold">{</span>worker_id<span style="color:#0ff;font-weight:bold">}</span><span style="color:#0ff;font-weight:bold"> å·²ç»ˆæ­¢&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">def</span> split_data(data, num_chunks, kernel_size=<span style="color:#ff0;font-weight:bold">5</span>, overlap=<span style="color:#fff;font-weight:bold">True</span>):
</span></span><span style="display:flex;"><span>    <span style="color:#0ff;font-weight:bold">&#34;&#34;&#34;å°†æ•°æ®åˆ†å‰²æˆå¤šä¸ªå—ï¼Œå¯é€‰æ·»åŠ é‡å åŒºåŸŸä»¥è§£å†³è¾¹ç•Œé—®é¢˜&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    rows, cols = data.shape
</span></span><span style="display:flex;"><span>    chunk_size = rows // num_chunks
</span></span><span style="display:flex;"><span>    chunks = []
</span></span><span style="display:flex;"><span>    chunk_bounds = []  <span style="color:#007f7f"># è®°å½•æ¯ä¸ªå—çš„æœ‰æ•ˆè¾¹ç•Œï¼ˆä¸åŒ…æ‹¬é‡å åŒºåŸŸï¼‰</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f"># è®¡ç®—é‡å å¤§å°ï¼Œè‡³å°‘éœ€è¦kernel_size//2çš„é‡å </span>
</span></span><span style="display:flex;"><span>    overlap_size = kernel_size // <span style="color:#ff0;font-weight:bold">2</span> <span style="color:#fff;font-weight:bold">if</span> overlap <span style="color:#fff;font-weight:bold">else</span> <span style="color:#ff0;font-weight:bold">0</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">for</span> i in <span style="color:#fff;font-weight:bold">range</span>(num_chunks):
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f"># è®¡ç®—å—çš„èµ·å§‹å’Œç»“æŸè¡Œï¼ŒåŒ…æ‹¬é‡å åŒºåŸŸ</span>
</span></span><span style="display:flex;"><span>        start_row = <span style="color:#fff;font-weight:bold">max</span>(<span style="color:#ff0;font-weight:bold">0</span>, i * chunk_size - overlap_size)
</span></span><span style="display:flex;"><span>        end_row = <span style="color:#fff;font-weight:bold">min</span>(rows, (i + <span style="color:#ff0;font-weight:bold">1</span>) * chunk_size + overlap_size <span style="color:#fff;font-weight:bold">if</span> i &lt; num_chunks - <span style="color:#ff0;font-weight:bold">1</span> <span style="color:#fff;font-weight:bold">else</span> rows)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f"># è®¡ç®—æœ‰æ•ˆè¾¹ç•Œï¼ˆä¸åŒ…æ‹¬é‡å åŒºåŸŸï¼‰</span>
</span></span><span style="display:flex;"><span>        valid_start = i * chunk_size
</span></span><span style="display:flex;"><span>        valid_end = <span style="color:#fff;font-weight:bold">min</span>(rows, (i + <span style="color:#ff0;font-weight:bold">1</span>) * chunk_size)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f"># å­˜å‚¨å—åŠå…¶æœ‰æ•ˆè¾¹ç•Œ</span>
</span></span><span style="display:flex;"><span>        chunks.append(data[start_row:end_row, :].copy())  <span style="color:#007f7f"># ä½¿ç”¨copy()ç¡®ä¿æ•°æ®ç‹¬ç«‹</span>
</span></span><span style="display:flex;"><span>        chunk_bounds.append((valid_start - start_row, valid_end - start_row))
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">return</span> chunks, chunk_bounds
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">def</span> run_distributed_process(data_size=<span style="color:#ff0;font-weight:bold">500</span>, kernel_size=<span style="color:#ff0;font-weight:bold">5</span>, num_workers=<span style="color:#fff;font-weight:bold">None</span>, input_data=<span style="color:#fff;font-weight:bold">None</span>):
</span></span><span style="display:flex;"><span>    <span style="color:#0ff;font-weight:bold">&#34;&#34;&#34;ä½¿ç”¨ZeroMQåˆ†å¸ƒå¼è¿è¡Œæ•°æ®å¤„ç†&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f"># å¦‚æœæ²¡æœ‰æŒ‡å®šå·¥ä½œè¿›ç¨‹æ•°ï¼Œä½¿ç”¨CPUæ ¸å¿ƒæ•°</span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">if</span> num_workers is <span style="color:#fff;font-weight:bold">None</span>:
</span></span><span style="display:flex;"><span>        num_workers = multiprocessing.cpu_count()
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">if</span> input_data is <span style="color:#fff;font-weight:bold">None</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">print</span>(<span style="color:#0ff;font-weight:bold">f</span><span style="color:#0ff;font-weight:bold">&#34;ç”Ÿæˆ </span><span style="color:#0ff;font-weight:bold">{</span>data_size<span style="color:#0ff;font-weight:bold">}</span><span style="color:#0ff;font-weight:bold">x</span><span style="color:#0ff;font-weight:bold">{</span>data_size<span style="color:#0ff;font-weight:bold">}</span><span style="color:#0ff;font-weight:bold"> çš„æ•°æ®çŸ©é˜µ...&#34;</span>)
</span></span><span style="display:flex;"><span>        data = generate_data(data_size)
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">else</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">print</span>(<span style="color:#0ff;font-weight:bold">f</span><span style="color:#0ff;font-weight:bold">&#34;ä½¿ç”¨æä¾›çš„è¾“å…¥æ•°æ®...&#34;</span>)
</span></span><span style="display:flex;"><span>        data = input_data
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f"># åˆ†å‰²æ•°æ®ï¼Œå¹¶æ·»åŠ é‡å åŒºåŸŸ</span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">print</span>(<span style="color:#0ff;font-weight:bold">f</span><span style="color:#0ff;font-weight:bold">&#34;å°†æ•°æ®åˆ†å‰²æˆ </span><span style="color:#0ff;font-weight:bold">{</span>num_workers<span style="color:#0ff;font-weight:bold">}</span><span style="color:#0ff;font-weight:bold"> å—ï¼Œå¹¶æ·»åŠ é‡å åŒºåŸŸ...&#34;</span>)
</span></span><span style="display:flex;"><span>    data_chunks, chunk_bounds = split_data(data, num_workers, kernel_size)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f"># åˆ›å»ºZeroMQä¸Šä¸‹æ–‡</span>
</span></span><span style="display:flex;"><span>    context = zmq.Context()
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f"># è®¾ç½®ä»»åŠ¡åˆ†å‘çš„PUSH socket</span>
</span></span><span style="display:flex;"><span>    task_sender = context.socket(zmq.PUSH)
</span></span><span style="display:flex;"><span>    task_sender.bind(<span style="color:#0ff;font-weight:bold">&#34;tcp://*:5557&#34;</span>)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f"># è®¾ç½®ç»“æœæ”¶é›†çš„PULL socket</span>
</span></span><span style="display:flex;"><span>    result_receiver = context.socket(zmq.PULL)
</span></span><span style="display:flex;"><span>    result_receiver.bind(<span style="color:#0ff;font-weight:bold">&#34;tcp://*:5558&#34;</span>)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f"># å¯åŠ¨å·¥ä½œè¿›ç¨‹</span>
</span></span><span style="display:flex;"><span>    processes = []
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">for</span> i in <span style="color:#fff;font-weight:bold">range</span>(num_workers):
</span></span><span style="display:flex;"><span>        p = multiprocessing.Process(target=worker, args=(i,))
</span></span><span style="display:flex;"><span>        p.daemon = <span style="color:#fff;font-weight:bold">True</span>
</span></span><span style="display:flex;"><span>        p.start()
</span></span><span style="display:flex;"><span>        processes.append(p)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f"># ç»™å·¥ä½œè¿›ç¨‹ä¸€ç‚¹æ—¶é—´å¯åŠ¨</span>
</span></span><span style="display:flex;"><span>    time.sleep(<span style="color:#ff0;font-weight:bold">0.5</span>)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f"># å¼€å§‹è®¡æ—¶</span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">print</span>(<span style="color:#0ff;font-weight:bold">&#34;å¼€å§‹åˆ†å¸ƒå¼å¤„ç†æ•°æ®...&#34;</span>)
</span></span><span style="display:flex;"><span>    start_time = time.time()
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f"># å‘é€ä»»åŠ¡åˆ°å·¥ä½œè¿›ç¨‹</span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">for</span> i, chunk in <span style="color:#fff;font-weight:bold">enumerate</span>(data_chunks):
</span></span><span style="display:flex;"><span>        task_sender.send_pyobj((i, chunk, kernel_size))
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f"># æ”¶é›†ç»“æœ</span>
</span></span><span style="display:flex;"><span>    results = [<span style="color:#fff;font-weight:bold">None</span>] * <span style="color:#fff;font-weight:bold">len</span>(data_chunks)
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">for</span> _ in <span style="color:#fff;font-weight:bold">range</span>(<span style="color:#fff;font-weight:bold">len</span>(data_chunks)):
</span></span><span style="display:flex;"><span>        chunk_id, result_chunk = result_receiver.recv_pyobj()
</span></span><span style="display:flex;"><span>        results[chunk_id] = result_chunk
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f"># åˆå¹¶ç»“æœï¼Œåªä¿ç•™æ¯ä¸ªå—çš„æœ‰æ•ˆåŒºåŸŸ</span>
</span></span><span style="display:flex;"><span>    final_results = []
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">for</span> i, result_chunk in <span style="color:#fff;font-weight:bold">enumerate</span>(results):
</span></span><span style="display:flex;"><span>        valid_start, valid_end = chunk_bounds[i]
</span></span><span style="display:flex;"><span>        final_results.append(result_chunk[valid_start:valid_end, :])
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f"># åˆå¹¶æœ‰æ•ˆåŒºåŸŸ</span>
</span></span><span style="display:flex;"><span>    result = np.vstack(final_results)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f"># ç»“æŸè®¡æ—¶</span>
</span></span><span style="display:flex;"><span>    end_time = time.time()
</span></span><span style="display:flex;"><span>    execution_time = end_time - start_time
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">print</span>(<span style="color:#0ff;font-weight:bold">f</span><span style="color:#0ff;font-weight:bold">&#34;å¤„ç†å®Œæˆï¼Œè€—æ—¶: </span><span style="color:#0ff;font-weight:bold">{</span>execution_time<span style="color:#0ff;font-weight:bold">:</span><span style="color:#0ff;font-weight:bold">.2f</span><span style="color:#0ff;font-weight:bold">}</span><span style="color:#0ff;font-weight:bold"> ç§’&#34;</span>)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f"># å‘é€ç»ˆæ­¢ä¿¡å·ç»™å·¥ä½œè¿›ç¨‹</span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">for</span> _ in <span style="color:#fff;font-weight:bold">range</span>(num_workers):
</span></span><span style="display:flex;"><span>        task_sender.send_pyobj(<span style="color:#0ff;font-weight:bold">&#34;DONE&#34;</span>)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f"># ç­‰å¾…å·¥ä½œè¿›ç¨‹ç»ˆæ­¢</span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">for</span> p in processes:
</span></span><span style="display:flex;"><span>        p.join(timeout=<span style="color:#ff0;font-weight:bold">1</span>)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f"># å…³é—­ZeroMQè¿æ¥</span>
</span></span><span style="display:flex;"><span>    task_sender.close()
</span></span><span style="display:flex;"><span>    result_receiver.close()
</span></span><span style="display:flex;"><span>    context.term()
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f"># å¯è§†åŒ–ç»“æœ</span>
</span></span><span style="display:flex;"><span>    visualize_results(data, result, execution_time, <span style="color:#0ff;font-weight:bold">&#34;ZeroMQ Distributed&#34;</span>)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">return</span> execution_time, result
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># æ–°å¢çš„ç›´æ¥ä½¿ç”¨å¤šè¿›ç¨‹çš„å®ç°</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">def</span> mp_worker(data_chunk, kernel_size, result_queue, chunk_id):
</span></span><span style="display:flex;"><span>    <span style="color:#0ff;font-weight:bold">&#34;&#34;&#34;å¤šè¿›ç¨‹å·¥ä½œå‡½æ•° - å¤„ç†æ•°æ®å—å¹¶å°†ç»“æœæ”¾å…¥é˜Ÿåˆ—&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">try</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f"># å¤„ç†æ•°æ®</span>
</span></span><span style="display:flex;"><span>        result_chunk = process_data(data_chunk, kernel_size)
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f"># å°†ç»“æœæ”¾å…¥é˜Ÿåˆ—</span>
</span></span><span style="display:flex;"><span>        result_queue.put((chunk_id, result_chunk))
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">except</span> Exception <span style="color:#fff;font-weight:bold">as</span> e:
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">print</span>(<span style="color:#0ff;font-weight:bold">f</span><span style="color:#0ff;font-weight:bold">&#34;å¤šè¿›ç¨‹å·¥ä½œå‡½æ•°é”™è¯¯: </span><span style="color:#0ff;font-weight:bold">{</span>e<span style="color:#0ff;font-weight:bold">}</span><span style="color:#0ff;font-weight:bold">&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">def</span> run_multiprocessing(data_size=<span style="color:#ff0;font-weight:bold">500</span>, kernel_size=<span style="color:#ff0;font-weight:bold">5</span>, num_workers=<span style="color:#fff;font-weight:bold">None</span>, input_data=<span style="color:#fff;font-weight:bold">None</span>):
</span></span><span style="display:flex;"><span>    <span style="color:#0ff;font-weight:bold">&#34;&#34;&#34;ä½¿ç”¨PythonåŸç”Ÿå¤šè¿›ç¨‹è¿è¡Œæ•°æ®å¤„ç†&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f"># å¦‚æœæ²¡æœ‰æŒ‡å®šå·¥ä½œè¿›ç¨‹æ•°ï¼Œä½¿ç”¨CPUæ ¸å¿ƒæ•°</span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">if</span> num_workers is <span style="color:#fff;font-weight:bold">None</span>:
</span></span><span style="display:flex;"><span>        num_workers = cpu_count()
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">if</span> input_data is <span style="color:#fff;font-weight:bold">None</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">print</span>(<span style="color:#0ff;font-weight:bold">f</span><span style="color:#0ff;font-weight:bold">&#34;ç”Ÿæˆ </span><span style="color:#0ff;font-weight:bold">{</span>data_size<span style="color:#0ff;font-weight:bold">}</span><span style="color:#0ff;font-weight:bold">x</span><span style="color:#0ff;font-weight:bold">{</span>data_size<span style="color:#0ff;font-weight:bold">}</span><span style="color:#0ff;font-weight:bold"> çš„æ•°æ®çŸ©é˜µ...&#34;</span>)
</span></span><span style="display:flex;"><span>        data = generate_data(data_size)
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">else</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">print</span>(<span style="color:#0ff;font-weight:bold">f</span><span style="color:#0ff;font-weight:bold">&#34;ä½¿ç”¨æä¾›çš„è¾“å…¥æ•°æ®...&#34;</span>)
</span></span><span style="display:flex;"><span>        data = input_data
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f"># åˆ†å‰²æ•°æ®ï¼Œå¹¶æ·»åŠ é‡å åŒºåŸŸ</span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">print</span>(<span style="color:#0ff;font-weight:bold">f</span><span style="color:#0ff;font-weight:bold">&#34;å°†æ•°æ®åˆ†å‰²æˆ </span><span style="color:#0ff;font-weight:bold">{</span>num_workers<span style="color:#0ff;font-weight:bold">}</span><span style="color:#0ff;font-weight:bold"> å—ï¼Œå¹¶æ·»åŠ é‡å åŒºåŸŸ...&#34;</span>)
</span></span><span style="display:flex;"><span>    data_chunks, chunk_bounds = split_data(data, num_workers, kernel_size)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f"># åˆ›å»ºç»“æœé˜Ÿåˆ—</span>
</span></span><span style="display:flex;"><span>    result_queue = Queue()
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f"># åˆ›å»ºè¿›ç¨‹</span>
</span></span><span style="display:flex;"><span>    processes = []
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f"># å¼€å§‹è®¡æ—¶</span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">print</span>(<span style="color:#0ff;font-weight:bold">&#34;å¼€å§‹å¤šè¿›ç¨‹å¤„ç†æ•°æ®...&#34;</span>)
</span></span><span style="display:flex;"><span>    start_time = time.time()
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f"># å¯åŠ¨å·¥ä½œè¿›ç¨‹</span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">for</span> i, chunk in <span style="color:#fff;font-weight:bold">enumerate</span>(data_chunks):
</span></span><span style="display:flex;"><span>        p = Process(target=mp_worker, args=(chunk, kernel_size, result_queue, i))
</span></span><span style="display:flex;"><span>        processes.append(p)
</span></span><span style="display:flex;"><span>        p.start()
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f"># æ”¶é›†ç»“æœ</span>
</span></span><span style="display:flex;"><span>    results = [<span style="color:#fff;font-weight:bold">None</span>] * <span style="color:#fff;font-weight:bold">len</span>(data_chunks)
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">for</span> _ in <span style="color:#fff;font-weight:bold">range</span>(<span style="color:#fff;font-weight:bold">len</span>(data_chunks)):
</span></span><span style="display:flex;"><span>        chunk_id, result_chunk = result_queue.get()
</span></span><span style="display:flex;"><span>        results[chunk_id] = result_chunk
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f"># ç­‰å¾…æ‰€æœ‰è¿›ç¨‹å®Œæˆ</span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">for</span> p in processes:
</span></span><span style="display:flex;"><span>        p.join()
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f"># åˆå¹¶ç»“æœï¼Œåªä¿ç•™æ¯ä¸ªå—çš„æœ‰æ•ˆåŒºåŸŸ</span>
</span></span><span style="display:flex;"><span>    final_results = []
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">for</span> i, result_chunk in <span style="color:#fff;font-weight:bold">enumerate</span>(results):
</span></span><span style="display:flex;"><span>        valid_start, valid_end = chunk_bounds[i]
</span></span><span style="display:flex;"><span>        final_results.append(result_chunk[valid_start:valid_end, :])
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f"># åˆå¹¶æœ‰æ•ˆåŒºåŸŸ</span>
</span></span><span style="display:flex;"><span>    result = np.vstack(final_results)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f"># ç»“æŸè®¡æ—¶</span>
</span></span><span style="display:flex;"><span>    end_time = time.time()
</span></span><span style="display:flex;"><span>    execution_time = end_time - start_time
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">print</span>(<span style="color:#0ff;font-weight:bold">f</span><span style="color:#0ff;font-weight:bold">&#34;å¤„ç†å®Œæˆï¼Œè€—æ—¶: </span><span style="color:#0ff;font-weight:bold">{</span>execution_time<span style="color:#0ff;font-weight:bold">:</span><span style="color:#0ff;font-weight:bold">.2f</span><span style="color:#0ff;font-weight:bold">}</span><span style="color:#0ff;font-weight:bold"> ç§’&#34;</span>)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f"># å¯è§†åŒ–ç»“æœ</span>
</span></span><span style="display:flex;"><span>    visualize_results(data, result, execution_time, <span style="color:#0ff;font-weight:bold">&#34;Multiprocessing&#34;</span>)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">return</span> execution_time, result
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># ç”¨äºéªŒè¯ç»“æœä¸€è‡´æ€§çš„å‡½æ•°</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">def</span> calculate_result_hash(result):
</span></span><span style="display:flex;"><span>    <span style="color:#0ff;font-weight:bold">&#34;&#34;&#34;è®¡ç®—ç»“æœæ•°ç»„çš„å“ˆå¸Œå€¼ä»¥éªŒè¯ä¸€è‡´æ€§&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f"># å°†numpyæ•°ç»„è½¬æ¢ä¸ºå­—èŠ‚åºåˆ—</span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f"># å…ˆå››èˆäº”å…¥åˆ°å›ºå®šå°æ•°ä½æ•°ï¼Œé¿å…æµ®ç‚¹æ•°è¯¯å·®å¼•èµ·çš„ä¸ä¸€è‡´</span>
</span></span><span style="display:flex;"><span>    rounded_result = np.round(result, <span style="color:#ff0;font-weight:bold">6</span>)
</span></span><span style="display:flex;"><span>    result_bytes = rounded_result.tobytes()
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f"># è®¡ç®—SHA-256å“ˆå¸Œ</span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">return</span> hashlib.sha256(result_bytes).hexdigest()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">def</span> compare_performance():
</span></span><span style="display:flex;"><span>    <span style="color:#0ff;font-weight:bold">&#34;&#34;&#34;æ¯”è¾ƒä¸‰ç§å®ç°çš„æ€§èƒ½å¹¶éªŒè¯ç»“æœä¸€è‡´æ€§&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">print</span>(<span style="color:#0ff;font-weight:bold">&#34;</span><span style="color:#0ff;font-weight:bold">\n</span><span style="color:#0ff;font-weight:bold">===== æ€§èƒ½å¯¹æ¯” =====&#34;</span>)
</span></span><span style="display:flex;"><span>    data_size = <span style="color:#ff0;font-weight:bold">2000</span>
</span></span><span style="display:flex;"><span>    kernel_size = <span style="color:#ff0;font-weight:bold">5</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f"># è®¾ç½®éšæœºç§å­ä»¥ç¡®ä¿å¯é‡ç°æ€§</span>
</span></span><span style="display:flex;"><span>    np.random.seed(<span style="color:#ff0;font-weight:bold">42</span>)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f"># è¿è¡Œå•è¿›ç¨‹ç‰ˆæœ¬</span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">print</span>(<span style="color:#0ff;font-weight:bold">&#34;</span><span style="color:#0ff;font-weight:bold">\n</span><span style="color:#0ff;font-weight:bold">è¿è¡Œå•è¿›ç¨‹ç‰ˆæœ¬...&#34;</span>)
</span></span><span style="display:flex;"><span>    single_data = generate_data(data_size)  <span style="color:#007f7f"># ä¿è¯æ‰€æœ‰å®ç°ä½¿ç”¨ç›¸åŒçš„è¾“å…¥æ•°æ®</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f"># ä¸ºäº†ç¡®ä¿ç»“æœä¸€è‡´æ€§ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨ä¸åˆ†å¸ƒå¼å®ç°ç›¸åŒçš„å¤„ç†æ–¹å¼</span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f"># å°†æ•°æ®åˆ†å‰²ï¼Œå¤„ç†ï¼Œç„¶åå†åˆå¹¶</span>
</span></span><span style="display:flex;"><span>    num_workers = cpu_count()
</span></span><span style="display:flex;"><span>    data_chunks, chunk_bounds = split_data(single_data, num_workers, kernel_size)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    single_start = time.time()
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f"># å¤„ç†æ¯ä¸ªå—</span>
</span></span><span style="display:flex;"><span>    result_chunks = []
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">for</span> chunk in data_chunks:
</span></span><span style="display:flex;"><span>        result_chunk = process_data(chunk, kernel_size)
</span></span><span style="display:flex;"><span>        result_chunks.append(result_chunk)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f"># åˆå¹¶ç»“æœï¼Œåªä¿ç•™æ¯ä¸ªå—çš„æœ‰æ•ˆåŒºåŸŸ</span>
</span></span><span style="display:flex;"><span>    final_results = []
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">for</span> i, result_chunk in <span style="color:#fff;font-weight:bold">enumerate</span>(result_chunks):
</span></span><span style="display:flex;"><span>        valid_start, valid_end = chunk_bounds[i]
</span></span><span style="display:flex;"><span>        final_results.append(result_chunk[valid_start:valid_end, :])
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f"># åˆå¹¶æœ‰æ•ˆåŒºåŸŸ</span>
</span></span><span style="display:flex;"><span>    single_result = np.vstack(final_results)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    single_time = time.time() - single_start
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">print</span>(<span style="color:#0ff;font-weight:bold">f</span><span style="color:#0ff;font-weight:bold">&#34;å¤„ç†å®Œæˆï¼Œè€—æ—¶: </span><span style="color:#0ff;font-weight:bold">{</span>single_time<span style="color:#0ff;font-weight:bold">:</span><span style="color:#0ff;font-weight:bold">.2f</span><span style="color:#0ff;font-weight:bold">}</span><span style="color:#0ff;font-weight:bold"> ç§’&#34;</span>)
</span></span><span style="display:flex;"><span>    visualize_results(single_data, single_result, single_time, <span style="color:#0ff;font-weight:bold">&#34;Single Process&#34;</span>)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f"># è¿è¡Œåˆ†å¸ƒå¼ç‰ˆæœ¬</span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">print</span>(<span style="color:#0ff;font-weight:bold">&#34;</span><span style="color:#0ff;font-weight:bold">\n</span><span style="color:#0ff;font-weight:bold">è¿è¡ŒZeroMQåˆ†å¸ƒå¼ç‰ˆæœ¬...&#34;</span>)
</span></span><span style="display:flex;"><span>    zmq_time, zmq_result = run_distributed_process(data_size=data_size, kernel_size=kernel_size, input_data=single_data)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f"># è¿è¡ŒåŸç”Ÿå¤šè¿›ç¨‹ç‰ˆæœ¬</span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">print</span>(<span style="color:#0ff;font-weight:bold">&#34;</span><span style="color:#0ff;font-weight:bold">\n</span><span style="color:#0ff;font-weight:bold">è¿è¡ŒåŸç”Ÿå¤šè¿›ç¨‹ç‰ˆæœ¬...&#34;</span>)
</span></span><span style="display:flex;"><span>    mp_time, mp_result = run_multiprocessing(data_size=data_size, kernel_size=kernel_size, input_data=single_data)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f"># éªŒè¯ç»“æœä¸€è‡´æ€§</span>
</span></span><span style="display:flex;"><span>    single_hash = calculate_result_hash(single_result)
</span></span><span style="display:flex;"><span>    zmq_hash = calculate_result_hash(zmq_result)
</span></span><span style="display:flex;"><span>    mp_hash = calculate_result_hash(mp_result)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">print</span>(<span style="color:#0ff;font-weight:bold">f</span><span style="color:#0ff;font-weight:bold">&#34;</span><span style="color:#0ff;font-weight:bold">\n</span><span style="color:#0ff;font-weight:bold">å“ˆå¸Œå€¼æ£€æŸ¥:&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">print</span>(<span style="color:#0ff;font-weight:bold">f</span><span style="color:#0ff;font-weight:bold">&#34;  å•è¿›ç¨‹ç»“æœå“ˆå¸Œ: </span><span style="color:#0ff;font-weight:bold">{</span>single_hash[:<span style="color:#ff0;font-weight:bold">10</span>]<span style="color:#0ff;font-weight:bold">}</span><span style="color:#0ff;font-weight:bold">...&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">print</span>(<span style="color:#0ff;font-weight:bold">f</span><span style="color:#0ff;font-weight:bold">&#34;  ZeroMQç»“æœå“ˆå¸Œ: </span><span style="color:#0ff;font-weight:bold">{</span>zmq_hash[:<span style="color:#ff0;font-weight:bold">10</span>]<span style="color:#0ff;font-weight:bold">}</span><span style="color:#0ff;font-weight:bold">...&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">print</span>(<span style="color:#0ff;font-weight:bold">f</span><span style="color:#0ff;font-weight:bold">&#34;  å¤šè¿›ç¨‹ç»“æœå“ˆå¸Œ: </span><span style="color:#0ff;font-weight:bold">{</span>mp_hash[:<span style="color:#ff0;font-weight:bold">10</span>]<span style="color:#0ff;font-weight:bold">}</span><span style="color:#0ff;font-weight:bold">...&#34;</span>)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f"># æ£€æŸ¥ç»“æœæ˜¯å¦ç›¸åŒ</span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">if</span> single_hash == zmq_hash and single_hash == mp_hash:
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">print</span>(<span style="color:#0ff;font-weight:bold">&#34;  ç»“æœä¸€è‡´æ€§æ£€æŸ¥: é€šè¿‡ </span><span style="color:#0ff;font-weight:bold">\u2705</span><span style="color:#0ff;font-weight:bold">&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">else</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">print</span>(<span style="color:#0ff;font-weight:bold">&#34;  ç»“æœä¸€è‡´æ€§æ£€æŸ¥: å¤±è´¥ </span><span style="color:#0ff;font-weight:bold">\u274c</span><span style="color:#0ff;font-weight:bold">&#34;</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">if</span> single_hash != zmq_hash:
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">print</span>(<span style="color:#0ff;font-weight:bold">&#34;    - å•è¿›ç¨‹ä¸ZeroMQç»“æœä¸ä¸€è‡´&#34;</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">if</span> single_hash != mp_hash:
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">print</span>(<span style="color:#0ff;font-weight:bold">&#34;    - å•è¿›ç¨‹ä¸å¤šè¿›ç¨‹ç»“æœä¸ä¸€è‡´&#34;</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">if</span> zmq_hash != mp_hash:
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">print</span>(<span style="color:#0ff;font-weight:bold">&#34;    - ZeroMQä¸å¤šè¿›ç¨‹ç»“æœä¸ä¸€è‡´&#34;</span>)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f"># æ£€æŸ¥ç»“æœæ˜¯å¦ç›¸åŒ</span>
</span></span><span style="display:flex;"><span>    zmq_match = (single_hash == zmq_hash)
</span></span><span style="display:flex;"><span>    mp_match = (single_hash == mp_hash)
</span></span><span style="display:flex;"><span>    results_match = zmq_match and mp_match
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f"># è®¡ç®—åŠ é€Ÿæ¯”</span>
</span></span><span style="display:flex;"><span>    zmq_speedup = single_time / zmq_time
</span></span><span style="display:flex;"><span>    mp_speedup = single_time / mp_time
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">print</span>(<span style="color:#0ff;font-weight:bold">&#34;</span><span style="color:#0ff;font-weight:bold">\n</span><span style="color:#0ff;font-weight:bold">===== ç»“æœå¯¹æ¯” =====&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">print</span>(<span style="color:#0ff;font-weight:bold">f</span><span style="color:#0ff;font-weight:bold">&#34;å•è¿›ç¨‹æ‰§è¡Œæ—¶é—´: </span><span style="color:#0ff;font-weight:bold">{</span>single_time<span style="color:#0ff;font-weight:bold">:</span><span style="color:#0ff;font-weight:bold">.2f</span><span style="color:#0ff;font-weight:bold">}</span><span style="color:#0ff;font-weight:bold"> ç§’&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">print</span>(<span style="color:#0ff;font-weight:bold">f</span><span style="color:#0ff;font-weight:bold">&#34;ZeroMQåˆ†å¸ƒå¼æ‰§è¡Œæ—¶é—´: </span><span style="color:#0ff;font-weight:bold">{</span>zmq_time<span style="color:#0ff;font-weight:bold">:</span><span style="color:#0ff;font-weight:bold">.2f</span><span style="color:#0ff;font-weight:bold">}</span><span style="color:#0ff;font-weight:bold"> ç§’ (åŠ é€Ÿæ¯”: </span><span style="color:#0ff;font-weight:bold">{</span>zmq_speedup<span style="color:#0ff;font-weight:bold">:</span><span style="color:#0ff;font-weight:bold">.2f</span><span style="color:#0ff;font-weight:bold">}</span><span style="color:#0ff;font-weight:bold">x)&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">print</span>(<span style="color:#0ff;font-weight:bold">f</span><span style="color:#0ff;font-weight:bold">&#34;åŸç”Ÿå¤šè¿›ç¨‹æ‰§è¡Œæ—¶é—´: </span><span style="color:#0ff;font-weight:bold">{</span>mp_time<span style="color:#0ff;font-weight:bold">:</span><span style="color:#0ff;font-weight:bold">.2f</span><span style="color:#0ff;font-weight:bold">}</span><span style="color:#0ff;font-weight:bold"> ç§’ (åŠ é€Ÿæ¯”: </span><span style="color:#0ff;font-weight:bold">{</span>mp_speedup<span style="color:#0ff;font-weight:bold">:</span><span style="color:#0ff;font-weight:bold">.2f</span><span style="color:#0ff;font-weight:bold">}</span><span style="color:#0ff;font-weight:bold">x)&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">print</span>(<span style="color:#0ff;font-weight:bold">f</span><span style="color:#0ff;font-weight:bold">&#34;ç»“æœä¸€è‡´æ€§æ£€æŸ¥: </span><span style="color:#0ff;font-weight:bold">{</span><span style="color:#0ff;font-weight:bold">&#39;é€šè¿‡&#39;</span> <span style="color:#fff;font-weight:bold">if</span> results_match <span style="color:#fff;font-weight:bold">else</span> <span style="color:#0ff;font-weight:bold">&#39;å¤±è´¥&#39;</span><span style="color:#0ff;font-weight:bold">}</span><span style="color:#0ff;font-weight:bold">&#34;</span>)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f"># ç»˜åˆ¶æ€§èƒ½å¯¹æ¯”å›¾</span>
</span></span><span style="display:flex;"><span>    fig = Figure(figsize=(<span style="color:#ff0;font-weight:bold">10</span>, <span style="color:#ff0;font-weight:bold">6</span>))
</span></span><span style="display:flex;"><span>    canvas = FigureCanvas(fig)
</span></span><span style="display:flex;"><span>    ax = fig.add_subplot(<span style="color:#ff0;font-weight:bold">111</span>)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    methods = [<span style="color:#0ff;font-weight:bold">&#39;Single Process&#39;</span>, <span style="color:#0ff;font-weight:bold">&#39;ZeroMQ Distributed&#39;</span>, <span style="color:#0ff;font-weight:bold">&#39;Python Multiprocessing&#39;</span>]
</span></span><span style="display:flex;"><span>    times = [single_time, zmq_time, mp_time]
</span></span><span style="display:flex;"><span>    colors = [<span style="color:#0ff;font-weight:bold">&#39;blue&#39;</span>, <span style="color:#0ff;font-weight:bold">&#39;green&#39;</span>, <span style="color:#0ff;font-weight:bold">&#39;orange&#39;</span>]
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    ax.bar(methods, times, color=colors)
</span></span><span style="display:flex;"><span>    ax.set_ylabel(<span style="color:#0ff;font-weight:bold">&#39;Execution Time (seconds)&#39;</span>)
</span></span><span style="display:flex;"><span>    ax.set_title(<span style="color:#0ff;font-weight:bold">&#39;Performance Comparison&#39;</span>)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f"># æ·»åŠ æ•°å€¼æ ‡ç­¾</span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">for</span> i, v in <span style="color:#fff;font-weight:bold">enumerate</span>(times):
</span></span><span style="display:flex;"><span>        ax.text(i, v + <span style="color:#ff0;font-weight:bold">0.1</span>, <span style="color:#0ff;font-weight:bold">f</span><span style="color:#0ff;font-weight:bold">&#34;</span><span style="color:#0ff;font-weight:bold">{</span>v<span style="color:#0ff;font-weight:bold">:</span><span style="color:#0ff;font-weight:bold">.2f</span><span style="color:#0ff;font-weight:bold">}</span><span style="color:#0ff;font-weight:bold">s&#34;</span>, ha=<span style="color:#0ff;font-weight:bold">&#39;center&#39;</span>)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f"># æ·»åŠ åŠ é€Ÿæ¯”</span>
</span></span><span style="display:flex;"><span>    ax.text(<span style="color:#ff0;font-weight:bold">1</span>, times[<span style="color:#ff0;font-weight:bold">1</span>] * <span style="color:#ff0;font-weight:bold">0.5</span>, <span style="color:#0ff;font-weight:bold">f</span><span style="color:#0ff;font-weight:bold">&#34;Speedup: </span><span style="color:#0ff;font-weight:bold">{</span>zmq_speedup<span style="color:#0ff;font-weight:bold">:</span><span style="color:#0ff;font-weight:bold">.2f</span><span style="color:#0ff;font-weight:bold">}</span><span style="color:#0ff;font-weight:bold">x&#34;</span>, 
</span></span><span style="display:flex;"><span>            ha=<span style="color:#0ff;font-weight:bold">&#39;center&#39;</span>, fontsize=<span style="color:#ff0;font-weight:bold">10</span>, bbox=<span style="color:#fff;font-weight:bold">dict</span>(facecolor=<span style="color:#0ff;font-weight:bold">&#39;white&#39;</span>, alpha=<span style="color:#ff0;font-weight:bold">0.8</span>))
</span></span><span style="display:flex;"><span>    ax.text(<span style="color:#ff0;font-weight:bold">2</span>, times[<span style="color:#ff0;font-weight:bold">2</span>] * <span style="color:#ff0;font-weight:bold">0.5</span>, <span style="color:#0ff;font-weight:bold">f</span><span style="color:#0ff;font-weight:bold">&#34;Speedup: </span><span style="color:#0ff;font-weight:bold">{</span>mp_speedup<span style="color:#0ff;font-weight:bold">:</span><span style="color:#0ff;font-weight:bold">.2f</span><span style="color:#0ff;font-weight:bold">}</span><span style="color:#0ff;font-weight:bold">x&#34;</span>, 
</span></span><span style="display:flex;"><span>            ha=<span style="color:#0ff;font-weight:bold">&#39;center&#39;</span>, fontsize=<span style="color:#ff0;font-weight:bold">10</span>, bbox=<span style="color:#fff;font-weight:bold">dict</span>(facecolor=<span style="color:#0ff;font-weight:bold">&#39;white&#39;</span>, alpha=<span style="color:#ff0;font-weight:bold">0.8</span>))
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    fig.tight_layout()
</span></span><span style="display:flex;"><span>    fig.savefig(<span style="color:#0ff;font-weight:bold">&#34;performance_comparison_all.png&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">print</span>(<span style="color:#0ff;font-weight:bold">&#34;æ€§èƒ½å¯¹æ¯”å›¾å·²ä¿å­˜ä¸º performance_comparison_all.png&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">if</span> __name__ == <span style="color:#0ff;font-weight:bold">&#34;__main__&#34;</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f"># æ¯”è¾ƒæ€§èƒ½</span>
</span></span><span style="display:flex;"><span>    compare_performance()
</span></span></code></pre></div>
</details></p>

<h4 id="æ€§èƒ½å¯¹æ¯”åˆ†æ">æ€§èƒ½å¯¹æ¯”åˆ†æ<a hidden class="anchor" aria-hidden="true" href="#æ€§èƒ½å¯¹æ¯”åˆ†æ">#</a></h4>
<p>ä¸ºäº†éªŒè¯ ZeroMQ åˆ†å¸ƒå¼å¤„ç†çš„æ•ˆæœï¼Œæˆ‘ä»¬å°†å…¶ä¸å•è¿›ç¨‹ç‰ˆæœ¬å’Œ Python åŸç”Ÿå¤šè¿›ç¨‹ç‰ˆæœ¬è¿›è¡Œå¯¹æ¯”ã€‚</p>
<p>æˆ‘ä»¬ä½¿ç”¨ç›¸åŒçš„è¾“å…¥æ•°æ®ï¼Œåˆ†åˆ«ç”¨ä¸‰ç§æ–¹æ³•å¤„ç†ï¼Œå¹¶è®°å½•æ‰§è¡Œæ—¶é—´ï¼š</p>
<ol>
<li><strong>å•è¿›ç¨‹ç‰ˆæœ¬</strong>ï¼šæ‰€æœ‰è®¡ç®—åœ¨ä¸€ä¸ªè¿›ç¨‹ä¸­å®Œæˆ</li>
<li><strong>ZeroMQ åˆ†å¸ƒå¼ç‰ˆæœ¬</strong>ï¼šä½¿ç”¨ ZeroMQ è¿›è¡Œè¿›ç¨‹é—´é€šä¿¡</li>
<li><strong>Python åŸç”Ÿå¤šè¿›ç¨‹ç‰ˆæœ¬</strong>ï¼šä½¿ç”¨ Python çš„ multiprocessing æ¨¡å—</li>
</ol>
<p><strong>æ€§èƒ½æµ‹è¯•ç»“æœ</strong></p>
<pre tabindex="0"><code>===== ç»“æœå¯¹æ¯” =====
å•è¿›ç¨‹æ‰§è¡Œæ—¶é—´: 9.75 ç§’
ZeroMQåˆ†å¸ƒå¼æ‰§è¡Œæ—¶é—´: 1.28 ç§’ (åŠ é€Ÿæ¯”: 7.62x)
åŸç”Ÿå¤šè¿›ç¨‹æ‰§è¡Œæ—¶é—´: 1.27 ç§’ (åŠ é€Ÿæ¯”: 7.66x)
ç»“æœä¸€è‡´æ€§æ£€æŸ¥: é€šè¿‡
</code></pre><h3 id="vllm-æ¶æ„æ¨¡æ‹Ÿcpu-gpu-å¹¶è¡Œä¼˜åŒ–">vLLM æ¶æ„æ¨¡æ‹Ÿï¼šCPU-GPU å¹¶è¡Œä¼˜åŒ–<a hidden class="anchor" aria-hidden="true" href="#vllm-æ¶æ„æ¨¡æ‹Ÿcpu-gpu-å¹¶è¡Œä¼˜åŒ–">#</a></h3>
<p>é™¤äº†è§£å†³ CPU å¯†é›†å‹ä»»åŠ¡çš„ GIL é™åˆ¶ï¼ŒZeroMQ è¿˜å¯ä»¥ç”¨äºä¼˜åŒ– CPU å’Œ GPU ä¹‹é—´çš„åä½œã€‚è¿™é‡Œæˆ‘ä»¬æ¨¡æ‹Ÿäº†ç±»ä¼¼ vLLMï¼ˆä¸€ç§é«˜æ•ˆçš„å¤§è¯­è¨€æ¨¡å‹æ¨ç†æ¡†æ¶ï¼‰çš„æ¶æ„ï¼Œé€šè¿‡ ZeroMQ å®ç° CPU å’Œ GPU ä»»åŠ¡çš„å¹¶è¡Œå¤„ç†ã€‚</p>
<p><strong>ä¼ ç»Ÿé¡ºåºå¤„ç†çš„é—®é¢˜</strong></p>
<p>åœ¨ä¼ ç»Ÿçš„æ·±åº¦å­¦ä¹ æ¨ç†ä¸­ï¼Œå¤„ç†æµç¨‹é€šå¸¸æ˜¯é¡ºåºçš„ï¼š</p>
<ol>
<li>CPU è¿›è¡Œé¢„å¤„ç†</li>
<li>ç­‰å¾… GPU å®Œæˆè®¡ç®—</li>
<li>CPU è¿›è¡Œåå¤„ç†</li>
</ol>
<p>è¿™ç§æ–¹å¼å¯¼è‡´ GPU åœ¨ CPU å¤„ç†æœŸé—´å¤„äºç©ºé—²çŠ¶æ€ï¼Œæ— æ³•å……åˆ†åˆ©ç”¨è®¡ç®—èµ„æºã€‚</p>
<h4 id="ä½¿ç”¨-zeromq-å®ç°-cpu-gpu-å¹¶è¡Œ">ä½¿ç”¨ ZeroMQ å®ç° CPU-GPU å¹¶è¡Œ<a hidden class="anchor" aria-hidden="true" href="#ä½¿ç”¨-zeromq-å®ç°-cpu-gpu-å¹¶è¡Œ">#</a></h4>
<p>é€šè¿‡ ZeroMQï¼Œæˆ‘ä»¬å¯ä»¥å®ç° CPU å’Œ GPU çš„å¹¶è¡Œå·¥ä½œï¼š</p>


<p><details >
  <summary markdown="span">æ¨¡æ‹Ÿvllmæ‹†åˆ†cpuå’Œgpuå·¥ä½œè´Ÿè½½</summary>
  <div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#007f7f">#!/usr/bin/env python</span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># æ¨¡æ‹ŸvLLMæ¶æ„çš„ç®€åŒ–ç‰ˆæœ¬ï¼Œä½¿ç”¨ZeroMQåˆ†ç¦»GPUå’ŒCPUå·¥ä½œè´Ÿè½½</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> numpy <span style="color:#fff;font-weight:bold">as</span> np
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> time
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> zmq
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> multiprocessing
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> threading
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> queue
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> json
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> argparse
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">from</span> tqdm <span style="color:#fff;font-weight:bold">import</span> tqdm
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> matplotlib.pyplot <span style="color:#fff;font-weight:bold">as</span> plt
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">from</span> matplotlib.figure <span style="color:#fff;font-weight:bold">import</span> Figure
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">from</span> matplotlib.backends.backend_agg <span style="color:#fff;font-weight:bold">import</span> FigureCanvasAgg <span style="color:#fff;font-weight:bold">as</span> FigureCanvas
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># æ¨¡æ‹ŸGPUè®¡ç®—çš„å‡½æ•°</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">def</span> simulate_gpu_computation(input_data, computation_time=<span style="color:#ff0;font-weight:bold">0.1</span>):
</span></span><span style="display:flex;"><span>    <span style="color:#0ff;font-weight:bold">&#34;&#34;&#34;æ¨¡æ‹ŸGPUä¸Šçš„çŸ©é˜µä¹˜æ³•è®¡ç®—&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f"># å®é™…ä¸Šæ˜¯åœ¨CPUä¸Šè¿è¡Œï¼Œä½†æˆ‘ä»¬ç”¨sleepæ¥æ¨¡æ‹ŸGPUè®¡ç®—æ—¶é—´</span>
</span></span><span style="display:flex;"><span>    time.sleep(computation_time)
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f"># æ¨¡æ‹ŸçŸ©é˜µä¹˜æ³•</span>
</span></span><span style="display:flex;"><span>    result = np.dot(input_data, input_data.T)
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">return</span> result
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># æ¨¡æ‹ŸCPUå¤„ç†çš„å‡½æ•°</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">def</span> simulate_cpu_preprocessing(request_id, size=<span style="color:#ff0;font-weight:bold">100</span>, processing_time=<span style="color:#ff0;font-weight:bold">0.05</span>):
</span></span><span style="display:flex;"><span>    <span style="color:#0ff;font-weight:bold">&#34;&#34;&#34;æ¨¡æ‹ŸCPUä¸Šçš„é¢„å¤„ç†æ“ä½œ&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f"># æ¨¡æ‹Ÿé¢„å¤„ç†è€—æ—¶</span>
</span></span><span style="display:flex;"><span>    time.sleep(processing_time)
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f"># ç”Ÿæˆéšæœºè¾“å…¥æ•°æ®</span>
</span></span><span style="display:flex;"><span>    input_data = np.random.random((size, size))
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">return</span> input_data
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">def</span> simulate_cpu_postprocessing(request_id, result, processing_time=<span style="color:#ff0;font-weight:bold">0.05</span>):
</span></span><span style="display:flex;"><span>    <span style="color:#0ff;font-weight:bold">&#34;&#34;&#34;æ¨¡æ‹ŸCPUä¸Šçš„åå¤„ç†æ“ä½œ&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f"># æ¨¡æ‹Ÿåå¤„ç†è€—æ—¶</span>
</span></span><span style="display:flex;"><span>    time.sleep(processing_time)
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f"># ç®€å•å¤„ç†ç»“æœ</span>
</span></span><span style="display:flex;"><span>    processed_result = np.mean(result)
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">return</span> processed_result
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># ä¼ ç»Ÿæ–¹å¼ï¼šå•è¿›ç¨‹ä¸­é¡ºåºæ‰§è¡ŒCPUå’ŒGPUæ“ä½œ</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">def</span> traditional_approach(num_requests=<span style="color:#ff0;font-weight:bold">10</span>, matrix_size=<span style="color:#ff0;font-weight:bold">100</span>, 
</span></span><span style="display:flex;"><span>                         preprocess_time=<span style="color:#ff0;font-weight:bold">0.05</span>, gpu_time=<span style="color:#ff0;font-weight:bold">0.1</span>, postprocess_time=<span style="color:#ff0;font-weight:bold">0.05</span>):
</span></span><span style="display:flex;"><span>    <span style="color:#0ff;font-weight:bold">&#34;&#34;&#34;ä¼ ç»Ÿæ–¹å¼ï¼šåœ¨å•ä¸€è¿›ç¨‹ä¸­é¡ºåºæ‰§è¡ŒCPUå’ŒGPUæ“ä½œ&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">print</span>(<span style="color:#0ff;font-weight:bold">&#34;</span><span style="color:#0ff;font-weight:bold">\n</span><span style="color:#0ff;font-weight:bold">è¿è¡Œä¼ ç»Ÿæ–¹å¼ï¼ˆå•è¿›ç¨‹é¡ºåºæ‰§è¡Œï¼‰...&#34;</span>)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    start_time = time.time()
</span></span><span style="display:flex;"><span>    gpu_active_time = <span style="color:#ff0;font-weight:bold">0</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">for</span> i in tqdm(<span style="color:#fff;font-weight:bold">range</span>(num_requests), desc=<span style="color:#0ff;font-weight:bold">&#34;å¤„ç†è¯·æ±‚&#34;</span>):
</span></span><span style="display:flex;"><span>        request_id = <span style="color:#0ff;font-weight:bold">f</span><span style="color:#0ff;font-weight:bold">&#34;req_</span><span style="color:#0ff;font-weight:bold">{</span>i<span style="color:#0ff;font-weight:bold">}</span><span style="color:#0ff;font-weight:bold">&#34;</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f"># CPUé¢„å¤„ç†</span>
</span></span><span style="display:flex;"><span>        preprocess_start = time.time()
</span></span><span style="display:flex;"><span>        input_data = simulate_cpu_preprocessing(request_id, matrix_size, preprocess_time)
</span></span><span style="display:flex;"><span>        preprocess_end = time.time()
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f"># GPUè®¡ç®—</span>
</span></span><span style="display:flex;"><span>        gpu_start = time.time()
</span></span><span style="display:flex;"><span>        result = simulate_gpu_computation(input_data, gpu_time)
</span></span><span style="display:flex;"><span>        gpu_end = time.time()
</span></span><span style="display:flex;"><span>        gpu_active_time += (gpu_end - gpu_start)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f"># CPUåå¤„ç†</span>
</span></span><span style="display:flex;"><span>        postprocess_start = time.time()
</span></span><span style="display:flex;"><span>        final_result = simulate_cpu_postprocessing(request_id, result, postprocess_time)
</span></span><span style="display:flex;"><span>        postprocess_end = time.time()
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    end_time = time.time()
</span></span><span style="display:flex;"><span>    total_time = end_time - start_time
</span></span><span style="display:flex;"><span>    gpu_utilization = gpu_active_time / total_time * <span style="color:#ff0;font-weight:bold">100</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">print</span>(<span style="color:#0ff;font-weight:bold">f</span><span style="color:#0ff;font-weight:bold">&#34;ä¼ ç»Ÿæ–¹å¼å®Œæˆæ—¶é—´: </span><span style="color:#0ff;font-weight:bold">{</span>total_time<span style="color:#0ff;font-weight:bold">:</span><span style="color:#0ff;font-weight:bold">.2f</span><span style="color:#0ff;font-weight:bold">}</span><span style="color:#0ff;font-weight:bold"> ç§’&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">print</span>(<span style="color:#0ff;font-weight:bold">f</span><span style="color:#0ff;font-weight:bold">&#34;GPUæ´»è·ƒæ—¶é—´: </span><span style="color:#0ff;font-weight:bold">{</span>gpu_active_time<span style="color:#0ff;font-weight:bold">:</span><span style="color:#0ff;font-weight:bold">.2f</span><span style="color:#0ff;font-weight:bold">}</span><span style="color:#0ff;font-weight:bold"> ç§’&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">print</span>(<span style="color:#0ff;font-weight:bold">f</span><span style="color:#0ff;font-weight:bold">&#34;GPUåˆ©ç”¨ç‡: </span><span style="color:#0ff;font-weight:bold">{</span>gpu_utilization<span style="color:#0ff;font-weight:bold">:</span><span style="color:#0ff;font-weight:bold">.2f</span><span style="color:#0ff;font-weight:bold">}</span><span style="color:#0ff;font-weight:bold">%&#34;</span>)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">return</span> total_time, gpu_utilization
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># GPUè¿›ç¨‹ï¼šæ¥æ”¶è¾“å…¥æ•°æ®ï¼Œæ‰§è¡ŒGPUè®¡ç®—ï¼Œè¿”å›ç»“æœ</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">def</span> gpu_worker(port_recv=<span style="color:#ff0;font-weight:bold">5555</span>, port_send=<span style="color:#ff0;font-weight:bold">5556</span>):
</span></span><span style="display:flex;"><span>    <span style="color:#0ff;font-weight:bold">&#34;&#34;&#34;GPUå·¥ä½œè¿›ç¨‹ï¼Œæ¥æ”¶è¾“å…¥æ•°æ®ï¼Œæ‰§è¡ŒGPUè®¡ç®—ï¼Œå‘é€ç»“æœ&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    context = zmq.Context()
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f"># è®¾ç½®æ¥æ”¶è¾“å…¥æ•°æ®çš„PULL socket</span>
</span></span><span style="display:flex;"><span>    receiver = context.socket(zmq.PULL)
</span></span><span style="display:flex;"><span>    receiver.bind(<span style="color:#0ff;font-weight:bold">f</span><span style="color:#0ff;font-weight:bold">&#34;tcp://*:</span><span style="color:#0ff;font-weight:bold">{</span>port_recv<span style="color:#0ff;font-weight:bold">}</span><span style="color:#0ff;font-weight:bold">&#34;</span>)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f"># è®¾ç½®å‘é€ç»“æœçš„PUSH socket</span>
</span></span><span style="display:flex;"><span>    sender = context.socket(zmq.PUSH)
</span></span><span style="display:flex;"><span>    sender.bind(<span style="color:#0ff;font-weight:bold">f</span><span style="color:#0ff;font-weight:bold">&#34;tcp://*:</span><span style="color:#0ff;font-weight:bold">{</span>port_send<span style="color:#0ff;font-weight:bold">}</span><span style="color:#0ff;font-weight:bold">&#34;</span>)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">print</span>(<span style="color:#0ff;font-weight:bold">&#34;GPUå·¥ä½œè¿›ç¨‹å·²å¯åŠ¨&#34;</span>)
</span></span><span style="display:flex;"><span>    gpu_active_time = <span style="color:#ff0;font-weight:bold">0</span>
</span></span><span style="display:flex;"><span>    processed_count = <span style="color:#ff0;font-weight:bold">0</span>
</span></span><span style="display:flex;"><span>    start_time = time.time()
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f"># è®°å½•æ¯æ¬¡GPUæ´»åŠ¨çš„å¼€å§‹å’Œç»“æŸæ—¶é—´</span>
</span></span><span style="display:flex;"><span>    gpu_activity_periods = []
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">try</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">while</span> <span style="color:#fff;font-weight:bold">True</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f"># æ¥æ”¶ä»»åŠ¡</span>
</span></span><span style="display:flex;"><span>            message = receiver.recv_pyobj()
</span></span><span style="display:flex;"><span>            
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f"># æ£€æŸ¥æ˜¯å¦æ˜¯ç»ˆæ­¢ä¿¡å·</span>
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">if</span> message == <span style="color:#0ff;font-weight:bold">&#34;DONE&#34;</span>:
</span></span><span style="display:flex;"><span>                <span style="color:#fff;font-weight:bold">print</span>(<span style="color:#0ff;font-weight:bold">&#34;GPUå·¥ä½œè¿›ç¨‹æ”¶åˆ°ç»ˆæ­¢ä¿¡å·&#34;</span>)
</span></span><span style="display:flex;"><span>                <span style="color:#007f7f"># å‘é€GPUåˆ©ç”¨ç‡ä¿¡æ¯</span>
</span></span><span style="display:flex;"><span>                total_time = time.time() - start_time
</span></span><span style="display:flex;"><span>                gpu_utilization = gpu_active_time / total_time * <span style="color:#ff0;font-weight:bold">100</span> <span style="color:#fff;font-weight:bold">if</span> total_time &gt; <span style="color:#ff0;font-weight:bold">0</span> <span style="color:#fff;font-weight:bold">else</span> <span style="color:#ff0;font-weight:bold">0</span>
</span></span><span style="display:flex;"><span>                sender.send_pyobj({
</span></span><span style="display:flex;"><span>                    <span style="color:#0ff;font-weight:bold">&#34;type&#34;</span>: <span style="color:#0ff;font-weight:bold">&#34;STATS&#34;</span>,
</span></span><span style="display:flex;"><span>                    <span style="color:#0ff;font-weight:bold">&#34;gpu_active_time&#34;</span>: gpu_active_time,
</span></span><span style="display:flex;"><span>                    <span style="color:#0ff;font-weight:bold">&#34;total_time&#34;</span>: total_time,
</span></span><span style="display:flex;"><span>                    <span style="color:#0ff;font-weight:bold">&#34;gpu_utilization&#34;</span>: gpu_utilization,
</span></span><span style="display:flex;"><span>                    <span style="color:#0ff;font-weight:bold">&#34;processed_count&#34;</span>: processed_count,
</span></span><span style="display:flex;"><span>                    <span style="color:#0ff;font-weight:bold">&#34;gpu_activity_periods&#34;</span>: gpu_activity_periods
</span></span><span style="display:flex;"><span>                })
</span></span><span style="display:flex;"><span>                <span style="color:#fff;font-weight:bold">break</span>
</span></span><span style="display:flex;"><span>            
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f"># è§£åŒ…ä»»åŠ¡æ•°æ®</span>
</span></span><span style="display:flex;"><span>            request_id, input_data, gpu_time = message
</span></span><span style="display:flex;"><span>            
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f"># æ‰§è¡ŒGPUè®¡ç®—</span>
</span></span><span style="display:flex;"><span>            gpu_start = time.time()
</span></span><span style="display:flex;"><span>            result = simulate_gpu_computation(input_data, gpu_time)
</span></span><span style="display:flex;"><span>            gpu_end = time.time()
</span></span><span style="display:flex;"><span>            
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f"># è®°å½•GPUæ´»åŠ¨æ—¶é—´æ®µ</span>
</span></span><span style="display:flex;"><span>            gpu_activity_periods.append((gpu_start, gpu_end))
</span></span><span style="display:flex;"><span>            
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f"># æ›´æ–°GPUæ´»è·ƒæ—¶é—´</span>
</span></span><span style="display:flex;"><span>            gpu_active_time += (gpu_end - gpu_start)
</span></span><span style="display:flex;"><span>            processed_count += <span style="color:#ff0;font-weight:bold">1</span>
</span></span><span style="display:flex;"><span>            
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f"># å‘é€ç»“æœ</span>
</span></span><span style="display:flex;"><span>            sender.send_pyobj((request_id, result))
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">except</span> Exception <span style="color:#fff;font-weight:bold">as</span> e:
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">print</span>(<span style="color:#0ff;font-weight:bold">f</span><span style="color:#0ff;font-weight:bold">&#34;GPUå·¥ä½œè¿›ç¨‹é”™è¯¯: </span><span style="color:#0ff;font-weight:bold">{</span>e<span style="color:#0ff;font-weight:bold">}</span><span style="color:#0ff;font-weight:bold">&#34;</span>)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">finally</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f"># å…³é—­è¿æ¥</span>
</span></span><span style="display:flex;"><span>        receiver.close()
</span></span><span style="display:flex;"><span>        sender.close()
</span></span><span style="display:flex;"><span>        context.term()
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">print</span>(<span style="color:#0ff;font-weight:bold">&#34;GPUå·¥ä½œè¿›ç¨‹å·²ç»ˆæ­¢&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># CPUè¿›ç¨‹ï¼šç”Ÿæˆè¯·æ±‚ï¼Œé¢„å¤„ç†ï¼Œå‘é€åˆ°GPUï¼Œæ¥æ”¶ç»“æœï¼Œåå¤„ç†</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">def</span> zmq_approach(num_requests=<span style="color:#ff0;font-weight:bold">10</span>, matrix_size=<span style="color:#ff0;font-weight:bold">100</span>, 
</span></span><span style="display:flex;"><span>                preprocess_time=<span style="color:#ff0;font-weight:bold">0.05</span>, gpu_time=<span style="color:#ff0;font-weight:bold">0.1</span>, postprocess_time=<span style="color:#ff0;font-weight:bold">0.05</span>):
</span></span><span style="display:flex;"><span>    <span style="color:#0ff;font-weight:bold">&#34;&#34;&#34;ä½¿ç”¨ZeroMQåˆ†ç¦»CPUå’ŒGPUæ“ä½œ&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">print</span>(<span style="color:#0ff;font-weight:bold">&#34;</span><span style="color:#0ff;font-weight:bold">\n</span><span style="color:#0ff;font-weight:bold">è¿è¡ŒZeroMQæ–¹å¼ï¼ˆåˆ†ç¦»CPUå’ŒGPUæ“ä½œï¼‰...&#34;</span>)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f"># å¯åŠ¨GPUå·¥ä½œè¿›ç¨‹</span>
</span></span><span style="display:flex;"><span>    gpu_process = multiprocessing.Process(target=gpu_worker)
</span></span><span style="display:flex;"><span>    gpu_process.daemon = <span style="color:#fff;font-weight:bold">True</span>
</span></span><span style="display:flex;"><span>    gpu_process.start()
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f"># ç»™GPUè¿›ç¨‹ä¸€ç‚¹æ—¶é—´å¯åŠ¨</span>
</span></span><span style="display:flex;"><span>    time.sleep(<span style="color:#ff0;font-weight:bold">0.5</span>)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f"># åˆ›å»ºZeroMQä¸Šä¸‹æ–‡</span>
</span></span><span style="display:flex;"><span>    context = zmq.Context()
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f"># è®¾ç½®å‘é€è¾“å…¥æ•°æ®çš„PUSH socket</span>
</span></span><span style="display:flex;"><span>    sender = context.socket(zmq.PUSH)
</span></span><span style="display:flex;"><span>    sender.connect(<span style="color:#0ff;font-weight:bold">&#34;tcp://localhost:5555&#34;</span>)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f"># è®¾ç½®æ¥æ”¶ç»“æœçš„PULL socket</span>
</span></span><span style="display:flex;"><span>    receiver = context.socket(zmq.PULL)
</span></span><span style="display:flex;"><span>    receiver.connect(<span style="color:#0ff;font-weight:bold">&#34;tcp://localhost:5556&#34;</span>)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f"># å¼€å§‹è®¡æ—¶</span>
</span></span><span style="display:flex;"><span>    start_time = time.time()
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f"># åˆ›å»ºç»“æœå­—å…¸</span>
</span></span><span style="display:flex;"><span>    results = {}
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f"># è®°å½•CPUæ´»åŠ¨æ—¶é—´æ®µ</span>
</span></span><span style="display:flex;"><span>    cpu_activity_periods = []
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f"># å¯åŠ¨é¢„å¤„ç†å’Œå‘é€çº¿ç¨‹</span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">def</span> preprocess_and_send():
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">for</span> i in <span style="color:#fff;font-weight:bold">range</span>(num_requests):
</span></span><span style="display:flex;"><span>            request_id = <span style="color:#0ff;font-weight:bold">f</span><span style="color:#0ff;font-weight:bold">&#34;req_</span><span style="color:#0ff;font-weight:bold">{</span>i<span style="color:#0ff;font-weight:bold">}</span><span style="color:#0ff;font-weight:bold">&#34;</span>
</span></span><span style="display:flex;"><span>            
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f"># CPUé¢„å¤„ç†å¼€å§‹</span>
</span></span><span style="display:flex;"><span>            cpu_start = time.time()
</span></span><span style="display:flex;"><span>            
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f"># CPUé¢„å¤„ç†</span>
</span></span><span style="display:flex;"><span>            input_data = simulate_cpu_preprocessing(request_id, matrix_size, preprocess_time)
</span></span><span style="display:flex;"><span>            
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f"># CPUé¢„å¤„ç†ç»“æŸ</span>
</span></span><span style="display:flex;"><span>            cpu_end = time.time()
</span></span><span style="display:flex;"><span>            
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f"># è®°å½•CPUé¢„å¤„ç†æ—¶é—´æ®µ</span>
</span></span><span style="display:flex;"><span>            cpu_activity_periods.append((<span style="color:#0ff;font-weight:bold">&#34;preprocess&#34;</span>, cpu_start, cpu_end))
</span></span><span style="display:flex;"><span>            
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f"># å‘é€åˆ°GPUè¿›ç¨‹</span>
</span></span><span style="display:flex;"><span>            sender.send_pyobj((request_id, input_data, gpu_time))
</span></span><span style="display:flex;"><span>            
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f"># ç®€å•çš„è¿›åº¦æ˜¾ç¤º</span>
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">if</span> (i + <span style="color:#ff0;font-weight:bold">1</span>) % <span style="color:#ff0;font-weight:bold">10</span> == <span style="color:#ff0;font-weight:bold">0</span> or i == num_requests - <span style="color:#ff0;font-weight:bold">1</span>:
</span></span><span style="display:flex;"><span>                <span style="color:#fff;font-weight:bold">print</span>(<span style="color:#0ff;font-weight:bold">f</span><span style="color:#0ff;font-weight:bold">&#34;å·²å‘é€ </span><span style="color:#0ff;font-weight:bold">{</span>i + <span style="color:#ff0;font-weight:bold">1</span><span style="color:#0ff;font-weight:bold">}</span><span style="color:#0ff;font-weight:bold">/</span><span style="color:#0ff;font-weight:bold">{</span>num_requests<span style="color:#0ff;font-weight:bold">}</span><span style="color:#0ff;font-weight:bold"> ä¸ªè¯·æ±‚&#34;</span>)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    send_thread = threading.Thread(target=preprocess_and_send)
</span></span><span style="display:flex;"><span>    send_thread.daemon = <span style="color:#fff;font-weight:bold">True</span>
</span></span><span style="display:flex;"><span>    send_thread.start()
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f"># æ¥æ”¶ç»“æœå’Œåå¤„ç†</span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">for</span> _ in tqdm(<span style="color:#fff;font-weight:bold">range</span>(num_requests), desc=<span style="color:#0ff;font-weight:bold">&#34;æ¥æ”¶å’Œå¤„ç†ç»“æœ&#34;</span>):
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f"># æ¥æ”¶ç»“æœ</span>
</span></span><span style="display:flex;"><span>        message = receiver.recv_pyobj()
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f"># å¤„ç†ç»“æœ</span>
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">if</span> <span style="color:#fff;font-weight:bold">isinstance</span>(message, <span style="color:#fff;font-weight:bold">dict</span>) and message.get(<span style="color:#0ff;font-weight:bold">&#34;type&#34;</span>) == <span style="color:#0ff;font-weight:bold">&#34;STATS&#34;</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f"># è¿™æ˜¯GPUè¿›ç¨‹å‘é€çš„ç»Ÿè®¡ä¿¡æ¯</span>
</span></span><span style="display:flex;"><span>            gpu_stats = message
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">continue</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        request_id, result = message
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f"># CPUåå¤„ç†å¼€å§‹</span>
</span></span><span style="display:flex;"><span>        cpu_start = time.time()
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f"># CPUåå¤„ç†</span>
</span></span><span style="display:flex;"><span>        final_result = simulate_cpu_postprocessing(request_id, result, postprocess_time)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f"># CPUåå¤„ç†ç»“æŸ</span>
</span></span><span style="display:flex;"><span>        cpu_end = time.time()
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f"># è®°å½•CPUåå¤„ç†æ—¶é—´æ®µ</span>
</span></span><span style="display:flex;"><span>        cpu_activity_periods.append((<span style="color:#0ff;font-weight:bold">&#34;postprocess&#34;</span>, cpu_start, cpu_end))
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f"># å­˜å‚¨ç»“æœ</span>
</span></span><span style="display:flex;"><span>        results[request_id] = final_result
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f"># å‘é€ç»ˆæ­¢ä¿¡å·ç»™GPUè¿›ç¨‹</span>
</span></span><span style="display:flex;"><span>    sender.send_pyobj(<span style="color:#0ff;font-weight:bold">&#34;DONE&#34;</span>)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f"># æ¥æ”¶GPUç»Ÿè®¡ä¿¡æ¯</span>
</span></span><span style="display:flex;"><span>    gpu_stats = receiver.recv_pyobj()
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f"># ç­‰å¾…GPUè¿›ç¨‹ç»ˆæ­¢</span>
</span></span><span style="display:flex;"><span>    gpu_process.join(timeout=<span style="color:#ff0;font-weight:bold">1</span>)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f"># ç»“æŸè®¡æ—¶</span>
</span></span><span style="display:flex;"><span>    end_time = time.time()
</span></span><span style="display:flex;"><span>    total_time = end_time - start_time
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f"># è®¡ç®—CPU-GPUé‡å æ—¶é—´</span>
</span></span><span style="display:flex;"><span>    gpu_periods = gpu_stats[<span style="color:#0ff;font-weight:bold">&#39;gpu_activity_periods&#39;</span>]
</span></span><span style="display:flex;"><span>    overlap_time = calculate_overlap(cpu_activity_periods, gpu_periods)
</span></span><span style="display:flex;"><span>    overlap_percentage = (overlap_time / total_time) * <span style="color:#ff0;font-weight:bold">100</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f"># å…³é—­ZeroMQè¿æ¥</span>
</span></span><span style="display:flex;"><span>    sender.close()
</span></span><span style="display:flex;"><span>    receiver.close()
</span></span><span style="display:flex;"><span>    context.term()
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">print</span>(<span style="color:#0ff;font-weight:bold">f</span><span style="color:#0ff;font-weight:bold">&#34;ZeroMQæ–¹å¼å®Œæˆæ—¶é—´: </span><span style="color:#0ff;font-weight:bold">{</span>total_time<span style="color:#0ff;font-weight:bold">:</span><span style="color:#0ff;font-weight:bold">.2f</span><span style="color:#0ff;font-weight:bold">}</span><span style="color:#0ff;font-weight:bold"> ç§’&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">print</span>(<span style="color:#0ff;font-weight:bold">f</span><span style="color:#0ff;font-weight:bold">&#34;GPUæ´»è·ƒæ—¶é—´: </span><span style="color:#0ff;font-weight:bold">{</span>gpu_stats[<span style="color:#0ff;font-weight:bold">&#39;gpu_active_time&#39;</span>]<span style="color:#0ff;font-weight:bold">:</span><span style="color:#0ff;font-weight:bold">.2f</span><span style="color:#0ff;font-weight:bold">}</span><span style="color:#0ff;font-weight:bold"> ç§’&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">print</span>(<span style="color:#0ff;font-weight:bold">f</span><span style="color:#0ff;font-weight:bold">&#34;CPUæ´»è·ƒæ—¶é—´: </span><span style="color:#0ff;font-weight:bold">{</span><span style="color:#fff;font-weight:bold">sum</span>([end-start <span style="color:#fff;font-weight:bold">for</span> _, start, end in cpu_activity_periods])<span style="color:#0ff;font-weight:bold">:</span><span style="color:#0ff;font-weight:bold">.2f</span><span style="color:#0ff;font-weight:bold">}</span><span style="color:#0ff;font-weight:bold"> ç§’&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">print</span>(<span style="color:#0ff;font-weight:bold">f</span><span style="color:#0ff;font-weight:bold">&#34;CPU-GPUé‡å æ—¶é—´: </span><span style="color:#0ff;font-weight:bold">{</span>overlap_time<span style="color:#0ff;font-weight:bold">:</span><span style="color:#0ff;font-weight:bold">.2f</span><span style="color:#0ff;font-weight:bold">}</span><span style="color:#0ff;font-weight:bold"> ç§’ (</span><span style="color:#0ff;font-weight:bold">{</span>overlap_percentage<span style="color:#0ff;font-weight:bold">:</span><span style="color:#0ff;font-weight:bold">.2f</span><span style="color:#0ff;font-weight:bold">}</span><span style="color:#0ff;font-weight:bold">%)&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">print</span>(<span style="color:#0ff;font-weight:bold">f</span><span style="color:#0ff;font-weight:bold">&#34;GPUåˆ©ç”¨ç‡: </span><span style="color:#0ff;font-weight:bold">{</span>gpu_stats[<span style="color:#0ff;font-weight:bold">&#39;gpu_utilization&#39;</span>]<span style="color:#0ff;font-weight:bold">:</span><span style="color:#0ff;font-weight:bold">.2f</span><span style="color:#0ff;font-weight:bold">}</span><span style="color:#0ff;font-weight:bold">%&#34;</span>)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">return</span> total_time, gpu_stats[<span style="color:#0ff;font-weight:bold">&#39;gpu_utilization&#39;</span>], overlap_percentage
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">def</span> calculate_overlap(cpu_periods, gpu_periods):
</span></span><span style="display:flex;"><span>    <span style="color:#0ff;font-weight:bold">&#34;&#34;&#34;è®¡ç®—CPUå’ŒGPUæ´»åŠ¨æ—¶é—´çš„é‡å éƒ¨åˆ†&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f"># å°†CPUé¢„å¤„ç†å’Œåå¤„ç†æ—¶é—´æ®µåˆå¹¶ä¸ºå•ä¸€åˆ—è¡¨</span>
</span></span><span style="display:flex;"><span>    cpu_time_ranges = [(start, end) <span style="color:#fff;font-weight:bold">for</span> _, start, end in cpu_periods]
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f"># åˆå§‹åŒ–é‡å æ—¶é—´</span>
</span></span><span style="display:flex;"><span>    total_overlap = <span style="color:#ff0;font-weight:bold">0.0</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f"># å¯¹æ¯ä¸ªGPUæ—¶é—´æ®µï¼Œè®¡ç®—ä¸æ‰€æœ‰CPUæ—¶é—´æ®µçš„é‡å </span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">for</span> gpu_start, gpu_end in gpu_periods:
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">for</span> cpu_start, cpu_end in cpu_time_ranges:
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f"># è®¡ç®—é‡å éƒ¨åˆ†</span>
</span></span><span style="display:flex;"><span>            overlap_start = <span style="color:#fff;font-weight:bold">max</span>(gpu_start, cpu_start)
</span></span><span style="display:flex;"><span>            overlap_end = <span style="color:#fff;font-weight:bold">min</span>(gpu_end, cpu_end)
</span></span><span style="display:flex;"><span>            
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f"># å¦‚æœæœ‰é‡å ï¼Œç´¯åŠ é‡å æ—¶é—´</span>
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">if</span> overlap_end &gt; overlap_start:
</span></span><span style="display:flex;"><span>                total_overlap += (overlap_end - overlap_start)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">return</span> total_overlap
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">def</span> compare_performance(num_requests=<span style="color:#ff0;font-weight:bold">50</span>):
</span></span><span style="display:flex;"><span>    <span style="color:#0ff;font-weight:bold">&#34;&#34;&#34;æ¯”è¾ƒä¼ ç»Ÿæ–¹å¼å’ŒZeroMQæ–¹å¼çš„æ€§èƒ½&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f"># è®¾ç½®å‚æ•°</span>
</span></span><span style="display:flex;"><span>    matrix_size = <span style="color:#ff0;font-weight:bold">100</span>
</span></span><span style="display:flex;"><span>    preprocess_time = <span style="color:#ff0;font-weight:bold">0.05</span>  <span style="color:#007f7f"># CPUé¢„å¤„ç†æ—¶é—´</span>
</span></span><span style="display:flex;"><span>    gpu_time = <span style="color:#ff0;font-weight:bold">0.1</span>         <span style="color:#007f7f"># GPUè®¡ç®—æ—¶é—´</span>
</span></span><span style="display:flex;"><span>    postprocess_time = <span style="color:#ff0;font-weight:bold">0.05</span>  <span style="color:#007f7f"># CPUåå¤„ç†æ—¶é—´</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f"># è¿è¡Œä¼ ç»Ÿæ–¹å¼</span>
</span></span><span style="display:flex;"><span>    trad_time, trad_gpu_util = traditional_approach(
</span></span><span style="display:flex;"><span>        num_requests, matrix_size, preprocess_time, gpu_time, postprocess_time
</span></span><span style="display:flex;"><span>    )
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f"># è¿è¡ŒZeroMQæ–¹å¼</span>
</span></span><span style="display:flex;"><span>    zmq_time, zmq_gpu_util, overlap_percentage = zmq_approach(
</span></span><span style="display:flex;"><span>        num_requests, matrix_size, preprocess_time, gpu_time, postprocess_time
</span></span><span style="display:flex;"><span>    )
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f"># è®¡ç®—åŠ é€Ÿæ¯”</span>
</span></span><span style="display:flex;"><span>    speedup = trad_time / zmq_time
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">print</span>(<span style="color:#0ff;font-weight:bold">&#34;</span><span style="color:#0ff;font-weight:bold">\n</span><span style="color:#0ff;font-weight:bold">===== æ€§èƒ½å¯¹æ¯” =====&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">print</span>(<span style="color:#0ff;font-weight:bold">f</span><span style="color:#0ff;font-weight:bold">&#34;ä¼ ç»Ÿæ–¹å¼æ‰§è¡Œæ—¶é—´: </span><span style="color:#0ff;font-weight:bold">{</span>trad_time<span style="color:#0ff;font-weight:bold">:</span><span style="color:#0ff;font-weight:bold">.2f</span><span style="color:#0ff;font-weight:bold">}</span><span style="color:#0ff;font-weight:bold"> ç§’, GPUåˆ©ç”¨ç‡: </span><span style="color:#0ff;font-weight:bold">{</span>trad_gpu_util<span style="color:#0ff;font-weight:bold">:</span><span style="color:#0ff;font-weight:bold">.2f</span><span style="color:#0ff;font-weight:bold">}</span><span style="color:#0ff;font-weight:bold">%&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">print</span>(<span style="color:#0ff;font-weight:bold">f</span><span style="color:#0ff;font-weight:bold">&#34;ZeroMQæ–¹å¼æ‰§è¡Œæ—¶é—´: </span><span style="color:#0ff;font-weight:bold">{</span>zmq_time<span style="color:#0ff;font-weight:bold">:</span><span style="color:#0ff;font-weight:bold">.2f</span><span style="color:#0ff;font-weight:bold">}</span><span style="color:#0ff;font-weight:bold"> ç§’, GPUåˆ©ç”¨ç‡: </span><span style="color:#0ff;font-weight:bold">{</span>zmq_gpu_util<span style="color:#0ff;font-weight:bold">:</span><span style="color:#0ff;font-weight:bold">.2f</span><span style="color:#0ff;font-weight:bold">}</span><span style="color:#0ff;font-weight:bold">%&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">print</span>(<span style="color:#0ff;font-weight:bold">f</span><span style="color:#0ff;font-weight:bold">&#34;CPU-GPUé‡å æ¯”ä¾‹: </span><span style="color:#0ff;font-weight:bold">{</span>overlap_percentage<span style="color:#0ff;font-weight:bold">:</span><span style="color:#0ff;font-weight:bold">.2f</span><span style="color:#0ff;font-weight:bold">}</span><span style="color:#0ff;font-weight:bold">%&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">print</span>(<span style="color:#0ff;font-weight:bold">f</span><span style="color:#0ff;font-weight:bold">&#34;åŠ é€Ÿæ¯”: </span><span style="color:#0ff;font-weight:bold">{</span>speedup<span style="color:#0ff;font-weight:bold">:</span><span style="color:#0ff;font-weight:bold">.2f</span><span style="color:#0ff;font-weight:bold">}</span><span style="color:#0ff;font-weight:bold">x&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">print</span>(<span style="color:#0ff;font-weight:bold">f</span><span style="color:#0ff;font-weight:bold">&#34;GPUåˆ©ç”¨ç‡æå‡: </span><span style="color:#0ff;font-weight:bold">{</span>zmq_gpu_util - trad_gpu_util<span style="color:#0ff;font-weight:bold">:</span><span style="color:#0ff;font-weight:bold">.2f</span><span style="color:#0ff;font-weight:bold">}</span><span style="color:#0ff;font-weight:bold">%&#34;</span>)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f"># ç»˜åˆ¶æ€§èƒ½å¯¹æ¯”å›¾</span>
</span></span><span style="display:flex;"><span>    fig = Figure(figsize=(<span style="color:#ff0;font-weight:bold">15</span>, <span style="color:#ff0;font-weight:bold">5</span>))
</span></span><span style="display:flex;"><span>    canvas = FigureCanvas(fig)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f"># æ‰§è¡Œæ—¶é—´å¯¹æ¯”</span>
</span></span><span style="display:flex;"><span>    ax1 = fig.add_subplot(<span style="color:#ff0;font-weight:bold">131</span>)
</span></span><span style="display:flex;"><span>    methods = [<span style="color:#0ff;font-weight:bold">&#39;Traditional&#39;</span>, <span style="color:#0ff;font-weight:bold">&#39;ZeroMQ&#39;</span>]
</span></span><span style="display:flex;"><span>    times = [trad_time, zmq_time]
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    ax1.bar(methods, times, color=[<span style="color:#0ff;font-weight:bold">&#39;blue&#39;</span>, <span style="color:#0ff;font-weight:bold">&#39;green&#39;</span>])
</span></span><span style="display:flex;"><span>    ax1.set_ylabel(<span style="color:#0ff;font-weight:bold">&#39;Execution Time (seconds)&#39;</span>)
</span></span><span style="display:flex;"><span>    ax1.set_title(<span style="color:#0ff;font-weight:bold">&#39;Execution Time Comparison&#39;</span>)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f"># æ·»åŠ æ•°å€¼æ ‡ç­¾</span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">for</span> i, v in <span style="color:#fff;font-weight:bold">enumerate</span>(times):
</span></span><span style="display:flex;"><span>        ax1.text(i, v + <span style="color:#ff0;font-weight:bold">0.1</span>, <span style="color:#0ff;font-weight:bold">f</span><span style="color:#0ff;font-weight:bold">&#34;</span><span style="color:#0ff;font-weight:bold">{</span>v<span style="color:#0ff;font-weight:bold">:</span><span style="color:#0ff;font-weight:bold">.2f</span><span style="color:#0ff;font-weight:bold">}</span><span style="color:#0ff;font-weight:bold">s&#34;</span>, ha=<span style="color:#0ff;font-weight:bold">&#39;center&#39;</span>)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f"># æ·»åŠ åŠ é€Ÿæ¯”</span>
</span></span><span style="display:flex;"><span>    ax1.text(<span style="color:#ff0;font-weight:bold">0.5</span>, <span style="color:#fff;font-weight:bold">max</span>(times) * <span style="color:#ff0;font-weight:bold">0.5</span>, <span style="color:#0ff;font-weight:bold">f</span><span style="color:#0ff;font-weight:bold">&#34;Speedup: </span><span style="color:#0ff;font-weight:bold">{</span>speedup<span style="color:#0ff;font-weight:bold">:</span><span style="color:#0ff;font-weight:bold">.2f</span><span style="color:#0ff;font-weight:bold">}</span><span style="color:#0ff;font-weight:bold">x&#34;</span>, 
</span></span><span style="display:flex;"><span>            ha=<span style="color:#0ff;font-weight:bold">&#39;center&#39;</span>, fontsize=<span style="color:#ff0;font-weight:bold">12</span>, bbox=<span style="color:#fff;font-weight:bold">dict</span>(facecolor=<span style="color:#0ff;font-weight:bold">&#39;white&#39;</span>, alpha=<span style="color:#ff0;font-weight:bold">0.8</span>))
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f"># GPUåˆ©ç”¨ç‡å¯¹æ¯”</span>
</span></span><span style="display:flex;"><span>    ax2 = fig.add_subplot(<span style="color:#ff0;font-weight:bold">132</span>)
</span></span><span style="display:flex;"><span>    utils = [trad_gpu_util, zmq_gpu_util]
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    ax2.bar(methods, utils, color=[<span style="color:#0ff;font-weight:bold">&#39;blue&#39;</span>, <span style="color:#0ff;font-weight:bold">&#39;green&#39;</span>])
</span></span><span style="display:flex;"><span>    ax2.set_ylabel(<span style="color:#0ff;font-weight:bold">&#39;GPU Utilization (%)&#39;</span>)
</span></span><span style="display:flex;"><span>    ax2.set_title(<span style="color:#0ff;font-weight:bold">&#39;GPU Utilization Comparison&#39;</span>)
</span></span><span style="display:flex;"><span>    ax2.set_ylim(<span style="color:#ff0;font-weight:bold">0</span>, <span style="color:#ff0;font-weight:bold">100</span>)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f"># æ·»åŠ æ•°å€¼æ ‡ç­¾</span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">for</span> i, v in <span style="color:#fff;font-weight:bold">enumerate</span>(utils):
</span></span><span style="display:flex;"><span>        ax2.text(i, v + <span style="color:#ff0;font-weight:bold">1</span>, <span style="color:#0ff;font-weight:bold">f</span><span style="color:#0ff;font-weight:bold">&#34;</span><span style="color:#0ff;font-weight:bold">{</span>v<span style="color:#0ff;font-weight:bold">:</span><span style="color:#0ff;font-weight:bold">.2f</span><span style="color:#0ff;font-weight:bold">}</span><span style="color:#0ff;font-weight:bold">%&#34;</span>, ha=<span style="color:#0ff;font-weight:bold">&#39;center&#39;</span>)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f"># æ·»åŠ åˆ©ç”¨ç‡æå‡</span>
</span></span><span style="display:flex;"><span>    ax2.text(<span style="color:#ff0;font-weight:bold">0.5</span>, <span style="color:#ff0;font-weight:bold">50</span>, <span style="color:#0ff;font-weight:bold">f</span><span style="color:#0ff;font-weight:bold">&#34;Improvement: </span><span style="color:#0ff;font-weight:bold">{</span>zmq_gpu_util - trad_gpu_util<span style="color:#0ff;font-weight:bold">:</span><span style="color:#0ff;font-weight:bold">.2f</span><span style="color:#0ff;font-weight:bold">}</span><span style="color:#0ff;font-weight:bold">%&#34;</span>, 
</span></span><span style="display:flex;"><span>            ha=<span style="color:#0ff;font-weight:bold">&#39;center&#39;</span>, fontsize=<span style="color:#ff0;font-weight:bold">12</span>, bbox=<span style="color:#fff;font-weight:bold">dict</span>(facecolor=<span style="color:#0ff;font-weight:bold">&#39;white&#39;</span>, alpha=<span style="color:#ff0;font-weight:bold">0.8</span>))
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f"># CPU-GPUé‡å æ¯”ä¾‹</span>
</span></span><span style="display:flex;"><span>    ax3 = fig.add_subplot(<span style="color:#ff0;font-weight:bold">133</span>)
</span></span><span style="display:flex;"><span>    ax3.pie([overlap_percentage, <span style="color:#ff0;font-weight:bold">100</span>-overlap_percentage], 
</span></span><span style="display:flex;"><span>            labels=[<span style="color:#0ff;font-weight:bold">&#39;Overlap&#39;</span>, <span style="color:#0ff;font-weight:bold">&#39;Non-overlap&#39;</span>],
</span></span><span style="display:flex;"><span>            colors=[<span style="color:#0ff;font-weight:bold">&#39;green&#39;</span>, <span style="color:#0ff;font-weight:bold">&#39;lightgray&#39;</span>],
</span></span><span style="display:flex;"><span>            autopct=<span style="color:#0ff;font-weight:bold">&#39;</span><span style="color:#0ff;font-weight:bold">%1.1f%%</span><span style="color:#0ff;font-weight:bold">&#39;</span>,
</span></span><span style="display:flex;"><span>            startangle=<span style="color:#ff0;font-weight:bold">90</span>)
</span></span><span style="display:flex;"><span>    ax3.set_title(<span style="color:#0ff;font-weight:bold">&#39;CPU-GPU Overlap Percentage&#39;</span>)
</span></span><span style="display:flex;"><span>    ax3.axis(<span style="color:#0ff;font-weight:bold">&#39;equal&#39;</span>)  <span style="color:#007f7f"># Equal aspect ratio ensures that pie is drawn as a circle</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    fig.tight_layout()
</span></span><span style="display:flex;"><span>    fig.savefig(<span style="color:#0ff;font-weight:bold">&#34;vllm_simulation_comparison.png&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">print</span>(<span style="color:#0ff;font-weight:bold">&#34;æ€§èƒ½å¯¹æ¯”å›¾å·²ä¿å­˜ä¸º vllm_simulation_comparison.png&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">if</span> __name__ == <span style="color:#0ff;font-weight:bold">&#34;__main__&#34;</span>:
</span></span><span style="display:flex;"><span>    parser = argparse.ArgumentParser(description=<span style="color:#0ff;font-weight:bold">&#39;æ¨¡æ‹ŸvLLMæ¶æ„çš„ç®€åŒ–ç‰ˆæœ¬&#39;</span>)
</span></span><span style="display:flex;"><span>    parser.add_argument(<span style="color:#0ff;font-weight:bold">&#39;--requests&#39;</span>, <span style="color:#fff;font-weight:bold">type</span>=<span style="color:#fff;font-weight:bold">int</span>, default=<span style="color:#ff0;font-weight:bold">50</span>, help=<span style="color:#0ff;font-weight:bold">&#39;è¯·æ±‚æ•°é‡&#39;</span>)
</span></span><span style="display:flex;"><span>    args = parser.parse_args()
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f"># æ¯”è¾ƒæ€§èƒ½</span>
</span></span><span style="display:flex;"><span>    compare_performance(args.requests)
</span></span></code></pre></div>
</details></p>

<h4 id="æ€§èƒ½å¯¹æ¯”">æ€§èƒ½å¯¹æ¯”<a hidden class="anchor" aria-hidden="true" href="#æ€§èƒ½å¯¹æ¯”">#</a></h4>
<p>æˆ‘ä»¬æ¯”è¾ƒäº†ä¼ ç»Ÿé¡ºåºå¤„ç†å’Œ ZeroMQ å¹¶è¡Œå¤„ç†çš„æ€§èƒ½å·®å¼‚ï¼š</p>
<pre tabindex="0"><code>è¿è¡Œä¼ ç»Ÿæ–¹å¼ï¼ˆå•è¿›ç¨‹é¡ºåºæ‰§è¡Œï¼‰...
å¤„ç†è¯·æ±‚: 100%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| 50/50 [00:10&lt;00:00,  4.94it/s]
ä¼ ç»Ÿæ–¹å¼å®Œæˆæ—¶é—´: 10.13 ç§’
GPUæ´»è·ƒæ—¶é—´: 5.04 ç§’
GPUåˆ©ç”¨ç‡: 49.73%

è¿è¡ŒZeroMQæ–¹å¼ï¼ˆåˆ†ç¦»CPUå’ŒGPUæ“ä½œï¼‰...
GPUå·¥ä½œè¿›ç¨‹å·²å¯åŠ¨
æ¥æ”¶å’Œå¤„ç†ç»“æœ:   8%|â–ˆâ–ˆâ–ˆâ–ˆâ–                                                   | 4/50 [00:00&lt;00:05,  8.69it/s]å·²å‘é€ 10/50 ä¸ªè¯·æ±‚
æ¥æ”¶å’Œå¤„ç†ç»“æœ:  18%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ                                              | 9/50 [00:01&lt;00:04,  9.73it/s]å·²å‘é€ 20/50 ä¸ªè¯·æ±‚
æ¥æ”¶å’Œå¤„ç†ç»“æœ:  28%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–                                       | 14/50 [00:01&lt;00:03,  9.85it/s]å·²å‘é€ 30/50 ä¸ªè¯·æ±‚
æ¥æ”¶å’Œå¤„ç†ç»“æœ:  38%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‰                                  | 19/50 [00:02&lt;00:03,  9.89it/s]å·²å‘é€ 40/50 ä¸ªè¯·æ±‚
æ¥æ”¶å’Œå¤„ç†ç»“æœ:  46%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–                             | 23/50 [00:02&lt;00:02,  9.86it/s]å·²å‘é€ 50/50 ä¸ªè¯·æ±‚
æ¥æ”¶å’Œå¤„ç†ç»“æœ: 100%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| 50/50 [00:05&lt;00:00,  9.69it/s]
GPUå·¥ä½œè¿›ç¨‹æ”¶åˆ°ç»ˆæ­¢ä¿¡å·
GPUå·¥ä½œè¿›ç¨‹å·²ç»ˆæ­¢
ZeroMQæ–¹å¼å®Œæˆæ—¶é—´: 5.16 ç§’
GPUæ´»è·ƒæ—¶é—´: 5.04 ç§’
CPUæ´»è·ƒæ—¶é—´: 5.07 ç§’
CPU-GPUé‡å æ—¶é—´: 4.96 ç§’ (96.09%)
GPUåˆ©ç”¨ç‡: 89.08%

===== æ€§èƒ½å¯¹æ¯” =====
ä¼ ç»Ÿæ–¹å¼æ‰§è¡Œæ—¶é—´: 10.13 ç§’, GPUåˆ©ç”¨ç‡: 49.73%
ZeroMQæ–¹å¼æ‰§è¡Œæ—¶é—´: 5.16 ç§’, GPUåˆ©ç”¨ç‡: 89.08%
CPU-GPUé‡å æ¯”ä¾‹: 96.09%
åŠ é€Ÿæ¯”: 1.96x
GPUåˆ©ç”¨ç‡æå‡: 39.35%
</code></pre><p>é€šè¿‡ ZeroMQ å®ç°çš„ CPU-GPU å¹¶è¡Œå¤„ç†ï¼Œæˆ‘ä»¬è·å¾—äº†ä»¥ä¸‹ä¼˜åŠ¿ï¼š</p>
<ol>
<li><strong>æ›´é«˜çš„ GPU åˆ©ç”¨ç‡</strong></li>
<li><strong>æ›´çŸ­çš„æ€»æ‰§è¡Œæ—¶é—´</strong></li>
<li><strong>CPU å’Œ GPU æ›´å¥½çš„å·¥ä½œé‡å </strong></li>
</ol>
<h3 id="æ€»ç»“ä¸æœ€ä½³å®è·µ">æ€»ç»“ä¸æœ€ä½³å®è·µ<a hidden class="anchor" aria-hidden="true" href="#æ€»ç»“ä¸æœ€ä½³å®è·µ">#</a></h3>
<p>é€šè¿‡æœ¬æ•™ç¨‹ï¼Œæˆ‘ä»¬å±•ç¤ºäº†å¦‚ä½•ä½¿ç”¨ ZeroMQ çªç ´ Python GIL é™åˆ¶ï¼Œæ˜¾è‘—æå‡ CPU å¯†é›†å‹ä»»åŠ¡çš„æ€§èƒ½ï¼Œä»¥åŠå¦‚ä½•ä¼˜åŒ– CPU-GPU åä½œã€‚ä»¥ä¸‹æ˜¯ä¸€äº›æœ€ä½³å®è·µï¼š</p>
<h4 id="ä½•æ—¶ä½¿ç”¨-zeromq-è¿›è¡Œå¹¶è¡Œå¤„ç†">ä½•æ—¶ä½¿ç”¨ ZeroMQ è¿›è¡Œå¹¶è¡Œå¤„ç†<a hidden class="anchor" aria-hidden="true" href="#ä½•æ—¶ä½¿ç”¨-zeromq-è¿›è¡Œå¹¶è¡Œå¤„ç†">#</a></h4>
<ul>
<li><strong>CPU å¯†é›†å‹ä»»åŠ¡</strong>ï¼šè®¡ç®—å¯†é›†çš„æ“ä½œï¼Œå¦‚å›¾åƒå¤„ç†ã€æ•°å€¼è®¡ç®—ç­‰</li>
<li><strong>å¯æ‹†åˆ†çš„ä»»åŠ¡</strong>ï¼šèƒ½å¤Ÿè¢«åˆ†å‰²æˆç‹¬ç«‹å­ä»»åŠ¡çš„é—®é¢˜</li>
<li><strong>éœ€è¦çµæ´»é€šä¿¡æ¨¡å¼</strong>çš„åœºæ™¯ï¼šè¶…å‡ºç®€å•å¤šè¿›ç¨‹æ¨¡å‹çš„å¤æ‚é€šä¿¡éœ€æ±‚</li>
<li><strong>CPU-GPU åä½œä¼˜åŒ–</strong>ï¼šåœ¨æ·±åº¦å­¦ä¹ æ¨ç†ç­‰åœºæ™¯ä¸­ä¼˜åŒ–èµ„æºåˆ©ç”¨</li>
</ul>
<h4 id="zeromq-vs-python-åŸç”Ÿå¤šè¿›ç¨‹">ZeroMQ vs Python åŸç”Ÿå¤šè¿›ç¨‹<a hidden class="anchor" aria-hidden="true" href="#zeromq-vs-python-åŸç”Ÿå¤šè¿›ç¨‹">#</a></h4>
<ul>
<li><strong>ZeroMQ ä¼˜åŠ¿</strong>ï¼šæ›´çµæ´»çš„é€šä¿¡æ¨¡å¼ï¼Œæ›´å¥½çš„æ‰©å±•æ€§ï¼ˆå¯è·¨ç½‘ç»œï¼‰ï¼Œæ›´ç²¾ç»†çš„æ§åˆ¶</li>
<li><strong>åŸç”Ÿå¤šè¿›ç¨‹ä¼˜åŠ¿</strong>ï¼šä½¿ç”¨æ›´ç®€å•ï¼Œé€‚åˆä¸éœ€è¦å¤æ‚é€šä¿¡çš„åœºæ™¯</li>
</ul>
<h4 id="æ³¨æ„äº‹é¡¹">æ³¨æ„äº‹é¡¹<a hidden class="anchor" aria-hidden="true" href="#æ³¨æ„äº‹é¡¹">#</a></h4>
<ol>
<li><strong>è¿›ç¨‹é—´é€šä¿¡å¼€é”€</strong>ï¼šåˆ†å¸ƒå¼å¤„ç†è™½ç„¶èƒ½çªç ´ GIL é™åˆ¶ï¼Œä½†ä¹Ÿå¼•å…¥äº†é€šä¿¡å¼€é”€</li>
<li><strong>æ•°æ®åºåˆ—åŒ–</strong>ï¼šåœ¨è¿›ç¨‹é—´ä¼ é€’æ•°æ®éœ€è¦åºåˆ—åŒ–å’Œååºåˆ—åŒ–ï¼Œå¯¹äºå¤§å‹æ•°æ®å¯èƒ½æˆä¸ºç“¶é¢ˆ</li>
<li><strong>ä»»åŠ¡ç²’åº¦</strong>ï¼šå¤ªå°çš„ä»»åŠ¡ä¼šä½¿é€šä¿¡å¼€é”€è¶…è¿‡å¹¶è¡Œå¤„ç†çš„æ”¶ç›Šï¼Œå¤ªå¤§çš„ä»»åŠ¡ä¼šå½±å“è´Ÿè½½å‡è¡¡</li>
<li><strong>èµ„æºç®¡ç†</strong>ï¼šåœ¨ CPU-GPU å¹¶è¡Œåœºæ™¯ä¸­ï¼Œéœ€è¦åˆç†ç®¡ç†å†…å­˜å’Œè®¡ç®—èµ„æº</li>
</ol>
<p>é€šè¿‡åˆç†ä½¿ç”¨ ZeroMQ è¿›è¡Œåˆ†å¸ƒå¼å¤„ç†ï¼Œæˆ‘ä»¬å¯ä»¥å……åˆ†å‘æŒ¥å¤šæ ¸å¤„ç†å™¨å’Œ GPU çš„æ€§èƒ½ï¼Œæ˜¾è‘—æå‡ Python ç¨‹åºçš„æ‰§è¡Œæ•ˆç‡ï¼Œç‰¹åˆ«æ˜¯å¯¹äºè®¡ç®—å¯†é›†å‹ä»»åŠ¡å’Œæ·±åº¦å­¦ä¹ æ¨ç†åœºæ™¯ã€‚</p>

  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="https://blog.niuhemoon.win/tags/zeromq/">ZeroMQ</a></li>
      <li><a href="https://blog.niuhemoon.win/tags/%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/">æ€§èƒ½ä¼˜åŒ–</a></li>
      <li><a href="https://blog.niuhemoon.win/tags/%E5%88%86%E5%B8%83%E5%BC%8F%E8%AE%A1%E7%AE%97/">åˆ†å¸ƒå¼è®¡ç®—</a></li>
    </ul>
<div class="footer-comments">
  <p>For comments, please   <a href="mailto:carlton2tang@gmail.com" class="email-button" style="font-size: inherit; padding: 5px 10px; background-color: #3f6b9a; color: white; text-decoration: none; border-radius: 3px; transition: background-color 0.3s;">
    send an email
</a> to me</p>

</div>
<nav class="paginav">
  <a class="next" href="https://blog.niuhemoon.win/posts/tech/cpu%E4%B8%8A%E9%83%A8%E7%BD%B2qwen3%E5%B9%B6%E6%B5%8B%E8%AF%95%E9%80%9F%E5%BA%A6/">
    <span class="title">ä¸‹ä¸€é¡µ Â»</span>
    <br>
    <span>CPUä¸Šéƒ¨ç½²Qwen3æ¨¡å‹åŠæ€§èƒ½æµ‹è¯•</span>
  </a>
</nav>

  </footer>
</article>
    </main>
    
<footer class="footer">
      
    <span>&copy; 2025 <a href="https://blog.niuhemoon.win">Niuhe&#39;s Blog</a></span>
    <span xmlns:cc="http://creativecommons.org/ns#" xmlns:dct="http://purl.org/dc/terms/">
        Licensed under
        <a
          href="http://creativecommons.org/licenses/by-nc-sa/4.0/?ref=chooser-v1"
          target="_blank"
          rel="license noopener noreferrer"
          style="display:inline-block;"
          >CC BY-NC-SA 4.0 </a></span>
    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = 'ğŸ“„å¤åˆ¶';

        function copyingDone() {
            copybutton.innerHTML = 'ğŸ‘ŒğŸ»å·²å¤åˆ¶!';
            setTimeout(() => {
                copybutton.innerHTML = 'ğŸ“„å¤åˆ¶';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
