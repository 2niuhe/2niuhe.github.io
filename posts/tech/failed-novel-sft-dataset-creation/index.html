<!DOCTYPE html>
<html lang="zh" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>è®°å½•ä¸€æ¬¡å¤±è´¥çš„å°è¯´SFTæ•°æ®é›†åˆ›å»º | Niuhe&#39;s Blog</title>
<meta name="keywords" content="LLM, SFT, Dataset">
<meta name="description" content="æœ¬æ¥æƒ³æ‹¿å–œæ¬¢çš„å°è¯´åšæ•°æ®é›†ï¼Œç„¶ååˆ¶ä½œSFTæ•°æ®é›†ï¼Œé€šè¿‡å¾®è°ƒï¼Œè®©LLMå­¦ä¼šå°è¯´å†…å®¹ã€æ–‡é£ï¼Œä»è€Œåˆ†æäººç‰©å…³ç³»ï¼Œè¿›è¡Œç»­å†™ï¼Œä½†å°è¯•å¤±è´¥">
<meta name="author" content="Niuhe">
<link rel="canonical" href="https://blog.niuhemoon.win/posts/tech/failed-novel-sft-dataset-creation/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.3613efbd0b1772781e8f49935e973cae632a7f61471c05b17be155505ccf87b5.css" integrity="sha256-NhPvvQsXcngej0mTXpc8rmMqf2FHHAWxe&#43;FVUFzPh7U=" rel="preload stylesheet" as="style">
<script defer crossorigin="anonymous" src="/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js" integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG&#43;9vmJ0cTS&#43;ovo0FeA="
    onload="hljs.initHighlightingOnLoad();"></script>
<link rel="icon" href="https://blog.niuhemoon.win/base/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="https://blog.niuhemoon.win/base/favicon.ico">
<link rel="icon" type="image/png" sizes="32x32" href="https://blog.niuhemoon.win/base/favicon.ico">
<link rel="apple-touch-icon" href="https://blog.niuhemoon.win/base/avatar.jpeg">
<link rel="mask-icon" href="https://blog.niuhemoon.win/base/avatar.jpeg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --hljs-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript>
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
	ga('create', 'UA-116933089-1', 'auto');
	
	ga('send', 'pageview');
}
</script><meta property="og:title" content="è®°å½•ä¸€æ¬¡å¤±è´¥çš„å°è¯´SFTæ•°æ®é›†åˆ›å»º" />
<meta property="og:description" content="æœ¬æ¥æƒ³æ‹¿å–œæ¬¢çš„å°è¯´åšæ•°æ®é›†ï¼Œç„¶ååˆ¶ä½œSFTæ•°æ®é›†ï¼Œé€šè¿‡å¾®è°ƒï¼Œè®©LLMå­¦ä¼šå°è¯´å†…å®¹ã€æ–‡é£ï¼Œä»è€Œåˆ†æäººç‰©å…³ç³»ï¼Œè¿›è¡Œç»­å†™ï¼Œä½†å°è¯•å¤±è´¥" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://blog.niuhemoon.win/posts/tech/failed-novel-sft-dataset-creation/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2025-01-13T00:00:00+00:00" />
<meta property="article:modified_time" content="2025-03-15T00:00:00+00:00" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="è®°å½•ä¸€æ¬¡å¤±è´¥çš„å°è¯´SFTæ•°æ®é›†åˆ›å»º"/>
<meta name="twitter:description" content="æœ¬æ¥æƒ³æ‹¿å–œæ¬¢çš„å°è¯´åšæ•°æ®é›†ï¼Œç„¶ååˆ¶ä½œSFTæ•°æ®é›†ï¼Œé€šè¿‡å¾®è°ƒï¼Œè®©LLMå­¦ä¼šå°è¯´å†…å®¹ã€æ–‡é£ï¼Œä»è€Œåˆ†æäººç‰©å…³ç³»ï¼Œè¿›è¡Œç»­å†™ï¼Œä½†å°è¯•å¤±è´¥"/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "ğŸ“šæ–‡ç« ",
      "item": "https://blog.niuhemoon.win/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  3 ,
      "name": "ğŸ‘¨ğŸ»â€ğŸ’» æŠ€æœ¯",
      "item": "https://blog.niuhemoon.win/posts/tech/"
    }, 
    {
      "@type": "ListItem",
      "position":  4 ,
      "name": "è®°å½•ä¸€æ¬¡å¤±è´¥çš„å°è¯´SFTæ•°æ®é›†åˆ›å»º",
      "item": "https://blog.niuhemoon.win/posts/tech/failed-novel-sft-dataset-creation/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "è®°å½•ä¸€æ¬¡å¤±è´¥çš„å°è¯´SFTæ•°æ®é›†åˆ›å»º",
  "name": "è®°å½•ä¸€æ¬¡å¤±è´¥çš„å°è¯´SFTæ•°æ®é›†åˆ›å»º",
  "description": "æœ¬æ¥æƒ³æ‹¿å–œæ¬¢çš„å°è¯´åšæ•°æ®é›†ï¼Œç„¶ååˆ¶ä½œSFTæ•°æ®é›†ï¼Œé€šè¿‡å¾®è°ƒï¼Œè®©LLMå­¦ä¼šå°è¯´å†…å®¹ã€æ–‡é£ï¼Œä»è€Œåˆ†æäººç‰©å…³ç³»ï¼Œè¿›è¡Œç»­å†™ï¼Œä½†å°è¯•å¤±è´¥",
  "keywords": [
    "LLM", "SFT", "Dataset"
  ],
  "articleBody": "èƒŒæ™¯ä»‹ç» æœ€è¿‘æˆ‘ä¸€ç›´åœ¨ç ”ç©¶å¦‚ä½•è®©LLMæ›´å¥½åœ°ç†è§£å’Œç”Ÿæˆç‰¹å®šé¢†åŸŸçš„å†…å®¹ã€‚æˆ‘é€‰æ‹©äº†è‡ªå·±å–œæ¬¢çš„å°è¯´ã€Šé€é¥å°æ•£ä»™ã€‹ä½œä¸ºå®éªŒæ•°æ®ï¼Œå¸Œæœ›é€šè¿‡SFTï¼ˆSupervised Fine-Tuningï¼‰è®©æ¨¡å‹å­¦ä¹ å°è¯´çš„å†…å®¹ã€äººç‰©å…³ç³»å’Œå†™ä½œé£æ ¼ï¼Œæœ€ç»ˆèƒ½å¤Ÿè¿›è¡Œç›¸å…³çš„åˆ†æå’Œç»­å†™ã€‚è¿™ç¯‡æ–‡ç« è¯¦ç»†è®°å½•äº†æˆ‘çš„æ•°æ®é›†åˆ›å»ºè¿‡ç¨‹ï¼Œä»¥åŠæœ€ç»ˆçš„å¾®è°ƒç»“æœã€‚\næ•°æ®é›†åˆ›å»ºè¿‡ç¨‹ æ•°æ®é¢„å¤„ç† é¦–å…ˆå°†å°è¯´ç”¨calibreä»epubæ ¼å¼è½¬æˆtxtæ ¼å¼ï¼Œä¸ºåç»­çš„å¤„ç†åšå‡†å¤‡ã€‚\næ–¹æ³•ä¸€ï¼šä½¿ç”¨LLMæå–é—®ç­”æ•°æ® ç¬¬ä¸€ç§æ–¹æ³•æ˜¯ä½¿ç”¨LLMä»å°è¯´æ–‡æœ¬ä¸­æå–é—®ç­”å¯¹ã€‚è¿™ç§æ–¹æ³•çš„æ ¸å¿ƒæ€æƒ³æ˜¯å°†å°è¯´åˆ†æˆå¤šä¸ªæ®µè½ï¼Œç„¶åè®©LLMä¸ºæ¯ä¸ªæ®µè½ç”Ÿæˆç›¸å…³çš„é—®é¢˜å’Œç­”æ¡ˆã€‚\n1. è®¾ç½®LLMæ¥å£ é¦–å…ˆï¼Œæˆ‘åˆ›å»ºäº†llm.pyæ–‡ä»¶ï¼Œç”¨äºä¸LLM APIè¿›è¡Œäº¤äº’ï¼š\nfrom openai import OpenAI from typing import List, Dict import json import re BaseURL = 'https://api.aiproxy.io/v1' APIKEY = 'sk-xxxx' # å·²éšè—çœŸå®APIå¯†é’¥ Model = 'gpt-4o-mini-2024-07-18' # ä¹Ÿå¯ä»¥ä½¿ç”¨DeepSeek API # BaseURL='https://api.deepseek.com/v1' # APIKEY='sk-xxxx' # Model='deepseek-chat' client = OpenAI(api_key=APIKEY, base_url=BaseURL) def get_qa(raw_content, stream=False) -\u003e str: response = client.chat.completions.create( model=Model, messages=[ {'role': 'system', 'content': 'ä½ æ˜¯ä¸€ä½å°è¯´åˆ†æå¸ˆï¼Œè´Ÿè´£ä»ä»¥ä¸‹æ–‡æœ¬ä¸­æå–ä¿¡æ¯å¹¶ç”Ÿæˆé—®ç­”å¯¹ã€‚è¾“å‡ºæ ¼å¼è¦æ±‚:\\n```json\\n[{\"question\": \"*\", \"answer\": \"*\"}]```'}, {'role': 'user', 'content': f'è¯·ä»”ç»†é˜…è¯»æ–‡æœ¬,å¹¶æ ¹æ®æ–‡æœ¬å†…å®¹ç”Ÿæˆé—®é¢˜å’Œç­”æ¡ˆ,é—®ç­”å¯¹è¦åŒ…å«æ–‡æœ¬æ‰€æœ‰æœ‰æ•ˆä¿¡æ¯, é—®ç­”å¯¹äº’ç›¸ç‹¬ç«‹,çœ‹ä¸åˆ°å…¶å®ƒé—®é¢˜ã€‚ç¡®ä¿é—®é¢˜æ¶µç›–è§’è‰²ã€æƒ…èŠ‚ã€æƒ…æ„Ÿå’ŒèƒŒæ™¯ç­‰å¤šæ–¹é¢ã€‚ç­”æ¡ˆåº”ç›´æ¥å¤åˆ¶åŸæ–‡å†…å®¹ã€‚ç›´æ¥ç”¨JSONæ ¼å¼å›ç­”ã€‚æ–‡æœ¬:\\n[{raw_content}]\\nè¯·ç”ŸæˆJSONæ ¼å¼(åˆ—è¡¨)é—®ç­”å¯¹:\\n'} ], temperature=0.7, top_p=1.0, max_tokens=4096, stream=stream ) if stream: for chunk in response: if chunk.choices[0].delta.content is not None: print(chunk.choices[0].delta.content, end='') else: r_content = response.choices[0].message.content json_match = re.findall(r'```(?:json)?\\n(.*?)\\n```', r_content, re.DOTALL) return json_match[0] if json_match else None 2. åŠ è½½å’Œå¤„ç†æ•°æ® æ¥ä¸‹æ¥ï¼Œåˆ›å»ºmain.pyæ–‡ä»¶æ¥åŠ è½½å°è¯´æ–‡æœ¬å¹¶åˆ†å—å¤„ç†ï¼š\nfrom datasets import load_dataset from llm import get_qa import tqdm import json import time from typing import List # åŠ è½½æ•´ä¸ªTXTæ–‡ä»¶ä½œä¸ºè®­ç»ƒé›† dataset = load_dataset(\"text\", data_files={\"train\": \"xiaoyao.txt\"}, sample_by=\"paragraph\") # è¾“å‡ºæ•°æ®é›†ä¿¡æ¯ print(dataset) chunk_size = 10 output_file = 'results.jsonl' def convert_to_json(s) -\u003e List: try: return json.loads(s) except Exception: return False total_chunks = (len(dataset['train']) + chunk_size - 1) // chunk_size pbar = tqdm.tqdm(total=len(dataset['train'])) for idx in tqdm.tqdm(range(0, len(dataset['train']), chunk_size), total=total_chunks): chunk = '\\n'.join(dataset['train'][idx: idx+chunk_size]['text']) # è·å– QA ç»“æœ response = get_qa(chunk) # å¤„ç†å“åº”å¹¶ä¿å­˜ try: j_list = convert_to_json(response) if isinstance(j_list, list): with open(output_file, 'a', encoding='utf-8') as f: for item in j_list: if not item: continue json.dump(item, f, ensure_ascii=False) f.write('\\n') else: # å¦‚æœæ˜¯å•ä¸ªå¯¹è±¡ï¼Œç›´æ¥å†™å…¥ with open(output_file, 'a', encoding='utf-8') as f: json.dump(response, f, ensure_ascii=False) f.write('\\n') except Exception as e: print(f\"Error processing response: {e}\") è¿™æ®µä»£ç çš„å·¥ä½œæµç¨‹æ˜¯ï¼š\nä½¿ç”¨datasetsåº“åŠ è½½å°è¯´æ–‡æœ¬ï¼ŒæŒ‰æ®µè½è¿›è¡Œåˆ†å‰² æ¯æ¬¡å–10ä¸ªæ®µè½ç»„æˆä¸€ä¸ªchunk å°†chunkå‘é€ç»™LLMè¿›è¡Œé—®ç­”å¯¹ç”Ÿæˆ è§£æLLMè¿”å›çš„JSONæ ¼å¼é—®ç­”å¯¹ å°†é—®ç­”å¯¹ä¿å­˜åˆ°JSONLæ–‡ä»¶ä¸­ 3. æ•°æ®è½¬æ¢ä¸ºSFTæ ¼å¼ ç”Ÿæˆé—®ç­”å¯¹åï¼Œéœ€è¦å°†å…¶è½¬æ¢ä¸ºSFTè®­ç»ƒæ‰€éœ€çš„æ ¼å¼ã€‚åˆ›å»ºconvert.pyæ–‡ä»¶ï¼š\nimport json # åˆå§‹åŒ–ä¸€ä¸ªç©ºåˆ—è¡¨æ¥å­˜å‚¨è½¬æ¢åçš„æ•°æ® data = [] with open('results.jsonl', 'r', encoding='utf-8') as file: for line in file: # è§£ææ¯ä¸€è¡Œçš„ JSON æ•°æ® json_object = json.loads(line) new_format = { \"instruction\": json_object[\"question\"], \"input\": \"\", # å¦‚æœéœ€è¦ï¼Œå¯ä»¥æ ¹æ®éœ€è¦å¡«å…… \"output\": json_object[\"answer\"] } # å°†æ–°æ ¼å¼å­—å…¸æ·»åŠ åˆ°åˆ—è¡¨ä¸­ data.append(new_format) with open('output.json', 'w', encoding='utf-8') as outfile: json.dump(data, outfile, ensure_ascii=False, indent=2) è¿™æ®µä»£ç å°†é—®ç­”å¯¹è½¬æ¢ä¸ºSFTè®­ç»ƒå¸¸ç”¨çš„æŒ‡ä»¤æ ¼å¼ï¼š\ninstructionï¼šé—®é¢˜ inputï¼šè¾“å…¥ï¼ˆåœ¨è¿™ä¸ªåœºæ™¯ä¸­ä¸ºç©ºï¼‰ outputï¼šç­”æ¡ˆ 4. ç”Ÿæˆçš„æ•°æ®ç¤ºä¾‹ ä»¥ä¸‹æ˜¯ç”Ÿæˆçš„é—®ç­”å¯¹æ•°æ®ç¤ºä¾‹ï¼š\n{ \"instruction\": \"å°ç„å¯¹è‡ªå·±çš„å¤„å¢ƒæœ‰ä½•è‡ªæˆ‘å®‰æ…°çš„æƒ³æ³•ï¼Ÿ\", \"input\": \"\", \"output\": \"å¿½å°”åšé¢œæ— è€»åœ°æ€é“ï¼šç”·å­æ±‰å¤§ä¸ˆå¤«ï¼Œè‡ªå¤ä»¥æ¥å°±ä¸‰å¦»å››å¦¾ï¼Œå¥¹ä»¬è€çˆ¹ä¸å°±å¨¶äº†äº”æˆ¿å¤«äººå˜›ï¼Œå²³çˆ¶å¯ä»¥æ”¾ç«ï¼Œå¥³å©¿å°±ä¸èƒ½ç‚¹ç¯ä¹ˆï¼Œå§å¦¹ä¿©æ€»ä¸èƒ½ä¸€ç‚¹æƒ…ç†ä¹Ÿä¸è®²å§......\" }, { \"instruction\": \"æ°´è‹¥å¯¹å°ç„çš„ååº”æ˜¯ä»€ä¹ˆï¼Ÿ\", \"input\": \"\", \"output\": \"æ°´è‹¥çªåœ°ä¸€å‘†ï¼Œç”¨æ‰‹æŠµä½äº†ä»–çš„èƒ¸å£ï¼Œæ€”æ€”ç›¯äº†ä»–ç‰‡åˆ»ï¼ŒçŒ›ç„¶åœ°å°†å…¶æ¨å¼€ï¼ŒæŒ£æ‰åèµ·ï¼Œæ¼æ¨äº¤åŠ é“ï¼šæ»šå¼€ï¼ä»¥åï¼Œå†ä¸è®¸ä½ ç¢°æˆ‘ï¼\" } æ–¹æ³•äºŒï¼šæå–å¯¹è¯æ•°æ® ç¬¬äºŒç§æ–¹æ³•æ˜¯æå–å°è¯´ä¸­çš„å¯¹è¯å†…å®¹ã€‚æˆ‘ä½¿ç”¨äº†extract-dialogueå·¥å…·æ¥å®Œæˆè¿™é¡¹å·¥ä½œï¼Œè¯¥å·¥å…·å¯ä»¥ä»å°è¯´æ–‡æœ¬ä¸­è‡ªåŠ¨è¯†åˆ«å¹¶æå–å¯¹è¯å†…å®¹ï¼ŒåŒ…æ‹¬è¯´è¯äººå’Œå¯¹è¯å†…å®¹ã€‚\n1. å®‰è£…å’Œé…ç½®å·¥å…· é¦–å…ˆï¼Œå…‹éš†å·¥å…·ä»“åº“å¹¶å®‰è£…ä¾èµ–ï¼š\ngit clone https://github.com/KMnO4-zx/extract-dialogue.git cd extract-dialogue \u0026\u0026 pip install -r requirements.txt 2. é…ç½®API åˆ›å»º.envæ–‡ä»¶ï¼Œé…ç½®DeepSeek APIï¼š\n# åˆ›å»º.envæ–‡ä»¶ DEEPSEEK_BASE_URL=https://api.deepseek.com DEEPSEEK_API=sk-xxxx 3. åˆ›å»ºä¸»ç¨‹åº åˆ›å»ºmain.pyæ–‡ä»¶ï¼Œç”¨äºå¤„ç†å°è¯´æ–‡æœ¬å¹¶æå–å¯¹è¯ï¼š\nfrom extract import system_prompt from schema import novel_schema from LLM import DeepseekChat from utils import ReadFiles from tqdm import tqdm import json # æŒ‡å®šå°è¯´æ–‡ä»¶è·¯å¾„ file_path = './xiaoyao.txt' # è¯»å–æ–‡ä»¶å†…å®¹å¹¶åˆ†å—ï¼Œæ¯å—æœ€å¤§tokenæ•°ä¸º500 docs = ReadFiles(file_path).get_content(max_token_len=500, cover_content=0) # è·å–ç³»ç»Ÿæç¤ºè¯ï¼Œç”¨äºæŒ‡å¯¼LLMæå–å¯¹è¯ sys_prompt = system_prompt(novel_schema) # åˆå§‹åŒ–DeepSeekæ¨¡å‹ model = DeepseekChat() # è·å–æ–‡ä»¶åï¼ˆä¸å«æ‰©å±•åï¼‰ç”¨äºè¾“å‡ºæ–‡ä»¶å‘½å file_name = file_path.split('/')[-1].split('.')[0] # éå†æ‰€æœ‰æ–‡æœ¬å—ï¼Œæå–å¯¹è¯ for i in tqdm(range(len(docs))): response = model.chat(sys_prompt, docs[i]) try: # è§£æJSONå“åº” response = json.loads(response) # å°†æ¯æ¡å¯¹è¯å†™å…¥JSONLæ–‡ä»¶ for item in response: with open(f'{file_name}.jsonl', 'a', encoding='utf-8') as f: json.dump(item, f, ensure_ascii=False) f.write('\\n') except Exception as e: print(e) 4. æå–ç»“æœç¤ºä¾‹ è¿è¡Œç¨‹åºåï¼Œä¼šå¾—åˆ°åŒ…å«è§’è‰²å’Œå¯¹è¯å†…å®¹çš„JSONLæ–‡ä»¶ï¼Œæ¯è¡Œæ˜¯ä¸€ä¸ªJSONå¯¹è±¡ï¼š\n{\"role\": \"å°ç„\", \"dialogue\": \"åŠä¸åˆ°ã€‚\"} {\"role\": \"æ–¹å°‘éºŸ\", \"dialogue\": \"åŠä¸åˆ°ï¼Ÿä½ æ˜¯ä¸æƒ³ï¼Ÿè¿˜æ˜¯åŠä¸åˆ°ï¼Ÿ\"} {\"role\": \"å°ç„\", \"dialogue\": \"æ¢ä¸ªæ¡ä»¶ã€‚\"} {\"role\": \"æ–¹å°‘éºŸ\", \"dialogue\": \"æˆ‘æƒ³ä¸å‡ºåˆ«çš„ã€‚å¦‚æœè¿™ä¸¤ä¸ªéƒ½åšä¸åˆ°ï¼Œé‚£ä¹ˆæˆ‘æ— æ³•ç›¸ä¿¡ä½ ä¹‹å‰è¯´çš„è¯ã€‚\"} {\"role\": \"æ–¹å°‘éºŸ\", \"dialogue\": \"è¡Œï¼Œä½ å‘Šè¯‰æˆ‘ï¼Œé™¤æ­¤ä¹‹å¤–ï¼Œä½ è¿˜èƒ½åšåˆ°ä»€ä¹ˆï¼Ÿ\"} {\"role\": \"å°ç„\", \"dialogue\": \"æˆ‘èƒ½è®©çš‡æœå†›é€€å…µã€‚å¦‚æœä½ ä¹Ÿé€€å›æ³½é˜³ï¼Œå°±å¯é¿å…ä¸¤è´¥ä¿±ä¼¤ï¼Œä»¤ä¸‡åƒç”Ÿçµæ¶‚ç‚­ï¼\"} {\"role\": \"æ–¹å°‘éºŸ\", \"dialogue\": \"æˆ‘ä¸èƒ½ã€‚æœå»·å¤±æ”¿æ—¥ä¹…ï¼Œå¦‚ä»Šå¤©ä¸‹è’è’ï¼Œçš†è¦æ¨å€’æ˜å›ï¼Œå¦‚æœä½ æ— æ³•è¯æ˜æ˜å›å·²ç»ä¸åœ¨ï¼Œå‡­æˆ‘æ˜¯è¯´æœä¸äº†åˆ«äººçš„ã€‚\"} å¤±è´¥åŸå› ä¸ç»éªŒæ€»ç»“ åç»­ä½¿ç”¨äº†LammaFactoryå·¥å…·è¿›è¡ŒSFTå¾®è°ƒï¼Œæµ‹è¯•æ•ˆæœéƒ½æ¯”è¾ƒå·®ï¼Œæ¨¡å‹åªèƒ½ç®€å•è®°å¿†é—®ç­”å¯¹ï¼Œè€Œä¸èƒ½è¿›è¡Œæ›´å¤æ‚çš„å¯¹è¯ã€‚æˆ‘è®¤ä¸ºä¸€æ–¹é¢æ˜¯æ•°æ®é›†è´¨é‡æ¯”è¾ƒå·®ï¼Œå¹¶ä¸”åœ¨å¾®è°ƒæ—¶å€™äº§ç”Ÿäº†è¿‡æ‹Ÿåˆï¼Œæ¨¡å‹é—å¿˜äº†åŸæœ‰çš„èƒ½åŠ›ã€‚ä½†æ›´ä¸»è¦é—®é¢˜åœ¨äºç›´æ¥è¿›è¡ŒSFTå¯èƒ½ä¸æ˜¯æœ€ä½³é€‰æ‹©ï¼Œåº”è¯¥å…ˆè¿›è¡Œé¢†åŸŸé€‚åº”æ€§çš„é¢„è®­ç»ƒã€‚æ­¤å¤–ï¼Œæ•°æ®é›†çš„è§„æ¨¡å’Œè´¨é‡ä¹Ÿæœ‰å¾…æé«˜ã€‚\n",
  "wordCount" : "2361",
  "inLanguage": "zh",
  "datePublished": "2025-01-13T00:00:00Z",
  "dateModified": "2025-03-15T00:00:00Z",
  "author":{
    "@type": "Person",
    "name": "Niuhe"
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://blog.niuhemoon.win/posts/tech/failed-novel-sft-dataset-creation/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Niuhe's Blog",
    "logo": {
      "@type": "ImageObject",
      "url": "https://blog.niuhemoon.win/base/favicon.ico"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://blog.niuhemoon.win" accesskey="h" title="Niuhe&#39;s Blog (Alt + H)">
                <img src="https://blog.niuhemoon.win/base/avatar.jpeg" alt="" aria-label="logo"
                    height="35">Niuhe&#39;s Blog</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="https://blog.niuhemoon.win/search" title="ğŸ”æœç´¢ (Alt &#43; /)" accesskey=/>
                    <span>ğŸ”æœç´¢</span>
                </a>
            </li>
            <li>
                <a href="https://blog.niuhemoon.win/" title="ğŸ ä¸»é¡µ">
                    <span>ğŸ ä¸»é¡µ</span>
                </a>
            </li>
            <li>
                <a href="https://blog.niuhemoon.win/posts" title="ğŸ“šæ–‡ç« ">
                    <span>ğŸ“šæ–‡ç« </span>
                </a>
            </li>
            <li>
                <a href="https://blog.niuhemoon.win/tags" title="ğŸ”–æ ‡ç­¾">
                    <span>ğŸ”–æ ‡ç­¾</span>
                </a>
            </li>
            <li>
                <a href="https://blog.niuhemoon.win/archives/" title="â±æ—¶é—´è½´">
                    <span>â±æ—¶é—´è½´</span>
                </a>
            </li>
            <li>
                <a href="https://blog.niuhemoon.win/about" title="ğŸ™‹ğŸ»â€â™‚ï¸å…³äº">
                    <span>ğŸ™‹ğŸ»â€â™‚ï¸å…³äº</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="https://blog.niuhemoon.win">ğŸ ä¸»é¡µ</a>&nbsp;Â»&nbsp;<a href="https://blog.niuhemoon.win/posts/">ğŸ“šæ–‡ç« </a>&nbsp;Â»&nbsp;<a href="https://blog.niuhemoon.win/posts/tech/">ğŸ‘¨ğŸ»â€ğŸ’» æŠ€æœ¯</a></div>
    <h1 class="post-title">
      è®°å½•ä¸€æ¬¡å¤±è´¥çš„å°è¯´SFTæ•°æ®é›†åˆ›å»º
    </h1>
    <div class="post-description">
      æœ¬æ¥æƒ³æ‹¿å–œæ¬¢çš„å°è¯´åšæ•°æ®é›†ï¼Œç„¶ååˆ¶ä½œSFTæ•°æ®é›†ï¼Œé€šè¿‡å¾®è°ƒï¼Œè®©LLMå­¦ä¼šå°è¯´å†…å®¹ã€æ–‡é£ï¼Œä»è€Œåˆ†æäººç‰©å…³ç³»ï¼Œè¿›è¡Œç»­å†™ï¼Œä½†å°è¯•å¤±è´¥
    </div>
    <div class="post-meta"><span title='2025-01-13 00:00:00 +0000 UTC'>2025-01-13</span>&nbsp;Â·&nbsp;5 min&nbsp;Â·&nbsp;2361 å­—&nbsp;Â·&nbsp;Niuhe

</div>
  </header> <div class="toc">
    <details  open>
        <summary accesskey="c" title="(Alt + C)">
            <span class="details">æ–‡ç« ç›®å½•</span>
        </summary>

        <div class="inner"><ul>
                <li>
                    <a href="#%e8%83%8c%e6%99%af%e4%bb%8b%e7%bb%8d" aria-label="èƒŒæ™¯ä»‹ç»">èƒŒæ™¯ä»‹ç»</a></li>
                <li>
                    <a href="#%e6%95%b0%e6%8d%ae%e9%9b%86%e5%88%9b%e5%bb%ba%e8%bf%87%e7%a8%8b" aria-label="æ•°æ®é›†åˆ›å»ºè¿‡ç¨‹">æ•°æ®é›†åˆ›å»ºè¿‡ç¨‹</a><ul>
                        
                <li>
                    <a href="#%e6%95%b0%e6%8d%ae%e9%a2%84%e5%a4%84%e7%90%86" aria-label="æ•°æ®é¢„å¤„ç†">æ•°æ®é¢„å¤„ç†</a></li>
                <li>
                    <a href="#%e6%96%b9%e6%b3%95%e4%b8%80%e4%bd%bf%e7%94%a8llm%e6%8f%90%e5%8f%96%e9%97%ae%e7%ad%94%e6%95%b0%e6%8d%ae" aria-label="æ–¹æ³•ä¸€ï¼šä½¿ç”¨LLMæå–é—®ç­”æ•°æ®">æ–¹æ³•ä¸€ï¼šä½¿ç”¨LLMæå–é—®ç­”æ•°æ®</a><ul>
                        
                <li>
                    <a href="#1-%e8%ae%be%e7%bd%aellm%e6%8e%a5%e5%8f%a3" aria-label="1. è®¾ç½®LLMæ¥å£">1. è®¾ç½®LLMæ¥å£</a></li>
                <li>
                    <a href="#2-%e5%8a%a0%e8%bd%bd%e5%92%8c%e5%a4%84%e7%90%86%e6%95%b0%e6%8d%ae" aria-label="2. åŠ è½½å’Œå¤„ç†æ•°æ®">2. åŠ è½½å’Œå¤„ç†æ•°æ®</a></li>
                <li>
                    <a href="#3-%e6%95%b0%e6%8d%ae%e8%bd%ac%e6%8d%a2%e4%b8%basft%e6%a0%bc%e5%bc%8f" aria-label="3. æ•°æ®è½¬æ¢ä¸ºSFTæ ¼å¼">3. æ•°æ®è½¬æ¢ä¸ºSFTæ ¼å¼</a></li>
                <li>
                    <a href="#4-%e7%94%9f%e6%88%90%e7%9a%84%e6%95%b0%e6%8d%ae%e7%a4%ba%e4%be%8b" aria-label="4. ç”Ÿæˆçš„æ•°æ®ç¤ºä¾‹">4. ç”Ÿæˆçš„æ•°æ®ç¤ºä¾‹</a></li></ul>
                </li>
                <li>
                    <a href="#%e6%96%b9%e6%b3%95%e4%ba%8c%e6%8f%90%e5%8f%96%e5%af%b9%e8%af%9d%e6%95%b0%e6%8d%ae" aria-label="æ–¹æ³•äºŒï¼šæå–å¯¹è¯æ•°æ®">æ–¹æ³•äºŒï¼šæå–å¯¹è¯æ•°æ®</a><ul>
                        
                <li>
                    <a href="#1-%e5%ae%89%e8%a3%85%e5%92%8c%e9%85%8d%e7%bd%ae%e5%b7%a5%e5%85%b7" aria-label="1. å®‰è£…å’Œé…ç½®å·¥å…·">1. å®‰è£…å’Œé…ç½®å·¥å…·</a></li>
                <li>
                    <a href="#2-%e9%85%8d%e7%bd%aeapi" aria-label="2. é…ç½®API">2. é…ç½®API</a></li>
                <li>
                    <a href="#3-%e5%88%9b%e5%bb%ba%e4%b8%bb%e7%a8%8b%e5%ba%8f" aria-label="3. åˆ›å»ºä¸»ç¨‹åº">3. åˆ›å»ºä¸»ç¨‹åº</a></li>
                <li>
                    <a href="#4-%e6%8f%90%e5%8f%96%e7%bb%93%e6%9e%9c%e7%a4%ba%e4%be%8b" aria-label="4. æå–ç»“æœç¤ºä¾‹">4. æå–ç»“æœç¤ºä¾‹</a></li></ul>
                </li></ul>
                </li>
                <li>
                    <a href="#%e5%a4%b1%e8%b4%a5%e5%8e%9f%e5%9b%a0%e4%b8%8e%e7%bb%8f%e9%aa%8c%e6%80%bb%e7%bb%93" aria-label="å¤±è´¥åŸå› ä¸ç»éªŒæ€»ç»“">å¤±è´¥åŸå› ä¸ç»éªŒæ€»ç»“</a>
                </li>
            </ul>
        </div>
    </details>
</div>

  <div class="post-content"><h3 id="èƒŒæ™¯ä»‹ç»">èƒŒæ™¯ä»‹ç»<a hidden class="anchor" aria-hidden="true" href="#èƒŒæ™¯ä»‹ç»">#</a></h3>
<p>æœ€è¿‘æˆ‘ä¸€ç›´åœ¨ç ”ç©¶å¦‚ä½•è®©LLMæ›´å¥½åœ°ç†è§£å’Œç”Ÿæˆç‰¹å®šé¢†åŸŸçš„å†…å®¹ã€‚æˆ‘é€‰æ‹©äº†è‡ªå·±å–œæ¬¢çš„å°è¯´ã€Šé€é¥å°æ•£ä»™ã€‹ä½œä¸ºå®éªŒæ•°æ®ï¼Œå¸Œæœ›é€šè¿‡SFTï¼ˆSupervised Fine-Tuningï¼‰è®©æ¨¡å‹å­¦ä¹ å°è¯´çš„å†…å®¹ã€äººç‰©å…³ç³»å’Œå†™ä½œé£æ ¼ï¼Œæœ€ç»ˆèƒ½å¤Ÿè¿›è¡Œç›¸å…³çš„åˆ†æå’Œç»­å†™ã€‚è¿™ç¯‡æ–‡ç« è¯¦ç»†è®°å½•äº†æˆ‘çš„æ•°æ®é›†åˆ›å»ºè¿‡ç¨‹ï¼Œä»¥åŠæœ€ç»ˆçš„å¾®è°ƒç»“æœã€‚</p>
<h3 id="æ•°æ®é›†åˆ›å»ºè¿‡ç¨‹">æ•°æ®é›†åˆ›å»ºè¿‡ç¨‹<a hidden class="anchor" aria-hidden="true" href="#æ•°æ®é›†åˆ›å»ºè¿‡ç¨‹">#</a></h3>
<h4 id="æ•°æ®é¢„å¤„ç†">æ•°æ®é¢„å¤„ç†<a hidden class="anchor" aria-hidden="true" href="#æ•°æ®é¢„å¤„ç†">#</a></h4>
<p>é¦–å…ˆå°†å°è¯´ç”¨calibreä»epubæ ¼å¼è½¬æˆtxtæ ¼å¼ï¼Œä¸ºåç»­çš„å¤„ç†åšå‡†å¤‡ã€‚</p>
<h4 id="æ–¹æ³•ä¸€ä½¿ç”¨llmæå–é—®ç­”æ•°æ®">æ–¹æ³•ä¸€ï¼šä½¿ç”¨LLMæå–é—®ç­”æ•°æ®<a hidden class="anchor" aria-hidden="true" href="#æ–¹æ³•ä¸€ä½¿ç”¨llmæå–é—®ç­”æ•°æ®">#</a></h4>
<p>ç¬¬ä¸€ç§æ–¹æ³•æ˜¯ä½¿ç”¨LLMä»å°è¯´æ–‡æœ¬ä¸­æå–é—®ç­”å¯¹ã€‚è¿™ç§æ–¹æ³•çš„æ ¸å¿ƒæ€æƒ³æ˜¯å°†å°è¯´åˆ†æˆå¤šä¸ªæ®µè½ï¼Œç„¶åè®©LLMä¸ºæ¯ä¸ªæ®µè½ç”Ÿæˆç›¸å…³çš„é—®é¢˜å’Œç­”æ¡ˆã€‚</p>
<h5 id="1-è®¾ç½®llmæ¥å£">1. è®¾ç½®LLMæ¥å£<a hidden class="anchor" aria-hidden="true" href="#1-è®¾ç½®llmæ¥å£">#</a></h5>
<p>é¦–å…ˆï¼Œæˆ‘åˆ›å»ºäº†<code>llm.py</code>æ–‡ä»¶ï¼Œç”¨äºä¸LLM APIè¿›è¡Œäº¤äº’ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">from</span> openai <span style="color:#fff;font-weight:bold">import</span> OpenAI
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">from</span> typing <span style="color:#fff;font-weight:bold">import</span> List, Dict
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> json
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> re
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>BaseURL = <span style="color:#0ff;font-weight:bold">&#39;https://api.aiproxy.io/v1&#39;</span>
</span></span><span style="display:flex;"><span>APIKEY = <span style="color:#0ff;font-weight:bold">&#39;sk-xxxx&#39;</span>  <span style="color:#007f7f"># å·²éšè—çœŸå®APIå¯†é’¥</span>
</span></span><span style="display:flex;"><span>Model = <span style="color:#0ff;font-weight:bold">&#39;gpt-4o-mini-2024-07-18&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># ä¹Ÿå¯ä»¥ä½¿ç”¨DeepSeek API</span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># BaseURL=&#39;https://api.deepseek.com/v1&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># APIKEY=&#39;sk-xxxx&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># Model=&#39;deepseek-chat&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>client = OpenAI(api_key=APIKEY, base_url=BaseURL)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">def</span> get_qa(raw_content, stream=<span style="color:#fff;font-weight:bold">False</span>) -&gt; <span style="color:#fff;font-weight:bold">str</span>:
</span></span><span style="display:flex;"><span>    response = client.chat.completions.create(
</span></span><span style="display:flex;"><span>        model=Model,
</span></span><span style="display:flex;"><span>        messages=[
</span></span><span style="display:flex;"><span>            {<span style="color:#0ff;font-weight:bold">&#39;role&#39;</span>: <span style="color:#0ff;font-weight:bold">&#39;system&#39;</span>, <span style="color:#0ff;font-weight:bold">&#39;content&#39;</span>: <span style="color:#0ff;font-weight:bold">&#39;ä½ æ˜¯ä¸€ä½å°è¯´åˆ†æå¸ˆï¼Œè´Ÿè´£ä»ä»¥ä¸‹æ–‡æœ¬ä¸­æå–ä¿¡æ¯å¹¶ç”Ÿæˆé—®ç­”å¯¹ã€‚è¾“å‡ºæ ¼å¼è¦æ±‚:</span><span style="color:#0ff;font-weight:bold">\n</span><span style="color:#0ff;font-weight:bold">```json</span><span style="color:#0ff;font-weight:bold">\n</span><span style="color:#0ff;font-weight:bold">[{&#34;question&#34;: &#34;*&#34;, &#34;answer&#34;: &#34;*&#34;}]```&#39;</span>},
</span></span><span style="display:flex;"><span>            {<span style="color:#0ff;font-weight:bold">&#39;role&#39;</span>: <span style="color:#0ff;font-weight:bold">&#39;user&#39;</span>, <span style="color:#0ff;font-weight:bold">&#39;content&#39;</span>: <span style="color:#0ff;font-weight:bold">f</span><span style="color:#0ff;font-weight:bold">&#39;è¯·ä»”ç»†é˜…è¯»æ–‡æœ¬,å¹¶æ ¹æ®æ–‡æœ¬å†…å®¹ç”Ÿæˆé—®é¢˜å’Œç­”æ¡ˆ,é—®ç­”å¯¹è¦åŒ…å«æ–‡æœ¬æ‰€æœ‰æœ‰æ•ˆä¿¡æ¯, é—®ç­”å¯¹äº’ç›¸ç‹¬ç«‹,çœ‹ä¸åˆ°å…¶å®ƒé—®é¢˜ã€‚ç¡®ä¿é—®é¢˜æ¶µç›–è§’è‰²ã€æƒ…èŠ‚ã€æƒ…æ„Ÿå’ŒèƒŒæ™¯ç­‰å¤šæ–¹é¢ã€‚ç­”æ¡ˆåº”ç›´æ¥å¤åˆ¶åŸæ–‡å†…å®¹ã€‚ç›´æ¥ç”¨JSONæ ¼å¼å›ç­”ã€‚æ–‡æœ¬:</span><span style="color:#0ff;font-weight:bold">\n</span><span style="color:#0ff;font-weight:bold">[</span><span style="color:#0ff;font-weight:bold">{</span>raw_content<span style="color:#0ff;font-weight:bold">}</span><span style="color:#0ff;font-weight:bold">]</span><span style="color:#0ff;font-weight:bold">\n</span><span style="color:#0ff;font-weight:bold">è¯·ç”ŸæˆJSONæ ¼å¼(åˆ—è¡¨)é—®ç­”å¯¹:</span><span style="color:#0ff;font-weight:bold">\n</span><span style="color:#0ff;font-weight:bold">&#39;</span>}
</span></span><span style="display:flex;"><span>        ],
</span></span><span style="display:flex;"><span>        temperature=<span style="color:#ff0;font-weight:bold">0.7</span>,
</span></span><span style="display:flex;"><span>        top_p=<span style="color:#ff0;font-weight:bold">1.0</span>,
</span></span><span style="display:flex;"><span>        max_tokens=<span style="color:#ff0;font-weight:bold">4096</span>,
</span></span><span style="display:flex;"><span>        stream=stream
</span></span><span style="display:flex;"><span>    )
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">if</span> stream:
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">for</span> chunk in response:
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">if</span> chunk.choices[<span style="color:#ff0;font-weight:bold">0</span>].delta.content is not <span style="color:#fff;font-weight:bold">None</span>:
</span></span><span style="display:flex;"><span>                <span style="color:#fff;font-weight:bold">print</span>(chunk.choices[<span style="color:#ff0;font-weight:bold">0</span>].delta.content, end=<span style="color:#0ff;font-weight:bold">&#39;&#39;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">else</span>:
</span></span><span style="display:flex;"><span>        r_content = response.choices[<span style="color:#ff0;font-weight:bold">0</span>].message.content
</span></span><span style="display:flex;"><span>        json_match = re.findall(<span style="color:#0ff;font-weight:bold">r</span><span style="color:#0ff;font-weight:bold">&#39;```(?:json)?\n(.*?)\n```&#39;</span>, r_content, re.DOTALL)
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> json_match[<span style="color:#ff0;font-weight:bold">0</span>] <span style="color:#fff;font-weight:bold">if</span> json_match <span style="color:#fff;font-weight:bold">else</span> <span style="color:#fff;font-weight:bold">None</span>
</span></span></code></pre></div><h5 id="2-åŠ è½½å’Œå¤„ç†æ•°æ®">2. åŠ è½½å’Œå¤„ç†æ•°æ®<a hidden class="anchor" aria-hidden="true" href="#2-åŠ è½½å’Œå¤„ç†æ•°æ®">#</a></h5>
<p>æ¥ä¸‹æ¥ï¼Œåˆ›å»º<code>main.py</code>æ–‡ä»¶æ¥åŠ è½½å°è¯´æ–‡æœ¬å¹¶åˆ†å—å¤„ç†ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">from</span> datasets <span style="color:#fff;font-weight:bold">import</span> load_dataset
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">from</span> llm <span style="color:#fff;font-weight:bold">import</span> get_qa
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> tqdm
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> json
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> time
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">from</span> typing <span style="color:#fff;font-weight:bold">import</span> List
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># åŠ è½½æ•´ä¸ªTXTæ–‡ä»¶ä½œä¸ºè®­ç»ƒé›†</span>
</span></span><span style="display:flex;"><span>dataset = load_dataset(<span style="color:#0ff;font-weight:bold">&#34;text&#34;</span>, data_files={<span style="color:#0ff;font-weight:bold">&#34;train&#34;</span>: <span style="color:#0ff;font-weight:bold">&#34;xiaoyao.txt&#34;</span>}, sample_by=<span style="color:#0ff;font-weight:bold">&#34;paragraph&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># è¾“å‡ºæ•°æ®é›†ä¿¡æ¯</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">print</span>(dataset)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>chunk_size = <span style="color:#ff0;font-weight:bold">10</span>
</span></span><span style="display:flex;"><span>output_file = <span style="color:#0ff;font-weight:bold">&#39;results.jsonl&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">def</span> convert_to_json(s) -&gt; List:
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">try</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> json.loads(s)
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">except</span> Exception:
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> <span style="color:#fff;font-weight:bold">False</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>total_chunks = (<span style="color:#fff;font-weight:bold">len</span>(dataset[<span style="color:#0ff;font-weight:bold">&#39;train&#39;</span>]) + chunk_size - <span style="color:#ff0;font-weight:bold">1</span>) // chunk_size
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>pbar = tqdm.tqdm(total=<span style="color:#fff;font-weight:bold">len</span>(dataset[<span style="color:#0ff;font-weight:bold">&#39;train&#39;</span>]))
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">for</span> idx in tqdm.tqdm(<span style="color:#fff;font-weight:bold">range</span>(<span style="color:#ff0;font-weight:bold">0</span>, <span style="color:#fff;font-weight:bold">len</span>(dataset[<span style="color:#0ff;font-weight:bold">&#39;train&#39;</span>]), chunk_size), total=total_chunks):
</span></span><span style="display:flex;"><span>    chunk = <span style="color:#0ff;font-weight:bold">&#39;</span><span style="color:#0ff;font-weight:bold">\n</span><span style="color:#0ff;font-weight:bold">&#39;</span>.join(dataset[<span style="color:#0ff;font-weight:bold">&#39;train&#39;</span>][idx: idx+chunk_size][<span style="color:#0ff;font-weight:bold">&#39;text&#39;</span>])
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f"># è·å– QA ç»“æœ</span>
</span></span><span style="display:flex;"><span>    response = get_qa(chunk)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f"># å¤„ç†å“åº”å¹¶ä¿å­˜</span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">try</span>:
</span></span><span style="display:flex;"><span>        j_list = convert_to_json(response)
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">if</span> <span style="color:#fff;font-weight:bold">isinstance</span>(j_list, <span style="color:#fff;font-weight:bold">list</span>):
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">with</span> <span style="color:#fff;font-weight:bold">open</span>(output_file, <span style="color:#0ff;font-weight:bold">&#39;a&#39;</span>, encoding=<span style="color:#0ff;font-weight:bold">&#39;utf-8&#39;</span>) <span style="color:#fff;font-weight:bold">as</span> f:
</span></span><span style="display:flex;"><span>                <span style="color:#fff;font-weight:bold">for</span> item in j_list:
</span></span><span style="display:flex;"><span>                    <span style="color:#fff;font-weight:bold">if</span> not item:
</span></span><span style="display:flex;"><span>                        <span style="color:#fff;font-weight:bold">continue</span>
</span></span><span style="display:flex;"><span>                    json.dump(item, f, ensure_ascii=<span style="color:#fff;font-weight:bold">False</span>)
</span></span><span style="display:flex;"><span>                    f.write(<span style="color:#0ff;font-weight:bold">&#39;</span><span style="color:#0ff;font-weight:bold">\n</span><span style="color:#0ff;font-weight:bold">&#39;</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">else</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f"># å¦‚æœæ˜¯å•ä¸ªå¯¹è±¡ï¼Œç›´æ¥å†™å…¥</span>
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">with</span> <span style="color:#fff;font-weight:bold">open</span>(output_file, <span style="color:#0ff;font-weight:bold">&#39;a&#39;</span>, encoding=<span style="color:#0ff;font-weight:bold">&#39;utf-8&#39;</span>) <span style="color:#fff;font-weight:bold">as</span> f:
</span></span><span style="display:flex;"><span>                json.dump(response, f, ensure_ascii=<span style="color:#fff;font-weight:bold">False</span>)
</span></span><span style="display:flex;"><span>                f.write(<span style="color:#0ff;font-weight:bold">&#39;</span><span style="color:#0ff;font-weight:bold">\n</span><span style="color:#0ff;font-weight:bold">&#39;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">except</span> Exception <span style="color:#fff;font-weight:bold">as</span> e:
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">print</span>(<span style="color:#0ff;font-weight:bold">f</span><span style="color:#0ff;font-weight:bold">&#34;Error processing response: </span><span style="color:#0ff;font-weight:bold">{</span>e<span style="color:#0ff;font-weight:bold">}</span><span style="color:#0ff;font-weight:bold">&#34;</span>)
</span></span></code></pre></div><p>è¿™æ®µä»£ç çš„å·¥ä½œæµç¨‹æ˜¯ï¼š</p>
<ol>
<li>ä½¿ç”¨<code>datasets</code>åº“åŠ è½½å°è¯´æ–‡æœ¬ï¼ŒæŒ‰æ®µè½è¿›è¡Œåˆ†å‰²</li>
<li>æ¯æ¬¡å–10ä¸ªæ®µè½ç»„æˆä¸€ä¸ªchunk</li>
<li>å°†chunkå‘é€ç»™LLMè¿›è¡Œé—®ç­”å¯¹ç”Ÿæˆ</li>
<li>è§£æLLMè¿”å›çš„JSONæ ¼å¼é—®ç­”å¯¹</li>
<li>å°†é—®ç­”å¯¹ä¿å­˜åˆ°JSONLæ–‡ä»¶ä¸­</li>
</ol>
<h5 id="3-æ•°æ®è½¬æ¢ä¸ºsftæ ¼å¼">3. æ•°æ®è½¬æ¢ä¸ºSFTæ ¼å¼<a hidden class="anchor" aria-hidden="true" href="#3-æ•°æ®è½¬æ¢ä¸ºsftæ ¼å¼">#</a></h5>
<p>ç”Ÿæˆé—®ç­”å¯¹åï¼Œéœ€è¦å°†å…¶è½¬æ¢ä¸ºSFTè®­ç»ƒæ‰€éœ€çš„æ ¼å¼ã€‚åˆ›å»º<code>convert.py</code>æ–‡ä»¶ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> json
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># åˆå§‹åŒ–ä¸€ä¸ªç©ºåˆ—è¡¨æ¥å­˜å‚¨è½¬æ¢åçš„æ•°æ®</span>
</span></span><span style="display:flex;"><span>data = []
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">with</span> <span style="color:#fff;font-weight:bold">open</span>(<span style="color:#0ff;font-weight:bold">&#39;results.jsonl&#39;</span>, <span style="color:#0ff;font-weight:bold">&#39;r&#39;</span>, encoding=<span style="color:#0ff;font-weight:bold">&#39;utf-8&#39;</span>) <span style="color:#fff;font-weight:bold">as</span> file:
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">for</span> line in file:
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f"># è§£ææ¯ä¸€è¡Œçš„ JSON æ•°æ®</span>
</span></span><span style="display:flex;"><span>        json_object = json.loads(line)
</span></span><span style="display:flex;"><span>        new_format = {
</span></span><span style="display:flex;"><span>            <span style="color:#0ff;font-weight:bold">&#34;instruction&#34;</span>: json_object[<span style="color:#0ff;font-weight:bold">&#34;question&#34;</span>],
</span></span><span style="display:flex;"><span>            <span style="color:#0ff;font-weight:bold">&#34;input&#34;</span>: <span style="color:#0ff;font-weight:bold">&#34;&#34;</span>,  <span style="color:#007f7f"># å¦‚æœéœ€è¦ï¼Œå¯ä»¥æ ¹æ®éœ€è¦å¡«å……</span>
</span></span><span style="display:flex;"><span>            <span style="color:#0ff;font-weight:bold">&#34;output&#34;</span>: json_object[<span style="color:#0ff;font-weight:bold">&#34;answer&#34;</span>]
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f"># å°†æ–°æ ¼å¼å­—å…¸æ·»åŠ åˆ°åˆ—è¡¨ä¸­</span>
</span></span><span style="display:flex;"><span>        data.append(new_format)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">with</span> <span style="color:#fff;font-weight:bold">open</span>(<span style="color:#0ff;font-weight:bold">&#39;output.json&#39;</span>, <span style="color:#0ff;font-weight:bold">&#39;w&#39;</span>, encoding=<span style="color:#0ff;font-weight:bold">&#39;utf-8&#39;</span>) <span style="color:#fff;font-weight:bold">as</span> outfile:
</span></span><span style="display:flex;"><span>    json.dump(data, outfile, ensure_ascii=<span style="color:#fff;font-weight:bold">False</span>, indent=<span style="color:#ff0;font-weight:bold">2</span>)
</span></span></code></pre></div><p>è¿™æ®µä»£ç å°†é—®ç­”å¯¹è½¬æ¢ä¸ºSFTè®­ç»ƒå¸¸ç”¨çš„æŒ‡ä»¤æ ¼å¼ï¼š</p>
<ul>
<li><code>instruction</code>ï¼šé—®é¢˜</li>
<li><code>input</code>ï¼šè¾“å…¥ï¼ˆåœ¨è¿™ä¸ªåœºæ™¯ä¸­ä¸ºç©ºï¼‰</li>
<li><code>output</code>ï¼šç­”æ¡ˆ</li>
</ul>
<h5 id="4-ç”Ÿæˆçš„æ•°æ®ç¤ºä¾‹">4. ç”Ÿæˆçš„æ•°æ®ç¤ºä¾‹<a hidden class="anchor" aria-hidden="true" href="#4-ç”Ÿæˆçš„æ•°æ®ç¤ºä¾‹">#</a></h5>
<p>ä»¥ä¸‹æ˜¯ç”Ÿæˆçš„é—®ç­”å¯¹æ•°æ®ç¤ºä¾‹ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="font-weight:bold">&#34;instruction&#34;</span>: <span style="color:#0ff;font-weight:bold">&#34;å°ç„å¯¹è‡ªå·±çš„å¤„å¢ƒæœ‰ä½•è‡ªæˆ‘å®‰æ…°çš„æƒ³æ³•ï¼Ÿ&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="font-weight:bold">&#34;input&#34;</span>: <span style="color:#0ff;font-weight:bold">&#34;&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="font-weight:bold">&#34;output&#34;</span>: <span style="color:#0ff;font-weight:bold">&#34;å¿½å°”åšé¢œæ— è€»åœ°æ€é“ï¼šç”·å­æ±‰å¤§ä¸ˆå¤«ï¼Œè‡ªå¤ä»¥æ¥å°±ä¸‰å¦»å››å¦¾ï¼Œå¥¹ä»¬è€çˆ¹ä¸å°±å¨¶äº†äº”æˆ¿å¤«äººå˜›ï¼Œå²³çˆ¶å¯ä»¥æ”¾ç«ï¼Œå¥³å©¿å°±ä¸èƒ½ç‚¹ç¯ä¹ˆï¼Œå§å¦¹ä¿©æ€»ä¸èƒ½ä¸€ç‚¹æƒ…ç†ä¹Ÿä¸è®²å§......&#34;</span>
</span></span><span style="display:flex;"><span>}<span style="color:#f00">,</span>
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="font-weight:bold">&#34;instruction&#34;</span>: <span style="color:#0ff;font-weight:bold">&#34;æ°´è‹¥å¯¹å°ç„çš„ååº”æ˜¯ä»€ä¹ˆï¼Ÿ&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="font-weight:bold">&#34;input&#34;</span>: <span style="color:#0ff;font-weight:bold">&#34;&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="font-weight:bold">&#34;output&#34;</span>: <span style="color:#0ff;font-weight:bold">&#34;æ°´è‹¥çªåœ°ä¸€å‘†ï¼Œç”¨æ‰‹æŠµä½äº†ä»–çš„èƒ¸å£ï¼Œæ€”æ€”ç›¯äº†ä»–ç‰‡åˆ»ï¼ŒçŒ›ç„¶åœ°å°†å…¶æ¨å¼€ï¼ŒæŒ£æ‰åèµ·ï¼Œæ¼æ¨äº¤åŠ é“ï¼šæ»šå¼€ï¼ä»¥åï¼Œå†ä¸è®¸ä½ ç¢°æˆ‘ï¼&#34;</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h4 id="æ–¹æ³•äºŒæå–å¯¹è¯æ•°æ®">æ–¹æ³•äºŒï¼šæå–å¯¹è¯æ•°æ®<a hidden class="anchor" aria-hidden="true" href="#æ–¹æ³•äºŒæå–å¯¹è¯æ•°æ®">#</a></h4>
<p>ç¬¬äºŒç§æ–¹æ³•æ˜¯æå–å°è¯´ä¸­çš„å¯¹è¯å†…å®¹ã€‚æˆ‘ä½¿ç”¨äº†<code>extract-dialogue</code>å·¥å…·æ¥å®Œæˆè¿™é¡¹å·¥ä½œï¼Œè¯¥å·¥å…·å¯ä»¥ä»å°è¯´æ–‡æœ¬ä¸­è‡ªåŠ¨è¯†åˆ«å¹¶æå–å¯¹è¯å†…å®¹ï¼ŒåŒ…æ‹¬è¯´è¯äººå’Œå¯¹è¯å†…å®¹ã€‚</p>
<h5 id="1-å®‰è£…å’Œé…ç½®å·¥å…·">1. å®‰è£…å’Œé…ç½®å·¥å…·<a hidden class="anchor" aria-hidden="true" href="#1-å®‰è£…å’Œé…ç½®å·¥å…·">#</a></h5>
<p>é¦–å…ˆï¼Œå…‹éš†å·¥å…·ä»“åº“å¹¶å®‰è£…ä¾èµ–ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>git clone https://github.com/KMnO4-zx/extract-dialogue.git
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">cd</span> extract-dialogue &amp;&amp; pip install -r requirements.txt
</span></span></code></pre></div><h5 id="2-é…ç½®api">2. é…ç½®API<a hidden class="anchor" aria-hidden="true" href="#2-é…ç½®api">#</a></h5>
<p>åˆ›å»º<code>.env</code>æ–‡ä»¶ï¼Œé…ç½®DeepSeek APIï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#007f7f"># åˆ›å»º.envæ–‡ä»¶</span>
</span></span><span style="display:flex;"><span>DEEPSEEK_BASE_URL=https://api.deepseek.com
</span></span><span style="display:flex;"><span>DEEPSEEK_API=sk-xxxx  
</span></span></code></pre></div><h5 id="3-åˆ›å»ºä¸»ç¨‹åº">3. åˆ›å»ºä¸»ç¨‹åº<a hidden class="anchor" aria-hidden="true" href="#3-åˆ›å»ºä¸»ç¨‹åº">#</a></h5>
<p>åˆ›å»º<code>main.py</code>æ–‡ä»¶ï¼Œç”¨äºå¤„ç†å°è¯´æ–‡æœ¬å¹¶æå–å¯¹è¯ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">from</span> extract <span style="color:#fff;font-weight:bold">import</span> system_prompt
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">from</span> schema <span style="color:#fff;font-weight:bold">import</span> novel_schema
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">from</span> LLM <span style="color:#fff;font-weight:bold">import</span> DeepseekChat
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">from</span> utils <span style="color:#fff;font-weight:bold">import</span> ReadFiles
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">from</span> tqdm <span style="color:#fff;font-weight:bold">import</span> tqdm
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> json
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># æŒ‡å®šå°è¯´æ–‡ä»¶è·¯å¾„</span>
</span></span><span style="display:flex;"><span>file_path = <span style="color:#0ff;font-weight:bold">&#39;./xiaoyao.txt&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># è¯»å–æ–‡ä»¶å†…å®¹å¹¶åˆ†å—ï¼Œæ¯å—æœ€å¤§tokenæ•°ä¸º500</span>
</span></span><span style="display:flex;"><span>docs = ReadFiles(file_path).get_content(max_token_len=<span style="color:#ff0;font-weight:bold">500</span>, cover_content=<span style="color:#ff0;font-weight:bold">0</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># è·å–ç³»ç»Ÿæç¤ºè¯ï¼Œç”¨äºæŒ‡å¯¼LLMæå–å¯¹è¯</span>
</span></span><span style="display:flex;"><span>sys_prompt = system_prompt(novel_schema)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># åˆå§‹åŒ–DeepSeekæ¨¡å‹</span>
</span></span><span style="display:flex;"><span>model = DeepseekChat()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># è·å–æ–‡ä»¶åï¼ˆä¸å«æ‰©å±•åï¼‰ç”¨äºè¾“å‡ºæ–‡ä»¶å‘½å</span>
</span></span><span style="display:flex;"><span>file_name = file_path.split(<span style="color:#0ff;font-weight:bold">&#39;/&#39;</span>)[-<span style="color:#ff0;font-weight:bold">1</span>].split(<span style="color:#0ff;font-weight:bold">&#39;.&#39;</span>)[<span style="color:#ff0;font-weight:bold">0</span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># éå†æ‰€æœ‰æ–‡æœ¬å—ï¼Œæå–å¯¹è¯</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">for</span> i in tqdm(<span style="color:#fff;font-weight:bold">range</span>(<span style="color:#fff;font-weight:bold">len</span>(docs))):
</span></span><span style="display:flex;"><span>    response = model.chat(sys_prompt, docs[i])
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">try</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f"># è§£æJSONå“åº”</span>
</span></span><span style="display:flex;"><span>        response = json.loads(response)
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f"># å°†æ¯æ¡å¯¹è¯å†™å…¥JSONLæ–‡ä»¶</span>
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">for</span> item in response:
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">with</span> <span style="color:#fff;font-weight:bold">open</span>(<span style="color:#0ff;font-weight:bold">f</span><span style="color:#0ff;font-weight:bold">&#39;</span><span style="color:#0ff;font-weight:bold">{</span>file_name<span style="color:#0ff;font-weight:bold">}</span><span style="color:#0ff;font-weight:bold">.jsonl&#39;</span>, <span style="color:#0ff;font-weight:bold">&#39;a&#39;</span>, encoding=<span style="color:#0ff;font-weight:bold">&#39;utf-8&#39;</span>) <span style="color:#fff;font-weight:bold">as</span> f:
</span></span><span style="display:flex;"><span>                json.dump(item, f, ensure_ascii=<span style="color:#fff;font-weight:bold">False</span>)
</span></span><span style="display:flex;"><span>                f.write(<span style="color:#0ff;font-weight:bold">&#39;</span><span style="color:#0ff;font-weight:bold">\n</span><span style="color:#0ff;font-weight:bold">&#39;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">except</span> Exception <span style="color:#fff;font-weight:bold">as</span> e:
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">print</span>(e)
</span></span></code></pre></div><h5 id="4-æå–ç»“æœç¤ºä¾‹">4. æå–ç»“æœç¤ºä¾‹<a hidden class="anchor" aria-hidden="true" href="#4-æå–ç»“æœç¤ºä¾‹">#</a></h5>
<p>è¿è¡Œç¨‹åºåï¼Œä¼šå¾—åˆ°åŒ…å«è§’è‰²å’Œå¯¹è¯å†…å®¹çš„JSONLæ–‡ä»¶ï¼Œæ¯è¡Œæ˜¯ä¸€ä¸ªJSONå¯¹è±¡ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span>{<span style="font-weight:bold">&#34;role&#34;</span>: <span style="color:#0ff;font-weight:bold">&#34;å°ç„&#34;</span>, <span style="font-weight:bold">&#34;dialogue&#34;</span>: <span style="color:#0ff;font-weight:bold">&#34;åŠä¸åˆ°ã€‚&#34;</span>}
</span></span><span style="display:flex;"><span>{<span style="font-weight:bold">&#34;role&#34;</span>: <span style="color:#0ff;font-weight:bold">&#34;æ–¹å°‘éºŸ&#34;</span>, <span style="font-weight:bold">&#34;dialogue&#34;</span>: <span style="color:#0ff;font-weight:bold">&#34;åŠä¸åˆ°ï¼Ÿä½ æ˜¯ä¸æƒ³ï¼Ÿè¿˜æ˜¯åŠä¸åˆ°ï¼Ÿ&#34;</span>}
</span></span><span style="display:flex;"><span>{<span style="font-weight:bold">&#34;role&#34;</span>: <span style="color:#0ff;font-weight:bold">&#34;å°ç„&#34;</span>, <span style="font-weight:bold">&#34;dialogue&#34;</span>: <span style="color:#0ff;font-weight:bold">&#34;æ¢ä¸ªæ¡ä»¶ã€‚&#34;</span>}
</span></span><span style="display:flex;"><span>{<span style="font-weight:bold">&#34;role&#34;</span>: <span style="color:#0ff;font-weight:bold">&#34;æ–¹å°‘éºŸ&#34;</span>, <span style="font-weight:bold">&#34;dialogue&#34;</span>: <span style="color:#0ff;font-weight:bold">&#34;æˆ‘æƒ³ä¸å‡ºåˆ«çš„ã€‚å¦‚æœè¿™ä¸¤ä¸ªéƒ½åšä¸åˆ°ï¼Œé‚£ä¹ˆæˆ‘æ— æ³•ç›¸ä¿¡ä½ ä¹‹å‰è¯´çš„è¯ã€‚&#34;</span>}
</span></span><span style="display:flex;"><span>{<span style="font-weight:bold">&#34;role&#34;</span>: <span style="color:#0ff;font-weight:bold">&#34;æ–¹å°‘éºŸ&#34;</span>, <span style="font-weight:bold">&#34;dialogue&#34;</span>: <span style="color:#0ff;font-weight:bold">&#34;è¡Œï¼Œä½ å‘Šè¯‰æˆ‘ï¼Œé™¤æ­¤ä¹‹å¤–ï¼Œä½ è¿˜èƒ½åšåˆ°ä»€ä¹ˆï¼Ÿ&#34;</span>}
</span></span><span style="display:flex;"><span>{<span style="font-weight:bold">&#34;role&#34;</span>: <span style="color:#0ff;font-weight:bold">&#34;å°ç„&#34;</span>, <span style="font-weight:bold">&#34;dialogue&#34;</span>: <span style="color:#0ff;font-weight:bold">&#34;æˆ‘èƒ½è®©çš‡æœå†›é€€å…µã€‚å¦‚æœä½ ä¹Ÿé€€å›æ³½é˜³ï¼Œå°±å¯é¿å…ä¸¤è´¥ä¿±ä¼¤ï¼Œä»¤ä¸‡åƒç”Ÿçµæ¶‚ç‚­ï¼&#34;</span>}
</span></span><span style="display:flex;"><span>{<span style="font-weight:bold">&#34;role&#34;</span>: <span style="color:#0ff;font-weight:bold">&#34;æ–¹å°‘éºŸ&#34;</span>, <span style="font-weight:bold">&#34;dialogue&#34;</span>: <span style="color:#0ff;font-weight:bold">&#34;æˆ‘ä¸èƒ½ã€‚æœå»·å¤±æ”¿æ—¥ä¹…ï¼Œå¦‚ä»Šå¤©ä¸‹è’è’ï¼Œçš†è¦æ¨å€’æ˜å›ï¼Œå¦‚æœä½ æ— æ³•è¯æ˜æ˜å›å·²ç»ä¸åœ¨ï¼Œå‡­æˆ‘æ˜¯è¯´æœä¸äº†åˆ«äººçš„ã€‚&#34;</span>}
</span></span></code></pre></div><h3 id="å¤±è´¥åŸå› ä¸ç»éªŒæ€»ç»“">å¤±è´¥åŸå› ä¸ç»éªŒæ€»ç»“<a hidden class="anchor" aria-hidden="true" href="#å¤±è´¥åŸå› ä¸ç»éªŒæ€»ç»“">#</a></h3>
<p>åç»­ä½¿ç”¨äº†LammaFactoryå·¥å…·è¿›è¡ŒSFTå¾®è°ƒï¼Œæµ‹è¯•æ•ˆæœéƒ½æ¯”è¾ƒå·®ï¼Œæ¨¡å‹åªèƒ½ç®€å•è®°å¿†é—®ç­”å¯¹ï¼Œè€Œä¸èƒ½è¿›è¡Œæ›´å¤æ‚çš„å¯¹è¯ã€‚æˆ‘è®¤ä¸ºä¸€æ–¹é¢æ˜¯æ•°æ®é›†è´¨é‡æ¯”è¾ƒå·®ï¼Œå¹¶ä¸”åœ¨å¾®è°ƒæ—¶å€™äº§ç”Ÿäº†è¿‡æ‹Ÿåˆï¼Œæ¨¡å‹é—å¿˜äº†åŸæœ‰çš„èƒ½åŠ›ã€‚ä½†æ›´ä¸»è¦é—®é¢˜åœ¨äºç›´æ¥è¿›è¡ŒSFTå¯èƒ½ä¸æ˜¯æœ€ä½³é€‰æ‹©ï¼Œåº”è¯¥å…ˆè¿›è¡Œé¢†åŸŸé€‚åº”æ€§çš„é¢„è®­ç»ƒã€‚æ­¤å¤–ï¼Œæ•°æ®é›†çš„è§„æ¨¡å’Œè´¨é‡ä¹Ÿæœ‰å¾…æé«˜ã€‚</p>

  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="https://blog.niuhemoon.win/tags/llm/">LLM</a></li>
      <li><a href="https://blog.niuhemoon.win/tags/sft/">SFT</a></li>
      <li><a href="https://blog.niuhemoon.win/tags/dataset/">Dataset</a></li>
    </ul>
<div class="footer-comments">
  <p>For comments, please   <a href="mailto:carlton2tang@gmail.com" class="email-button" style="font-size: inherit; padding: 5px 10px; background-color: #3f6b9a; color: white; text-decoration: none; border-radius: 3px; transition: background-color 0.3s;">
    send an email
</a> to me</p>

</div>
<nav class="paginav">
  <a class="prev" href="https://blog.niuhemoon.win/posts/tech/c-language-cheetsheet/">
    <span class="title">Â« ä¸Šä¸€é¡µ</span>
    <br>
    <span>C Language Cheetsheet</span>
  </a>
  <a class="next" href="https://blog.niuhemoon.win/posts/tech/whisper-transcript-pytorch-dev-podcast/">
    <span class="title">ä¸‹ä¸€é¡µ Â»</span>
    <br>
    <span>whisperæ¨¡å‹è½¬å½•Pytorchæ’­å®¢å†…å®¹</span>
  </a>
</nav>

  </footer>
</article>
    </main>
    
<footer class="footer">
      
    <span>&copy; 2025 <a href="https://blog.niuhemoon.win">Niuhe&#39;s Blog</a></span>
    <span xmlns:cc="http://creativecommons.org/ns#" xmlns:dct="http://purl.org/dc/terms/">
        Licensed under
        <a
          href="http://creativecommons.org/licenses/by-nc-sa/4.0/?ref=chooser-v1"
          target="_blank"
          rel="license noopener noreferrer"
          style="display:inline-block;"
          >CC BY-NC-SA 4.0 </a></span>
    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = 'ğŸ“„å¤åˆ¶';

        function copyingDone() {
            copybutton.innerHTML = 'ğŸ‘ŒğŸ»å·²å¤åˆ¶!';
            setTimeout(() => {
                copybutton.innerHTML = 'ğŸ“„å¤åˆ¶';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
