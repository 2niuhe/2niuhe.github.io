<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta name="author" content="niuhe" />
    <meta name="robots" content="index, follow"/>

    <meta property="og:title" content="STM32笔记1"/>
    <meta property="og:url" content="../../../../../pages/2019/05/12/STM32-example-1/"/>
    <meta property="og:site_name" content="Niuhe's Blog"/>
    <meta property="og:type" content="article"/>

    <link rel="canonical" href="../../../../../pages/2019/05/12/STM32-example-1/" />

    <title>STM32笔记1 | Niuhe's Blog</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?">
    <link rel="stylesheet" type="text/css" href="//netdna.bootstrapcdn.com/font-awesome/4.0.3/css/font-awesome.css" />
    <link rel="stylesheet" type="text/css" href="//netdna.bootstrapcdn.com/twitter-bootstrap/2.3.2/css/bootstrap-combined.min.css" />

    <link rel="stylesheet" type="text/css" href="../../../../../theme/css/main.css" />

    <script type="text/javascript">var switchTo5x=true;</script>
    <script type="text/javascript" src="http://w.sharethis.com/button/buttons.js"></script>
    <script type="text/javascript">
        stLight.options({
            publisher: "",
            doNotHash: false,
            doNotCopy: false,
            hashAddressBar: false
        });
    </script>
</head>

<body id="index">
<a class="hidden-phone" href="https://github.com/2niuhe">
<img style="position: absolute; top: 0; right: 0; border: 0;" src="http://s3.amazonaws.com/github/ribbons/forkme_right_gray_6d6d6d.png" alt="Fork me on GitHub" />
</a>
    <div class="row-fluid">
        <div class="span10 offset1">
            <header id="banner" >
                <h1>
                    <a href="../../../../../">Niuhe's Blog </a>
                </h1>
                <nav class="navbar">
                    <div class="navbar-inner">
                        <ul class="nav">
                            <li ><a href="../../../../../category/angular.html">Angular</a></li>
                            <li ><a href="../../../../../category/arduino.html">Arduino</a></li>
                            <li ><a href="../../../../../category/golang.html">Golang</a></li>
                            <li ><a href="../../../../../category/life.html">Life : )</a></li>
                            <li class="active"><a href="../../../../../category/linux.html">Linux</a></li>
                            <li ><a href="../../../../../category/openstack.html">Openstack</a></li>
                            <li ><a href="../../../../../category/others.html">Others</a></li>
                            <li ><a href="../../../../../category/python.html">Python</a></li>
                            <li ><a href="../../../../../category/raspberry.html">Raspberry</a></li>
                            <li ><a href="../../../../../category/ros.html">ROS</a></li>
                        </ul>

                    </div>
                </nav>
            </header><!-- /#banner -->
        </div>
    </div>

    <div class="row-fluid">
        <div class="span10 offset1">
            <div class="row-fluid">
<div class="span10 offset1">
  <section>
    <article>
      <header>
        <h1 class="entry-title">
          <a href="../../../../../pages/2019/05/12/STM32-example-1/" rel="bookmark"
             title="Permalink to STM32笔记1">STM32笔记1</a></h1>
      </header>
      <div class="entry-content">
<footer class="post-info">
    <address class="vcard author">
        by <a class="url fn" href="../../../../../author/niuhe.html">niuhe</a>
    </address>

    in <a href="../../../../../category/linux.html">Linux</a>

    on 2019-05-12

        |
        tags:         <a href="../../../../../tag/c.html">C</a>
        <a href="../../../../../tag/stm32.html">STM32</a>


        |
        <a href="../../../../../pages/2019/05/12/STM32-example-1/#disqus_thread">comments</a>

    
</footer><!-- /.post-info -->

        <h2>STM32F103学习笔记</h2>
<h3>GPIO初始化和读写操作</h3>
<blockquote>
<p>STM32的GPIO引脚有多种模式使用，在使用前需要进行配置。</p>
</blockquote>
<hr>
<h4>LED灯实验</h4>
<div class="highlight"><pre><span></span><code><span class="cp">#include</span> <span class="cpf">&quot;stm32f10x.h&quot;</span><span class="cp"></span>

<span class="cp">#define LED GPIO_Pin_All    </span>

<span class="kt">void</span> <span class="nf">delay</span><span class="p">(</span><span class="n">u32</span> <span class="n">i</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">while</span><span class="p">(</span><span class="n">i</span><span class="o">--</span><span class="p">);</span>
<span class="p">}</span>

<span class="c1">//LED的GPIO初始化程序</span>
<span class="kt">void</span> <span class="nf">LED_Init</span><span class="p">()</span>
<span class="p">{</span>
    <span class="n">GPIO_InitTypeDef</span> <span class="n">GPIO_InitStructure</span><span class="p">;</span>
    <span class="c1">//GPIO时钟初始化</span>
    <span class="n">SystemInit</span><span class="p">();</span>
    <span class="n">RCC_APB2PeriphClockCmd</span><span class="p">(</span><span class="n">RCC_APB2Periph_GPIOC</span><span class="p">,</span><span class="n">ENABLE</span><span class="p">);</span>

    <span class="c1">//配置GPIO模式和端口</span>
    <span class="n">GPIO_InitStructure</span><span class="p">.</span><span class="n">GPIO_Pin</span> <span class="o">=</span> <span class="n">LED</span><span class="p">;</span>
    <span class="n">GPIO_InitStructure</span><span class="p">.</span><span class="n">GPIO_Mode</span> <span class="o">=</span> <span class="n">GPIO_Mode_Out_PP</span><span class="p">;</span>  <span class="c1">//推挽模式</span>
    <span class="n">GPIO_InitStructure</span><span class="p">.</span><span class="n">GPIO_Speed</span> <span class="o">=</span> <span class="n">GPIO_Speed_50MHz</span><span class="p">;</span>
    <span class="n">GPIO_Init</span><span class="p">(</span><span class="n">GPIOC</span><span class="p">,</span><span class="o">&amp;</span><span class="n">GPIO_InitStructure</span><span class="p">);</span>       <span class="c1">//初始化GPIO</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">led_display</span><span class="p">()</span>
<span class="p">{</span>
    <span class="n">GPIO_SetBits</span><span class="p">(</span><span class="n">GPIOC</span><span class="p">,</span><span class="n">LED</span><span class="p">);</span>
    <span class="n">delay</span><span class="p">(</span><span class="mi">6000000</span><span class="p">);</span>
    <span class="n">GPIO_ResetBits</span><span class="p">(</span><span class="n">GPIOC</span><span class="p">,</span><span class="n">LED</span><span class="p">);</span>
    <span class="n">delay</span><span class="p">(</span><span class="mi">6000000</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span>
<span class="p">{</span>
    <span class="n">LED_Init</span><span class="p">();</span>
    <span class="k">while</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">led_display</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>


<h4>蜂鸣器实验</h4>
<blockquote>
<p>使用无源蜂鸣器</p>
</blockquote>
<div class="highlight"><pre><span></span><code><span class="cp">#include</span> <span class="cpf">&quot;stm32f10x.h&quot;</span><span class="cp"></span>

<span class="cp">#define BZ GPIO_Pin_5 </span><span class="c1">//PB5  定义端口PB5</span>

<span class="kt">void</span> <span class="nf">delay</span><span class="p">(</span><span class="n">u32</span> <span class="n">i</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">while</span><span class="p">(</span><span class="n">i</span><span class="o">--</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">BEEP_Init</span><span class="p">()</span>
<span class="p">{</span>
    <span class="n">GPIO_InitTypeDef</span> <span class="n">GPIO_InitStructure</span><span class="p">;</span>
    <span class="c1">//GPIO时钟初始化</span>
    <span class="n">SystemInit</span><span class="p">();</span>
    <span class="n">RCC_APB2PeriphClockCmd</span><span class="p">(</span><span class="n">RCC_APB2Periph_GPIOB</span><span class="p">,</span><span class="n">ENABLE</span><span class="p">);</span>

    <span class="c1">//配置GPIO模式和端口</span>
    <span class="n">GPIO_InitStructure</span><span class="p">.</span><span class="n">GPIO_Pin</span> <span class="o">=</span> <span class="n">BZ</span><span class="p">;</span>
    <span class="n">GPIO_InitStructure</span><span class="p">.</span><span class="n">GPIO_Mode</span> <span class="o">=</span> <span class="n">GPIO_Mode_Out_PP</span><span class="p">;</span>  <span class="c1">//推挽模式</span>
    <span class="n">GPIO_InitStructure</span><span class="p">.</span><span class="n">GPIO_Speed</span> <span class="o">=</span> <span class="n">GPIO_Speed_50MHz</span><span class="p">;</span>
    <span class="n">GPIO_Init</span><span class="p">(</span><span class="n">GPIOB</span><span class="p">,</span><span class="o">&amp;</span><span class="n">GPIO_InitStructure</span><span class="p">);</span>       <span class="c1">//初始化GPIO</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">sound</span><span class="p">(</span><span class="n">u32</span> <span class="n">i</span><span class="p">)</span>  <span class="c1">// i= 5000救护车，i=1000电动车</span>
<span class="p">{</span>
    <span class="k">while</span><span class="p">(</span><span class="n">i</span><span class="o">--</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">GPIO_SetBits</span><span class="p">(</span><span class="n">GPIOB</span><span class="p">,</span><span class="n">BZ</span><span class="p">);</span>
        <span class="n">delay</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
        <span class="n">GPIO_ResetBits</span><span class="p">(</span><span class="n">GPIOB</span><span class="p">,</span><span class="n">BZ</span><span class="p">);</span>
        <span class="n">delay</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span>
<span class="p">{</span>   
    <span class="n">BEEP_Init</span><span class="p">();</span>    <span class="c1">//端口初始化  </span>
    <span class="k">while</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">sound</span><span class="p">(</span><span class="mi">5000</span><span class="p">);</span>                
    <span class="p">}</span>   
<span class="p">}</span>
</code></pre></div>


<h4>SysTick实验</h4>
<blockquote>
<p>系统滴答计时器比延时函数更加精确，可移植性更高。systick定时器是24位的定时器，当定时器计数到0时，将自动从RELOAD寄存器中重装定时器初值，如果开启了中断，此时还会产生异常中断信号。</p>
<p>定时器必须要一个时钟来驱动，systick定时器的时钟来源时系统时钟，不过它的时钟可以选择成直接取自系统时钟，也可以将系统时钟8分频后再赋给systick定时器。</p>
<p>systick定时器的操作步骤：</p>
<ol>
<li>设置systick定时器的时钟源</li>
<li>设置systick定时器的重装初始值（若使用中断，就将中断使能打开）</li>
<li>清零systick定时器计数器的值</li>
<li>打开systick定时器</li>
</ol>
</blockquote>
<div class="highlight"><pre><span></span><code><span class="cp">#include</span> <span class="cpf">&quot;stm32f10x.h&quot;</span><span class="cp"></span>

<span class="cp">#define LED GPIO_Pin_All</span>
<span class="kt">void</span> <span class="nf">delay_us</span><span class="p">(</span><span class="n">u32</span> <span class="n">i</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">u32</span> <span class="n">temp</span><span class="p">;</span>
    <span class="n">SysTick</span><span class="o">-&gt;</span><span class="n">LOAD</span> <span class="o">=</span> <span class="mi">9</span><span class="o">*</span><span class="n">i</span><span class="p">;</span>        <span class="c1">//设置重装数值 72MHz时</span>
    <span class="n">SysTick</span><span class="o">-&gt;</span><span class="n">CTRL</span> <span class="o">=</span> <span class="mh">0x01</span><span class="p">;</span>       <span class="c1">//使能，减到零时无动作，采用外部时钟源(8分频系统时钟)</span>
    <span class="n">SysTick</span><span class="o">-&gt;</span><span class="n">VAL</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>           <span class="c1">//清零计数器</span>
    <span class="k">do</span>
    <span class="p">{</span>
        <span class="n">temp</span> <span class="o">=</span> <span class="n">SysTick</span><span class="o">-&gt;</span><span class="n">CTRL</span><span class="p">;</span>   <span class="c1">//读取当前计数值</span>
    <span class="p">}</span>
    <span class="k">while</span><span class="p">((</span><span class="n">temp</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">temp</span> <span class="o">&amp;</span><span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">16</span><span class="p">))));</span> 
    <span class="c1">//与运算取出指定位的数值</span>
    <span class="c1">//实际上就是CTRL寄存器的第1位为0或第16位为1时，退出循环</span>
    <span class="n">SysTick</span><span class="o">-&gt;</span><span class="n">CTRL</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>            <span class="c1">//关闭计数器</span>
    <span class="n">SysTick</span><span class="o">-&gt;</span><span class="n">VAL</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>           <span class="c1">//清空计数器</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">delay_ms</span><span class="p">(</span><span class="n">u32</span> <span class="n">i</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">u32</span> <span class="n">temp</span><span class="p">;</span>
    <span class="n">SysTick</span><span class="o">-&gt;</span><span class="n">LOAD</span><span class="o">=</span><span class="mi">9000</span><span class="o">*</span><span class="n">i</span><span class="p">;</span>     <span class="c1">//设置重装数值, 72MHZ时</span>
    <span class="n">SysTick</span><span class="o">-&gt;</span><span class="n">CTRL</span><span class="o">=</span><span class="mh">0x01</span><span class="p">;</span>     <span class="c1">//使能，减到零是无动作，采用外部时钟源</span>
    <span class="n">SysTick</span><span class="o">-&gt;</span><span class="n">VAL</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>         <span class="c1">//清零计数器</span>
    <span class="k">do</span>
    <span class="p">{</span>
        <span class="n">temp</span><span class="o">=</span><span class="n">SysTick</span><span class="o">-&gt;</span><span class="n">CTRL</span><span class="p">;</span>    <span class="c1">//读取当前倒计数值</span>
    <span class="p">}</span>
    <span class="k">while</span><span class="p">((</span><span class="n">temp</span><span class="o">&amp;</span><span class="mh">0x01</span><span class="p">)</span><span class="o">&amp;&amp;</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">temp</span><span class="o">&amp;</span><span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">16</span><span class="p">))));</span>  <span class="c1">//等待时间到达</span>
    <span class="n">SysTick</span><span class="o">-&gt;</span><span class="n">CTRL</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>    <span class="c1">//关闭计数器</span>
    <span class="n">SysTick</span><span class="o">-&gt;</span><span class="n">VAL</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>     <span class="c1">//清空计数器</span>
<span class="p">}</span>

<span class="c1">//LED的GPIO初始化程序</span>
<span class="kt">void</span> <span class="nf">LED_Init</span><span class="p">()</span>
<span class="p">{</span>
    <span class="n">GPIO_InitTypeDef</span> <span class="n">GPIO_InitStructure</span><span class="p">;</span>
    <span class="c1">//GPIO时钟初始化</span>
    <span class="n">SystemInit</span><span class="p">();</span>
    <span class="n">RCC_APB2PeriphClockCmd</span><span class="p">(</span><span class="n">RCC_APB2Periph_GPIOC</span><span class="p">,</span><span class="n">ENABLE</span><span class="p">);</span>

    <span class="c1">//配置GPIO模式和端口</span>
    <span class="n">GPIO_InitStructure</span><span class="p">.</span><span class="n">GPIO_Pin</span> <span class="o">=</span> <span class="n">LED</span><span class="p">;</span>
    <span class="n">GPIO_InitStructure</span><span class="p">.</span><span class="n">GPIO_Mode</span> <span class="o">=</span> <span class="n">GPIO_Mode_Out_PP</span><span class="p">;</span>  <span class="c1">//推挽模式</span>
    <span class="n">GPIO_InitStructure</span><span class="p">.</span><span class="n">GPIO_Speed</span> <span class="o">=</span> <span class="n">GPIO_Speed_50MHz</span><span class="p">;</span>
    <span class="n">GPIO_Init</span><span class="p">(</span><span class="n">GPIOC</span><span class="p">,</span><span class="o">&amp;</span><span class="n">GPIO_InitStructure</span><span class="p">);</span>       <span class="c1">//初始化GPIO</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span>
<span class="p">{</span>
    <span class="n">u8</span> <span class="n">i</span><span class="p">;</span>
    <span class="n">LED_Init</span><span class="p">();</span>
    <span class="k">while</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;</span><span class="mi">8</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">GPIO_Write</span><span class="p">(</span><span class="n">GPIOC</span><span class="p">,(</span><span class="n">u16</span><span class="p">)</span><span class="o">~</span><span class="p">(</span><span class="mh">0x01</span><span class="o">&lt;&lt;</span><span class="n">i</span><span class="p">));</span>
            <span class="n">delay_ms</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span>     <span class="c1">//精确延时1秒</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>


<h4>系统时钟实验</h4>
<blockquote>
<p>STM32一共可以有4个时钟源</p>
<ul>
<li>HSI（High Speed Inner)内部自带的高速时钟，单片机启动后默认使用的时钟源</li>
<li>HSE (High Speed External)外部高速时钟，大多数时8M晶振</li>
<li>LSE（Low Speed External）外部低速时钟，给单片机内部RTC提供时钟</li>
<li>LSI，内部低速时钟，主要给单片机内部RTC和看门狗提供时钟</li>
</ul>
<p>STM32的系统时钟源，有3个时钟来源：</p>
<ul>
<li>直接来自内部高速时钟HSI</li>
<li>直接来自外部的高速时钟HSE</li>
<li>将HSI或HSE进行处理，倍频之后的PLL时钟（Phase-Locked Loops锁相环）</li>
</ul>
<p><strong>STM32设置RCC（复位和时钟控制）时钟的步骤</strong></p>
<blockquote>
<p>以设置外部高速时钟作为PLL输入，然后以PLL作为时钟源的例子：</p>
<ol>
<li>复位RCC时钟</li>
<li>打开HSE外部高速时钟</li>
<li>监测HSE外部高速时钟是否开启成功</li>
<li>设置FLASH读写</li>
<li>设置AHB总线的分频，还有APB1和APB2的分频，<strong>注</strong>：AHB和APB2最大频率72MHz，APB1做大频率36MHz</li>
<li>设置HSE外部高速时钟作为PLLs时钟的时钟输入</li>
<li>设置PLL时钟的倍频倍数</li>
<li>打开PLL时钟的使能</li>
<li>等待PLL时钟的开启成功</li>
<li>将系统时钟源设置为PLL时</li>
<li>等待时钟源切换成功</li>
</ol>
</blockquote>
</blockquote>
<div class="highlight"><pre><span></span><code><span class="c1">//在上一个实验基础上</span>
<span class="c1">//自定义系统时钟</span>
<span class="kt">void</span> <span class="nf">RCC_HSE_Configuration</span><span class="p">()</span>
<span class="p">{</span>
    <span class="n">RCC_DeInit</span><span class="p">();</span>               <span class="c1">//重置RCC外设寄存器</span>
    <span class="n">RCC_HSEConfig</span><span class="p">(</span><span class="n">RCC_HSE_ON</span><span class="p">);</span>  <span class="c1">//设置外部高速晶振（HSE）</span>
    <span class="k">if</span><span class="p">(</span><span class="n">RCC_WaitForHSEStartUp</span><span class="p">()</span> <span class="o">==</span> <span class="n">SUCCESS</span><span class="p">)</span>      <span class="c1">//等待HSE起振</span>
    <span class="p">{</span>
        <span class="n">RCC_HCLKConfig</span><span class="p">(</span><span class="n">RCC_SYSCLK_Div1</span><span class="p">);</span>    <span class="c1">//设置AHB时钟</span>
        <span class="n">RCC_PCLK1Config</span><span class="p">(</span><span class="n">RCC_HCLK_Div2</span><span class="p">);</span>     <span class="c1">//设置低速AHB时钟（PCLK1）</span>
        <span class="n">RCC_PCLK2Config</span><span class="p">(</span><span class="n">RCC_HCLK_Div1</span><span class="p">);</span>     <span class="c1">//设置高速AHB时钟（PCLK2）</span>
        <span class="n">RCC_PLLConfig</span><span class="p">(</span><span class="n">RCC_PLLSource_HSE_Div2</span><span class="p">,</span><span class="n">RCC_PLLMul_9</span><span class="p">);</span><span class="c1">//设置PLL时钟源及倍频系数，实际系统时钟36MHz</span>
        <span class="n">RCC_PLLCmd</span><span class="p">(</span><span class="n">ENABLE</span><span class="p">);</span>                 <span class="c1">//PLL使能</span>
        <span class="k">while</span><span class="p">(</span><span class="n">RCC_GetFlagStatus</span><span class="p">(</span><span class="n">RCC_FLAG_PLLRDY</span><span class="p">)</span><span class="o">==</span><span class="n">RESET</span><span class="p">);</span><span class="c1">//检查指定的RCC标志位设置与否，PLL就绪</span>
        <span class="n">RCC_SYSCLKConfig</span><span class="p">(</span><span class="n">RCC_SYSCLKSource_PLLCLK</span><span class="p">);</span>  <span class="c1">//设置系统时钟（SYSCLK）</span>
        <span class="k">while</span><span class="p">(</span><span class="n">RCC_GetSYSCLKSource</span><span class="p">()</span><span class="err">网易</span> <span class="o">!=</span> <span class="mh">0x08</span><span class="p">);</span>     <span class="c1">//返回用作系统时钟的时钟源，0x08，PLL作为系统时钟</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span>
<span class="p">{</span>
    <span class="n">LED_Init</span><span class="p">();</span>
    <span class="n">RCC_HSE_Configuration</span><span class="p">();</span>    <span class="c1">//自定义系统时钟，修改倍频或分频参数</span>
    <span class="k">while</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">GPIO_SetBits</span><span class="p">(</span><span class="n">GPIOC</span><span class="p">,</span><span class="n">LED</span><span class="p">);</span>
        <span class="n">delay_ms</span><span class="p">(</span><span class="mi">500</span><span class="p">);</span>          <span class="c1">//精确延时0.5s，实际延时1s</span>
        <span class="n">GPIO_ResetBits</span><span class="p">(</span><span class="n">GPIOC</span><span class="p">,</span><span class="n">LED</span><span class="p">);</span>
        <span class="n">delay_ms</span><span class="p">(</span><span class="mi">500</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>


<h4>按键实验</h4>
<blockquote>
<p>注意按键5ms-10ms左右的延时消抖，注意按键的上拉还是下拉</p>
</blockquote>
<div class="highlight"><pre><span></span><code><span class="cp">#include</span> <span class="cpf">&quot;stm32f10x.h&quot;</span><span class="cp"></span>
<span class="cp">#define K_UP GPIO_Pin_0 </span><span class="c1">//PA0</span>
<span class="cp">#define K_DOWN GPIO_Pin_3 </span><span class="c1">//PE3</span>
<span class="cp">#define K_LEFT GPIO_Pin_2 </span><span class="c1">//PE2</span>
<span class="cp">#define K_RIGHT GPIO_Pin_4 </span><span class="c1">//PE4</span>

<span class="cp">#define k_up GPIO_ReadInputDataBit(GPIOA,K_UP)        </span><span class="c1">//获取按键的状态</span>
<span class="cp">#define k_down GPIO_ReadInputDataBit(GPIOE,K_DOWN)</span>
<span class="cp">#define k_left GPIO_ReadInputDataBit(GPIOE,K_LEFT)</span>
<span class="cp">#define k_right GPIO_ReadInputDataBit(GPIOE,K_RIGHT)</span>

<span class="cp">#define LED GPIO_Pin_All    </span>


<span class="kt">void</span> <span class="nf">delay_ms</span><span class="p">(</span><span class="n">u32</span> <span class="n">i</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">u32</span> <span class="n">temp</span><span class="p">;</span>
    <span class="n">SysTick</span><span class="o">-&gt;</span><span class="n">LOAD</span><span class="o">=</span><span class="mi">9000</span><span class="o">*</span><span class="n">i</span><span class="p">;</span>     <span class="c1">//设置重装数值, 72MHZ时</span>
    <span class="n">SysTick</span><span class="o">-&gt;</span><span class="n">CTRL</span><span class="o">=</span><span class="mh">0x01</span><span class="p">;</span>     <span class="c1">//使能，减到零是无动作，采用外部时钟源</span>
    <span class="n">SysTick</span><span class="o">-&gt;</span><span class="n">VAL</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>         <span class="c1">//清零计数器</span>
    <span class="k">do</span>
    <span class="p">{</span>
        <span class="n">temp</span><span class="o">=</span><span class="n">SysTick</span><span class="o">-&gt;</span><span class="n">CTRL</span><span class="p">;</span>    <span class="c1">//读取当前倒计数值</span>
    <span class="p">}</span>
    <span class="k">while</span><span class="p">((</span><span class="n">temp</span><span class="o">&amp;</span><span class="mh">0x01</span><span class="p">)</span><span class="o">&amp;&amp;</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">temp</span><span class="o">&amp;</span><span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">16</span><span class="p">))));</span>  <span class="c1">//等待时间到达</span>
    <span class="n">SysTick</span><span class="o">-&gt;</span><span class="n">CTRL</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>    <span class="c1">//关闭计数器</span>
    <span class="n">SysTick</span><span class="o">-&gt;</span><span class="n">VAL</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>     <span class="c1">//清空计数器</span>
<span class="p">}</span>

<span class="c1">//LED的GPIO初始化程序</span>
<span class="kt">void</span> <span class="nf">LED_Init</span><span class="p">()</span>
<span class="p">{</span>
    <span class="n">GPIO_InitTypeDef</span> <span class="n">GPIO_InitStructure</span><span class="p">;</span>
    <span class="c1">//GPIO时钟初始化</span>
    <span class="n">SystemInit</span><span class="p">();</span>
    <span class="n">RCC_APB2PeriphClockCmd</span><span class="p">(</span><span class="n">RCC_APB2Periph_GPIOC</span><span class="p">,</span><span class="n">ENABLE</span><span class="p">);</span>

    <span class="c1">//配置GPIO模式和端口</span>
    <span class="n">GPIO_InitStructure</span><span class="p">.</span><span class="n">GPIO_Pin</span> <span class="o">=</span> <span class="n">LED</span><span class="p">;</span>
    <span class="n">GPIO_InitStructure</span><span class="p">.</span><span class="n">GPIO_Mode</span> <span class="o">=</span> <span class="n">GPIO_Mode_Out_PP</span><span class="p">;</span>  <span class="c1">//推挽模式</span>
    <span class="n">GPIO_InitStructure</span><span class="p">.</span><span class="n">GPIO_Speed</span> <span class="o">=</span> <span class="n">GPIO_Speed_50MHz</span><span class="p">;</span>
    <span class="n">GPIO_Init</span><span class="p">(</span><span class="n">GPIOC</span><span class="p">,</span><span class="o">&amp;</span><span class="n">GPIO_InitStructure</span><span class="p">);</span>       <span class="c1">//初始化GPIO</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">key_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">GPIO_InitTypeDef</span> <span class="n">GPIO_InitStructure</span><span class="p">;</span>
    <span class="n">SystemInit</span><span class="p">();</span>
    <span class="c1">//开启GPIO时钟</span>
    <span class="n">RCC_APB2PeriphClockCmd</span><span class="p">(</span><span class="n">RCC_APB2Periph_GPIOA</span><span class="o">|</span><span class="n">RCC_APB2Periph_GPIOE</span><span class="p">,</span><span class="n">ENABLE</span><span class="p">);</span>
    <span class="cm">/*  配置GPIO的模式和IO口 */</span>
    <span class="n">GPIO_InitStructure</span><span class="p">.</span><span class="n">GPIO_Pin</span><span class="o">=</span><span class="n">K_UP</span><span class="p">;</span>      <span class="c1">//选择你要设置的IO口</span>
    <span class="n">GPIO_InitStructure</span><span class="p">.</span><span class="n">GPIO_Mode</span><span class="o">=</span><span class="n">GPIO_Mode_IPD</span><span class="p">;</span><span class="c1">//下拉输入  </span>
    <span class="n">GPIO_InitStructure</span><span class="p">.</span><span class="n">GPIO_Speed</span><span class="o">=</span><span class="n">GPIO_Speed_50MHz</span><span class="p">;</span>    <span class="c1">//设置传输速率</span>
    <span class="n">GPIO_Init</span><span class="p">(</span><span class="n">GPIOA</span><span class="p">,</span><span class="o">&amp;</span><span class="n">GPIO_InitStructure</span><span class="p">);</span>         <span class="cm">/* 初始化GPIO */</span>

    <span class="n">GPIO_InitStructure</span><span class="p">.</span><span class="n">GPIO_Pin</span><span class="o">=</span><span class="n">K_DOWN</span><span class="o">|</span><span class="n">K_LEFT</span><span class="o">|</span><span class="n">K_RIGHT</span><span class="p">;</span>
    <span class="n">GPIO_InitStructure</span><span class="p">.</span><span class="n">GPIO_Mode</span><span class="o">=</span><span class="n">GPIO_Mode_IPU</span><span class="p">;</span> <span class="c1">//上拉输入</span>
    <span class="n">GPIO_InitStructure</span><span class="p">.</span><span class="n">GPIO_Speed</span><span class="o">=</span><span class="n">GPIO_Speed_50MHz</span><span class="p">;</span>
    <span class="n">GPIO_Init</span><span class="p">(</span><span class="n">GPIOE</span><span class="p">,</span><span class="o">&amp;</span><span class="n">GPIO_InitStructure</span><span class="p">);</span>

    <span class="n">GPIO_ResetBits</span><span class="p">(</span><span class="n">GPIOA</span><span class="p">,</span><span class="n">K_UP</span><span class="p">);</span> <span class="c1">//对K_UP初始化输出0</span>

<span class="p">}</span>


<span class="kt">void</span> <span class="nf">key_pros</span><span class="p">()</span>   <span class="c1">//按键处理函数</span>
<span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="n">k_up</span><span class="o">==</span><span class="mi">1</span><span class="p">)</span>   <span class="c1">//判断按键k_up是否按下</span>
    <span class="p">{</span>
        <span class="n">delay_ms</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span> <span class="c1">//消抖处理</span>
        <span class="k">if</span><span class="p">(</span><span class="n">k_up</span><span class="o">==</span><span class="mi">1</span><span class="p">)</span>  <span class="c1">//再次判断按键k_up是否按下</span>
        <span class="p">{</span>
            <span class="n">GPIO_Write</span><span class="p">(</span><span class="n">GPIOC</span><span class="p">,(</span><span class="n">u16</span><span class="p">)</span><span class="mh">0xfe</span><span class="p">);</span>            
        <span class="p">}</span>
        <span class="k">while</span><span class="p">(</span><span class="n">k_up</span><span class="p">);</span> <span class="c1">//等待按键松开</span>
    <span class="p">}</span>
    <span class="k">if</span><span class="p">(</span><span class="n">k_down</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">delay_ms</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
        <span class="k">if</span><span class="p">(</span><span class="n">k_down</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">GPIO_Write</span><span class="p">(</span><span class="n">GPIOC</span><span class="p">,(</span><span class="n">u16</span><span class="p">)(</span><span class="mh">0xfd</span><span class="p">));</span>      
        <span class="p">}</span>
        <span class="k">while</span><span class="p">(</span><span class="o">!</span><span class="n">k_down</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">if</span><span class="p">(</span><span class="n">k_left</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">delay_ms</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
        <span class="k">if</span><span class="p">(</span><span class="n">k_left</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">GPIO_Write</span><span class="p">(</span><span class="n">GPIOC</span><span class="p">,(</span><span class="n">u16</span><span class="p">)(</span><span class="mh">0xfb</span><span class="p">));</span>      
        <span class="p">}</span>
        <span class="k">while</span><span class="p">(</span><span class="o">!</span><span class="n">k_left</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">if</span><span class="p">(</span><span class="n">k_right</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">delay_ms</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
        <span class="k">if</span><span class="p">(</span><span class="n">k_right</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">GPIO_Write</span><span class="p">(</span><span class="n">GPIOC</span><span class="p">,(</span><span class="n">u16</span><span class="p">)(</span><span class="mh">0xf7</span><span class="p">));</span>      
        <span class="p">}</span>
        <span class="k">while</span><span class="p">(</span><span class="o">!</span><span class="n">k_right</span><span class="p">);</span>
    <span class="p">}</span>   
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span>
<span class="p">{</span>         
    <span class="n">LED_Init</span><span class="p">();</span> <span class="c1">//LED初始化</span>
    <span class="n">key_init</span><span class="p">();</span>      <span class="c1">//按键端口初始化函数</span>
    <span class="n">GPIO_Write</span><span class="p">(</span><span class="n">GPIOC</span><span class="p">,(</span><span class="n">u16</span><span class="p">)(</span><span class="mh">0xff</span><span class="p">));</span>
    <span class="k">while</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="p">{</span>   
        <span class="n">key_pros</span><span class="p">();</span> <span class="c1">//按键处理函数                        </span>
    <span class="p">}</span>   
<span class="p">}</span>
</code></pre></div>


<h4>数码管实验</h4>
<div class="highlight"><pre><span></span><code><span class="cp">#include</span> <span class="cpf">&quot;stm32f10x.h&quot;</span><span class="cp"></span>
<span class="cp">#define smg_duan (GPIO_Pin_0|GPIO_Pin_1|GPIO_Pin_2|GPIO_Pin_3|GPIO_Pin_4|GPIO_Pin_5|GPIO_Pin_6|GPIO_Pin_7)</span><span class="c1">//PC0~PC7 </span>

<span class="n">u8</span> <span class="n">smgduan</span><span class="p">[</span><span class="mi">16</span><span class="p">]</span><span class="o">=</span><span class="p">{</span><span class="mh">0x3F</span><span class="p">,</span> <span class="mh">0x06</span><span class="p">,</span> <span class="mh">0x5B</span><span class="p">,</span> <span class="mh">0x4F</span><span class="p">,</span> <span class="mh">0x66</span><span class="p">,</span> <span class="mh">0x6D</span><span class="p">,</span> <span class="mh">0x7D</span><span class="p">,</span> <span class="mh">0x07</span><span class="p">,</span>
             <span class="mh">0x7F</span><span class="p">,</span> <span class="mh">0x6F</span><span class="p">,</span> <span class="mh">0x77</span><span class="p">,</span> <span class="mh">0x7C</span><span class="p">,</span> <span class="mh">0x39</span><span class="p">,</span> <span class="mh">0x5E</span><span class="p">,</span> <span class="mh">0x79</span><span class="p">,</span> <span class="mh">0x71</span><span class="p">};</span><span class="c1">//0~F 数码管段选数据</span>

<span class="kt">void</span> <span class="nf">delay_ms</span><span class="p">(</span><span class="n">u32</span> <span class="n">i</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">u32</span> <span class="n">temp</span><span class="p">;</span>
    <span class="n">SysTick</span><span class="o">-&gt;</span><span class="n">LOAD</span><span class="o">=</span><span class="mi">9000</span><span class="o">*</span><span class="n">i</span><span class="p">;</span>     <span class="c1">//设置重装数值, 72MHZ时</span>
    <span class="n">SysTick</span><span class="o">-&gt;</span><span class="n">CTRL</span><span class="o">=</span><span class="mh">0x01</span><span class="p">;</span>     <span class="c1">//使能，减到零是无动作，采用外部时钟源</span>
    <span class="n">SysTick</span><span class="o">-&gt;</span><span class="n">VAL</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>         <span class="c1">//清零计数器</span>
    <span class="k">do</span>
    <span class="p">{</span>
        <span class="n">temp</span><span class="o">=</span><span class="n">SysTick</span><span class="o">-&gt;</span><span class="n">CTRL</span><span class="p">;</span>    <span class="c1">//读取当前倒计数值</span>
    <span class="p">}</span>
    <span class="k">while</span><span class="p">((</span><span class="n">temp</span><span class="o">&amp;</span><span class="mh">0x01</span><span class="p">)</span><span class="o">&amp;&amp;</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">temp</span><span class="o">&amp;</span><span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">16</span><span class="p">))));</span>  <span class="c1">//等待时间到达</span>
    <span class="n">SysTick</span><span class="o">-&gt;</span><span class="n">CTRL</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>    <span class="c1">//关闭计数器</span>
    <span class="n">SysTick</span><span class="o">-&gt;</span><span class="n">VAL</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>     <span class="c1">//清空计数器</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">smg_init</span><span class="p">()</span>
<span class="p">{</span>
    <span class="n">GPIO_InitTypeDef</span> <span class="n">GPIO_InitStructure</span><span class="p">;</span>  <span class="c1">//声明一个结构体变量，用来初始化GPIO</span>
    <span class="cm">/* 开启GPIO时钟 */</span>
    <span class="n">RCC_APB2PeriphClockCmd</span><span class="p">(</span><span class="n">RCC_APB2Periph_GPIOC</span><span class="p">,</span><span class="n">ENABLE</span><span class="p">);</span>


    <span class="cm">/*  配置GPIO的模式和IO口 */</span>
    <span class="n">GPIO_InitStructure</span><span class="p">.</span><span class="n">GPIO_Pin</span><span class="o">=</span><span class="n">smg_duan</span><span class="p">;</span>     <span class="c1">//选择你要设置的IO口</span>
    <span class="n">GPIO_InitStructure</span><span class="p">.</span><span class="n">GPIO_Mode</span><span class="o">=</span><span class="n">GPIO_Mode_Out_PP</span><span class="p">;</span>
    <span class="n">GPIO_InitStructure</span><span class="p">.</span><span class="n">GPIO_Speed</span><span class="o">=</span><span class="n">GPIO_Speed_50MHz</span><span class="p">;</span>
    <span class="n">GPIO_Init</span><span class="p">(</span><span class="n">GPIOC</span><span class="p">,</span><span class="o">&amp;</span><span class="n">GPIO_InitStructure</span><span class="p">);</span>       <span class="cm">/* 初始化GPIO */</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">static_smg_display</span><span class="p">()</span>   <span class="c1">//静态数码管显示</span>
<span class="p">{</span>   
    <span class="n">u8</span> <span class="n">i</span><span class="p">;</span>
    <span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;</span><span class="mi">16</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">GPIO_Write</span><span class="p">(</span><span class="n">GPIOC</span><span class="p">,(</span><span class="n">u16</span><span class="p">)(</span><span class="o">~</span><span class="n">smgduan</span><span class="p">[</span><span class="n">i</span><span class="p">]));</span>
        <span class="n">delay_ms</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span> 
    <span class="p">}</span>           
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span>
<span class="p">{</span>         
    <span class="n">smg_init</span><span class="p">();</span>  <span class="c1">//数码管端口初始化函数</span>
    <span class="k">while</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">static_smg_display</span><span class="p">();</span>   <span class="c1">//静态数码管显示</span>
    <span class="p">}</span>   
<span class="p">}</span>
</code></pre></div>


<h3>中断和定时器</h3>
<h4>外部中断实验</h4>
<blockquote>
<p>注意将端口引脚映射到外部中断线路上，注意配置中断优先级</p>
</blockquote>
<div class="highlight"><pre><span></span><code><span class="cp">#include</span> <span class="cpf">&quot;stm32f10x.h&quot;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&quot;stm32f10x_exti.h&quot;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&quot;misc.h&quot;</span><span class="cp"></span>

<span class="cp">#define k_left GPIO_Pin_2</span>
<span class="cp">#define LED GPIO_Pin_All</span>

<span class="kt">void</span> <span class="nf">delay_ms</span><span class="p">(</span><span class="n">u32</span> <span class="n">i</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">u32</span> <span class="n">temp</span><span class="p">;</span>
    <span class="n">SysTick</span><span class="o">-&gt;</span><span class="n">LOAD</span><span class="o">=</span><span class="mi">9000</span><span class="o">*</span><span class="n">i</span><span class="p">;</span>     <span class="c1">//设置重装数值, 72MHZ时</span>
    <span class="n">SysTick</span><span class="o">-&gt;</span><span class="n">CTRL</span><span class="o">=</span><span class="mh">0x01</span><span class="p">;</span>     <span class="c1">//使能，减到零是无动作，采用外部时钟源</span>
    <span class="n">SysTick</span><span class="o">-&gt;</span><span class="n">VAL</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>         <span class="c1">//清零计数器</span>
    <span class="k">do</span>
    <span class="p">{</span>
        <span class="n">temp</span><span class="o">=</span><span class="n">SysTick</span><span class="o">-&gt;</span><span class="n">CTRL</span><span class="p">;</span>    <span class="c1">//读取当前倒计数值</span>
    <span class="p">}</span>
    <span class="k">while</span><span class="p">((</span><span class="n">temp</span><span class="o">&amp;</span><span class="mh">0x01</span><span class="p">)</span><span class="o">&amp;&amp;</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">temp</span><span class="o">&amp;</span><span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">16</span><span class="p">))));</span>  <span class="c1">//等待时间到达</span>
    <span class="n">SysTick</span><span class="o">-&gt;</span><span class="n">CTRL</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>    <span class="c1">//关闭计数器</span>
    <span class="n">SysTick</span><span class="o">-&gt;</span><span class="n">VAL</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>     <span class="c1">//清空计数器</span>
<span class="p">}</span>

<span class="c1">//LED的GPIO初始化程序</span>
<span class="kt">void</span> <span class="nf">led_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">GPIO_InitTypeDef</span> <span class="n">GPIO_InitStructure</span><span class="p">;</span>
    <span class="c1">//GPIO时钟初始化</span>
    <span class="n">SystemInit</span><span class="p">();</span>
    <span class="n">RCC_APB2PeriphClockCmd</span><span class="p">(</span><span class="n">RCC_APB2Periph_GPIOC</span><span class="p">,</span><span class="n">ENABLE</span><span class="p">);</span>

    <span class="c1">//配置GPIO模式和端口</span>
    <span class="n">GPIO_InitStructure</span><span class="p">.</span><span class="n">GPIO_Pin</span> <span class="o">=</span> <span class="n">LED</span><span class="p">;</span>
    <span class="n">GPIO_InitStructure</span><span class="p">.</span><span class="n">GPIO_Mode</span> <span class="o">=</span> <span class="n">GPIO_Mode_Out_PP</span><span class="p">;</span>  <span class="c1">//推挽模式</span>
    <span class="n">GPIO_InitStructure</span><span class="p">.</span><span class="n">GPIO_Speed</span> <span class="o">=</span> <span class="n">GPIO_Speed_50MHz</span><span class="p">;</span>
    <span class="n">GPIO_Init</span><span class="p">(</span><span class="n">GPIOC</span><span class="p">,</span><span class="o">&amp;</span><span class="n">GPIO_InitStructure</span><span class="p">);</span>       <span class="c1">//初始化GPIO</span>

    <span class="n">GPIO_SetBits</span><span class="p">(</span><span class="n">GPIOC</span><span class="p">,</span><span class="n">LED</span><span class="p">);</span>
<span class="p">}</span>


<span class="kt">void</span> <span class="nf">exti_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>        <span class="c1">//外部中断初始化</span>
<span class="p">{</span>
    <span class="n">GPIO_InitTypeDef</span> <span class="n">GPIO_InitStructure</span><span class="p">;</span>
    <span class="n">EXTI_InitTypeDef</span> <span class="n">EXTI_InitStructure</span><span class="p">;</span>
    <span class="n">NVIC_InitTypeDef</span> <span class="n">NVIC_InitStructure</span><span class="p">;</span>

    <span class="n">SystemInit</span><span class="p">();</span>
    <span class="c1">//开启GPIO时钟，用到了时引脚复用功能，开启复用时钟</span>
    <span class="n">RCC_APB2PeriphClockCmd</span><span class="p">(</span><span class="n">RCC_APB2Periph_AFIO</span><span class="p">,</span><span class="n">ENABLE</span><span class="p">);</span>
    <span class="n">RCC_APB2PeriphClockCmd</span><span class="p">(</span><span class="n">RCC_APB2Periph_GPIOE</span><span class="p">,</span><span class="n">ENABLE</span><span class="p">);</span>

    <span class="n">GPIO_InitStructure</span><span class="p">.</span><span class="n">GPIO_Pin</span> <span class="o">=</span> <span class="n">k_left</span><span class="p">;</span>
    <span class="n">GPIO_InitStructure</span><span class="p">.</span><span class="n">GPIO_Mode</span> <span class="o">=</span> <span class="n">GPIO_Mode_IPU</span><span class="p">;</span>   <span class="c1">//上拉输入</span>
    <span class="n">GPIO_InitStructure</span><span class="p">.</span><span class="n">GPIO_Speed</span> <span class="o">=</span> <span class="n">GPIO_Speed_50MHz</span><span class="p">;</span>
    <span class="n">GPIO_Init</span><span class="p">(</span><span class="n">GPIOE</span><span class="p">,</span><span class="o">&amp;</span><span class="n">GPIO_InitStructure</span><span class="p">);</span>
    <span class="c1">//选择外部中断线路对应的GPIO管脚，此处是PE2</span>
    <span class="n">GPIO_EXTILineConfig</span><span class="p">(</span><span class="n">GPIO_PortSourceGPIOE</span><span class="p">,</span><span class="n">GPIO_PinSource2</span><span class="p">);</span>

    <span class="c1">//设置外部中断的模式</span>
    <span class="n">EXTI_InitStructure</span><span class="p">.</span><span class="n">EXTI_Line</span> <span class="o">=</span> <span class="n">EXTI_Line2</span><span class="p">;</span>
    <span class="n">EXTI_InitStructure</span><span class="p">.</span><span class="n">EXTI_Mode</span> <span class="o">=</span> <span class="n">EXTI_Mode_Interrupt</span><span class="p">;</span>
    <span class="n">EXTI_InitStructure</span><span class="p">.</span><span class="n">EXTI_Trigger</span> <span class="o">=</span> <span class="n">EXTI_Trigger_Falling</span><span class="p">;</span> <span class="c1">//下降沿触发</span>
    <span class="n">EXTI_InitStructure</span><span class="p">.</span><span class="n">EXTI_LineCmd</span> <span class="o">=</span> <span class="n">ENABLE</span><span class="p">;</span>
    <span class="n">EXTI_Init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">EXTI_InitStructure</span><span class="p">);</span>

    <span class="c1">//设置NVIC参数（nested vector interrupt config)</span>
    <span class="n">NVIC_PriorityGroupConfig</span><span class="p">(</span><span class="n">NVIC_PriorityGroup_1</span><span class="p">);</span>
    <span class="n">NVIC_InitStructure</span><span class="p">.</span><span class="n">NVIC_IRQChannel</span> <span class="o">=</span> <span class="n">EXTI2_IRQn</span><span class="p">;</span>    <span class="c1">//打开EXTI2的全局中断</span>
    <span class="n">NVIC_InitStructure</span><span class="p">.</span><span class="n">NVIC_IRQChannelPreemptionPriority</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>   <span class="c1">//抢占优先级为0</span>
    <span class="n">NVIC_InitStructure</span><span class="p">.</span><span class="n">NVIC_IRQChannelSubPriority</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>          <span class="c1">//响应优先级为0</span>
    <span class="n">NVIC_InitStructure</span><span class="p">.</span><span class="n">NVIC_IRQChannelCmd</span> <span class="o">=</span> <span class="n">ENABLE</span><span class="p">;</span>             <span class="c1">//使能</span>
    <span class="n">NVIC_Init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">NVIC_InitStructure</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">EXTI2_IRQHandler</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>    <span class="c1">//外部中断2中断处理函数</span>
<span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="n">EXTI_GetITStatus</span><span class="p">(</span><span class="n">EXTI_Line2</span><span class="p">)</span><span class="o">==</span><span class="n">SET</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">EXTI_ClearITPendingBit</span><span class="p">(</span><span class="n">EXTI_Line2</span><span class="p">);</span><span class="c1">//清除EXTI2线路挂起位</span>
        <span class="n">delay_ms</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span><span class="c1">//消抖</span>
        <span class="k">if</span><span class="p">(</span><span class="n">GPIO_ReadInputDataBit</span><span class="p">(</span><span class="n">GPIOE</span><span class="p">,</span><span class="n">k_left</span><span class="p">)</span><span class="o">==</span><span class="n">Bit_RESET</span><span class="p">)</span>     <span class="c1">//k_left按下</span>
        <span class="p">{</span>
            <span class="n">delay_ms</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span><span class="c1">//消抖</span>
            <span class="k">if</span><span class="p">(</span><span class="n">GPIO_ReadOutputDataBit</span><span class="p">(</span><span class="n">GPIOC</span><span class="p">,</span><span class="n">GPIO_Pin_0</span><span class="p">)</span><span class="o">==</span><span class="n">Bit_RESET</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="c1">//LED熄灭</span>
               <span class="n">GPIO_SetBits</span><span class="p">(</span><span class="n">GPIOC</span><span class="p">,</span><span class="n">GPIO_Pin_0</span><span class="p">);</span>  
            <span class="p">}</span>
            <span class="k">else</span>
            <span class="p">{</span>
               <span class="c1">//LED发光</span>
                <span class="n">GPIO_ResetBits</span><span class="p">(</span><span class="n">GPIOC</span><span class="p">,</span><span class="n">GPIO_Pin_0</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span> 
        <span class="k">while</span><span class="p">(</span><span class="n">GPIO_ReadInputDataBit</span><span class="p">(</span><span class="n">GPIOE</span><span class="p">,</span><span class="n">GPIO_Pin_2</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">);</span>  <span class="c1">//等待按键松开</span>
    <span class="p">}</span>       
<span class="p">}</span>


<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span>
<span class="p">{</span>
    <span class="n">led_init</span><span class="p">();</span>
    <span class="n">exti_init</span><span class="p">();</span>
    <span class="k">while</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>


<h4>定时器实验</h4>
<blockquote>
<p>STM32中一共有11个定时器：</p>
<ul>
<li>2个高级控制定时器   （TIM1,TIM8)</li>
<li>4个通用定时器  （TIM2-TIM5）</li>
<li>2个基本定时器    (TIM6,TIm7)</li>
<li>2个看门狗定时器</li>
<li>1个系统滴答定时器</li>
</ul>
<p><strong>注</strong>:TIM2-TIM7的时钟由APB1产生，TIM1和TIM8是由APB2产生时钟</p>
</blockquote>
<div class="highlight"><pre><span></span><code><span class="c1">//实现1s流水灯实验</span>
<span class="cp">#include</span> <span class="cpf">&quot;stm32f10x.h&quot;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&quot;stm32f10x_tim.h&quot;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&quot;stm32f10x_exti.h&quot;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&quot;misc.h&quot;</span><span class="cp"></span>

<span class="cp">#define LED GPIO_Pin_All</span>

<span class="c1">//LED的GPIO初始化程序</span>
<span class="kt">void</span> <span class="nf">led_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">GPIO_InitTypeDef</span> <span class="n">GPIO_InitStructure</span><span class="p">;</span>
    <span class="c1">//GPIO时钟初始化</span>
    <span class="n">SystemInit</span><span class="p">();</span>
    <span class="n">RCC_APB2PeriphClockCmd</span><span class="p">(</span><span class="n">RCC_APB2Periph_GPIOC</span><span class="p">,</span><span class="n">ENABLE</span><span class="p">);</span>

    <span class="c1">//配置GPIO模式和端口</span>
    <span class="n">GPIO_InitStructure</span><span class="p">.</span><span class="n">GPIO_Pin</span> <span class="o">=</span> <span class="n">LED</span><span class="p">;</span>
    <span class="n">GPIO_InitStructure</span><span class="p">.</span><span class="n">GPIO_Mode</span> <span class="o">=</span> <span class="n">GPIO_Mode_Out_PP</span><span class="p">;</span>  <span class="c1">//推挽模式</span>
    <span class="n">GPIO_InitStructure</span><span class="p">.</span><span class="n">GPIO_Speed</span> <span class="o">=</span> <span class="n">GPIO_Speed_50MHz</span><span class="p">;</span>
    <span class="n">GPIO_Init</span><span class="p">(</span><span class="n">GPIOC</span><span class="p">,</span><span class="o">&amp;</span><span class="n">GPIO_InitStructure</span><span class="p">);</span>       <span class="c1">//初始化GPIO</span>

<span class="p">}</span>


<span class="kt">void</span> <span class="nf">time_init</span><span class="p">()</span>
<span class="p">{</span>
    <span class="n">TIM_TimeBaseInitTypeDef</span> <span class="n">TIM_TimeBaseInitStructure</span><span class="p">;</span>  <span class="c1">//定时器初始化结构体</span>
    <span class="n">NVIC_InitTypeDef</span> <span class="n">NVIC_InitStructure</span><span class="p">;</span>
    <span class="c1">//开启定时器3时钟</span>
    <span class="n">RCC_APB1PeriphClockCmd</span><span class="p">(</span><span class="n">RCC_APB1Periph_TIM3</span><span class="p">,</span><span class="n">ENABLE</span><span class="p">);</span>

    <span class="n">TIM_ClearITPendingBit</span><span class="p">(</span><span class="n">TIM3</span><span class="p">,</span><span class="n">TIM_IT_Update</span><span class="p">);</span>  <span class="c1">//清除TIMx的中断待处理位：TIM中断源</span>

    <span class="n">TIM_TimeBaseInitStructure</span><span class="p">.</span><span class="n">TIM_Period</span> <span class="o">=</span> <span class="mi">2000</span><span class="p">;</span><span class="c1">//设置自动重装寄存器周期的值</span>
    <span class="n">TIM_TimeBaseInitStructure</span><span class="p">.</span><span class="n">TIM_Prescaler</span> <span class="o">=</span> <span class="mi">36000</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span><span class="c1">//设置作为TIMx时钟频率的预分频值，2Khz计数频率</span>
    <span class="n">TIM_TimeBaseInitStructure</span><span class="p">.</span><span class="n">TIM_ClockDivision</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span><span class="c1">//设置时钟分割：TDTS = Tck_tim</span>
    <span class="n">TIM_TimeBaseInitStructure</span><span class="p">.</span><span class="n">TIM_CounterMode</span> <span class="o">=</span> <span class="n">TIM_CounterMode_Up</span><span class="p">;</span><span class="c1">//向上计数模式 </span>
    <span class="n">TIM_TimeBaseInit</span><span class="p">(</span><span class="n">TIM3</span><span class="p">,</span><span class="o">&amp;</span><span class="n">TIM_TimeBaseInitStructure</span><span class="p">);</span>
    <span class="n">TIM_Cmd</span><span class="p">(</span><span class="n">TIM3</span><span class="p">,</span><span class="n">ENABLE</span><span class="p">);</span>   <span class="c1">//使能或失能TIMx外设</span>

    <span class="c1">//设置中断参数，并打开中断</span>
    <span class="n">TIM_ITConfig</span><span class="p">(</span><span class="n">TIM3</span><span class="p">,</span><span class="n">TIM_IT_Update</span><span class="p">,</span><span class="n">ENABLE</span><span class="p">);</span>    <span class="c1">//使能或失能指定的TIM中断</span>

    <span class="c1">//设置NVIC参数</span>
    <span class="n">NVIC_PriorityGroupConfig</span><span class="p">(</span><span class="n">NVIC_PriorityGroup_1</span><span class="p">);</span>
    <span class="n">NVIC_InitStructure</span><span class="p">.</span><span class="n">NVIC_IRQChannel</span> <span class="o">=</span> <span class="n">TIM3_IRQn</span><span class="p">;</span> <span class="c1">//打开EXTI2的全局中断</span>
    <span class="n">NVIC_InitStructure</span><span class="p">.</span><span class="n">NVIC_IRQChannelPreemptionPriority</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>   <span class="c1">//抢占优先级为0</span>
    <span class="n">NVIC_InitStructure</span><span class="p">.</span><span class="n">NVIC_IRQChannelSubPriority</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>          <span class="c1">//响应优先级为1</span>
    <span class="n">NVIC_InitStructure</span><span class="p">.</span><span class="n">NVIC_IRQChannelCmd</span> <span class="o">=</span> <span class="n">ENABLE</span><span class="p">;</span>             <span class="c1">//使能</span>
    <span class="n">NVIC_Init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">NVIC_InitStructure</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">TIM3_IRQHandler</span><span class="p">()</span>      <span class="c1">//定时器3的中断处理函数</span>
<span class="p">{</span>
    <span class="k">static</span> <span class="n">u8</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">TIM_ClearITPendingBit</span><span class="p">(</span><span class="n">TIM3</span><span class="p">,</span><span class="n">TIM_IT_Update</span><span class="p">);</span>
    <span class="n">GPIO_Write</span><span class="p">(</span><span class="n">GPIOC</span><span class="p">,(</span><span class="n">u16</span><span class="p">)</span><span class="o">~</span><span class="p">(</span><span class="mh">0x01</span><span class="o">&lt;&lt;</span><span class="n">i</span><span class="o">++</span><span class="p">));</span>
    <span class="k">if</span><span class="p">(</span><span class="n">i</span><span class="o">==</span><span class="mi">8</span><span class="p">)</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span>
<span class="p">{</span>
    <span class="n">time_init</span><span class="p">();</span>
    <span class="n">led_init</span><span class="p">();</span>
    <span class="k">while</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>

      </div><!-- /.entry-content -->
      <div class="comments">
        <h2>Comments</h2>
        <div id="disqus_thread"></div>
        <script type="text/javascript">
          var disqus_identifier = "pages/2019/05/12/STM32-example-1/";
          (function() {
          var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
          dsq.src = '//niuhemoon.disqus.com/embed.js';
          (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
          })();
        </script>
      </div>

    </article>
  </section>
</div>
            </div>
        </div>
    </div>

    <footer id="site-footer">
        <div class="row-fluid">
            <div class="span10 offset1">
                <address>
                    <p>
                        This blog is proudly powered by <a href="http://getpelican.com/">Pelican</a>, which takes great advantage of <a href="http://python.org">Python</a>.
                    </p>
                    <p>
                        <a href="http://github.com/jsliang/pelican-fresh/">Fresh</a> is a responsive theme designed by <a href="http://jsliang.com/">jsliang</a> and <a href="https://github.com/jsliang/pelican-fresh/graphs/contributors">contributors</a>.
                        Special thanks to <a href="http://coding.smashingmagazine.com/2009/08/04/designing-a-html-5-layout-from-scratch/">Smashing Magazine</a> and <a href="http://getbootstrap.com/">Twitter Bootstrap</a>.
                    </p>
                </address>
            </div>
        </div>
    </footer>

    <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-116933089-1']);
    _gaq.push(['_trackPageview']);
    (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
    </script>
<script type="text/javascript">
    var disqus_shortname = 'niuhemoon';
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = '//' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>
    <script src="//code.jquery.com/jquery.min.js"></script>
    <script src="//netdna.bootstrapcdn.com/bootstrap/2.3.2/js/bootstrap.min.js"></script>
</body>
</html>