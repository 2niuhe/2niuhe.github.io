<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta name="author" content="niuhe" />
    <meta name="robots" content="index, follow"/>

    <meta property="og:title" content="Python进阶下"/>
    <meta property="og:url" content="../../../../../pages/2020/10/13/Python-Advanced-3/"/>
    <meta property="og:site_name" content="Niuhe's Blog"/>
    <meta property="og:type" content="article"/>

    <link rel="canonical" href="../../../../../pages/2020/10/13/Python-Advanced-3/" />

    <title>Python进阶下 | Niuhe's Blog</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?">
    <link rel="stylesheet" type="text/css" href="//netdna.bootstrapcdn.com/font-awesome/4.0.3/css/font-awesome.css" />
    <link rel="stylesheet" type="text/css" href="//netdna.bootstrapcdn.com/twitter-bootstrap/2.3.2/css/bootstrap-combined.min.css" />

    <link rel="stylesheet" type="text/css" href="../../../../../theme/css/main.css" />

    <script type="text/javascript">var switchTo5x=true;</script>
    <script type="text/javascript" src="http://w.sharethis.com/button/buttons.js"></script>
    <script type="text/javascript">
        stLight.options({
            publisher: "",
            doNotHash: false,
            doNotCopy: false,
            hashAddressBar: false
        });
    </script>
</head>

<body id="index">
<a class="hidden-phone" href="https://github.com/2niuhe">
<img style="position: absolute; top: 0; right: 0; border: 0;" src="http://s3.amazonaws.com/github/ribbons/forkme_right_gray_6d6d6d.png" alt="Fork me on GitHub" />
</a>
    <div class="row-fluid">
        <div class="span10 offset1">
            <header id="banner" >
                <h1>
                    <a href="../../../../../">Niuhe's Blog </a>
                </h1>
                <nav class="navbar">
                    <div class="navbar-inner">
                        <ul class="nav">
                            <li ><a href="../../../../../category/angular.html">Angular</a></li>
                            <li ><a href="../../../../../category/arduino.html">Arduino</a></li>
                            <li ><a href="../../../../../category/go.html">Go</a></li>
                            <li ><a href="../../../../../category/golang.html">Golang</a></li>
                            <li ><a href="../../../../../category/life.html">Life : )</a></li>
                            <li ><a href="../../../../../category/linux.html">Linux</a></li>
                            <li ><a href="../../../../../category/openstack.html">Openstack</a></li>
                            <li ><a href="../../../../../category/others.html">Others</a></li>
                            <li class="active"><a href="../../../../../category/python.html">Python</a></li>
                            <li ><a href="../../../../../category/raspberry.html">Raspberry</a></li>
                            <li ><a href="../../../../../category/ros.html">ROS</a></li>
                        </ul>

                    </div>
                </nav>
            </header><!-- /#banner -->
        </div>
    </div>

    <div class="row-fluid">
        <div class="span10 offset1">
            <div class="row-fluid">
<div class="span10 offset1">
  <section>
    <article>
      <header>
        <h1 class="entry-title">
          <a href="../../../../../pages/2020/10/13/Python-Advanced-3/" rel="bookmark"
             title="Permalink to Python进阶下">Python进阶下</a></h1>
      </header>
      <div class="entry-content">
<footer class="post-info">
    <address class="vcard author">
        by <a class="url fn" href="../../../../../author/niuhe.html">niuhe</a>
    </address>

    in <a href="../../../../../category/python.html">Python</a>

    on 2020-10-13

        |
        tags:         <a href="../../../../../tag/python.html">Python</a>


        |
        <a href="../../../../../pages/2020/10/13/Python-Advanced-3/#disqus_thread">comments</a>

    
</footer><!-- /.post-info -->

        <blockquote>
<p>有两种常用的方法可以使得代码并行执行，多线程和多进程 。因为Cython解释器的实现不是线程安全的，具有GIL锁，同一时刻，只有一个线程可以获得解释器的锁。因此，Python利用多核心的CPU只能通过多进程，而多线程只适用于IO密集型的程序。</p>
</blockquote>
<h3>多进程基础</h3>
<h5>创建并开启进程</h5>
<blockquote>
<p>可以使用<code>multiprocessing.Process()</code>来创建进程，它接受两个参数：</p>
<ul>
<li>target，一个可调用的函数，当进程开始时会执行</li>
<li>args，一个元组，提供目标函数的参数</li>
</ul>
<p>使用<code>process.start()</code>来开始执行一个进程</p>
<p>调用<code>process.join()</code>来告诉程序等待进程结束再执行后续代码，主进程将会被阻塞</p>
</blockquote>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">multiprocessing</span> <span class="kn">import</span> <span class="n">Process</span>
<span class="kn">import</span> <span class="nn">os</span>

<span class="k">def</span> <span class="nf">square_numbers</span><span class="p">():</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1000</span><span class="p">):</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">i</span> <span class="o">*</span> <span class="n">i</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>        
    <span class="n">processes</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">num_processes</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">cpu_count</span><span class="p">()</span>
    <span class="c1"># number of CPUs on the machine. Usually a good choise for the number of processes</span>

    <span class="c1"># create processes and asign a function for each process</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_processes</span><span class="p">):</span>
        <span class="n">process</span> <span class="o">=</span> <span class="n">Process</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">square_numbers</span><span class="p">)</span>
        <span class="n">processes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">process</span><span class="p">)</span>

    <span class="c1"># start all processes</span>
    <span class="k">for</span> <span class="n">process</span> <span class="ow">in</span> <span class="n">processes</span><span class="p">:</span>
        <span class="n">process</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

    <span class="c1"># wait for all processes to finish</span>
    <span class="c1"># block the main programm until these processes are finished</span>
    <span class="k">for</span> <span class="n">process</span> <span class="ow">in</span> <span class="n">processes</span><span class="p">:</span>
        <span class="n">process</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
</code></pre></div>


<h5>进程间分享数据</h5>
<blockquote>
<p>因为进程的内存空间不同，需要特殊的共享内存对象来分享数据。</p>
<p>数据可以保存在共享内存变量中，使用<code>Value</code>或者<code>Array</code></p>
<ul>
<li>Value(type, value)创建一个<code>ctype</code>对象</li>
<li>Array(type, value)创建一个<code>ctype</code>类型的列表</li>
</ul>
<p>如下程序演示年race condition资源竟态，每次执行结果都不一样，例如当两个进程读取同一个值，并对其执行+1操作，然后写会原有地址，其结果并不是预想的加2。</p>
</blockquote>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">multiprocessing</span> <span class="kn">import</span> <span class="n">Process</span><span class="p">,</span> <span class="n">Value</span><span class="p">,</span> <span class="n">Array</span>
<span class="kn">import</span> <span class="nn">time</span>

<span class="k">def</span> <span class="nf">add_100</span><span class="p">(</span><span class="n">number</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">100</span><span class="p">):</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.001</span><span class="p">)</span>
        <span class="n">number</span><span class="o">.</span><span class="n">value</span> <span class="o">+=</span> <span class="mi">1</span>

<span class="k">def</span> <span class="nf">add_100_array</span><span class="p">(</span><span class="n">numbers</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">100</span><span class="p">):</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.01</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">numbers</span><span class="p">)):</span>
            <span class="n">numbers</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>

    <span class="n">shared_number</span> <span class="o">=</span> <span class="n">Value</span><span class="p">(</span><span class="s1">&#39;i&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> 
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Value at beginning:&#39;</span><span class="p">,</span> <span class="n">shared_number</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>

    <span class="n">shared_array</span> <span class="o">=</span> <span class="n">Array</span><span class="p">(</span><span class="s1">&#39;d&#39;</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">100.0</span><span class="p">,</span> <span class="mf">200.0</span><span class="p">])</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Array at beginning:&#39;</span><span class="p">,</span> <span class="n">shared_array</span><span class="p">[:])</span>

    <span class="n">process1</span> <span class="o">=</span> <span class="n">Process</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">add_100</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">shared_number</span><span class="p">,))</span>
    <span class="n">process2</span> <span class="o">=</span> <span class="n">Process</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">add_100</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">shared_number</span><span class="p">,))</span>

    <span class="n">process3</span> <span class="o">=</span> <span class="n">Process</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">add_100_array</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">shared_array</span><span class="p">,))</span>
    <span class="n">process4</span> <span class="o">=</span> <span class="n">Process</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">add_100_array</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">shared_array</span><span class="p">,))</span>

    <span class="n">process1</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
    <span class="n">process2</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
    <span class="n">process3</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
    <span class="n">process4</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

    <span class="n">process1</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
    <span class="n">process2</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
    <span class="n">process3</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
    <span class="n">process4</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>

    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Value at end:&#39;</span><span class="p">,</span> <span class="n">shared_number</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Array at end:&#39;</span><span class="p">,</span> <span class="n">shared_array</span><span class="p">[:])</span>

    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;end main&#39;</span><span class="p">)</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Value at beginning: 0</span>
<span class="sd">    Array at beginning: [0.0, 100.0, 200.0]</span>
<span class="sd">    Value at end: 144</span>
<span class="sd">    Array at end: [134.0, 237.0, 339.0]</span>
<span class="sd">    end main</span>
<span class="sd">&quot;&quot;&quot;</span>
</code></pre></div>


<h5>可以使用锁避免资源竟态</h5>
<blockquote>
<p>锁（也称为互斥锁）是一种同步机制，用于在存在许多执行进程/线程的环境中强制限制对资源的访问。锁具有两种状态：锁定和解锁。 如果状态为锁定，则在再次解除锁定状态之前，不允许其他并发进程/线程进入此代码段。</p>
</blockquote>
<div class="highlight"><pre><span></span><code><span class="c1"># import Lock</span>
<span class="kn">from</span> <span class="nn">multiprocessing</span> <span class="kn">import</span> <span class="n">Lock</span>
<span class="kn">from</span> <span class="nn">multiprocessing</span> <span class="kn">import</span> <span class="n">Process</span><span class="p">,</span> <span class="n">Value</span><span class="p">,</span> <span class="n">Array</span>
<span class="kn">import</span> <span class="nn">time</span>

<span class="k">def</span> <span class="nf">add_100</span><span class="p">(</span><span class="n">number</span><span class="p">,</span> <span class="n">lock</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">100</span><span class="p">):</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.001</span><span class="p">)</span>
        <span class="c1"># lock the state</span>
        <span class="n">lock</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>

        <span class="n">number</span><span class="o">.</span><span class="n">value</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="c1"># unlock the state</span>
        <span class="n">lock</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">add_100_array</span><span class="p">(</span><span class="n">numbers</span><span class="p">,</span> <span class="n">lock</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">100</span><span class="p">):</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.01</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">numbers</span><span class="p">)):</span>
            <span class="n">lock</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>
            <span class="n">numbers</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">lock</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>

    <span class="c1"># create a lock</span>
    <span class="n">lock1</span> <span class="o">=</span> <span class="n">Lock</span><span class="p">()</span>
    <span class="n">lock2</span> <span class="o">=</span> <span class="n">Lock</span><span class="p">()</span>

    <span class="n">shared_number</span> <span class="o">=</span> <span class="n">Value</span><span class="p">(</span><span class="s1">&#39;i&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> 
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Value at beginning:&#39;</span><span class="p">,</span> <span class="n">shared_number</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>

    <span class="n">shared_array</span> <span class="o">=</span> <span class="n">Array</span><span class="p">(</span><span class="s1">&#39;d&#39;</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">100.0</span><span class="p">,</span> <span class="mf">200.0</span><span class="p">])</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Array at beginning:&#39;</span><span class="p">,</span> <span class="n">shared_array</span><span class="p">[:])</span>

    <span class="c1"># pass the lock to the target function</span>
    <span class="n">process1</span> <span class="o">=</span> <span class="n">Process</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">add_100</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">shared_number</span><span class="p">,</span> <span class="n">lock1</span><span class="p">))</span>
    <span class="n">process2</span> <span class="o">=</span> <span class="n">Process</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">add_100</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">shared_number</span><span class="p">,</span> <span class="n">lock1</span><span class="p">))</span>

    <span class="n">process3</span> <span class="o">=</span> <span class="n">Process</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">add_100_array</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">shared_array</span><span class="p">,</span> <span class="n">lock2</span><span class="p">))</span>
    <span class="n">process4</span> <span class="o">=</span> <span class="n">Process</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">add_100_array</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">shared_array</span><span class="p">,</span> <span class="n">lock2</span><span class="p">))</span>

    <span class="n">process1</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
    <span class="n">process2</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
    <span class="n">process3</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
    <span class="n">process4</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

    <span class="n">process1</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
    <span class="n">process2</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
    <span class="n">process3</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
    <span class="n">process4</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>

    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Value at end:&#39;</span><span class="p">,</span> <span class="n">shared_number</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Array at end:&#39;</span><span class="p">,</span> <span class="n">shared_array</span><span class="p">[:])</span>

    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;end main&#39;</span><span class="p">)</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Value at beginning: 0</span>
<span class="sd">Array at beginning: [0.0, 100.0, 200.0]</span>
<span class="sd">Value at end: 200</span>
<span class="sd">Array at end: [200.0, 300.0, 400.0]</span>
<span class="sd">end main</span>
<span class="sd">&quot;&quot;&quot;</span>
</code></pre></div>


<h5>在上下文管理器中使用锁</h5>
<blockquote>
<p>使用上下文管理器管理锁的获取和释放更加安全</p>
</blockquote>
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">add_100</span><span class="p">(</span><span class="n">number</span><span class="p">,</span> <span class="n">lock</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">100</span><span class="p">):</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.01</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">lock</span><span class="p">:</span>
            <span class="n">number</span><span class="o">.</span><span class="n">value</span> <span class="o">+=</span> <span class="mi">1</span>
</code></pre></div>


<h5>多进程使用队列通信</h5>
<blockquote>
<p>使用队列的操作是进程安全的。多进程队列实现了队列的所有方法。done()和join()除外。</p>
<ul>
<li><code>q.get()</code>:移除队首第一个元素，默认情况，会阻塞直到有元素可用</li>
<li><code>q.put(item)</code>将元素压到队尾，默认情况，阻塞直到队列有空的槽</li>
<li><code>q.empty()</code>如果队列为空，返回True</li>
<li><code>q.close()</code>表明当前进程不会有新的数据放到队列中了</li>
</ul>
</blockquote>
<div class="highlight"><pre><span></span><code><span class="c1"># communicate between processes with the multiprocessing Queue</span>
<span class="c1"># Queues are thread and process safe</span>
<span class="kn">from</span> <span class="nn">multiprocessing</span> <span class="kn">import</span> <span class="n">Process</span><span class="p">,</span> <span class="n">Queue</span>
<span class="kn">import</span> <span class="nn">time</span> 

<span class="k">def</span> <span class="nf">square</span><span class="p">(</span><span class="n">numbers</span><span class="p">,</span> <span class="n">queue</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">numbers</span><span class="p">:</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.01</span><span class="p">)</span>
        <span class="n">queue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">i</span><span class="o">*</span><span class="n">i</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">make_negative</span><span class="p">(</span><span class="n">numbers</span><span class="p">,</span> <span class="n">queue</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">numbers</span><span class="p">:</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.01</span><span class="p">)</span>
        <span class="n">queue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">i</span><span class="o">*-</span><span class="mi">1</span><span class="p">)</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>

    <span class="n">numbers</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span>
    <span class="n">q</span> <span class="o">=</span> <span class="n">Queue</span><span class="p">()</span>

    <span class="n">p1</span> <span class="o">=</span> <span class="n">Process</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">square</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">numbers</span><span class="p">,</span><span class="n">q</span><span class="p">))</span>
    <span class="n">p2</span> <span class="o">=</span> <span class="n">Process</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">make_negative</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">numbers</span><span class="p">,</span><span class="n">q</span><span class="p">))</span>

    <span class="n">p1</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
    <span class="n">p2</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

    <span class="n">p1</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
    <span class="n">p2</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>

    <span class="c1"># order might not be sequential</span>
    <span class="k">while</span> <span class="ow">not</span> <span class="n">q</span><span class="o">.</span><span class="n">empty</span><span class="p">():</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">q</span><span class="o">.</span><span class="n">get</span><span class="p">())</span>

    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;end main&#39;</span><span class="p">)</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">1</span>
<span class="sd">-1</span>
<span class="sd">4</span>
<span class="sd">-2</span>
<span class="sd">9</span>
<span class="sd">-3</span>
<span class="sd">16</span>
<span class="sd">-4</span>
<span class="sd">25</span>
<span class="sd">-5</span>
<span class="sd">end main</span>
<span class="sd">&quot;&quot;&quot;</span>
</code></pre></div>


<h5>进程池</h5>
<blockquote>
<p>进程池对象控制一些工作进程worker，可以支持超时和回调以实现异步处理，也有一些并行的map实现。它可以自动管理多个处理器，并将数据分成小块，在多个处理器上并行处理。</p>
<p>重要的函数包括：</p>
<ul>
<li><code>map(func, iterable[, chunksize])</code>将可迭代对象切分成小块，作为独立任务提交到进程池，并行处理。函数将会阻塞，直到返回结果。</li>
<li><code>close()</code>阻止更多任务添加到进程池，一旦任务完成，worker进程将退出</li>
<li><code>join()</code>等待工作进程退出，在调用<code>join()</code>之前需要调用<code>close()</code>或者<code>terminate()</code></li>
<li><code>apply(func, args)</code>调用<code>func</code>函数，参数是<code>args</code>。阻塞直到返回结果，<code>func</code>函数只在进程池中一个worker中执行</li>
<li>有<code>map_async()</code>和<code>apply_async()</code>这种非阻塞的异步函数</li>
</ul>
</blockquote>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">multiprocessing</span> <span class="kn">import</span> <span class="n">Pool</span> 
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">import</span> <span class="nn">time</span>

<span class="k">def</span> <span class="nf">cube</span><span class="p">(</span><span class="n">number</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Hi&quot;</span><span class="p">)</span>
    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">number</span> <span class="o">*</span> <span class="n">number</span> <span class="o">*</span> <span class="n">number</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">numbers</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>

    <span class="n">p</span> <span class="o">=</span> <span class="n">Pool</span><span class="p">()</span>

    <span class="c1"># by default this allocates the maximum number of available </span>
    <span class="c1"># processors for this task --&gt; os.cpu_count()</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">cube</span><span class="p">,</span>  <span class="n">numbers</span><span class="p">)</span>

    <span class="c1"># or </span>
    <span class="c1"># result = [p.apply(cube, args=(i,)) for i in numbers]</span>

    <span class="n">p</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="n">p</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>

    <span class="nb">print</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
</code></pre></div>


<h3>多线程基础</h3>
<blockquote>
<p>Python多线程相对比较鸡肋，其使用和多进程类似</p>
</blockquote>
<h5>创建并开始线程</h5>
<blockquote>
<p>使用threading库实现</p>
</blockquote>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">threading</span> <span class="kn">import</span> <span class="n">Thread</span>

<span class="k">def</span> <span class="nf">square_numbers</span><span class="p">():</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1000</span><span class="p">):</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">i</span> <span class="o">*</span> <span class="n">i</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>        
    <span class="n">threads</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">num_threads</span> <span class="o">=</span> <span class="mi">10</span>

    <span class="c1"># create threads and asign a function for each thread</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_threads</span><span class="p">):</span>
        <span class="n">thread</span> <span class="o">=</span> <span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">square_numbers</span><span class="p">)</span>
        <span class="n">threads</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">thread</span><span class="p">)</span>

    <span class="c1"># start all threads</span>
    <span class="k">for</span> <span class="n">thread</span> <span class="ow">in</span> <span class="n">threads</span><span class="p">:</span>
        <span class="n">thread</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

    <span class="c1"># wait for all threads to finish</span>
    <span class="c1"># block the main thread until these threads are finished</span>
    <span class="k">for</span> <span class="n">thread</span> <span class="ow">in</span> <span class="n">threads</span><span class="p">:</span>
        <span class="n">thread</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
</code></pre></div>


<h5>线程间共享数据</h5>
<blockquote>
<p>线程间可以通过全局变量来共享数据，因为线程间是共享内存空间的</p>
</blockquote>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">threading</span> <span class="kn">import</span> <span class="n">Thread</span>
<span class="kn">import</span> <span class="nn">time</span>

<span class="c1"># all threads can access this global variable</span>
<span class="n">database_value</span> <span class="o">=</span> <span class="mi">0</span>

<span class="k">def</span> <span class="nf">increase</span><span class="p">():</span>
    <span class="k">global</span> <span class="n">database_value</span> <span class="c1"># needed to modify the global value</span>

    <span class="c1"># get a local copy (simulate data retrieving)</span>
    <span class="n">local_copy</span> <span class="o">=</span> <span class="n">database_value</span>

    <span class="c1"># simulate some modifying operation</span>
    <span class="n">local_copy</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>

    <span class="c1"># write the calculated new value into the global variable</span>
    <span class="n">database_value</span> <span class="o">=</span> <span class="n">local_copy</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>

    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Start value: &#39;</span><span class="p">,</span> <span class="n">database_value</span><span class="p">)</span>

    <span class="n">t1</span> <span class="o">=</span> <span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">increase</span><span class="p">)</span>
    <span class="n">t2</span> <span class="o">=</span> <span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">increase</span><span class="p">)</span>

    <span class="n">t1</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
    <span class="n">t2</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

    <span class="n">t1</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
    <span class="n">t2</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>

    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;End value:&#39;</span><span class="p">,</span> <span class="n">database_value</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;end main&#39;</span><span class="p">)</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Start value:  0</span>
<span class="sd">    End value: 1</span>
<span class="sd">    end main</span>
<span class="sd">&quot;&quot;&quot;</span>
</code></pre></div>


<h5>使用锁处理资源竟态</h5>
<div class="highlight"><pre><span></span><code><span class="c1"># import Lock</span>
<span class="kn">from</span> <span class="nn">threading</span> <span class="kn">import</span> <span class="n">Thread</span><span class="p">,</span> <span class="n">Lock</span>
<span class="kn">import</span> <span class="nn">time</span>


<span class="n">database_value</span> <span class="o">=</span> <span class="mi">0</span>

<span class="k">def</span> <span class="nf">increase</span><span class="p">(</span><span class="n">lock</span><span class="p">):</span>
    <span class="k">global</span> <span class="n">database_value</span> 

    <span class="c1"># lock the state</span>
    <span class="n">lock</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>

    <span class="n">local_copy</span> <span class="o">=</span> <span class="n">database_value</span>
    <span class="n">local_copy</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
    <span class="n">database_value</span> <span class="o">=</span> <span class="n">local_copy</span>

    <span class="c1"># unlock the state</span>
    <span class="n">lock</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>

    <span class="c1"># create a lock</span>
    <span class="n">lock</span> <span class="o">=</span> <span class="n">Lock</span><span class="p">()</span>

    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Start value: &#39;</span><span class="p">,</span> <span class="n">database_value</span><span class="p">)</span>

    <span class="c1"># pass the lock to the target function</span>
    <span class="n">t1</span> <span class="o">=</span> <span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">increase</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">lock</span><span class="p">,))</span> <span class="c1"># notice the comma after lock since args must be a tuple</span>
    <span class="n">t2</span> <span class="o">=</span> <span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">increase</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">lock</span><span class="p">,))</span>

    <span class="n">t1</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
    <span class="n">t2</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

    <span class="n">t1</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
    <span class="n">t2</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>

    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;End value:&#39;</span><span class="p">,</span> <span class="n">database_value</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;end main&#39;</span><span class="p">)</span>
</code></pre></div>


<blockquote>
<p>使用上下文管理器</p>
</blockquote>
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">increase</span><span class="p">(</span><span class="n">lock</span><span class="p">):</span>
    <span class="k">global</span> <span class="n">database_value</span> 

    <span class="k">with</span> <span class="n">lock</span><span class="p">:</span> 
        <span class="n">local_copy</span> <span class="o">=</span> <span class="n">database_value</span>
        <span class="n">local_copy</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
        <span class="n">database_value</span> <span class="o">=</span> <span class="n">local_copy</span>
</code></pre></div>


<h5>多线程消息队列通信</h5>
<blockquote>
<p>对队列的操作是线程安全的</p>
</blockquote>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">threading</span> <span class="kn">import</span> <span class="n">Thread</span><span class="p">,</span> <span class="n">Lock</span><span class="p">,</span> <span class="n">current_thread</span>
<span class="kn">from</span> <span class="nn">queue</span> <span class="kn">import</span> <span class="n">Queue</span>

<span class="k">def</span> <span class="nf">worker</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">lock</span><span class="p">):</span>
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">q</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>  <span class="c1"># blocks until the item is available</span>

        <span class="c1"># do stuff...</span>
        <span class="k">with</span> <span class="n">lock</span><span class="p">:</span>
            <span class="c1"># prevent printing at the same time with this lock</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;in </span><span class="si">{</span><span class="n">current_thread</span><span class="p">()</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> got </span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="c1"># ...</span>

        <span class="c1"># For each get(), a subsequent call to task_done() tells the queue</span>
        <span class="c1"># that the processing on this item is complete.</span>
        <span class="c1"># If all tasks are done, q.join() can unblock</span>
        <span class="n">q</span><span class="o">.</span><span class="n">task_done</span><span class="p">()</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">q</span> <span class="o">=</span> <span class="n">Queue</span><span class="p">()</span>
    <span class="n">num_threads</span> <span class="o">=</span> <span class="mi">10</span>
    <span class="n">lock</span> <span class="o">=</span> <span class="n">Lock</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_threads</span><span class="p">):</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">Thread</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Thread</span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">target</span><span class="o">=</span><span class="n">worker</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">lock</span><span class="p">))</span>
        <span class="n">t</span><span class="o">.</span><span class="n">daemon</span> <span class="o">=</span> <span class="kc">True</span>  <span class="c1"># dies when the main thread dies</span>
        <span class="n">t</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

    <span class="c1"># fill the queue with items</span>
    <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">20</span><span class="p">):</span>
        <span class="n">q</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

    <span class="n">q</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>  <span class="c1"># Blocks until all items in the queue have been gotten and processed.</span>

    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;main done&#39;</span><span class="p">)</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">in Thread1 got 0</span>
<span class="sd">    in Thread2 got 1</span>
<span class="sd">    in Thread2 got 11</span>
<span class="sd">    in Thread2 got 12</span>
<span class="sd">    in Thread2 got 13</span>
<span class="sd">    in Thread2 got 14</span>
<span class="sd">    in Thread2 got 15</span>
<span class="sd">    in Thread2 got 16</span>
<span class="sd">    in Thread2 got 17</span>
<span class="sd">    in Thread2 got 18</span>
<span class="sd">    in Thread2 got 19</span>
<span class="sd">    in Thread8 got 5</span>
<span class="sd">    in Thread4 got 9</span>
<span class="sd">    in Thread1 got 10</span>
<span class="sd">    in Thread5 got 2</span>
<span class="sd">    in Thread6 got 3</span>
<span class="sd">    in Thread9 got 6</span>
<span class="sd">    in Thread7 got 4</span>
<span class="sd">    in Thread10 got 7</span>
<span class="sd">    in Thread3 got 8</span>
<span class="sd">    main done</span>
<span class="sd">&quot;&quot;&quot;</span>
</code></pre></div>


<h3>参考</h3>
<p><a href="https://www.python-engineer.com/courses/advancedpython/15-thread-vs-process/">Python多线程和多进程</a></p>

      </div><!-- /.entry-content -->
      <div class="comments">
        <h2>Comments</h2>
        <div id="disqus_thread"></div>
        <script type="text/javascript">
          var disqus_identifier = "pages/2020/10/13/Python-Advanced-3/";
          (function() {
          var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
          dsq.src = '//niuhemoon.disqus.com/embed.js';
          (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
          })();
        </script>
      </div>

    </article>
  </section>
</div>
            </div>
        </div>
    </div>

    <footer id="site-footer">
        <div class="row-fluid">
            <div class="span10 offset1">
                <address>
                    <p>
                        This blog is proudly powered by <a href="http://getpelican.com/">Pelican</a>, which takes great advantage of <a href="http://python.org">Python</a>.
                    </p>
                    <p>
                        <a href="http://github.com/jsliang/pelican-fresh/">Fresh</a> is a responsive theme designed by <a href="http://jsliang.com/">jsliang</a> and <a href="https://github.com/jsliang/pelican-fresh/graphs/contributors">contributors</a>.
                        Special thanks to <a href="http://coding.smashingmagazine.com/2009/08/04/designing-a-html-5-layout-from-scratch/">Smashing Magazine</a> and <a href="http://getbootstrap.com/">Twitter Bootstrap</a>.
                    </p>
                </address>
            </div>
        </div>
    </footer>

    <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-116933089-1']);
    _gaq.push(['_trackPageview']);
    (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
    </script>
<script type="text/javascript">
    var disqus_shortname = 'niuhemoon';
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = '//' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>
    <script src="//code.jquery.com/jquery.min.js"></script>
    <script src="//netdna.bootstrapcdn.com/bootstrap/2.3.2/js/bootstrap.min.js"></script>
</body>
</html>